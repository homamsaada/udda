<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Ø´Ø¬Ø±Ø© Ø§Ù„Ø¹Ø§Ø¦Ù„Ø© - Ø£Ù†Ø´Ø¦ Ø´Ø¬Ø±Ø© Ø¹Ø§Ø¦Ù„ØªÙƒ Ù…Ø¬Ø§Ù†Ø§Ù‹ | Ø¹ÙØ¯Ù‘Ø©</title>
  <meta name="description" content="Ø£Ø¯Ø§Ø© Ù…Ø¬Ø§Ù†ÙŠØ© Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø´Ø¬Ø±Ø© Ø§Ù„Ø¹Ø§Ø¦Ù„Ø© Ø¨Ø³Ù‡ÙˆÙ„Ø©. Ø£Ø¶Ù Ø§Ù„Ø£Ø´Ø®Ø§Øµ ÙˆØ§Ù„Ø¹Ù„Ø§Ù‚Ø§ØªØŒ Ø§Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±ØŒ ÙˆØµØ¯Ù‘Ø± Ø§Ù„Ø´Ø¬Ø±Ø© ÙƒØµÙˆØ±Ø© Ø£Ùˆ PDF.">
  <meta name="keywords" content="Ø´Ø¬Ø±Ø© Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©ØŒ Ø´Ø¬Ø±Ø© Ø¹Ø§Ø¦Ù„Ø©ØŒ Ù†Ø³Ø¨ØŒ Ø³Ù„Ø§Ù„Ø©ØŒ Ø£Ù†Ø³Ø§Ø¨ØŒ Ø¹Ù„Ø§Ù‚Ø§Øª Ø¹Ø§Ø¦Ù„ÙŠØ©ØŒ family tree">
  <meta name="author" content="Udda">
  <meta name="robots" content="index, follow">
  
  <meta property="og:type" content="website">
  <meta property="og:title" content="Ø´Ø¬Ø±Ø© Ø§Ù„Ø¹Ø§Ø¦Ù„Ø© - Ø£Ù†Ø´Ø¦ Ø´Ø¬Ø±Ø© Ø¹Ø§Ø¦Ù„ØªÙƒ Ù…Ø¬Ø§Ù†Ø§Ù‹ | Ø¹ÙØ¯Ù‘Ø©">
  <meta property="og:description" content="Ø£Ø¯Ø§Ø© Ù…Ø¬Ø§Ù†ÙŠØ© Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø´Ø¬Ø±Ø© Ø§Ù„Ø¹Ø§Ø¦Ù„Ø© Ø¨Ø³Ù‡ÙˆÙ„Ø©. Ø£Ø¶Ù Ø§Ù„Ø£Ø´Ø®Ø§Øµ ÙˆØ§Ù„Ø¹Ù„Ø§Ù‚Ø§ØªØŒ Ø§Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±ØŒ ÙˆØµØ¯Ù‘Ø± Ø§Ù„Ø´Ø¬Ø±Ø© ÙƒØµÙˆØ±Ø© Ø£Ùˆ PDF.">
  <meta property="og:url" content="https://udda.tools/ar/tools/family-tree.html">
  <meta property="og:site_name" content="Ø¹ÙØ¯Ù‘Ø©">
  <meta property="og:locale" content="ar_SA">
  
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Ø´Ø¬Ø±Ø© Ø§Ù„Ø¹Ø§Ø¦Ù„Ø© - Ø£Ù†Ø´Ø¦ Ø´Ø¬Ø±Ø© Ø¹Ø§Ø¦Ù„ØªÙƒ Ù…Ø¬Ø§Ù†Ø§Ù‹ | Ø¹ÙØ¯Ù‘Ø©">
  <meta name="twitter:description" content="Ø£Ø¯Ø§Ø© Ù…Ø¬Ø§Ù†ÙŠØ© Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø´Ø¬Ø±Ø© Ø§Ù„Ø¹Ø§Ø¦Ù„Ø© Ø¨Ø³Ù‡ÙˆÙ„Ø©. Ø£Ø¶Ù Ø§Ù„Ø£Ø´Ø®Ø§Øµ ÙˆØ§Ù„Ø¹Ù„Ø§Ù‚Ø§ØªØŒ Ø§Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±ØŒ ÙˆØµØ¯Ù‘Ø± Ø§Ù„Ø´Ø¬Ø±Ø© ÙƒØµÙˆØ±Ø© Ø£Ùˆ PDF.">
  
  <link rel="alternate" hreflang="ar" href="https://udda.tools/ar/tools/family-tree.html">
  <link rel="alternate" hreflang="en" href="https://udda.tools/en/tools/family-tree.html">
  <link rel="alternate" hreflang="x-default" href="https://udda.tools/ar/tools/family-tree.html">
  <link rel="canonical" href="https://udda.tools/ar/tools/family-tree.html">
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../../assets/css/main.css">
  
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "WebApplication",
    "name": "Ø´Ø¬Ø±Ø© Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©",
    "description": "Ø£Ø¯Ø§Ø© Ù…Ø¬Ø§Ù†ÙŠØ© Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø´Ø¬Ø±Ø© Ø§Ù„Ø¹Ø§Ø¦Ù„Ø© Ø¨Ø³Ù‡ÙˆÙ„Ø©. Ø£Ø¶Ù Ø§Ù„Ø£Ø´Ø®Ø§Øµ ÙˆØ§Ù„Ø¹Ù„Ø§Ù‚Ø§ØªØŒ Ø§Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±ØŒ ÙˆØµØ¯Ù‘Ø± Ø§Ù„Ø´Ø¬Ø±Ø© ÙƒØµÙˆØ±Ø© Ø£Ùˆ PDF.",
    "url": "https://udda.tools/ar/tools/family-tree.html",
    "applicationCategory": "UtilityApplication",
    "operatingSystem": "Any",
    "offers": { "@type": "Offer", "price": "0", "priceCurrency": "USD" },
    "inLanguage": ["ar", "en"],
    "isAccessibleForFree": true
  }
  </script>
</head>
<body data-tool-id="family-tree">
  <div class="app-container">
    <div class="sidebar-overlay"></div>
    
    <aside class="sidebar">
      <div class="sidebar-header">
        <a href="../../ar/" class="logo">
          <div class="logo-icon">ğŸ”§</div>
          <span class="logo-text sidebar-text">Ø¹ÙØ¯Ù‘Ø©</span>
        </a>
      </div>
      
      <div class="sidebar-search">
        <div class="search-input-wrapper">
          <input type="text" class="search-input" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø£Ø¯Ø§Ø©..." aria-label="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø£Ø¯Ø§Ø©...">
          <svg class="search-icon" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <circle cx="11" cy="11" r="8"></circle>
            <path d="m21 21-4.35-4.35"></path>
          </svg>
        </div>
      </div>
      
      <nav class="sidebar-nav">
        
        <a href="../../ar/" class="nav-item ">
          <span class="nav-item-icon">ğŸ </span>
          <span class="sidebar-text">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span>
        </a>
        <div class="nav-section ">
          <div class="nav-section-title">
            <span>
              <span class="nav-section-icon">ğŸ§®</span>
              <span class="sidebar-text">Ø­Ø§Ø³Ø¨Ø§Øª</span>
            </span>
            <svg class="nav-section-arrow sidebar-text" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path d="m6 9 6 6 6-6"></path>
            </svg>
          </div>
          <div class="nav-section-items">
            <a href="../../ar/tools/percentage.html" class="nav-item ">
              <span class="nav-item-icon">ğŸ”¢</span>
              <span class="sidebar-text">Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø¦ÙˆÙŠØ©</span>
            </a>
            <a href="../../ar/tools/interest-calculator.html" class="nav-item ">
              <span class="nav-item-icon">ğŸ’°</span>
              <span class="sidebar-text">Ø­Ø§Ø³Ø¨Ø© Ø§Ù„ÙÙˆØ§Ø¦Ø¯</span>
            </a>
            <a href="../../ar/tools/loan-calculator.html" class="nav-item ">
              <span class="nav-item-icon">ğŸ¦</span>
              <span class="sidebar-text">Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ù‚Ø±ÙˆØ¶</span>
            </a>
            <a href="../../ar/tools/body-calculator.html" class="nav-item ">
              <span class="nav-item-icon">âš–ï¸</span>
              <span class="sidebar-text">Ø­Ø§Ø³Ø¨Ø© ÙƒØªÙ„Ø© Ø§Ù„Ø¬Ø³Ù…</span>
            </a>
            <a href="../../ar/tools/age-calculator.html" class="nav-item ">
              <span class="nav-item-icon">ğŸ‚</span>
              <span class="sidebar-text">Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ø¹Ù…Ø±</span>
            </a>
          </div>
        </div>
        <div class="nav-section ">
          <div class="nav-section-title">
            <span>
              <span class="nav-section-icon">ğŸ”„</span>
              <span class="sidebar-text">Ù…Ø­ÙˆÙ‘Ù„Ø§Øª</span>
            </span>
            <svg class="nav-section-arrow sidebar-text" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path d="m6 9 6 6 6-6"></path>
            </svg>
          </div>
          <div class="nav-section-items">
          </div>
        </div>
        <div class="nav-section ">
          <div class="nav-section-title">
            <span>
              <span class="nav-section-icon">ğŸ“</span>
              <span class="sidebar-text">Ø£Ø¯ÙˆØ§Øª Ù†ØµÙŠØ©</span>
            </span>
            <svg class="nav-section-arrow sidebar-text" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path d="m6 9 6 6 6-6"></path>
            </svg>
          </div>
          <div class="nav-section-items">
          </div>
        </div>
        <div class="nav-section ">
          <div class="nav-section-title">
            <span>
              <span class="nav-section-icon">ğŸ“…</span>
              <span class="sidebar-text">ÙˆÙ‚Øª ÙˆØªØ§Ø±ÙŠØ®</span>
            </span>
            <svg class="nav-section-arrow sidebar-text" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path d="m6 9 6 6 6-6"></path>
            </svg>
          </div>
          <div class="nav-section-items">
          </div>
        </div>
        <div class="nav-section ">
          <div class="nav-section-title">
            <span>
              <span class="nav-section-icon">âš¡</span>
              <span class="sidebar-text">Ù…ÙˆÙ„Ù‘Ø¯Ø§Øª</span>
            </span>
            <svg class="nav-section-arrow sidebar-text" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path d="m6 9 6 6 6-6"></path>
            </svg>
          </div>
          <div class="nav-section-items">
          </div>
        </div>
        <div class="nav-section ">
          <div class="nav-section-title">
            <span>
              <span class="nav-section-icon">ğŸ–¼ï¸</span>
              <span class="sidebar-text">Ø£Ø¯ÙˆØ§Øª ØµÙˆØ±</span>
            </span>
            <svg class="nav-section-arrow sidebar-text" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path d="m6 9 6 6 6-6"></path>
            </svg>
          </div>
          <div class="nav-section-items">
          </div>
        </div>
        <div class="nav-section ">
          <div class="nav-section-title">
            <span>
              <span class="nav-section-icon">ğŸ’»</span>
              <span class="sidebar-text">Ø£Ø¯ÙˆØ§Øª Ù…Ø·ÙˆØ±ÙŠÙ†</span>
            </span>
            <svg class="nav-section-arrow sidebar-text" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path d="m6 9 6 6 6-6"></path>
            </svg>
          </div>
          <div class="nav-section-items">
          </div>
        </div>
        <div class="nav-section open">
          <div class="nav-section-title">
            <span>
              <span class="nav-section-icon">ğŸ </span>
              <span class="sidebar-text">Ø£Ø¯ÙˆØ§Øª ÙŠÙˆÙ…ÙŠØ©</span>
            </span>
            <svg class="nav-section-arrow sidebar-text" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path d="m6 9 6 6 6-6"></path>
            </svg>
          </div>
          <div class="nav-section-items">
            <a href="../../ar/tools/family-tree.html" class="nav-item active">
              <span class="nav-item-icon">ğŸŒ³</span>
              <span class="sidebar-text">Ø´Ø¬Ø±Ø© Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©</span>
            </a>
          </div>
        </div>
      </nav>
      
      <div class="sidebar-footer">
        <button class="sidebar-toggle" aria-label="Toggle sidebar">
          <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path d="M11 19l-7-7 7-7m8 14l-7-7 7-7"></path>
          </svg>
          <span class="sidebar-text">Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ©</span>
        </button>
      </div>
    </aside>
    
    <div class="main-content">
      <header class="main-header">
        <button class="header-btn mobile-menu-btn" aria-label="Menu">
          <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path d="M4 6h16M4 12h16M4 18h16"></path>
          </svg>
        </button>
        
        <nav class="header-breadcrumb">
          <a href="../../ar/" class="breadcrumb-link">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
          <span class="breadcrumb-separator">â€º</span>
          <a href="../../ar/category/everyday.html" class="breadcrumb-link">Ø£Ø¯ÙˆØ§Øª ÙŠÙˆÙ…ÙŠØ©</a>
          <span class="breadcrumb-separator">â€º</span>
          <span class="breadcrumb-current">Ø´Ø¬Ø±Ø© Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©</span>
        </nav>
        
        <div class="header-actions">
          <button class="header-btn" data-favorite-btn aria-label="Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ù…ÙØ¶Ù„Ø©">â˜†</button>
          <button class="header-btn" onclick="App.shareUrl('Ø´Ø¬Ø±Ø© Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©')" aria-label="Ù…Ø´Ø§Ø±ÙƒØ©">
            <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"></path>
              <polyline points="16 6 12 2 8 6"></polyline>
              <line x1="12" y1="2" x2="12" y2="15"></line>
            </svg>
          </button>
          <button class="header-btn" data-open-settings aria-label="Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª">
            <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <circle cx="12" cy="12" r="3"></circle>
              <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
            </svg>
          </button>
        </div>
      </header>
      
      <main class="page-content">
        <style>
:root {
  --primary: #059669;
  --primary-dark: #047857;
  --male-color: #3b82f6;
  --female-color: #ec4899;
  --marriage-color: #f59e0b;
  --bg-secondary: #1e293b;
  --bg-card: #334155;
  --text-primary: #f8fafc;
  --text-secondary: #94a3b8;
  --text-muted: #64748b;
  --border-color: #475569;
  --danger: #ef4444;
}

* { box-sizing: border-box; }

.ft-container {
  display: flex;
  gap: 10px;
  min-height: 70vh;
}

/* ========== PERSONS SIDEBAR ========== */
.ft-sidebar {
  width: 220px;
  background: var(--bg-secondary);
  border-radius: 10px;
  display: flex;
  flex-direction: column;
  flex-shrink: 0;
  overflow: hidden;
}

.ft-sidebar-head {
  padding: 12px;
  border-bottom: 2px solid var(--border-color);
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.ft-sidebar-head h4 {
  margin: 0;
  font-size: 0.9rem;
  color: var(--text-primary);
  display: flex;
  align-items: center;
  gap: 6px;
}

.ft-sidebar-head .count {
  background: var(--primary);
  color: white;
  padding: 2px 8px;
  border-radius: 10px;
  font-size: 0.7rem;
}

.ft-sidebar-search {
  padding: 8px;
  border-bottom: 1px solid var(--border-color);
}

.ft-sidebar-search input {
  width: 100%;
  padding: 8px 10px;
  background: var(--bg-card);
  border: 2px solid var(--border-color);
  border-radius: 6px;
  color: var(--text-primary);
  font-size: 0.8rem;
  font-family: inherit;
}

.ft-sidebar-search input:focus { outline: none; border-color: var(--primary); }

.ft-sidebar-list {
  flex: 1;
  overflow-y: auto;
  padding: 6px;
  max-height: 400px;
}

.ft-list-item {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 8px;
  background: var(--bg-card);
  border-radius: 6px;
  margin-bottom: 4px;
  cursor: pointer;
  border: 2px solid transparent;
  transition: all 0.15s;
}

.ft-list-item:hover { border-color: var(--primary); }
.ft-list-item.orphan { border: 2px dashed var(--text-muted); }
.ft-list-item.male { border-left: 3px solid var(--male-color); }
.ft-list-item.female { border-left: 3px solid var(--female-color); }

.ft-list-item .av {
  width: 30px;
  height: 30px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.1rem;
  flex-shrink: 0;
}

.ft-list-item .info { flex: 1; min-width: 0; }
.ft-list-item .nm { font-size: 0.8rem; font-weight: 600; color: var(--text-primary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.ft-list-item .sub { font-size: 0.65rem; color: var(--text-muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

.ft-list-item .menu-btn {
  padding: 3px 6px;
  background: none;
  border: none;
  color: var(--text-muted);
  cursor: pointer;
  font-size: 0.9rem;
  border-radius: 4px;
}

.ft-list-item .menu-btn:hover { background: var(--bg-secondary); color: var(--text-primary); }

.ft-section-label {
  font-size: 0.7rem;
  color: var(--text-muted);
  padding: 8px 6px 4px;
  border-top: 1px solid var(--border-color);
  margin-top: 6px;
}

.ft-add-btn {
  margin: 8px;
  padding: 10px;
  background: var(--primary);
  border: none;
  border-radius: 6px;
  color: white;
  font-weight: 600;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
  font-family: inherit;
  font-size: 0.85rem;
}

.ft-add-btn:hover { background: var(--primary-dark); }

/* ========== MAIN AREA ========== */
.ft-main {
  flex: 1;
  display: flex;
  flex-direction: column;
  min-width: 0;
}

/* Toolbar */
.ft-toolbar {
  display: flex;
  flex-wrap: wrap;
  gap: 5px;
  padding: 8px 10px;
  background: var(--bg-secondary);
  border-radius: 8px;
  margin-bottom: 8px;
}

.ft-toolbar-group {
  display: flex;
  gap: 4px;
  padding-left: 10px;
  border-left: 2px solid var(--border-color);
}

.ft-toolbar-group:first-child { border-left: none; padding-left: 0; }

.ft-btn {
  display: flex;
  align-items: center;
  gap: 4px;
  padding: 6px 10px;
  background: var(--bg-card);
  border: 2px solid var(--border-color);
  border-radius: 5px;
  color: var(--text-primary);
  font-size: 0.75rem;
  font-weight: 600;
  cursor: pointer;
  font-family: inherit;
  transition: all 0.15s;
}

.ft-btn:hover { border-color: var(--primary); }
.ft-btn .ic { font-size: 0.95rem; }

/* Canvas */
.ft-canvas {
  flex: 1;
  position: relative;
  background: var(--bg-secondary);
  border-radius: 8px;
  overflow: hidden;
  min-height: 380px;
  border: 2px solid var(--border-color);
}

.ft-svg { width: 100%; height: 100%; min-height: 380px; cursor: grab; }
.ft-svg:active { cursor: grabbing; }
.ft-svg text { font-family: inherit; pointer-events: none; }

.ft-empty {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  text-align: center;
  color: var(--text-muted);
  pointer-events: none;
}

.ft-empty .ic { font-size: 3rem; margin-bottom: 8px; opacity: 0.5; }
.ft-empty h3 { margin: 0; color: var(--text-secondary); font-size: 1rem; }

/* Zoom */
.ft-zoom {
  position: absolute;
  bottom: 10px;
  right: 10px;
  display: flex;
  flex-direction: column;
  gap: 3px;
  background: var(--bg-card);
  padding: 4px;
  border-radius: 6px;
  border: 2px solid var(--border-color);
}

.ft-zoom-btn {
  width: 28px;
  height: 28px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: var(--bg-secondary);
  border: none;
  border-radius: 4px;
  color: var(--text-primary);
  font-size: 0.9rem;
  cursor: pointer;
}

.ft-zoom-btn:hover { background: var(--primary); }
.ft-zoom-lvl { text-align: center; font-size: 0.65rem; color: var(--text-muted); }

/* Stats */
.ft-stats {
  display: flex;
  gap: 12px;
  padding: 7px 12px;
  background: var(--bg-card);
  border-radius: 6px;
  margin-top: 8px;
  flex-wrap: wrap;
}

.ft-stat { display: flex; align-items: center; gap: 4px; font-size: 0.75rem; }
.ft-stat .lbl { color: var(--text-muted); }
.ft-stat .val { font-weight: 700; color: var(--text-primary); }

/* ========== MODALS ========== */
.ft-modal-bg {
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.75);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
  opacity: 0;
  visibility: hidden;
  transition: all 0.25s;
}

.ft-modal-bg.show { opacity: 1; visibility: visible; }

.ft-modal {
  background: var(--bg-secondary);
  border-radius: 12px;
  width: 92%;
  max-width: 450px;
  max-height: 85vh;
  overflow-y: auto;
  transform: scale(0.9);
  transition: transform 0.25s;
}

.ft-modal-bg.show .ft-modal { transform: scale(1); }

.ft-modal-head {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 12px 16px;
  border-bottom: 2px solid var(--border-color);
  position: sticky;
  top: 0;
  background: var(--bg-secondary);
  z-index: 10;
}

.ft-modal-head h2 { font-size: 0.95rem; color: var(--text-primary); margin: 0; }

.ft-modal-close {
  background: none;
  border: none;
  font-size: 1.3rem;
  color: var(--text-muted);
  cursor: pointer;
  padding: 2px 6px;
  border-radius: 4px;
}

.ft-modal-close:hover { background: var(--bg-card); color: var(--text-primary); }

.ft-modal-body { padding: 14px 16px; }

.ft-form-group { margin-bottom: 12px; }
.ft-form-group label { display: block; font-size: 0.75rem; font-weight: 600; color: var(--text-secondary); margin-bottom: 4px; }

.ft-form-group input,
.ft-form-group select,
.ft-form-group textarea {
  width: 100%;
  padding: 8px 10px;
  background: var(--bg-card);
  border: 2px solid var(--border-color);
  border-radius: 6px;
  color: var(--text-primary);
  font-size: 0.85rem;
  font-family: inherit;
}

.ft-form-group input:focus,
.ft-form-group select:focus { outline: none; border-color: var(--primary); }

.ft-form-row { display: flex; gap: 10px; }
.ft-form-row .ft-form-group { flex: 1; }

/* Gender */
.ft-gender { display: flex; gap: 8px; }

.ft-gender-opt {
  flex: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 5px;
  padding: 10px;
  background: var(--bg-card);
  border: 2px solid var(--border-color);
  border-radius: 6px;
  cursor: pointer;
}

.ft-gender-opt input { display: none; }
.ft-gender-opt.male:has(input:checked) { border-color: var(--male-color); background: rgba(59,130,246,0.15); }
.ft-gender-opt.female:has(input:checked) { border-color: var(--female-color); background: rgba(236,72,153,0.15); }
.ft-gender-opt span { font-weight: 600; font-size: 0.85rem; }

/* Photo */
.ft-photo-row { display: flex; align-items: center; gap: 12px; }

.ft-photo-preview {
  width: 50px;
  height: 50px;
  border-radius: 50%;
  background: var(--bg-card);
  border: 2px solid var(--border-color);
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
}

.ft-photo-preview img { width: 100%; height: 100%; object-fit: cover; }
.ft-photo-preview .ph { font-size: 1.4rem; color: var(--text-muted); }

.ft-photo-btn {
  padding: 5px 10px;
  background: var(--bg-card);
  border: 2px solid var(--border-color);
  border-radius: 5px;
  color: var(--text-primary);
  font-size: 0.7rem;
  cursor: pointer;
  font-family: inherit;
}

.ft-photo-btn:hover { border-color: var(--primary); }
.ft-photo-btn.rm { border-color: var(--danger); color: var(--danger); }

/* Person Select */
.ft-person-select {
  border: 2px solid var(--border-color);
  border-radius: 6px;
  overflow: hidden;
}

.ft-person-select-search {
  width: 100%;
  padding: 7px 10px;
  background: var(--bg-card);
  border: none;
  border-bottom: 1px solid var(--border-color);
  color: var(--text-primary);
  font-size: 0.8rem;
  font-family: inherit;
}

.ft-person-select-list { max-height: 140px; overflow-y: auto; }

.ft-person-opt {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 6px 8px;
  cursor: pointer;
  border: 2px solid transparent;
  margin: 3px;
  border-radius: 5px;
}

.ft-person-opt:hover { background: var(--bg-card); }
.ft-person-opt.selected { border-color: var(--primary); background: rgba(5,150,105,0.15); }
.ft-person-opt.none { color: var(--text-muted); border: 2px dashed var(--border-color); justify-content: center; }

.ft-person-opt .av { font-size: 1rem; }
.ft-person-opt .nm { font-size: 0.8rem; color: var(--text-primary); }

/* Status */
.ft-status-opts { display: flex; gap: 6px; flex-wrap: wrap; }

.ft-status-opt {
  flex: 1;
  min-width: 75px;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 3px;
  padding: 8px 5px;
  background: var(--bg-card);
  border: 2px solid var(--border-color);
  border-radius: 6px;
  cursor: pointer;
}

.ft-status-opt input { display: none; }
.ft-status-opt:has(input:checked) { border-color: var(--primary); background: rgba(5,150,105,0.15); }
.ft-status-opt .ic { font-size: 1.1rem; }
.ft-status-opt .tx { font-size: 0.65rem; color: var(--text-secondary); text-align: center; }

/* Modal Footer */
.ft-modal-foot {
  display: flex;
  gap: 6px;
  padding: 10px 16px;
  border-top: 2px solid var(--border-color);
  position: sticky;
  bottom: 0;
  background: var(--bg-secondary);
}

.ft-modal-foot button {
  flex: 1;
  padding: 9px;
  border-radius: 6px;
  font-size: 0.85rem;
  font-weight: 700;
  cursor: pointer;
  font-family: inherit;
}

.ft-btn-cancel { background: var(--bg-card); border: 2px solid var(--border-color); color: var(--text-primary); }
.ft-btn-save { background: var(--primary); border: none; color: white; }
.ft-btn-save:hover { background: var(--primary-dark); }
.ft-btn-del { background: var(--danger); border: none; color: white; flex: 0.4; }

/* Tabs */
.ft-tabs { display: flex; border-bottom: 2px solid var(--border-color); margin-bottom: 12px; }

.ft-tab {
  flex: 1;
  padding: 8px;
  background: none;
  border: none;
  color: var(--text-muted);
  font-weight: 600;
  cursor: pointer;
  font-family: inherit;
  font-size: 0.8rem;
  border-bottom: 2px solid transparent;
  margin-bottom: -2px;
}

.ft-tab.active { color: var(--primary); border-bottom-color: var(--primary); }

/* ========== RELATIONS MODAL ========== */
.ft-rel-section {
  background: var(--bg-card);
  border-radius: 8px;
  margin-bottom: 12px;
  overflow: hidden;
}

.ft-rel-section-head {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 10px 12px;
  background: rgba(0,0,0,0.2);
  font-weight: 600;
  font-size: 0.8rem;
  color: var(--text-primary);
}

.ft-rel-section-head .add-btn {
  padding: 3px 8px;
  background: var(--primary);
  border: none;
  border-radius: 4px;
  color: white;
  font-size: 0.7rem;
  cursor: pointer;
}

.ft-rel-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 10px 12px;
  border-bottom: 1px solid var(--border-color);
}

.ft-rel-item:last-child { border-bottom: none; }

.ft-rel-item .av { font-size: 1.2rem; }

.ft-rel-item .info { flex: 1; }
.ft-rel-item .nm { font-weight: 600; font-size: 0.85rem; color: var(--text-primary); }
.ft-rel-item .role { font-size: 0.7rem; color: var(--text-muted); }

.ft-rel-item .actions { display: flex; gap: 4px; }

.ft-rel-item .act-btn {
  padding: 4px 8px;
  background: var(--bg-secondary);
  border: 1px solid var(--border-color);
  border-radius: 4px;
  color: var(--text-primary);
  font-size: 0.7rem;
  cursor: pointer;
}

.ft-rel-item .act-btn:hover { border-color: var(--primary); }
.ft-rel-item .act-btn.danger { color: var(--danger); border-color: var(--danger); }
.ft-rel-item .act-btn.danger:hover { background: var(--danger); color: white; }

.ft-rel-empty {
  padding: 15px;
  text-align: center;
  color: var(--text-muted);
  font-size: 0.8rem;
}

/* Card Menu - Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙˆØ­Ø¯Ø© */
.ft-card-menu {
  position: fixed;
  background: var(--bg-card);
  border: 2px solid var(--border-color);
  border-radius: 8px;
  min-width: 160px;
  z-index: 2000;
  box-shadow: 0 8px 25px rgba(0,0,0,0.4);
  display: none;
}

.ft-card-menu.show { display: block; }

.ft-menu-item {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 8px;
  padding: 10px 14px;
  color: var(--text-primary);
  cursor: pointer;
  font-size: 0.8rem;
  position: relative;
}

.ft-menu-item:first-child { border-radius: 6px 6px 0 0; }
.ft-menu-item:last-child { border-radius: 0 0 6px 6px; }
.ft-menu-item:hover { background: var(--bg-secondary); }
.ft-menu-item.danger { color: var(--danger); }
.ft-menu-item.danger:hover { background: rgba(239, 68, 68, 0.1); }

.ft-menu-divider { height: 1px; background: var(--border-color); margin: 2px 0; }

/* Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙØ±Ø¹ÙŠØ© */
.ft-has-submenu { position: relative; }
.ft-submenu-arrow { font-size: 0.6rem; color: var(--text-muted); }

.ft-submenu {
  position: absolute;
  right: calc(100% - 8px);
  top: -8px;
  background: var(--bg-card);
  border: 2px solid var(--border-color);
  border-radius: 8px;
  min-width: 140px;
  box-shadow: 0 8px 25px rgba(0,0,0,0.4);
  display: none;
  z-index: 2001;
}

.ft-has-submenu:hover .ft-submenu,
.ft-submenu.show { display: block; }

.ft-submenu .ft-menu-item:first-child { border-radius: 6px 6px 0 0; }
.ft-submenu .ft-menu-item:last-child { border-radius: 0 0 6px 6px; }

/* Toast */
.ft-toast {
  position: fixed;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%) translateY(100px);
  background: var(--bg-card);
  border: 2px solid var(--primary);
  padding: 12px 20px;
  border-radius: 8px;
  color: var(--text-primary);
  font-weight: 600;
  z-index: 3000;
  opacity: 0;
  transition: all 0.3s;
}

.ft-toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }

/* Dropdown */
.ft-dropdown { position: relative; }

.ft-dropdown-menu {
  position: absolute;
  top: 100%;
  right: 0;
  margin-top: 4px;
  background: var(--bg-card);
  border: 2px solid var(--border-color);
  border-radius: 6px;
  min-width: 110px;
  z-index: 100;
  opacity: 0;
  visibility: hidden;
}

.ft-dropdown.open .ft-dropdown-menu { opacity: 1; visibility: visible; }

.ft-dropdown-item { display: flex; align-items: center; gap: 5px; padding: 7px 10px; color: var(--text-primary); font-size: 0.75rem; cursor: pointer; }
.ft-dropdown-item:hover { background: var(--bg-secondary); }

.ft-dropdown-divider { height: 1px; background: var(--border-color); }

.hidden { display: none; }

/* Dragging card */
.ft-card-dragging { opacity: 0.6; }

@media (max-width: 700px) {
  .ft-container { flex-direction: column; }
  .ft-sidebar { width: 100%; max-height: 180px; }
  .ft-btn span:not(.ic) { display: none; }
}
</style>

<div class="tool-card">
  <div class="tool-header">
    <div class="tool-icon">ğŸŒ³</div>
    <div>
      <h1 class="tool-title">Ø´Ø¬Ø±Ø© Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©</h1>
      <p class="tool-description">Ø£Ù†Ø´Ø¦ Ø´Ø¬Ø±Ø© Ø¹Ø§Ø¦Ù„ØªÙƒ Ø¨Ø³Ù‡ÙˆÙ„Ø© ÙˆØµØ¯Ù‘Ø±Ù‡Ø§ ÙƒØµÙˆØ±Ø©</p>
    </div>
  </div>

  <div class="ft-container">
    <!-- Sidebar: Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø´Ø®Ø§Øµ -->
    <aside class="ft-sidebar">
      <div class="ft-sidebar-head">
        <h4>ğŸ“‹ <span id="txt-persons">Ø§Ù„Ø£Ø´Ø®Ø§Øµ</span> <span class="count" id="persons-count">0</span></h4>
      </div>
      <div class="ft-sidebar-search">
        <input type="text" id="search-input" placeholder="Ø§Ø¨Ø­Ø«..." oninput="filterList()">
      </div>
      <div class="ft-sidebar-list" id="persons-list"></div>
      <button class="ft-add-btn" onclick="openPersonModal()">â• <span id="txt-add">Ø¥Ø¶Ø§ÙØ© Ø´Ø®Øµ</span></button>
    </aside>

    <!-- Main Area -->
    <main class="ft-main">
      <div class="ft-toolbar">
        <div class="ft-toolbar-group">
          <button class="ft-btn" onclick="saveLocal()"><span class="ic">ğŸ’¾</span><span>Ø­ÙØ¸</span></button>
          <button class="ft-btn" onclick="loadLocal()"><span class="ic">ğŸ“‚</span><span>ØªØ­Ù…ÙŠÙ„</span></button>
        </div>
        <div class="ft-toolbar-group">
          <div class="ft-dropdown" id="export-dd">
            <button class="ft-btn" onclick="toggleDD('export-dd')"><span class="ic">ğŸ“¤</span><span>ØªØµØ¯ÙŠØ±</span></button>
            <div class="ft-dropdown-menu">
              <div class="ft-dropdown-item" onclick="exportPNG()">ğŸ–¼ï¸ PNG</div>
              <div class="ft-dropdown-item" onclick="exportSVG()">ğŸ“ SVG</div>
              <div class="ft-dropdown-divider"></div>
              <div class="ft-dropdown-item" onclick="exportJSON()">ğŸ“„ JSON</div>
            </div>
          </div>
          <button class="ft-btn" onclick="document.getElementById('import-file').click()"><span class="ic">ğŸ“¥</span><span>Ø§Ø³ØªÙŠØ±Ø§Ø¯</span></button>
        </div>
        <div class="ft-toolbar-group">
          <button class="ft-btn" onclick="resetLayout()"><span class="ic">ğŸ“</span><span>ØªØ±ØªÙŠØ¨</span></button>
          <button class="ft-btn" onclick="clearAll()"><span class="ic">ğŸ—‘ï¸</span><span>Ù…Ø³Ø­</span></button>
        </div>
      </div>

      <div class="ft-canvas" id="canvas">
        <svg class="ft-svg" id="svg">
          <defs>
            <filter id="shadow" x="-20%" y="-20%" width="140%" height="140%">
              <feDropShadow dx="0" dy="2" stdDeviation="3" flood-opacity="0.25"/>
            </filter>
          </defs>
          <g id="tree-g">
            <g id="lines-g"></g>
            <g id="cards-g"></g>
          </g>
        </svg>
        <div class="ft-empty" id="empty-msg">
          <div class="ic">ğŸŒ³</div>
          <h3>Ø§Ø¨Ø¯Ø£ Ø¨Ø¥Ø¶Ø§ÙØ© Ø´Ø®Øµ</h3>
        </div>
        <div class="ft-zoom">
          <button class="ft-zoom-btn" onclick="zoomIn()">â•</button>
          <div class="ft-zoom-lvl" id="zoom-lvl">100%</div>
          <button class="ft-zoom-btn" onclick="zoomOut()">â–</button>
          <button class="ft-zoom-btn" onclick="fitView()">âŠ¡</button>
        </div>
      </div>

      <div class="ft-stats">
        <div class="ft-stat"><span class="lbl">ğŸ‘¥</span><span class="val" id="stat-total">0</span></div>
        <div class="ft-stat"><span class="lbl">ğŸ‘¨</span><span class="val" id="stat-males">0</span></div>
        <div class="ft-stat"><span class="lbl">ğŸ‘©</span><span class="val" id="stat-females">0</span></div>
        <div class="ft-stat"><span class="lbl">ğŸ’‘</span><span class="val" id="stat-marriages">0</span></div>
        <div class="ft-stat"><span class="lbl">ğŸ“Š</span><span class="val" id="stat-gens">0</span></div>
      </div>
    </main>
  </div>
</div>

<!-- Person Modal -->
<div class="ft-modal-bg" id="person-modal">
  <div class="ft-modal">
    <div class="ft-modal-head">
      <h2 id="pm-title">ğŸ‘¤ Ø¥Ø¶Ø§ÙØ© Ø´Ø®Øµ</h2>
      <button class="ft-modal-close" onclick="closeModal('person-modal')">&times;</button>
    </div>
    <div class="ft-modal-body">
      <div class="ft-form-group">
        <label>Ø§Ù„Ø§Ø³Ù… *</label>
        <input type="text" id="p-name">
      </div>
      <div class="ft-form-group">
        <label>Ø§Ù„Ø¬Ù†Ø³</label>
        <div class="ft-gender">
          <label class="ft-gender-opt male"><input type="radio" name="p-gender" value="male" checked><span>ğŸ‘¨ Ø°ÙƒØ±</span></label>
          <label class="ft-gender-opt female"><input type="radio" name="p-gender" value="female"><span>ğŸ‘© Ø£Ù†Ø«Ù‰</span></label>
        </div>
      </div>
      <div class="ft-form-group">
        <label>Ø§Ù„ØµÙˆØ±Ø©</label>
        <div class="ft-photo-row">
          <div class="ft-photo-preview" id="photo-prev"><span class="ph">ğŸ‘¤</span></div>
          <div>
            <button type="button" class="ft-photo-btn" onclick="document.getElementById('photo-input').click()">ğŸ“· Ø±ÙØ¹</button>
            <button type="button" class="ft-photo-btn rm" onclick="clearPhoto()" id="btn-rm-photo" style="display:none">ğŸ—‘ï¸</button>
          </div>
        </div>
        <input type="file" id="photo-input" class="hidden" accept="image/*" onchange="onPhotoSelect(event)">
      </div>
      <div class="ft-form-row">
        <div class="ft-form-group"><label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯</label><input type="date" id="p-birth"></div>
        <div class="ft-form-group"><label>ØªØ§Ø±ÙŠØ® Ø§Ù„ÙˆÙØ§Ø©</label><input type="date" id="p-death"></div>
      </div>
      <div class="ft-form-group">
        <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
        <textarea id="p-notes" rows="2"></textarea>
      </div>
    </div>
    <div class="ft-modal-foot">
      <button class="ft-btn-del" id="pm-del" onclick="deletePerson()" style="display:none">ğŸ—‘ï¸</button>
      <button class="ft-btn-cancel" onclick="closeModal('person-modal')">Ø¥Ù„ØºØ§Ø¡</button>
      <button class="ft-btn-save" onclick="savePerson()">Ø­ÙØ¸</button>
    </div>
  </div>
</div>

<!-- Spouse Modal -->
<div class="ft-modal-bg" id="spouse-modal">
  <div class="ft-modal">
    <div class="ft-modal-head">
      <h2 id="sm-title">ğŸ’‘ Ø¥Ø¶Ø§ÙØ© Ø²ÙˆØ§Ø¬</h2>
      <button class="ft-modal-close" onclick="closeModal('spouse-modal')">&times;</button>
    </div>
    <div class="ft-modal-body">
      <div class="ft-form-group">
        <label>Ø§Ù„Ø²ÙˆØ¬</label>
        <div class="ft-person-select" id="husband-select"></div>
      </div>
      <div class="ft-form-group">
        <label>Ø§Ù„Ø²ÙˆØ¬Ø©</label>
        <div class="ft-person-select" id="wife-select"></div>
      </div>
      <div class="ft-form-group">
        <label>Ø§Ù„Ø­Ø§Ù„Ø©</label>
        <div class="ft-status-opts">
          <label class="ft-status-opt"><input type="radio" name="sp-status" value="married" checked><span class="ic">ğŸ’‘</span><span class="tx">Ù…ØªØ²ÙˆØ¬Ø§Ù†</span></label>
          <label class="ft-status-opt"><input type="radio" name="sp-status" value="divorced"><span class="ic">ğŸ’”</span><span class="tx">Ù…Ø·Ù„Ù‚Ø§Ù†</span></label>
          <label class="ft-status-opt"><input type="radio" name="sp-status" value="widowed"><span class="ic">âœï¸</span><span class="tx">Ø£Ø±Ù…Ù„/Ø©</span></label>
        </div>
      </div>
      <div class="ft-form-row">
        <div class="ft-form-group"><label>Ø³Ù†Ø© Ø§Ù„Ø²ÙˆØ§Ø¬</label><input type="number" id="sp-start" min="1900" max="2100"></div>
        <div class="ft-form-group"><label>Ø³Ù†Ø© Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡</label><input type="number" id="sp-end" min="1900" max="2100"></div>
      </div>
    </div>
    <div class="ft-modal-foot">
      <button class="ft-btn-del" id="sm-del" onclick="deleteSpouseRel()" style="display:none">ğŸ—‘ï¸</button>
      <button class="ft-btn-cancel" onclick="closeModal('spouse-modal')">Ø¥Ù„ØºØ§Ø¡</button>
      <button class="ft-btn-save" onclick="saveSpouseRel()">Ø­ÙØ¸</button>
    </div>
  </div>
</div>

<!-- Child Modal -->
<div class="ft-modal-bg" id="child-modal">
  <div class="ft-modal">
    <div class="ft-modal-head">
      <h2>ğŸ‘¶ Ø¥Ø¶Ø§ÙØ© Ø§Ø¨Ù†/Ø§Ø¨Ù†Ø©</h2>
      <button class="ft-modal-close" onclick="closeModal('child-modal')">&times;</button>
    </div>
    <div class="ft-modal-body">
      <div class="ft-tabs">
        <button class="ft-tab active" data-tab="new" onclick="switchChildTab('new')">Ø´Ø®Øµ Ø¬Ø¯ÙŠØ¯</button>
        <button class="ft-tab" data-tab="existing" onclick="switchChildTab('existing')">Ø´Ø®Øµ Ù…ÙˆØ¬ÙˆØ¯</button>
      </div>
      <div id="child-form-new">
        <div class="ft-form-group"><label>Ø§Ù„Ø§Ø³Ù… *</label><input type="text" id="c-name"></div>
        <div class="ft-form-group">
          <label>Ø§Ù„Ø¬Ù†Ø³</label>
          <div class="ft-gender">
            <label class="ft-gender-opt male"><input type="radio" name="c-gender" value="male" checked><span>ğŸ‘¨ Ø°ÙƒØ±</span></label>
            <label class="ft-gender-opt female"><input type="radio" name="c-gender" value="female"><span>ğŸ‘© Ø£Ù†Ø«Ù‰</span></label>
          </div>
        </div>
      </div>
      <div id="child-form-existing" style="display:none">
        <div class="ft-form-group"><label>Ø§Ø®ØªØ± Ø§Ù„Ø´Ø®Øµ</label><div class="ft-person-select" id="child-select"></div></div>
      </div>
      <div class="ft-form-group" style="margin-top:12px;padding-top:12px;border-top:1px solid var(--border-color)">
        <label>Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù„Ø§Ù‚Ø©</label>
        <div class="ft-status-opts" id="child-type-opts"></div>
      </div>
    </div>
    <div class="ft-modal-foot">
      <button class="ft-btn-cancel" onclick="closeModal('child-modal')">Ø¥Ù„ØºØ§Ø¡</button>
      <button class="ft-btn-save" onclick="saveChild()">Ø­ÙØ¸</button>
    </div>
  </div>
</div>

<!-- â­ RELATIONS MODAL - Ù†Ø§ÙØ°Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù„Ø§Ù‚Ø§Øª -->
<div class="ft-modal-bg" id="relations-modal">
  <div class="ft-modal" style="max-width:480px">
    <div class="ft-modal-head">
      <h2 id="rm-title">ğŸ”— Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù„Ø§Ù‚Ø§Øª</h2>
      <button class="ft-modal-close" onclick="closeModal('relations-modal')">&times;</button>
    </div>
    <div class="ft-modal-body" id="relations-content">
      <!-- ÙŠÙÙ…Ù„Ø£ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ -->
    </div>
    <div class="ft-modal-foot">
      <button class="ft-btn-cancel" onclick="closeModal('relations-modal')">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
  </div>
</div>

<!-- Edit Child Relation Modal -->
<div class="ft-modal-bg" id="edit-child-rel-modal">
  <div class="ft-modal">
    <div class="ft-modal-head">
      <h2>âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø¹Ù„Ø§Ù‚Ø© Ø§Ù„Ø£Ø¨ÙˆØ©</h2>
      <button class="ft-modal-close" onclick="closeModal('edit-child-rel-modal')">&times;</button>
    </div>
    <div class="ft-modal-body">
      <div class="ft-form-group">
        <label>Ø§Ù„Ø£Ø¨</label>
        <div class="ft-person-select" id="edit-father-select"></div>
      </div>
      <div class="ft-form-group">
        <label>Ø§Ù„Ø£Ù…</label>
        <div class="ft-person-select" id="edit-mother-select"></div>
      </div>
    </div>
    <div class="ft-modal-foot">
      <button class="ft-btn-del" onclick="deleteChildRel()">ğŸ—‘ï¸ Ø­Ø°Ù</button>
      <button class="ft-btn-cancel" onclick="closeModal('edit-child-rel-modal')">Ø¥Ù„ØºØ§Ø¡</button>
      <button class="ft-btn-save" onclick="saveEditChildRel()">Ø­ÙØ¸</button>
    </div>
  </div>
</div>

<!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù…ÙˆØ­Ø¯Ø© -->
<div class="ft-card-menu" id="card-menu">
  <div class="ft-menu-item" onclick="cardMenuAction('edit')">âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</div>
  <div class="ft-menu-item" onclick="cardMenuAction('relations')">ğŸ”— Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù„Ø§Ù‚Ø§Øª</div>
  <div class="ft-menu-divider"></div>
  <div class="ft-menu-item ft-has-submenu" onmouseenter="showSubmenu(this)" onmouseleave="hideSubmenu(this)">
    â• Ø¥Ø¶Ø§ÙØ©
    <span class="ft-submenu-arrow">â—€</span>
    <div class="ft-submenu">
      <div class="ft-menu-item" onclick="cardMenuAction('parent')">ğŸ‘¨â€ğŸ‘© Ø£Ø¨/Ø£Ù…</div>
      <div class="ft-menu-item" onclick="cardMenuAction('spouse')">ğŸ’‘ Ø²ÙˆØ¬/Ø²ÙˆØ¬Ø©</div>
      <div class="ft-menu-item" onclick="cardMenuAction('child')">ğŸ‘¶ Ø§Ø¨Ù†/Ø§Ø¨Ù†Ø©</div>
      <div class="ft-menu-item" onclick="cardMenuAction('sibling')">ğŸ‘« Ø£Ø®/Ø£Ø®Øª</div>
    </div>
  </div>
  <div class="ft-menu-divider"></div>
  <div class="ft-menu-item" onclick="cardMenuAction('locate')">ğŸ“ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹</div>
  <div class="ft-menu-divider"></div>
  <div class="ft-menu-item danger" onclick="cardMenuAction('delete')">ğŸ—‘ï¸ Ø­Ø°Ù</div>
</div>

<div class="ft-toast" id="toast"></div>
<input type="file" id="import-file" class="hidden" accept=".json" onchange="importJSON(event)">

<script>
const isAr = document.documentElement.lang === 'ar';
const t = (ar, en) => isAr ? ar : en;

let db = { persons: {}, relations: {} };

let state = {
  editingPersonId: null,
  editingRelId: null,
  editingChildRelId: null,
  contextPersonId: null,
  menuPersonId: null,
  childContext: null,
  currentPhoto: null,
  childTab: 'new',
  siblingForId: null,  // Ù„Ø¥Ø¶Ø§ÙØ© Ø´Ù‚ÙŠÙ‚ Ø¨Ø¯ÙˆÙ† Ø£Ø¨
  zoom: 1,
  panX: 50,
  panY: 50,
  dragCardId: null,
  dragStartX: 0,
  dragStartY: 0,
  dragOrigX: 0,
  dragOrigY: 0,
  dragGroup: null
};

const CARD_W = 115, CARD_H = 80;
const GAP_X = 35, GAP_Y = 100;  // Ø²ÙŠØ§Ø¯Ø© GAP_Y Ù„Ø¥ÙØ³Ø§Ø­ Ù…Ø¬Ø§Ù„ Ù„Ø¯Ø§Ø¦Ø±Ø© Ø§Ù„Ø£Ù…
const SPOUSE_GAP = 25;
const MOTHER_CIRCLE_R = 18;  // Ù†ØµÙ Ù‚Ø·Ø± Ø¯Ø§Ø¦Ø±Ø© Ø§Ù„Ø£Ù…

// ==================== INIT ====================
function init() {
  setupCanvas();
  render();
  
  document.addEventListener('click', e => {
    // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬Ù‡Ø§
    if (!e.target.closest('.ft-card-menu') && !e.target.closest('.menu-btn')) {
      hideCardMenu();
    }
    document.querySelectorAll('.ft-dropdown.open').forEach(d => d.classList.remove('open'));
  });
  
  document.addEventListener('keydown', e => { if (e.key === 'Escape') { closeAllModals(); hideCardMenu(); } });
}

// ==================== HELPERS ====================
const genId = () => Date.now().toString(36) + Math.random().toString(36).substr(2, 5);

// === Ø¹Ù„Ø§Ù‚Ø§Øª Ø§Ù„Ø²ÙˆØ§Ø¬ (Ù„Ù„Ø¹Ø±Ø¶ ÙÙ‚Ø·) ===
function getSpouseRels(pid) {
  return Object.values(db.relations).filter(r => r.type === 'spouse' && (r.person1Id === pid || r.person2Id === pid));
}

function getSpouse(pid, rid) {
  const r = db.relations[rid];
  if (!r || r.type !== 'spouse') return null;
  return db.persons[r.person1Id === pid ? r.person2Id : r.person1Id];
}

// === Ø¹Ù„Ø§Ù‚Ø§Øª Ø§Ù„Ø£Ø®ÙˆØ© ===
function getSiblingRels(pid) {
  return Object.values(db.relations).filter(r => r.type === 'sibling' && (r.person1Id === pid || r.person2Id === pid));
}

// === Ø§Ù„Ø£Ø¨Ù†Ø§Ø¡ (Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯ - fatherId Ù…Ø¨Ø§Ø´Ø±) ===
function getChildren(fatherId) {
  return Object.values(db.persons).filter(p => p.fatherId === fatherId);
}

function getChildrenByMother(fatherId, motherId) {
  return Object.values(db.persons).filter(p => p.fatherId === fatherId && p.motherId === motherId);
}

// === Ø§Ù„ÙˆØ§Ù„Ø¯ÙŠÙ† ===
function getFather(pid) {
  const p = db.persons[pid];
  return p?.fatherId ? db.persons[p.fatherId] : null;
}

function getMother(pid) {
  const p = db.persons[pid];
  return p?.motherId ? db.persons[p.motherId] : null;
}

function getParents(pid) {
  return { father: getFather(pid), mother: getMother(pid) };
}

// === Ø§Ù„Ø¥Ø®ÙˆØ© ===
function getSiblings(pid) {
  const p = db.persons[pid];
  if (!p) return [];
  
  // Ø¥Ø®ÙˆØ© Ù…Ù† Ù†ÙØ³ Ø§Ù„Ø£Ø¨
  if (p.fatherId) {
    return Object.values(db.persons).filter(s => s.id !== pid && s.fatherId === p.fatherId);
  }
  
  // Ø¥Ø®ÙˆØ© Ø¹Ø¨Ø± Ø¹Ù„Ø§Ù‚Ø© sibling (Ø¨Ø¯ÙˆÙ† Ø£Ø¨)
  const sibRels = getSiblingRels(pid);
  return sibRels.map(r => db.persons[r.person1Id === pid ? r.person2Id : r.person1Id]).filter(Boolean);
}

// === Ø§Ù„Ù†Ø³Ø¨ ===
function getLineage(pid) {
  const p = db.persons[pid]; if (!p) return '';
  let r = p.name;
  const father = getFather(pid);
  if (father) r += ' ' + t('Ø¨Ù†','s/o') + ' ' + father.name;
  return r;
}

function hasRelation(p) {
  return p.fatherId || getChildren(p.id).length > 0 || getSpouseRels(p.id).length > 0 || getSiblingRels(p.id).length > 0;
}

// === Ø¬Ù…Ø¹ Ø§Ù„Ø°Ø±ÙŠØ© Ù„Ù„Ø³Ø­Ø¨ ===
function getDescendants(pid, visited = new Set()) {
  if (visited.has(pid)) return [];
  visited.add(pid);
  
  const result = [];
  const children = getChildren(pid);
  
  children.forEach(child => {
    if (!visited.has(child.id)) {
      result.push(child);
      result.push(...getDescendants(child.id, visited));
    }
  });
  
  return result;
}

function getDragGroup(pid) {
  const mainPerson = db.persons[pid];
  if (!mainPerson) return { descendants: [] };
  
  const descendants = [];
  const visited = new Set([pid]);
  
  // Ø¬Ù…Ø¹ ÙƒÙ„ Ø§Ù„Ø°Ø±ÙŠØ©
  getDescendants(pid, visited).forEach(d => {
    if (d._x !== undefined) {
      descendants.push({ id: d.id, origX: d._x, origY: d._y });
    }
  });
  
  return { descendants };
}

// ==================== RENDER LIST ====================
function render() {
  renderList();
  layoutTree();
  renderTree();
  updateStats();
}

function renderList() {
  const list = document.getElementById('persons-list');
  const search = document.getElementById('search-input').value.toLowerCase();
  const persons = Object.values(db.persons);
  
  const linked = persons.filter(hasRelation);
  const orphans = persons.filter(p => !hasRelation(p));
  const filter = p => p.name.toLowerCase().includes(search);
  
  let html = '';
  linked.filter(filter).forEach(p => html += listItem(p, false));
  
  const fo = orphans.filter(filter);
  if (fo.length) {
    html += `<div class="ft-section-label">âš ï¸ ${t('ØºÙŠØ± Ù…Ø±ØªØ¨Ø·ÙŠÙ†','Unlinked')} (${fo.length})</div>`;
    fo.forEach(p => html += listItem(p, true));
  }
  
  list.innerHTML = html || `<div style="text-align:center;padding:20px;color:var(--text-muted)">${t('Ù„Ø§ ÙŠÙˆØ¬Ø¯','Empty')}</div>`;
  document.getElementById('persons-count').textContent = persons.length;
}

function listItem(p, orphan) {
  const g = p.gender === 'male' ? 'male' : 'female';
  const icon = p.photo ? `<img src="${p.photo}" style="width:100%;height:100%;border-radius:50%;object-fit:cover">` : (p.gender === 'female' ? 'ğŸ‘©' : 'ğŸ‘¨');
  return `<div class="ft-list-item ${g} ${orphan ? 'orphan' : ''}" onclick="locatePerson('${p.id}')" oncontextmenu="showCtx(event,'${p.id}')">
    <div class="av">${icon}</div>
    <div class="info"><div class="nm">${p.name}</div><div class="sub">${getLineage(p.id)}</div></div>
    <button class="menu-btn" onclick="event.stopPropagation();showCtx(event,'${p.id}')">â‹®</button>
  </div>`;
}

function filterList() { renderList(); }

// ==================== PERSON MODAL ====================
function openPersonModal(editId = null) {
  state.editingPersonId = editId;
  state.currentPhoto = null;
  
  const isEdit = !!editId;
  const isSibling = !isEdit && state.siblingForId;
  
  let title = isEdit ? 'âœï¸ ØªØ¹Ø¯ÙŠÙ„' : 'ğŸ‘¤ Ø¥Ø¶Ø§ÙØ© Ø´Ø®Øµ';
  if (isSibling) {
    const sib = db.persons[state.siblingForId];
    title = `ğŸ‘« Ø¥Ø¶Ø§ÙØ© Ø´Ù‚ÙŠÙ‚ Ù„Ù€ ${sib?.name || ''}`;
  }
  document.getElementById('pm-title').innerHTML = title;
  document.getElementById('pm-del').style.display = isEdit ? 'block' : 'none';
  
  if (isEdit) {
    const p = db.persons[editId];
    document.getElementById('p-name').value = p.name;
    document.querySelector(`input[name="p-gender"][value="${p.gender}"]`).checked = true;
    document.getElementById('p-birth').value = p.birthDate || '';
    document.getElementById('p-death').value = p.deathDate || '';
    document.getElementById('p-notes').value = p.notes || '';
    state.currentPhoto = p.photo;
  } else {
    document.getElementById('p-name').value = '';
    document.querySelector('input[name="p-gender"][value="male"]').checked = true;
    document.getElementById('p-birth').value = '';
    document.getElementById('p-death').value = '';
    document.getElementById('p-notes').value = '';
  }
  updatePhotoPreview();
  openModal('person-modal');
}

function savePerson() {
  const name = document.getElementById('p-name').value.trim();
  if (!name) return toast(t('Ø£Ø¯Ø®Ù„ Ø§Ù„Ø§Ø³Ù…','Enter name'));
  
  const data = {
    name,
    gender: document.querySelector('input[name="p-gender"]:checked').value,
    photo: state.currentPhoto,
    birthDate: document.getElementById('p-birth').value || null,
    deathDate: document.getElementById('p-death').value || null,
    notes: document.getElementById('p-notes').value.trim()
  };
  
  if (state.editingPersonId) {
    Object.assign(db.persons[state.editingPersonId], data);
  } else {
    const id = genId();
    db.persons[id] = { id, ...data, fatherId: null, motherId: null };
    
    // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø´Ù‚ÙŠÙ‚ Ø¨Ø¯ÙˆÙ† Ø£Ø¨ - Ù†Ø¶ÙŠÙ Ø¹Ù„Ø§Ù‚Ø© sibling
    if (state.siblingForId) {
      const relId = genId();
      db.relations[relId] = {
        id: relId,
        type: 'sibling',
        person1Id: state.siblingForId,
        person2Id: id
      };
      state.siblingForId = null;
    }
  }
  
  closeModal('person-modal');
  render();
  toast(t('ØªÙ…','Done'));
}

function deletePerson() {
  if (!state.editingPersonId || !confirm(t('Ø­Ø°ÙØŸ','Delete?'))) return;
  const id = state.editingPersonId;
  
  // Ø­Ø°Ù Ø¹Ù„Ø§Ù‚Ø§Øª Ø§Ù„Ø²ÙˆØ§Ø¬ ÙˆØ§Ù„Ø£Ø®ÙˆØ©
  Object.keys(db.relations).forEach(rid => {
    const r = db.relations[rid];
    if (r.type === 'spouse' && (r.person1Id === id || r.person2Id === id)) delete db.relations[rid];
    if (r.type === 'sibling' && (r.person1Id === id || r.person2Id === id)) delete db.relations[rid];
  });
  
  // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø£Ø¨ Ù…Ù† Ø§Ù„Ø£Ø¨Ù†Ø§Ø¡
  Object.values(db.persons).forEach(p => {
    if (p.fatherId === id) p.fatherId = null;
    if (p.motherId === id) p.motherId = null;
  });
  
  delete db.persons[id];
  closeModal('person-modal');
  render();
  toast(t('ØªÙ…','Done'));
}

// Photo
function onPhotoSelect(e) {
  const f = e.target.files[0]; if (!f) return;
  const r = new FileReader();
  r.onload = ev => { state.currentPhoto = ev.target.result; updatePhotoPreview(); };
  r.readAsDataURL(f);
}

function clearPhoto() { state.currentPhoto = null; document.getElementById('photo-input').value = ''; updatePhotoPreview(); }

function updatePhotoPreview() {
  const prev = document.getElementById('photo-prev');
  const btn = document.getElementById('btn-rm-photo');
  if (state.currentPhoto) { prev.innerHTML = `<img src="${state.currentPhoto}">`; btn.style.display = 'inline'; }
  else { prev.innerHTML = '<span class="ph">ğŸ‘¤</span>'; btn.style.display = 'none'; }
}

// ==================== SPOUSE MODAL ====================
function openSpouseModal(editRelId = null, preselect = null) {
  state.editingRelId = editRelId;
  const males = Object.values(db.persons).filter(p => p.gender === 'male');
  const females = Object.values(db.persons).filter(p => p.gender === 'female');
  let selH = preselect?.husbandId, selW = preselect?.wifeId;
  
  if (editRelId) {
    const r = db.relations[editRelId];
    document.getElementById('sm-title').innerHTML = 'ğŸ’‘ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø²ÙˆØ§Ø¬';
    document.getElementById('sm-del').style.display = 'block';
    selH = r.person1Id; selW = r.person2Id;
    document.querySelector(`input[name="sp-status"][value="${r.status}"]`).checked = true;
    document.getElementById('sp-start').value = r.startYear || '';
    document.getElementById('sp-end').value = r.endYear || '';
  } else {
    document.getElementById('sm-title').innerHTML = 'ğŸ’‘ Ø¥Ø¶Ø§ÙØ© Ø²ÙˆØ§Ø¬';
    document.getElementById('sm-del').style.display = 'none';
    document.querySelector('input[name="sp-status"][value="married"]').checked = true;
    document.getElementById('sp-start').value = '';
    document.getElementById('sp-end').value = '';
  }
  
  renderPersonSelect('husband-select', males, selH);
  renderPersonSelect('wife-select', females, selW);
  openModal('spouse-modal');
}

function saveSpouseRel() {
  const hId = getSelectedPerson('husband-select');
  const wId = getSelectedPerson('wife-select');
  if (!hId && !wId) return toast(t('Ø§Ø®ØªØ± Ø£Ø­Ø¯Ù‡Ù…Ø§','Select one'));
  
  const status = document.querySelector('input[name="sp-status"]:checked').value;
  
  const data = {
    type: 'spouse', person1Id: hId, person2Id: wId, status,
    startYear: parseInt(document.getElementById('sp-start').value) || null,
    endYear: parseInt(document.getElementById('sp-end').value) || null
  };
  
  if (state.editingRelId) Object.assign(db.relations[state.editingRelId], data);
  else { const id = genId(); db.relations[id] = { id, ...data }; }
  
  closeModal('spouse-modal');
  render();
  toast(t('ØªÙ…','Done'));
}

function deleteSpouseRel() {
  if (!state.editingRelId || !confirm(t('Ø­Ø°ÙØŸ','Delete?'))) return;
  delete db.relations[state.editingRelId];
  closeModal('spouse-modal');
  render();
  toast(t('ØªÙ…','Done'));
}

// ==================== CHILD MODAL ====================
function openChildModal(ctx) {
  state.childContext = ctx;
  state.childTab = 'new';
  document.querySelector('.ft-tab[data-tab="new"]').classList.add('active');
  document.querySelector('.ft-tab[data-tab="existing"]').classList.remove('active');
  document.getElementById('child-form-new').style.display = 'block';
  document.getElementById('child-form-existing').style.display = 'none';
  document.getElementById('c-name').value = '';
  document.querySelector('input[name="c-gender"][value="male"]').checked = true;
  
  const opts = document.getElementById('child-type-opts');
  const f = ctx.fatherId ? db.persons[ctx.fatherId] : null;
  const m = ctx.motherId ? db.persons[ctx.motherId] : null;
  let html = '';
  if (f && m) {
    html += `<label class="ft-status-opt"><input type="radio" name="c-type" value="both" checked><span class="ic">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§</span><span class="tx">Ù…Ù† Ø§Ù„Ø£Ø¨ ÙˆØ§Ù„Ø£Ù…</span></label>`;
    html += `<label class="ft-status-opt"><input type="radio" name="c-type" value="father"><span class="ic">ğŸ‘¨</span><span class="tx">Ù…Ù† Ø§Ù„Ø£Ø¨ ÙÙ‚Ø·</span></label>`;
    html += `<label class="ft-status-opt"><input type="radio" name="c-type" value="mother"><span class="ic">ğŸ‘©</span><span class="tx">Ù…Ù† Ø§Ù„Ø£Ù… ÙÙ‚Ø·</span></label>`;
  } else if (f) {
    html += `<label class="ft-status-opt"><input type="radio" name="c-type" value="father" checked><span class="ic">ğŸ‘¨</span><span class="tx">Ù…Ù† Ø§Ù„Ø£Ø¨</span></label>`;
  } else if (m) {
    html += `<label class="ft-status-opt"><input type="radio" name="c-type" value="mother" checked><span class="ic">ğŸ‘©</span><span class="tx">Ù…Ù† Ø§Ù„Ø£Ù…</span></label>`;
  }
  opts.innerHTML = html;
  
  const avail = Object.values(db.persons).filter(p => !p.fatherId);
  renderPersonSelect('child-select', avail, null);
  openModal('child-modal');
}

function switchChildTab(tab) {
  state.childTab = tab;
  document.querySelector('.ft-tab[data-tab="new"]').classList.toggle('active', tab === 'new');
  document.querySelector('.ft-tab[data-tab="existing"]').classList.toggle('active', tab === 'existing');
  document.getElementById('child-form-new').style.display = tab === 'new' ? 'block' : 'none';
  document.getElementById('child-form-existing').style.display = tab === 'existing' ? 'block' : 'none';
}

function saveChild() {
  let childId;
  if (state.childTab === 'new') {
    const name = document.getElementById('c-name').value.trim();
    if (!name) return toast(t('Ø£Ø¯Ø®Ù„ Ø§Ù„Ø§Ø³Ù…','Enter name'));
    childId = genId();
    db.persons[childId] = { 
      id: childId, 
      name, 
      gender: document.querySelector('input[name="c-gender"]:checked').value, 
      photo: null, 
      birthDate: null, 
      deathDate: null, 
      notes: '',
      fatherId: state.childContext.fatherId || null,
      motherId: state.childContext.motherId || null
    };
  } else {
    childId = getSelectedPerson('child-select');
    if (!childId) return toast(t('Ø§Ø®ØªØ± Ø´Ø®ØµØ§Ù‹','Select person'));
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø´Ø®Øµ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯
    const child = db.persons[childId];
    if (child) {
      child.fatherId = state.childContext.fatherId || child.fatherId;
      child.motherId = state.childContext.motherId || child.motherId;
    }
  }
  
  closeModal('child-modal');
  render();
  toast(t('ØªÙ…','Done'));
}

// ==================== â­ RELATIONS MODAL ====================
function openRelationsModal(pid) {
  const p = db.persons[pid];
  if (!p) return;
  
  state.contextPersonId = pid;
  document.getElementById('rm-title').innerHTML = `ğŸ”— Ø¹Ù„Ø§Ù‚Ø§Øª: ${p.name}`;
  
  let html = '';
  
  // Ø§Ù„ÙˆØ§Ù„Ø¯ÙŠÙ†
  const parents = getParents(pid);
  html += `<div class="ft-rel-section">`;
  html += `<div class="ft-rel-section-head">ğŸ‘¨â€ğŸ‘© Ø§Ù„ÙˆØ§Ù„Ø¯ÙŠÙ†</div>`;
  if (parents.father || parents.mother) {
    if (parents.father) {
      html += `<div class="ft-rel-item">
        <span class="av">ğŸ‘¨</span>
        <div class="info"><div class="nm">${parents.father.name}</div><div class="role">Ø§Ù„Ø£Ø¨</div></div>
        <div class="actions">
          <button class="act-btn" onclick="editParentRel('${pid}')">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
          <button class="act-btn danger" onclick="removeParent('${pid}','father')">âŒ</button>
        </div>
      </div>`;
    }
    if (parents.mother) {
      html += `<div class="ft-rel-item">
        <span class="av">ğŸ‘©</span>
        <div class="info"><div class="nm">${parents.mother.name}</div><div class="role">Ø§Ù„Ø£Ù…</div></div>
        <div class="actions">
          <button class="act-btn" onclick="editParentRel('${pid}')">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
          <button class="act-btn danger" onclick="removeParent('${pid}','mother')">âŒ</button>
        </div>
      </div>`;
    }
  } else {
    html += `<div class="ft-rel-empty">Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆØ§Ù„Ø¯ÙŠÙ† <button class="act-btn" onclick="addParentRel('${pid}')" style="margin-right:10px">+ Ø¥Ø¶Ø§ÙØ©</button></div>`;
  }
  html += `</div>`;
  
  // Ø§Ù„Ø²ÙŠØ¬Ø§Øª
  const spouseRels = getSpouseRels(pid);
  html += `<div class="ft-rel-section">`;
  html += `<div class="ft-rel-section-head">ğŸ’‘ Ø§Ù„Ø²ÙŠØ¬Ø§Øª <button class="add-btn" onclick="closeModal('relations-modal');openSpouseModal(null,{${p.gender==='male'?'husbandId':'wifeId'}:'${pid}'})">+ Ø¥Ø¶Ø§ÙØ©</button></div>`;
  if (spouseRels.length) {
    spouseRels.forEach(rel => {
      const sp = getSpouse(pid, rel.id);
      if (!sp) return;
      const statusIcon = rel.status === 'divorced' ? 'ğŸ’”' : rel.status === 'widowed' ? 'âœï¸' : 'ğŸ’‘';
      const statusTxt = rel.status === 'divorced' ? 'Ù…Ø·Ù„Ù‚Ø§Ù†' : rel.status === 'widowed' ? 'Ø£Ø±Ù…Ù„/Ø©' : 'Ù…ØªØ²ÙˆØ¬Ø§Ù†';
      html += `<div class="ft-rel-item">
        <span class="av">${sp.gender === 'female' ? 'ğŸ‘©' : 'ğŸ‘¨'}</span>
        <div class="info"><div class="nm">${sp.name}</div><div class="role">${statusIcon} ${statusTxt}</div></div>
        <div class="actions">
          <button class="act-btn" onclick="closeModal('relations-modal');openSpouseModal('${rel.id}')">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
          <button class="act-btn danger" onclick="removeSpouseRel('${rel.id}')">âŒ</button>
        </div>
      </div>`;
    });
  } else {
    html += `<div class="ft-rel-empty">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø²ÙŠØ¬Ø§Øª</div>`;
  }
  html += `</div>`;
  
  // Ø§Ù„Ø£Ø¨Ù†Ø§Ø¡
  const children = getChildren(pid);
  html += `<div class="ft-rel-section">`;
  html += `<div class="ft-rel-section-head">ğŸ‘¶ Ø§Ù„Ø£Ø¨Ù†Ø§Ø¡ <button class="add-btn" onclick="closeModal('relations-modal');openChildModalFor('${pid}')">+ Ø¥Ø¶Ø§ÙØ©</button></div>`;
  if (children.length) {
    children.forEach(child => {
      const mother = getMother(child.id);
      const motherTxt = mother ? `Ù…Ù† ${mother.name}` : 'Ø£Ù… ØºÙŠØ± Ù…Ø­Ø¯Ø¯Ø©';
      html += `<div class="ft-rel-item">
        <span class="av">${child.gender === 'female' ? 'ğŸ‘©' : 'ğŸ‘¨'}</span>
        <div class="info"><div class="nm">${child.name}</div><div class="role">${motherTxt}</div></div>
        <div class="actions">
          <button class="act-btn" onclick="editChildRel('${child.id}')">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
          <button class="act-btn danger" onclick="removeChildRel('${child.id}')">âŒ</button>
        </div>
      </div>`;
    });
  } else {
    html += `<div class="ft-rel-empty">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£Ø¨Ù†Ø§Ø¡</div>`;
  }
  html += `</div>`;
  
  document.getElementById('relations-content').innerHTML = html;
  openModal('relations-modal');
}

function openChildModalFor(pid) {
  const p = db.persons[pid];
  if (p.gender === 'male') {
    // Ø§Ù„Ø´Ø®Øµ Ø°ÙƒØ± - Ù‡Ùˆ Ø§Ù„Ø£Ø¨
    openChildModal({ fatherId: pid, motherId: null });
  } else {
    // Ø§Ù„Ø´Ø®Øµ Ø£Ù†Ø«Ù‰ - Ù†Ø­ØªØ§Ø¬ Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø£Ø¨
    const spRels = getSpouseRels(pid);
    if (spRels.length > 0) {
      const sp = getSpouse(pid, spRels[0].id);
      if (sp && sp.gender === 'male') {
        openChildModal({ fatherId: sp.id, motherId: pid });
      } else {
        // Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø²ÙˆØ¬ Ø°ÙƒØ±
        toast(t('ÙŠØ¬Ø¨ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø£Ø¨ Ø£ÙˆÙ„Ø§Ù‹', 'Must specify father first'));
      }
    } else {
      toast(t('ÙŠØ¬Ø¨ Ø¥Ø¶Ø§ÙØ© Ø²ÙˆØ¬ Ø£ÙˆÙ„Ø§Ù‹ Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø£Ø¨', 'Must add spouse first to specify father'));
    }
  }
}

function removeSpouseRel(rid) {
  if (!confirm(t('Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø²ÙˆØ§Ø¬ØŸ','Delete?'))) return;
  delete db.relations[rid];
  render();
  openRelationsModal(state.contextPersonId);
  toast(t('ØªÙ…','Done'));
}

function removeChildRel(rid) {
  // ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯ - Ù†Ø²ÙŠÙ„ fatherId Ù…Ù† Ø§Ù„Ø´Ø®Øµ
  if (!confirm(t('Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¹Ù„Ø§Ù‚Ø© Ù…Ø¹ Ø§Ù„Ø£Ø¨ØŸ','Remove father relation?'))) return;
  const child = db.persons[rid];
  if (child) {
    child.fatherId = null;
    child.motherId = null;
  }
  render();
  openRelationsModal(state.contextPersonId);
  toast(t('ØªÙ…','Done'));
}

function removeParent(pid, which) {
  const p = db.persons[pid];
  if (!p) return;
  if (which === 'father') p.fatherId = null;
  if (which === 'mother') p.motherId = null;
  render();
  openRelationsModal(pid);
  toast(t('ØªÙ…','Done'));
}

function addParentRel(pid) {
  closeModal('relations-modal');
  state.editingChildRelId = pid;
  const p = db.persons[pid];
  const males = Object.values(db.persons).filter(m => m.gender === 'male' && m.id !== pid);
  const females = Object.values(db.persons).filter(f => f.gender === 'female' && f.id !== pid);
  renderPersonSelect('edit-father-select', males, p?.fatherId);
  renderPersonSelect('edit-mother-select', females, p?.motherId);
  openModal('edit-child-rel-modal');
}

function editParentRel(pid) {
  closeModal('relations-modal');
  state.editingChildRelId = pid;
  const p = db.persons[pid];
  const males = Object.values(db.persons).filter(m => m.gender === 'male' && m.id !== pid);
  const females = Object.values(db.persons).filter(f => f.gender === 'female' && f.id !== pid);
  renderPersonSelect('edit-father-select', males, p?.fatherId);
  renderPersonSelect('edit-mother-select', females, p?.motherId);
  openModal('edit-child-rel-modal');
}

function editChildRel(childId) {
  closeModal('relations-modal');
  const child = db.persons[childId];
  if (!child) return;
  state.editingChildRelId = childId;
  const males = Object.values(db.persons).filter(m => m.gender === 'male' && m.id !== childId);
  const females = Object.values(db.persons).filter(f => f.gender === 'female' && f.id !== childId);
  renderPersonSelect('edit-father-select', males, child.fatherId);
  renderPersonSelect('edit-mother-select', females, child.motherId);
  openModal('edit-child-rel-modal');
}

function saveEditChildRel() {
  const pid = state.editingChildRelId;
  if (!pid) return;
  const p = db.persons[pid];
  if (!p) return;
  
  const fid = getSelectedPerson('edit-father-select');
  const mid = getSelectedPerson('edit-mother-select');
  
  // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø´Ø®Øµ Ù…Ø¨Ø§Ø´Ø±Ø©
  p.fatherId = fid || null;
  p.motherId = mid || null;
  
  closeModal('edit-child-rel-modal');
  render();
  toast(t('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù„Ø§Ù‚Ø©','Updated'));
}

function deleteChildRel() {
  const pid = state.editingChildRelId;
  if (!pid) return;
  const p = db.persons[pid];
  if (p) {
    p.fatherId = null;
    p.motherId = null;
  }
  closeModal('edit-child-rel-modal');
  render();
  toast(t('ØªÙ…','Done'));
}

// ==================== PERSON SELECT ====================
function renderPersonSelect(cid, persons, selId) {
  const c = document.getElementById(cid);
  let h = `<input type="text" class="ft-person-select-search" placeholder="${t('Ø§Ø¨Ø­Ø«...','Search...')}" oninput="filterSelect('${cid}',this.value)">`;
  h += `<div class="ft-person-select-list">`;
  h += `<div class="ft-person-opt none ${!selId?'selected':''}" onclick="pickPerson('${cid}',null)">${t('Ø¨Ø¯ÙˆÙ†','None')}</div>`;
  persons.forEach(p => {
    h += `<div class="ft-person-opt ${selId===p.id?'selected':''}" data-id="${p.id}" data-name="${p.name.toLowerCase()}" onclick="pickPerson('${cid}','${p.id}')">
      <span class="av">${p.gender==='female'?'ğŸ‘©':'ğŸ‘¨'}</span>
      <span class="nm">${p.name}</span>
    </div>`;
  });
  h += '</div>';
  c.innerHTML = h;
}

function filterSelect(cid, q) {
  document.querySelectorAll(`#${cid} .ft-person-opt:not(.none)`).forEach(o => {
    o.style.display = (o.dataset.name||'').includes(q.toLowerCase()) ? '' : 'none';
  });
}

function pickPerson(cid, id) {
  document.querySelectorAll(`#${cid} .ft-person-opt`).forEach(o => {
    o.classList.toggle('selected', id ? o.dataset.id === id : o.classList.contains('none'));
  });
}

function getSelectedPerson(cid) {
  return document.querySelector(`#${cid} .ft-person-opt.selected:not(.none)`)?.dataset.id || null;
}

// ==================== CONTEXT MENU ====================
// ==================== CARD MENU ====================
function showCardMenu(pid, x, y) {
  state.menuPersonId = pid;
  const menu = document.getElementById('card-menu');
  
  // Ø¶Ø¨Ø· Ø§Ù„Ù…ÙˆÙ‚Ø¹
  menu.style.left = x + 'px';
  menu.style.top = y + 'px';
  menu.classList.add('show');
  
  // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¹Ø¯Ù… Ø§Ù„Ø®Ø±ÙˆØ¬ Ù…Ù† Ø§Ù„Ø´Ø§Ø´Ø©
  setTimeout(() => {
    const rect = menu.getBoundingClientRect();
    if (rect.right > window.innerWidth) {
      menu.style.left = (x - rect.width) + 'px';
    }
    if (rect.bottom > window.innerHeight) {
      menu.style.top = (y - rect.height) + 'px';
    }
  }, 0);
}

function hideCardMenu() { 
  document.getElementById('card-menu').classList.remove('show');
  // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„ÙØ±Ø¹ÙŠØ©
  document.querySelectorAll('.ft-submenu').forEach(s => s.classList.remove('show'));
}

function showSubmenu(el) {
  const submenu = el.querySelector('.ft-submenu');
  if (submenu) submenu.classList.add('show');
}

function hideSubmenu(el) {
  const submenu = el.querySelector('.ft-submenu');
  if (submenu) submenu.classList.remove('show');
}

function cardMenuAction(action) {
  hideCardMenu();
  const id = state.menuPersonId;
  if (!id) return;
  const p = db.persons[id];
  
  switch (action) {
    case 'edit': openPersonModal(id); break;
    case 'relations': openRelationsModal(id); break;
    case 'spouse': openSpouseModal(null, p.gender==='male'?{husbandId:id}:{wifeId:id}); break;
    case 'child': 
      // Ø¥Ø¶Ø§ÙØ© Ø§Ø¨Ù† - Ø§Ù„Ø£Ø¨ Ù‡Ùˆ Ø§Ù„Ø´Ø®Øµ Ø§Ù„Ø­Ø§Ù„ÙŠ (Ø¥Ø°Ø§ Ø°ÙƒØ±)
      if (p.gender === 'male') {
        openChildModal({ fatherId: id, motherId: null });
      } else {
        // Ø¥Ø°Ø§ Ø£Ù†Ø«Ù‰ØŒ Ù†Ø­ØªØ§Ø¬ Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø£Ø¨
        const spRels = getSpouseRels(id);
        if (spRels.length > 0) {
          const sp = getSpouse(id, spRels[0].id);
          if (sp && sp.gender === 'male') {
            openChildModal({ fatherId: sp.id, motherId: id });
          } else {
            toast(t('ÙŠØ¬Ø¨ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø£Ø¨ Ø£ÙˆÙ„Ø§Ù‹', 'Must specify father first'));
          }
        } else {
          toast(t('ÙŠØ¬Ø¨ Ø¥Ø¶Ø§ÙØ© Ø²ÙˆØ¬ Ø£ÙˆÙ„Ø§Ù‹', 'Must add spouse first'));
        }
      }
      break;
    case 'sibling':
      // Ø¥Ø¶Ø§ÙØ© Ø´Ù‚ÙŠÙ‚ - Ø¥Ø°Ø§ ÙƒØ§Ù† Ù„Ù‡ Ø£Ø¨ Ù†Ø¶ÙŠÙ Ù„Ù†ÙØ³ Ø§Ù„Ø£Ø¨
      if (p.fatherId) {
        openChildModal({ fatherId: p.fatherId, motherId: p.motherId });
      } else {
        // Ù„ÙŠØ³ Ù„Ù‡ Ø£Ø¨ - Ù†Ø¶ÙŠÙ Ø¹Ù„Ø§Ù‚Ø© sibling
        openSiblingModal(id);
      }
      break;
    case 'parent':
      // Ø¥Ø¶Ø§ÙØ© Ø£Ø¨/Ø£Ù…
      addParentRel(id);
      break;
    case 'locate': locatePerson(id); break;
    case 'delete': 
      if (confirm(t('Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø´Ø®ØµØŸ', 'Delete this person?'))) {
        state.editingPersonId = id; 
        deletePerson(); 
      }
      break;
  }
}

// Ù†Ø§ÙØ°Ø© Ø¥Ø¶Ø§ÙØ© Ø´Ù‚ÙŠÙ‚ (Ø¨Ø¯ÙˆÙ† Ø£Ø¨) - ØªØ³ØªØ®Ø¯Ù… Ù†Ø§ÙØ°Ø© Ù…ÙˆØ­Ø¯Ø©
function openSiblingModal(personId) {
  const p = db.persons[personId];
  if (!p) return;
  
  // ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø¥Ø¶Ø§ÙØ© Ø´Ø®Øµ Ù…Ø¹ Ø±Ø¨Ø·Ù‡ ÙƒØ´Ù‚ÙŠÙ‚
  state.siblingForId = personId;
  openPersonModal(null);
}

// Ø¯ÙˆØ§Ù„ Ù‚Ø¯ÙŠÙ…Ø© Ù„Ù„ØªÙˆØ§ÙÙ‚ Ù…Ø¹ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø´Ø®Ø§Øµ Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ©
function showCtx(e, pid) {
  e.preventDefault();
  e.stopPropagation();
  showCardMenu(pid, e.clientX, e.clientY);
}

function hideCtx() { hideCardMenu(); }

// ==================== LAYOUT & RENDER TREE ====================

// Ø­Ø³Ø§Ø¨ Ø¹Ø±Ø¶ Ø´Ø¬Ø±Ø© Ø´Ø®Øµ (Ù‡Ùˆ ÙˆØ£Ø¨Ù†Ø§Ø¤Ù‡)
function calcTreeWidth(personId, visited = new Set()) {
  if (visited.has(personId)) return CARD_W;
  visited.add(personId);
  
  const person = db.persons[personId];
  if (!person) return CARD_W;
  
  // Ø¬Ù…Ø¹ Ø§Ù„Ø£Ø¨Ù†Ø§Ø¡
  const children = getChildren(personId);
  if (children.length === 0) return CARD_W;
  
  // Ø­Ø³Ø§Ø¨ Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø¨Ù†Ø§Ø¡
  let childrenWidth = 0;
  children.forEach((child, i) => {
    childrenWidth += calcTreeWidth(child.id, new Set(visited));
    if (i < children.length - 1) childrenWidth += GAP_X;
  });
  
  return Math.max(CARD_W, childrenWidth);
}

// ÙˆØ¶Ø¹ Ø´Ø®Øµ ÙˆØ£Ø¨Ù†Ø§Ø¦Ù‡
function placeTree(personId, level, centerX, processed) {
  if (processed.has(personId)) return;
  
  const person = db.persons[personId];
  if (!person) return;
  
  // ØªØ®Ø·ÙŠ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ù…ÙˆÙ‚Ø¹ ÙŠØ¯ÙˆÙŠ
  if (person._manualX !== undefined) {
    processed.add(personId);
    return;
  }
  
  processed.add(personId);
  const y = level * (CARD_H + GAP_Y);
  
  // ÙˆØ¶Ø¹ Ø§Ù„Ø´Ø®Øµ ÙÙŠ Ø§Ù„Ù…Ø±ÙƒØ²
  person._x = centerX - CARD_W / 2;
  person._y = y;
  person._level = level;
  
  // Ø¬Ù…Ø¹ Ø§Ù„Ø£Ø¨Ù†Ø§Ø¡
  const children = getChildren(personId);
  if (children.length === 0) return;
  
  // Ø­Ø³Ø§Ø¨ Ø¹Ø±Ø¶ ÙƒÙ„ Ø§Ø¨Ù†
  const childWidths = children.map(c => calcTreeWidth(c.id, new Set(processed)));
  const totalChildrenWidth = childWidths.reduce((sum, w, i) => sum + w + (i > 0 ? GAP_X : 0), 0);
  
  // ÙˆØ¶Ø¹ Ø§Ù„Ø£Ø¨Ù†Ø§Ø¡ Ù…ØªÙˆØ³Ø·ÙŠÙ† ØªØ­Øª Ø§Ù„Ø£Ø¨
  let childStartX = centerX - totalChildrenWidth / 2;
  
  children.forEach((child, i) => {
    const childWidth = childWidths[i];
    const childCenterX = childStartX + childWidth / 2;
    
    placeTree(child.id, level + 1, childCenterX, processed);
    
    childStartX += childWidth + GAP_X;
  });
}

function layoutTree() {
  const allPersons = Object.values(db.persons);
  if (allPersons.length === 0) return;
  
  // Ø¥ÙŠØ¬Ø§Ø¯ Ø§Ù„Ø¬Ø°ÙˆØ± (Ù…Ù† Ù„ÙŠØ³ Ù„Ù‡Ù… Ø¢Ø¨Ø§Ø¡)
  const roots = allPersons.filter(p => !p.fatherId);
  
  // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¥Ø®ÙˆØ© Ø¨Ø¯ÙˆÙ† Ø¢Ø¨Ø§Ø¡ (Ø±Ø¨Ø·Ù‡Ù… Ù…Ø¹Ø§Ù‹)
  const processedRoots = new Set();
  const rootGroups = [];
  
  roots.forEach(root => {
    if (processedRoots.has(root.id)) return;
    
    const group = [root];
    processedRoots.add(root.id);
    
    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø¥Ø®ÙˆØ© Ø¹Ø¨Ø± Ø¹Ù„Ø§Ù‚Ø© sibling
    getSiblingRels(root.id).forEach(rel => {
      const sibId = rel.person1Id === root.id ? rel.person2Id : rel.person1Id;
      const sib = db.persons[sibId];
      if (sib && !sib.fatherId && !processedRoots.has(sibId)) {
        group.push(sib);
        processedRoots.add(sibId);
      }
    });
    
    rootGroups.push(group);
  });
  
  const processed = new Set();
  let globalX = 100;
  
  rootGroups.forEach(group => {
    // Ø­Ø³Ø§Ø¨ Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©
    let groupWidth = 0;
    group.forEach((root, i) => {
      groupWidth += calcTreeWidth(root.id, new Set());
      if (i < group.length - 1) groupWidth += GAP_X;
    });
    
    // ÙˆØ¶Ø¹ ÙƒÙ„ Ø´Ø®Øµ ÙÙŠ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©
    let startX = globalX;
    group.forEach((root, i) => {
      const width = calcTreeWidth(root.id, new Set());
      const centerX = startX + width / 2;
      
      placeTree(root.id, 0, centerX, processed);
      
      startX += width + GAP_X;
    });
    
    globalX += groupWidth + GAP_X * 2;
  });
}

function renderTree() {
  const linesG = document.getElementById('lines-g');
  const cardsG = document.getElementById('cards-g');
  linesG.innerHTML = '';
  cardsG.innerHTML = '';
  
  const persons = Object.values(db.persons);
  document.getElementById('empty-msg').style.display = persons.length ? 'none' : 'block';
  if (!persons.length) return;
  
  // Ø±Ø³Ù… Ø®Ø·ÙˆØ· Ø§Ù„Ø£Ø¨-Ø§Ù„Ø§Ø¨Ù†
  persons.forEach(p => {
    if (p._x === undefined) return;
    const father = getFather(p.id);
    if (father && father._x !== undefined) {
      drawFatherChildLine(father, p, linesG);
    }
  });
  
  // Ø±Ø³Ù… Ø®Ø·ÙˆØ· Ø§Ù„Ø²ÙˆØ§Ø¬ (Ù„Ù„Ø¹Ø±Ø¶ ÙÙ‚Ø·)
  Object.values(db.relations).filter(r => r.type === 'spouse').forEach(rel => {
    const p1 = db.persons[rel.person1Id], p2 = db.persons[rel.person2Id];
    if (p1?._x !== undefined && p2?._x !== undefined) drawSpouseLine(p1, p2, rel, linesG);
  });
  
  // Ø±Ø³Ù… Ø®Ø·ÙˆØ· Ø§Ù„Ø£Ø®ÙˆØ© (Ø¨Ø¯ÙˆÙ† Ø¢Ø¨Ø§Ø¡)
  Object.values(db.relations).filter(r => r.type === 'sibling').forEach(rel => {
    const p1 = db.persons[rel.person1Id], p2 = db.persons[rel.person2Id];
    if (p1?._x !== undefined && p2?._x !== undefined && !p1.fatherId && !p2.fatherId) {
      drawSiblingLine(p1, p2, linesG);
    }
  });
  
  // Ø±Ø³Ù… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª
  persons.forEach(p => { if (p._x !== undefined) drawCard(p, cardsG); });
  
  // Ø±Ø³Ù… Ø¯ÙˆØ§Ø¦Ø± Ø§Ù„Ø£Ù…Ù‡Ø§Øª (ÙÙˆÙ‚ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª)
  persons.forEach(p => {
    if (p._x !== undefined && p.motherId) {
      const mother = db.persons[p.motherId];
      if (mother) drawMotherCircle(p, mother, cardsG);
    }
  });
  
  updateTransform();
}

// Ø®Ø· Ù…Ù† Ø§Ù„Ø£Ø¨ Ù„Ù„Ø§Ø¨Ù†
function drawFatherChildLine(father, child, layer) {
  const fx = father._x + CARD_W / 2;
  const fy = father._y + CARD_H;
  const cx = child._x + CARD_W / 2;
  // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø£Ù…ØŒ Ø§Ù„Ø®Ø· ÙŠÙ†ØªÙ‡ÙŠ Ø¹Ù†Ø¯ Ø¯Ø§Ø¦Ø±Ø© Ø§Ù„Ø£Ù…
  const cy = child.motherId ? child._y - MOTHER_CIRCLE_R : child._y;
  const midY = fy + (cy - fy) / 2;
  
  const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
  path.setAttribute('d', `M ${fx} ${fy} L ${fx} ${midY} L ${cx} ${midY} L ${cx} ${cy}`);
  path.setAttribute('stroke', '#475569');
  path.setAttribute('stroke-width', '2');
  path.setAttribute('fill', 'none');
  layer.appendChild(path);
}

// Ø¯Ø§Ø¦Ø±Ø© Ø§Ù„Ø£Ù… ÙÙˆÙ‚ Ø§Ù„Ø§Ø¨Ù†
function drawMotherCircle(child, mother, layer) {
  const cx = child._x + CARD_W / 2;
  const cy = child._y - MOTHER_CIRCLE_R + 2; // Ù…Ù…Ø§Ø³Ø© Ù„Ù„Ù…Ø±Ø¨Ø¹
  
  const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
  g.setAttribute('class', 'mother-circle');
  g.setAttribute('data-mother-id', mother.id);
  g.style.cursor = 'pointer';
  
  // Ø§Ù„Ø¯Ø§Ø¦Ø±Ø©
  const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
  circle.setAttribute('cx', cx);
  circle.setAttribute('cy', cy);
  circle.setAttribute('r', MOTHER_CIRCLE_R);
  circle.setAttribute('fill', '#831843');
  circle.setAttribute('stroke', '#ec4899');
  circle.setAttribute('stroke-width', '2');
  g.appendChild(circle);
  
  // Ø§Ø³Ù… Ø§Ù„Ø£Ù… Ù…Ø®ØªØµØ±
  const name = document.createElementNS('http://www.w3.org/2000/svg', 'text');
  name.setAttribute('x', cx);
  name.setAttribute('y', cy + 1);
  name.setAttribute('text-anchor', 'middle');
  name.setAttribute('dominant-baseline', 'middle');
  name.setAttribute('fill', '#fce7f3');
  name.setAttribute('font-size', '8');
  name.setAttribute('font-weight', '600');
  const shortName = mother.name.length > 5 ? mother.name.substring(0, 4) + '..' : mother.name;
  name.textContent = shortName;
  g.appendChild(name);
  
  // Ø²Ø± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© (Ø«Ù„Ø§Ø« Ù†Ù‚Ø§Ø·)
  const menuBtn = document.createElementNS('http://www.w3.org/2000/svg', 'g');
  menuBtn.setAttribute('class', 'mother-menu-btn');
  menuBtn.style.cursor = 'pointer';
  menuBtn.style.opacity = '0';
  
  // Ù†Ù‚Ø§Ø· Ø£ÙÙ‚ÙŠØ© ØµØºÙŠØ±Ø©
  [-4, 0, 4].forEach(dx => {
    const dot = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
    dot.setAttribute('cx', cx + dx);
    dot.setAttribute('cy', cy + MOTHER_CIRCLE_R - 5);
    dot.setAttribute('r', 1.5);
    dot.setAttribute('fill', '#f9a8d4');
    menuBtn.appendChild(dot);
  });
  
  g.appendChild(menuBtn);
  
  // Ø§Ù„Ø£Ø­Ø¯Ø§Ø«
  g.onmouseenter = () => { 
    circle.setAttribute('stroke-width', '3');
    menuBtn.style.opacity = '1';
  };
  g.onmouseleave = () => { 
    circle.setAttribute('stroke-width', '2');
    menuBtn.style.opacity = '0';
  };
  
  g.onclick = e => {
    e.stopPropagation();
    const svgRect = document.getElementById('svg').getBoundingClientRect();
    const menuX = svgRect.left + (cx + 20) * state.zoom + state.panX;
    const menuY = svgRect.top + (cy) * state.zoom + state.panY;
    showCardMenu(mother.id, menuX, menuY);
  };
  
  layer.appendChild(g);
}

// Ø®Ø· Ø¨ÙŠÙ† Ø§Ù„Ø¥Ø®ÙˆØ© (Ø¨Ø¯ÙˆÙ† Ø¢Ø¨Ø§Ø¡)
function drawSiblingLine(p1, p2, layer) {
  const x1 = p1._x + CARD_W / 2;
  const x2 = p2._x + CARD_W / 2;
  const y = Math.min(p1._y, p2._y) - 15;
  
  const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
  path.setAttribute('d', `M ${x1} ${p1._y} L ${x1} ${y} L ${x2} ${y} L ${x2} ${p2._y}`);
  path.setAttribute('stroke', '#6366f1');
  path.setAttribute('stroke-width', '2');
  path.setAttribute('stroke-dasharray', '4,3');
  path.setAttribute('fill', 'none');
  layer.appendChild(path);
}

function drawSpouseLine(p1, p2, rel, layer) {
  const x1 = Math.min(p1._x, p2._x) + CARD_W, x2 = Math.max(p1._x, p2._x);
  const y = p1._y + CARD_H / 2;
  
  const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
  line.setAttribute('x1', x1); line.setAttribute('y1', y); line.setAttribute('x2', x2); line.setAttribute('y2', y);
  line.setAttribute('stroke', rel.status==='divorced'?'#6b7280':rel.status==='widowed'?'#4b5563':'#f59e0b');
  line.setAttribute('stroke-width', '3');
  if (rel.status !== 'married') line.setAttribute('stroke-dasharray', rel.status==='divorced'?'5,5':'2,4');
  layer.appendChild(line);
  
  const midX = (x1 + x2) / 2;
  const icon = document.createElementNS('http://www.w3.org/2000/svg', 'text');
  icon.setAttribute('x', midX); icon.setAttribute('y', y - 8); icon.setAttribute('text-anchor', 'middle'); icon.setAttribute('font-size', '13');
  icon.textContent = rel.status==='divorced'?'ğŸ’”':rel.status==='widowed'?'âœï¸':'ğŸ’‘';
  layer.appendChild(icon);
}

function drawCard(p, layer) {
  const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
  g.setAttribute('transform', `translate(${p._x}, ${p._y})`);
  g.setAttribute('data-person-id', p.id);
  g.style.cursor = 'grab';
  
  const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
  rect.setAttribute('width', CARD_W); rect.setAttribute('height', CARD_H); rect.setAttribute('rx', '9');
  rect.setAttribute('fill', '#334155');
  rect.setAttribute('stroke', p.gender==='female'?'#ec4899':'#3b82f6');
  rect.setAttribute('stroke-width', p.deathDate?'2':'2.5');
  if (p.deathDate) rect.setAttribute('stroke-dasharray', '4,3');
  rect.setAttribute('filter', 'url(#shadow)');
  g.appendChild(rect);
  
  if (p.photo) {
    const img = document.createElementNS('http://www.w3.org/2000/svg', 'image');
    img.setAttribute('x', CARD_W/2 - 14); img.setAttribute('y', 6); img.setAttribute('width', 28); img.setAttribute('height', 28);
    img.setAttribute('href', p.photo);
    g.appendChild(img);
  } else {
    const icon = document.createElementNS('http://www.w3.org/2000/svg', 'text');
    icon.setAttribute('x', CARD_W/2); icon.setAttribute('y', 26); icon.setAttribute('text-anchor', 'middle'); icon.setAttribute('font-size', '20');
    icon.textContent = p.gender==='female'?'ğŸ‘©':'ğŸ‘¨';
    g.appendChild(icon);
  }
  
  const name = document.createElementNS('http://www.w3.org/2000/svg', 'text');
  name.setAttribute('x', CARD_W/2); name.setAttribute('y', 48); name.setAttribute('text-anchor', 'middle');
  name.setAttribute('fill', '#f8fafc'); name.setAttribute('font-size', '10'); name.setAttribute('font-weight', '600');
  name.textContent = p.name.length > 12 ? p.name.substring(0, 12) + '..' : p.name;
  g.appendChild(name);
  
  if (p.birthDate) {
    const b = new Date(p.birthDate), e = p.deathDate ? new Date(p.deathDate) : new Date();
    let age = e.getFullYear() - b.getFullYear();
    const ageT = document.createElementNS('http://www.w3.org/2000/svg', 'text');
    ageT.setAttribute('x', CARD_W/2); ageT.setAttribute('y', 60); ageT.setAttribute('text-anchor', 'middle');
    ageT.setAttribute('fill', '#94a3b8'); ageT.setAttribute('font-size', '8');
    ageT.textContent = age + ' Ø³Ù†Ø©' + (p.deathDate ? ' âœ' : '');
    g.appendChild(ageT);
  }
  
  // Ø²Ø± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© (Ø«Ù„Ø§Ø« Ù†Ù‚Ø§Ø·) ÙÙŠ Ø§Ù„Ø²Ø§ÙˆÙŠØ© Ø§Ù„Ø¹Ù„ÙˆÙŠØ© Ø§Ù„ÙŠØ³Ø±Ù‰
  const menuBtn = document.createElementNS('http://www.w3.org/2000/svg', 'g');
  menuBtn.setAttribute('class', 'menu-btn');
  menuBtn.style.cursor = 'pointer';
  
  const menuBg = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
  menuBg.setAttribute('x', 2); menuBg.setAttribute('y', 2);
  menuBg.setAttribute('width', 18); menuBg.setAttribute('height', 18);
  menuBg.setAttribute('rx', 4);
  menuBg.setAttribute('fill', 'transparent');
  menuBtn.appendChild(menuBg);
  
  // Ø«Ù„Ø§Ø« Ù†Ù‚Ø§Ø· Ø¹Ù…ÙˆØ¯ÙŠØ©
  [6, 11, 16].forEach(cy => {
    const dot = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
    dot.setAttribute('cx', 11); dot.setAttribute('cy', cy);
    dot.setAttribute('r', 1.5);
    dot.setAttribute('fill', '#94a3b8');
    menuBtn.appendChild(dot);
  });
  
  menuBtn.onmousedown = e => e.stopPropagation();
  menuBtn.onclick = e => {
    e.stopPropagation();
    const svgRect = document.getElementById('svg').getBoundingClientRect();
    const menuX = svgRect.left + (p._x + 20) * state.zoom + state.panX;
    const menuY = svgRect.top + (p._y + 5) * state.zoom + state.panY;
    showCardMenu(p.id, menuX, menuY);
  };
  menuBtn.onmouseenter = () => { 
    menuBg.setAttribute('fill', 'rgba(255,255,255,0.1)');
    menuBtn.querySelectorAll('circle').forEach(c => c.setAttribute('fill', '#fff'));
  };
  menuBtn.onmouseleave = () => { 
    menuBg.setAttribute('fill', 'transparent');
    menuBtn.querySelectorAll('circle').forEach(c => c.setAttribute('fill', '#94a3b8'));
  };
  g.appendChild(menuBtn);
  
  // Events - Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¶ØºØ· Ø¨Ø§Ù„ÙŠÙ…ÙŠÙ†
  g.ondblclick = e => { e.stopPropagation(); openRelationsModal(p.id); };
  
  // Drag card
  g.onmousedown = e => {
    if (e.target.closest('.menu-btn')) return;
    e.stopPropagation();
    state.dragCardId = p.id;
    state.dragStartX = (e.clientX - state.panX) / state.zoom - p._x;
    state.dragStartY = (e.clientY - state.panY) / state.zoom - p._y;
    
    // Ø­ÙØ¸ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø£ØµÙ„ÙŠ
    state.dragOrigX = p._x;
    state.dragOrigY = p._y;
    
    // Ø¬Ù…Ø¹ Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ø³Ø­Ø¨ (Ø§Ù„Ø£Ø²ÙˆØ§Ø¬ + Ø§Ù„Ø°Ø±ÙŠØ©)
    state.dragGroup = getDragGroup(p.id);
    
    g.style.cursor = 'grabbing';
    g.classList.add('ft-card-dragging');
  };
  
  layer.appendChild(g);
}

// ==================== CANVAS ====================
let isPanning = false, panStartX = 0, panStartY = 0;

function setupCanvas() {
  const svg = document.getElementById('svg');
  const canvas = document.getElementById('canvas');
  
  svg.onmousedown = e => {
    if (e.target.closest('g[data-person-id]')) return;
    isPanning = true;
    panStartX = e.clientX - state.panX;
    panStartY = e.clientY - state.panY;
  };
  
  svg.onmousemove = e => {
    // Drag card
    if (state.dragCardId) {
      const p = db.persons[state.dragCardId];
      if (p) {
        const newX = (e.clientX - state.panX) / state.zoom - state.dragStartX;
        const newY = (e.clientY - state.panY) / state.zoom - state.dragStartY;
        
        // Ø­Ø³Ø§Ø¨ Ø§Ù„ÙØ±Ù‚
        const deltaX = newX - state.dragOrigX;
        const deltaY = newY - state.dragOrigY;
        
        // ØªØ­Ø±ÙŠÙƒ Ø§Ù„Ø´Ø®Øµ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
        p._x = newX;
        p._y = newY;
        p._manualX = newX;
        p._manualY = newY;
        
        // ØªØ­Ø±ÙŠÙƒ Ø§Ù„Ø°Ø±ÙŠØ©
        if (state.dragGroup && state.dragGroup.descendants) {
          state.dragGroup.descendants.forEach(d => {
            const desc = db.persons[d.id];
            if (desc) {
              desc._x = d.origX + deltaX;
              desc._y = d.origY + deltaY;
              desc._manualX = desc._x;
              desc._manualY = desc._y;
            }
          });
        }
        
        // Ø¥Ø¹Ø§Ø¯Ø© Ø±Ø³Ù… ÙƒÙ„ Ø´ÙŠØ¡ (Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª ÙˆØ§Ù„Ø®Ø·ÙˆØ·)
        renderTree();
      }
      return;
    }
    
    // Pan canvas
    if (isPanning) {
      state.panX = e.clientX - panStartX;
      state.panY = e.clientY - panStartY;
      updateTransform();
    }
  };
  
  svg.onmouseup = () => {
    if (state.dragCardId) {
      const g = document.querySelector(`g[data-person-id="${state.dragCardId}"]`);
      if (g) { g.style.cursor = 'grab'; g.classList.remove('ft-card-dragging'); }
      state.dragCardId = null;
      renderTree(); // re-render lines
    }
    isPanning = false;
  };
  
  svg.onmouseleave = () => { isPanning = false; state.dragCardId = null; };
  
  canvas.onwheel = e => {
    e.preventDefault();
    state.zoom = Math.max(0.3, Math.min(2, state.zoom + (e.deltaY > 0 ? -0.1 : 0.1)));
    updateTransform();
    document.getElementById('zoom-lvl').textContent = Math.round(state.zoom * 100) + '%';
  };
}

function updateTransform() {
  document.getElementById('tree-g').setAttribute('transform', `translate(${state.panX}, ${state.panY}) scale(${state.zoom})`);
}

function zoomIn() { state.zoom = Math.min(2, state.zoom + 0.1); updateTransform(); document.getElementById('zoom-lvl').textContent = Math.round(state.zoom * 100) + '%'; }
function zoomOut() { state.zoom = Math.max(0.3, state.zoom - 0.1); updateTransform(); document.getElementById('zoom-lvl').textContent = Math.round(state.zoom * 100) + '%'; }
function fitView() { state.zoom = 1; state.panX = 50; state.panY = 50; updateTransform(); document.getElementById('zoom-lvl').textContent = '100%'; }

function locatePerson(id) {
  const p = db.persons[id];
  if (!p || p._x === undefined) return;
  const svg = document.getElementById('svg');
  state.panX = svg.clientWidth / 2 - p._x * state.zoom - CARD_W / 2;
  state.panY = svg.clientHeight / 2 - p._y * state.zoom - CARD_H / 2;
  updateTransform();
}

// ==================== STATS ====================
function updateStats() {
  const persons = Object.values(db.persons);
  const spRels = Object.values(db.relations).filter(r => r.type === 'spouse');
  const levels = new Set(persons.map(p => p._level).filter(l => l !== undefined));
  document.getElementById('stat-total').textContent = persons.length;
  document.getElementById('stat-males').textContent = persons.filter(p => p.gender === 'male').length;
  document.getElementById('stat-females').textContent = persons.filter(p => p.gender === 'female').length;
  document.getElementById('stat-marriages').textContent = spRels.length;
  document.getElementById('stat-gens').textContent = levels.size;
}

// ==================== SAVE/LOAD ====================
function saveLocal() { localStorage.setItem('familyTreeV58', JSON.stringify(db)); toast(t('ØªÙ… Ø§Ù„Ø­ÙØ¸','Saved')); }
function loadLocal() {
  const s = localStorage.getItem('familyTreeV58');
  if (s) { 
    db = JSON.parse(s); 
    // Ù…Ø³Ø­ Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹ Ø§Ù„ÙŠØ¯ÙˆÙŠØ© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ø¬Ø¯ÙŠØ¯
    Object.values(db.persons).forEach(p => {
      delete p._manualX;
      delete p._manualY;
    });
    render(); 
    toast(t('ØªÙ… Ø§Ù„ØªØ­Ù…ÙŠÙ„','Loaded')); 
  }
  else toast(t('Ù„Ø§ Ø¨ÙŠØ§Ù†Ø§Øª','No data'));
}

function exportJSON() { download(JSON.stringify(db, null, 2), 'family-tree.json', 'application/json'); }
function importJSON(e) {
  const f = e.target.files[0]; if (!f) return;
  const r = new FileReader();
  r.onload = ev => { 
    try { 
      db = JSON.parse(ev.target.result); 
      // Ù…Ø³Ø­ Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹ Ø§Ù„ÙŠØ¯ÙˆÙŠØ©
      Object.values(db.persons).forEach(p => {
        delete p._manualX;
        delete p._manualY;
      });
      render(); 
      toast(t('ØªÙ…','Done')); 
    } catch { toast(t('Ø®Ø·Ø£','Error')); } 
  };
  r.readAsText(f); e.target.value = '';
}

function exportPNG() {
  const svg = document.getElementById('svg');
  const data = new XMLSerializer().serializeToString(svg);
  const canvas = document.createElement('canvas');
  const ctx = canvas.getContext('2d');
  const img = new Image();
  canvas.width = svg.clientWidth * 2; canvas.height = svg.clientHeight * 2;
  img.onload = () => {
    ctx.fillStyle = '#0f172a'; ctx.fillRect(0, 0, canvas.width, canvas.height);
    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
    const a = document.createElement('a'); a.download = 'family-tree.png'; a.href = canvas.toDataURL('image/png'); a.click();
  };
  img.src = 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(data)));
}

function exportSVG() { download(new XMLSerializer().serializeToString(document.getElementById('svg')), 'family-tree.svg', 'image/svg+xml'); }

function download(c, n, t) { const b = new Blob([c], { type: t }); const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = n; a.click(); }

function clearAll() {
  if (!confirm(t('Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„ØŸ','Clear all?'))) return;
  db = { persons: {}, relations: {} };
  render(); toast(t('ØªÙ…','Done'));
}

// Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ (Ù…Ø³Ø­ Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹ Ø§Ù„ÙŠØ¯ÙˆÙŠØ©)
function resetLayout() {
  Object.values(db.persons).forEach(p => {
    delete p._manualX;
    delete p._manualY;
  });
  render();
  toast(t('ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ±ØªÙŠØ¨','Layout reset'));
}

// ==================== UTILS ====================
function openModal(id) { document.getElementById(id).classList.add('show'); }
function closeModal(id) { 
  document.getElementById(id).classList.remove('show'); 
  if (id === 'person-modal') state.siblingForId = null;
}
function closeAllModals() { 
  document.querySelectorAll('.ft-modal-bg.show').forEach(m => m.classList.remove('show')); 
  state.siblingForId = null;
}
function toast(msg) { const el = document.getElementById('toast'); el.textContent = msg; el.classList.add('show'); setTimeout(() => el.classList.remove('show'), 2500); }
function toggleDD(id) { event.stopPropagation(); document.getElementById(id).classList.toggle('open'); }

init();
</script>

<script>
  window.toolsData = [{"id":"percentage","icon":"ğŸ”¢","name":"Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø¦ÙˆÙŠØ©","keywords":"Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø¦ÙˆÙŠØ©ØŒ Ø­Ø³Ø§Ø¨ Ø§Ù„Ù†Ø³Ø¨Ø©ØŒ Ù†Ø³Ø¨Ø© Ø§Ù„Ø®ØµÙ…ØŒ Ø­Ø³Ø§Ø¨ Ø§Ù„Ø®ØµÙ…ØŒ percentage calculator","searchTerms":"Ù†Ø³Ø¨Ø© Ø§Ù„Ù†Ø³Ø¨Ø© Ù…Ø¦ÙˆÙŠØ© Ø§Ù„Ù…Ø¦ÙˆÙŠØ© Ù†Ø³Ø¨ Ù…Ø¦ÙˆÙŠÙ‡ Ø¨Ø§Ù„Ù…ÙŠØ© Ø¨Ø§Ù„Ù…ÙŠÙ‡ Ø¨Ø§Ù„Ù…Ø¦Ø© Ø¨Ø§Ù„Ù…Ø¦Ù‡ Ø§Ù„Ù…Ø¦ÙˆÙŠÙ‡ Ø®ØµÙ… Ø§Ù„Ø®ØµÙ… ØªØ®ÙÙŠØ¶ Ø§Ù„ØªØ®ÙÙŠØ¶ Ø­Ø³Ù… Ø§Ù„Ø­Ø³Ù… Ø³Ø¹Ø± Ø§Ù„Ø³Ø¹Ø± Ø§ÙˆÙ Ø¹Ø±Ø¶ Ø§Ù„Ø¹Ø±Ø¶ ØªÙ†Ø²ÙŠÙ„Ø§Øª Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø²ÙŠØ§Ø¯Ø© Ù†Ù‚ØµØ§Ù† Ø§Ù„Ù†Ù‚ØµØ§Ù† ÙØ±Ù‚ Ø§Ù„ÙØ±Ù‚ Ø±Ø¨Ø¹ Ø§Ù„Ø±Ø¨Ø¹ Ù†Øµ Ø§Ù„Ù†Øµ Ø«Ù„Ø« Ø§Ù„Ø«Ù„Ø« percent percentage Ø­Ø³Ø§Ø¨ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø±ÙŠØ§Ø¶ÙŠØ§Øª Ø±Ø¨Ø­ Ø§Ù„Ø±Ø¨Ø­ Ø®Ø³Ø§Ø±Ø© Ø§Ù„Ø®Ø³Ø§Ø±Ø© Ø¶Ø±ÙŠØ¨Ø© Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© Ø¶Ø±Ø§ÙŠØ¨ Ù‡Ø§Ù…Ø´ Ø§Ù„Ù‡Ø§Ù…Ø´ ÙƒØ³Ø± Ø§Ù„ÙƒØ³Ø± ÙƒØ³ÙˆØ± Ù‚Ø¨Ù„ Ø¨Ø¹Ø¯ Ø§ØµÙ„ÙŠ Ø§Ù„Ø§ØµÙ„ÙŠ Ø§ØµÙ„ Ø§Ù„Ø§ØµÙ„ ØªÙƒÙ„ÙØ© Ø§Ù„ØªÙƒÙ„ÙØ© Ø¨ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ¹ Ø´Ø±Ø§Ø¡ Ø§Ù„Ø´Ø±Ø§Ø¡ Ø¬Ø²Ø¡ Ø§Ù„Ø¬Ø²Ø¡ ÙƒÙ„ Ø§Ù„ÙƒÙ„ Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹","category":"calculators","categoryName":"Ø­Ø§Ø³Ø¨Ø§Øª","url":"../../ar/tools/percentage.html"},{"id":"interest-calculator","icon":"ğŸ’°","name":"Ø­Ø§Ø³Ø¨Ø© Ø§Ù„ÙÙˆØ§Ø¦Ø¯","keywords":"Ø­Ø§Ø³Ø¨Ø© Ø§Ù„ÙÙˆØ§Ø¦Ø¯ØŒ ÙØ§Ø¦Ø¯Ø© Ø¨Ø³ÙŠØ·Ø©ØŒ ÙØ§Ø¦Ø¯Ø© Ù…Ø±ÙƒØ¨Ø©ØŒ Ø­Ø³Ø§Ø¨ Ø§Ù„Ù‚Ø±Ø¶ØŒ interest calculator","searchTerms":"ÙØ§Ø¦Ø¯Ø© Ø§Ù„ÙØ§Ø¦Ø¯Ø© ÙÙˆØ§Ø¦Ø¯ Ø§Ù„ÙÙˆØ§Ø¦Ø¯ ÙØ§ÙŠØ¯Ø© Ø§Ù„ÙØ§ÙŠØ¯Ø© ÙÙˆØ§ÙŠØ¯ Ø¨Ø³ÙŠØ·Ø© Ø§Ù„Ø¨Ø³ÙŠØ·Ø© Ù…Ø±ÙƒØ¨Ø© Ø§Ù„Ù…Ø±ÙƒØ¨Ø© Ù…Ø±ÙƒØ¨Ù‡ Ù‚Ø±Ø¶ Ø§Ù„Ù‚Ø±Ø¶ Ù‚Ø±ÙˆØ¶ Ø§Ù„Ù‚Ø±ÙˆØ¶ Ø§Ø³ØªØ«Ù…Ø§Ø± Ø§Ù„Ø§Ø³ØªØ«Ù…Ø§Ø± Ø¹Ø§Ø¦Ø¯ Ø§Ù„Ø¹Ø§Ø¦Ø¯ Ø¹ÙˆØ§Ø¦Ø¯ Ø§Ù„Ø¹ÙˆØ§Ø¦Ø¯ Ø±Ø¨Ø­ Ø§Ù„Ø±Ø¨Ø­ Ø¨Ù†Ùƒ Ø§Ù„Ø¨Ù†Ùƒ Ø¨Ù†ÙˆÙƒ Ø§Ù„Ø¨Ù†ÙˆÙƒ Ù…Ø§Ù„ Ø§Ù„Ù…Ø§Ù„ Ù…Ø§Ù„ÙŠØ© Ø§Ù„Ù…Ø§Ù„ÙŠØ© ÙÙ„ÙˆØ³ Ø§Ù„ÙÙ„ÙˆØ³ Ø±Ø§Ø³ Ø±Ø£Ø³ Ø±Ø£Ø³Ù…Ø§Ù„ Ø³Ù†ÙˆÙŠ Ø§Ù„Ø³Ù†ÙˆÙŠ Ø´Ù‡Ø±ÙŠ Ø§Ù„Ø´Ù‡Ø±ÙŠ ÙŠÙˆÙ…ÙŠ Ø§Ù„ÙŠÙˆÙ…ÙŠ Ø±Ø¨Ø¹ÙŠ Ù†ØµÙ ØªØ±Ø§ÙƒÙ… Ø§Ù„ØªØ±Ø§ÙƒÙ… ØªØ±Ø§ÙƒÙ…ÙŠ Ø±ØµÙŠØ¯ Ø§Ù„Ø±ØµÙŠØ¯ Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¨Ù„Øº Ø§ØµÙ„ÙŠ Ø§Ù„Ø§ØµÙ„ÙŠ Ù…Ø¹Ø¯Ù„ Ø§Ù„Ù…Ø¹Ø¯Ù„ Ù†Ø³Ø¨Ø© Ø§Ù„Ù†Ø³Ø¨Ø© Ø­Ø³Ø§Ø¨ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ø­Ø³Ø¨ interest loan compound simple bank money investment","category":"calculators","categoryName":"Ø­Ø§Ø³Ø¨Ø§Øª","url":"../../ar/tools/interest-calculator.html"},{"id":"loan-calculator","icon":"ğŸ¦","name":"Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ù‚Ø±ÙˆØ¶","keywords":"Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ù‚Ø±ÙˆØ¶ØŒ Ù‚Ø³Ø· Ø´Ù‡Ø±ÙŠØŒ Ø¬Ø¯ÙˆÙ„ Ø³Ø¯Ø§Ø¯ØŒ ÙØ§Ø¦Ø¯Ø© Ø§Ù„Ù‚Ø±Ø¶ØŒ loan calculator","searchTerms":"Ù‚Ø±Ø¶ Ø§Ù„Ù‚Ø±Ø¶ Ù‚Ø±ÙˆØ¶ Ø§Ù„Ù‚Ø±ÙˆØ¶ ØªÙ…ÙˆÙŠÙ„ Ø§Ù„ØªÙ…ÙˆÙŠÙ„ Ø¨Ù†Ùƒ Ø§Ù„Ø¨Ù†Ùƒ Ø¨Ù†ÙˆÙƒ Ù‚Ø³Ø· Ø§Ù„Ù‚Ø³Ø· Ø§Ù‚Ø³Ø§Ø· Ø§Ù„Ø§Ù‚Ø³Ø§Ø· Ø´Ù‡Ø±ÙŠ Ø³Ø¯Ø§Ø¯ Ø¬Ø¯ÙˆÙ„ ÙØ§Ø¦Ø¯Ø© ÙÙˆØ§Ø¦Ø¯ ØªÙ‚Ø³ÙŠØ· Ø³ÙŠØ§Ø±Ø© Ù…Ù†Ø²Ù„ Ø¹Ù‚Ø§Ø± Ø´Ø®ØµÙŠ loan payment installment bank mortgage","category":"calculators","categoryName":"Ø­Ø§Ø³Ø¨Ø§Øª","url":"../../ar/tools/loan-calculator.html"},{"id":"body-calculator","icon":"âš–ï¸","name":"Ø­Ø§Ø³Ø¨Ø© ÙƒØªÙ„Ø© Ø§Ù„Ø¬Ø³Ù…","keywords":"Ø­Ø§Ø³Ø¨Ø© BMIØŒ Ù…Ø¤Ø´Ø± ÙƒØªÙ„Ø© Ø§Ù„Ø¬Ø³Ù…ØŒ Ø§Ù„ÙˆØ²Ù† Ø§Ù„Ù…Ø«Ø§Ù„ÙŠØŒ Ø§Ù„Ø³Ø¹Ø±Ø§Øª Ø§Ù„Ø­Ø±Ø§Ø±ÙŠØ©ØŒ Ù†Ø³Ø¨Ø© Ø§Ù„Ø¯Ù‡ÙˆÙ†","searchTerms":"ÙˆØ²Ù† Ø§Ù„ÙˆØ²Ù† ÙƒØªÙ„Ø© Ø§Ù„ÙƒØªÙ„Ø© Ø¬Ø³Ù… Ø§Ù„Ø¬Ø³Ù… bmi Ø¨ÙŠ Ø§Ù… Ø§ÙŠ Ù…Ø¤Ø´Ø± Ø³Ù…Ù†Ø© Ø§Ù„Ø³Ù…Ù†Ø© Ù†Ø­Ø§ÙØ© Ø¯Ù‡ÙˆÙ† Ø§Ù„Ø¯Ù‡ÙˆÙ† Ø³Ø¹Ø±Ø§Øª Ø§Ù„Ø³Ø¹Ø±Ø§Øª Ø­Ø±Ø§Ø±ÙŠØ© Ø§ÙŠØ¶ Ø§Ù„Ø§ÙŠØ¶ Ù…Ø«Ø§Ù„ÙŠ Ø§Ù„Ù…Ø«Ø§Ù„ÙŠ Ø·ÙˆÙ„ Ø§Ù„Ø·ÙˆÙ„ Ø®ØµØ± Ø§Ù„Ø®ØµØ± ÙˆØ±Ùƒ body mass index weight fat calories ideal","category":"calculators","categoryName":"Ø­Ø§Ø³Ø¨Ø§Øª","url":"../../ar/tools/body-calculator.html"},{"id":"age-calculator","icon":"ğŸ‚","name":"Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ø¹Ù…Ø±","keywords":"Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ø¹Ù…Ø±ØŒ Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¹Ù…Ø±ØŒ ÙƒÙ… Ø¹Ù…Ø±ÙŠØŒ Ø§Ù„Ø¨Ø±Ø¬ Ø§Ù„ÙÙ„ÙƒÙŠØŒ Ø¹ÙŠØ¯ Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯","searchTerms":"Ø¹Ù…Ø± Ø§Ù„Ø¹Ù…Ø± Ø¹Ù…Ø±ÙŠ Ø³Ù† Ø§Ù„Ø³Ù† ÙƒÙ… Ù…ÙŠÙ„Ø§Ø¯ Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯ ØªØ§Ø±ÙŠØ® Ø¨Ø±Ø¬ Ø§Ù„Ø¨Ø±Ø¬ Ø§Ø¨Ø±Ø§Ø¬ ÙÙ„ÙƒÙŠ Ø²ÙˆØ¯ÙŠØ§Ùƒ Ø³Ù†Ø© Ø´Ù‡Ø± ÙŠÙˆÙ… age birthday birth date zodiac calculate how old","category":"calculators","categoryName":"Ø­Ø§Ø³Ø¨Ø§Øª","url":"../../ar/tools/age-calculator.html"},{"id":"family-tree","icon":"ğŸŒ³","name":"Ø´Ø¬Ø±Ø© Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©","keywords":"Ø´Ø¬Ø±Ø© Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©ØŒ Ø´Ø¬Ø±Ø© Ø¹Ø§Ø¦Ù„Ø©ØŒ Ù†Ø³Ø¨ØŒ Ø³Ù„Ø§Ù„Ø©ØŒ Ø£Ù†Ø³Ø§Ø¨ØŒ Ø¹Ù„Ø§Ù‚Ø§Øª Ø¹Ø§Ø¦Ù„ÙŠØ©ØŒ family tree","searchTerms":"Ø´Ø¬Ø±Ø© Ø¹Ø§Ø¦Ù„Ø© Ø¹Ø§Ø¦Ù„Ù‡ Ø§Ù„Ø¹Ø§Ø¦Ù„Ù‡ Ø§Ù„Ø¹Ø§Ø¦Ù„Ø© Ù†Ø³Ø¨ Ø£Ù†Ø³Ø§Ø¨ Ø§Ù„Ø£Ù†Ø³Ø§Ø¨ Ø³Ù„Ø§Ù„Ø© Ø¬Ø¯ Ø¬Ø¯Ø© Ø£Ø¨ Ø£Ù… Ø§Ø¨Ù† Ø§Ø¨Ù†Ø© Ø£Ø® Ø£Ø®Øª Ø¹Ù… Ø¹Ù…Ø© Ø®Ø§Ù„ Ø®Ø§Ù„Ø© Ù‚Ø±Ø§Ø¨Ø© Ù‚Ø±ÙŠØ¨ Ø£Ù‚Ø§Ø±Ø¨ Ø§Ù„Ø£Ù‚Ø§Ø±Ø¨ Ù†Ø³Ù„ Ø°Ø±ÙŠØ© family tree genealogy","category":"everyday","categoryName":"Ø£Ø¯ÙˆØ§Øª ÙŠÙˆÙ…ÙŠØ©","url":"../../ar/tools/family-tree.html"}];
</script>
      </main>
      
      <footer class="main-footer">
        <p>ØµÙÙ†Ø¹ Ø¨Ù€ â¤ï¸ | Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø© Â© 2026 Ø¹ÙØ¯Ù‘Ø©</p>
      </footer>
    </div>
  </div>
  
  <!-- Settings Panel -->
  <div class="settings-overlay"></div>
  <div class="settings-panel">
    <div class="settings-header">
      <h2 class="settings-title">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</h2>
      <button class="settings-close" aria-label="Close">âœ•</button>
    </div>
    <div class="settings-content">
      <div class="settings-section">
        <div class="settings-section-title">Ø§Ù„Ù„ØºØ©</div>
        <div class="settings-option">
          <button class="settings-btn active" data-lang-btn="ar">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</button>
          <button class="settings-btn " data-lang-btn="en">English</button>
        </div>
      </div>
      <div class="settings-section">
        <div class="settings-section-title">Ø§Ù„Ù…Ø¸Ù‡Ø±</div>
        <div class="settings-option">
          <button class="settings-btn" data-theme-btn="light">â˜€ï¸ ÙØ§ØªØ­</button>
          <button class="settings-btn" data-theme-btn="dark">ğŸŒ™ Ø¯Ø§ÙƒÙ†</button>
          <button class="settings-btn active" data-theme-btn="auto">ğŸ’» ØªÙ„Ù‚Ø§Ø¦ÙŠ</button>
        </div>
      </div>
      <div class="settings-section">
        <button class="settings-btn" data-clear-data style="width:100%;justify-content:center;color:var(--error);">
          ğŸ—‘ï¸ Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©
        </button>
      </div>
    </div>
  </div>
  
  <div class="toast"></div>
  <script src="../../assets/js/app.js"></script>
</body>
</html>