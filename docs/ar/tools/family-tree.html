<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Ø´Ø¬Ø±Ø© Ø§Ù„Ø¹Ø§Ø¦Ù„Ø© - Ø£Ù†Ø´Ø¦ Ø´Ø¬Ø±Ø© Ø¹Ø§Ø¦Ù„ØªÙƒ Ù…Ø¬Ø§Ù†Ø§Ù‹ | Ø¹ÙØ¯Ù‘Ø©</title>
  <meta name="description" content="Ø£Ø¯Ø§Ø© Ù…Ø¬Ø§Ù†ÙŠØ© Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø´Ø¬Ø±Ø© Ø§Ù„Ø¹Ø§Ø¦Ù„Ø© Ø¨Ø³Ù‡ÙˆÙ„Ø©. Ø£Ø¶Ù Ø§Ù„Ø£Ø´Ø®Ø§Øµ ÙˆØ§Ù„Ø¹Ù„Ø§Ù‚Ø§ØªØŒ Ø§Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±ØŒ ÙˆØµØ¯Ù‘Ø± Ø§Ù„Ø´Ø¬Ø±Ø© ÙƒØµÙˆØ±Ø© Ø£Ùˆ PDF.">
  <meta name="keywords" content="Ø´Ø¬Ø±Ø© Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©ØŒ Ø´Ø¬Ø±Ø© Ø¹Ø§Ø¦Ù„Ø©ØŒ Ù†Ø³Ø¨ØŒ Ø³Ù„Ø§Ù„Ø©ØŒ Ø£Ù†Ø³Ø§Ø¨ØŒ Ø¹Ù„Ø§Ù‚Ø§Øª Ø¹Ø§Ø¦Ù„ÙŠØ©ØŒ family tree">
  <meta name="author" content="Udda">
  <meta name="robots" content="index, follow">
  
  <meta property="og:type" content="website">
  <meta property="og:title" content="Ø´Ø¬Ø±Ø© Ø§Ù„Ø¹Ø§Ø¦Ù„Ø© - Ø£Ù†Ø´Ø¦ Ø´Ø¬Ø±Ø© Ø¹Ø§Ø¦Ù„ØªÙƒ Ù…Ø¬Ø§Ù†Ø§Ù‹ | Ø¹ÙØ¯Ù‘Ø©">
  <meta property="og:description" content="Ø£Ø¯Ø§Ø© Ù…Ø¬Ø§Ù†ÙŠØ© Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø´Ø¬Ø±Ø© Ø§Ù„Ø¹Ø§Ø¦Ù„Ø© Ø¨Ø³Ù‡ÙˆÙ„Ø©. Ø£Ø¶Ù Ø§Ù„Ø£Ø´Ø®Ø§Øµ ÙˆØ§Ù„Ø¹Ù„Ø§Ù‚Ø§ØªØŒ Ø§Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±ØŒ ÙˆØµØ¯Ù‘Ø± Ø§Ù„Ø´Ø¬Ø±Ø© ÙƒØµÙˆØ±Ø© Ø£Ùˆ PDF.">
  <meta property="og:url" content="https://udda.tools/ar/tools/family-tree.html">
  <meta property="og:site_name" content="Ø¹ÙØ¯Ù‘Ø©">
  <meta property="og:locale" content="ar_SA">
  
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Ø´Ø¬Ø±Ø© Ø§Ù„Ø¹Ø§Ø¦Ù„Ø© - Ø£Ù†Ø´Ø¦ Ø´Ø¬Ø±Ø© Ø¹Ø§Ø¦Ù„ØªÙƒ Ù…Ø¬Ø§Ù†Ø§Ù‹ | Ø¹ÙØ¯Ù‘Ø©">
  <meta name="twitter:description" content="Ø£Ø¯Ø§Ø© Ù…Ø¬Ø§Ù†ÙŠØ© Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø´Ø¬Ø±Ø© Ø§Ù„Ø¹Ø§Ø¦Ù„Ø© Ø¨Ø³Ù‡ÙˆÙ„Ø©. Ø£Ø¶Ù Ø§Ù„Ø£Ø´Ø®Ø§Øµ ÙˆØ§Ù„Ø¹Ù„Ø§Ù‚Ø§ØªØŒ Ø§Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±ØŒ ÙˆØµØ¯Ù‘Ø± Ø§Ù„Ø´Ø¬Ø±Ø© ÙƒØµÙˆØ±Ø© Ø£Ùˆ PDF.">
  
  <link rel="alternate" hreflang="ar" href="https://udda.tools/ar/tools/family-tree.html">
  <link rel="alternate" hreflang="en" href="https://udda.tools/en/tools/family-tree.html">
  <link rel="alternate" hreflang="x-default" href="https://udda.tools/ar/tools/family-tree.html">
  <link rel="canonical" href="https://udda.tools/ar/tools/family-tree.html">
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../../assets/css/main.css">
  
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "WebApplication",
    "name": "Ø´Ø¬Ø±Ø© Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©",
    "description": "Ø£Ø¯Ø§Ø© Ù…Ø¬Ø§Ù†ÙŠØ© Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø´Ø¬Ø±Ø© Ø§Ù„Ø¹Ø§Ø¦Ù„Ø© Ø¨Ø³Ù‡ÙˆÙ„Ø©. Ø£Ø¶Ù Ø§Ù„Ø£Ø´Ø®Ø§Øµ ÙˆØ§Ù„Ø¹Ù„Ø§Ù‚Ø§ØªØŒ Ø§Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±ØŒ ÙˆØµØ¯Ù‘Ø± Ø§Ù„Ø´Ø¬Ø±Ø© ÙƒØµÙˆØ±Ø© Ø£Ùˆ PDF.",
    "url": "https://udda.tools/ar/tools/family-tree.html",
    "applicationCategory": "UtilityApplication",
    "operatingSystem": "Any",
    "offers": { "@type": "Offer", "price": "0", "priceCurrency": "USD" },
    "inLanguage": ["ar", "en"],
    "isAccessibleForFree": true
  }
  </script>
</head>
<body data-tool-id="family-tree">
  <div class="app-container">
    <div class="sidebar-overlay"></div>
    
    <aside class="sidebar">
      <div class="sidebar-header">
        <a href="../../ar/" class="logo">
          <div class="logo-icon">ğŸ”§</div>
          <span class="logo-text sidebar-text">Ø¹ÙØ¯Ù‘Ø©</span>
        </a>
      </div>
      
      <div class="sidebar-search">
        <div class="search-input-wrapper">
          <input type="text" class="search-input" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø£Ø¯Ø§Ø©..." aria-label="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø£Ø¯Ø§Ø©...">
          <svg class="search-icon" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <circle cx="11" cy="11" r="8"></circle>
            <path d="m21 21-4.35-4.35"></path>
          </svg>
        </div>
      </div>
      
      <nav class="sidebar-nav">
        
        <a href="../../ar/" class="nav-item ">
          <span class="nav-item-icon">ğŸ </span>
          <span class="sidebar-text">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span>
        </a>
        <div class="nav-section ">
          <div class="nav-section-title">
            <span>
              <span class="nav-section-icon">ğŸ§®</span>
              <span class="sidebar-text">Ø­Ø§Ø³Ø¨Ø§Øª</span>
            </span>
            <svg class="nav-section-arrow sidebar-text" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path d="m6 9 6 6 6-6"></path>
            </svg>
          </div>
          <div class="nav-section-items">
            <a href="../../ar/tools/percentage.html" class="nav-item ">
              <span class="nav-item-icon">ğŸ”¢</span>
              <span class="sidebar-text">Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø¦ÙˆÙŠØ©</span>
            </a>
            <a href="../../ar/tools/interest-calculator.html" class="nav-item ">
              <span class="nav-item-icon">ğŸ’°</span>
              <span class="sidebar-text">Ø­Ø§Ø³Ø¨Ø© Ø§Ù„ÙÙˆØ§Ø¦Ø¯</span>
            </a>
            <a href="../../ar/tools/loan-calculator.html" class="nav-item ">
              <span class="nav-item-icon">ğŸ¦</span>
              <span class="sidebar-text">Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ù‚Ø±ÙˆØ¶</span>
            </a>
            <a href="../../ar/tools/body-calculator.html" class="nav-item ">
              <span class="nav-item-icon">âš–ï¸</span>
              <span class="sidebar-text">Ø­Ø§Ø³Ø¨Ø© ÙƒØªÙ„Ø© Ø§Ù„Ø¬Ø³Ù…</span>
            </a>
            <a href="../../ar/tools/age-calculator.html" class="nav-item ">
              <span class="nav-item-icon">ğŸ‚</span>
              <span class="sidebar-text">Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ø¹Ù…Ø±</span>
            </a>
          </div>
        </div>
        <div class="nav-section ">
          <div class="nav-section-title">
            <span>
              <span class="nav-section-icon">ğŸ”„</span>
              <span class="sidebar-text">Ù…Ø­ÙˆÙ‘Ù„Ø§Øª</span>
            </span>
            <svg class="nav-section-arrow sidebar-text" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path d="m6 9 6 6 6-6"></path>
            </svg>
          </div>
          <div class="nav-section-items">
          </div>
        </div>
        <div class="nav-section ">
          <div class="nav-section-title">
            <span>
              <span class="nav-section-icon">ğŸ“</span>
              <span class="sidebar-text">Ø£Ø¯ÙˆØ§Øª Ù†ØµÙŠØ©</span>
            </span>
            <svg class="nav-section-arrow sidebar-text" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path d="m6 9 6 6 6-6"></path>
            </svg>
          </div>
          <div class="nav-section-items">
          </div>
        </div>
        <div class="nav-section ">
          <div class="nav-section-title">
            <span>
              <span class="nav-section-icon">ğŸ“…</span>
              <span class="sidebar-text">ÙˆÙ‚Øª ÙˆØªØ§Ø±ÙŠØ®</span>
            </span>
            <svg class="nav-section-arrow sidebar-text" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path d="m6 9 6 6 6-6"></path>
            </svg>
          </div>
          <div class="nav-section-items">
          </div>
        </div>
        <div class="nav-section ">
          <div class="nav-section-title">
            <span>
              <span class="nav-section-icon">âš¡</span>
              <span class="sidebar-text">Ù…ÙˆÙ„Ù‘Ø¯Ø§Øª</span>
            </span>
            <svg class="nav-section-arrow sidebar-text" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path d="m6 9 6 6 6-6"></path>
            </svg>
          </div>
          <div class="nav-section-items">
          </div>
        </div>
        <div class="nav-section ">
          <div class="nav-section-title">
            <span>
              <span class="nav-section-icon">ğŸ–¼ï¸</span>
              <span class="sidebar-text">Ø£Ø¯ÙˆØ§Øª ØµÙˆØ±</span>
            </span>
            <svg class="nav-section-arrow sidebar-text" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path d="m6 9 6 6 6-6"></path>
            </svg>
          </div>
          <div class="nav-section-items">
          </div>
        </div>
        <div class="nav-section ">
          <div class="nav-section-title">
            <span>
              <span class="nav-section-icon">ğŸ’»</span>
              <span class="sidebar-text">Ø£Ø¯ÙˆØ§Øª Ù…Ø·ÙˆØ±ÙŠÙ†</span>
            </span>
            <svg class="nav-section-arrow sidebar-text" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path d="m6 9 6 6 6-6"></path>
            </svg>
          </div>
          <div class="nav-section-items">
          </div>
        </div>
        <div class="nav-section open">
          <div class="nav-section-title">
            <span>
              <span class="nav-section-icon">ğŸ </span>
              <span class="sidebar-text">Ø£Ø¯ÙˆØ§Øª ÙŠÙˆÙ…ÙŠØ©</span>
            </span>
            <svg class="nav-section-arrow sidebar-text" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path d="m6 9 6 6 6-6"></path>
            </svg>
          </div>
          <div class="nav-section-items">
            <a href="../../ar/tools/family-tree.html" class="nav-item active">
              <span class="nav-item-icon">ğŸŒ³</span>
              <span class="sidebar-text">Ø´Ø¬Ø±Ø© Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©</span>
            </a>
          </div>
        </div>
      </nav>
      
      <div class="sidebar-footer">
        <button class="sidebar-toggle" aria-label="Toggle sidebar">
          <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path d="M11 19l-7-7 7-7m8 14l-7-7 7-7"></path>
          </svg>
          <span class="sidebar-text">Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ©</span>
        </button>
      </div>
    </aside>
    
    <div class="main-content">
      <header class="main-header">
        <button class="header-btn mobile-menu-btn" aria-label="Menu">
          <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path d="M4 6h16M4 12h16M4 18h16"></path>
          </svg>
        </button>
        
        <nav class="header-breadcrumb">
          <a href="../../ar/" class="breadcrumb-link">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
          <span class="breadcrumb-separator">â€º</span>
          <a href="../../ar/category/everyday.html" class="breadcrumb-link">Ø£Ø¯ÙˆØ§Øª ÙŠÙˆÙ…ÙŠØ©</a>
          <span class="breadcrumb-separator">â€º</span>
          <span class="breadcrumb-current">Ø´Ø¬Ø±Ø© Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©</span>
        </nav>
        
        <div class="header-actions">
          <button class="header-btn" data-favorite-btn aria-label="Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ù…ÙØ¶Ù„Ø©">â˜†</button>
          <button class="header-btn" onclick="App.shareUrl('Ø´Ø¬Ø±Ø© Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©')" aria-label="Ù…Ø´Ø§Ø±ÙƒØ©">
            <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"></path>
              <polyline points="16 6 12 2 8 6"></polyline>
              <line x1="12" y1="2" x2="12" y2="15"></line>
            </svg>
          </button>
          <button class="header-btn" data-open-settings aria-label="Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª">
            <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <circle cx="12" cy="12" r="3"></circle>
              <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
            </svg>
          </button>
        </div>
      </header>
      
      <main class="page-content">
        <style>
:root {
  --primary: #059669;
  --primary-dark: #047857;
  --male-color: #3b82f6;
  --female-color: #ec4899;
  --marriage-color: #f59e0b;
  --bg-secondary: #1e293b;
  --bg-card: #334155;
  --text-primary: #f8fafc;
  --text-secondary: #94a3b8;
  --text-muted: #64748b;
  --border-color: #475569;
  --danger: #ef4444;
}

* { box-sizing: border-box; }

.ft-app { display: flex; flex-direction: column; gap: 8px; min-height: 65vh; }

/* Toolbar */
.ft-toolbar {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
  padding: 10px 12px;
  background: var(--bg-secondary);
  border-radius: 8px;
  align-items: center;
}

.ft-toolbar-group {
  display: flex;
  gap: 4px;
  padding-left: 10px;
  border-left: 2px solid var(--border-color);
}

.ft-toolbar-group:first-child { border-left: none; padding-left: 0; }

.ft-btn {
  display: flex;
  align-items: center;
  gap: 5px;
  padding: 7px 12px;
  background: var(--bg-card);
  border: 2px solid var(--border-color);
  border-radius: 6px;
  color: var(--text-primary);
  font-size: 0.8rem;
  font-weight: 600;
  cursor: pointer;
  font-family: inherit;
  transition: all 0.2s;
}

.ft-btn:hover { border-color: var(--primary); }
.ft-btn.primary { background: var(--primary); border-color: var(--primary); }
.ft-btn.primary:hover { background: var(--primary-dark); }
.ft-btn .ic { font-size: 1rem; }

/* Persons Panel */
.ft-persons-panel {
  background: var(--bg-secondary);
  border-radius: 8px;
  overflow: hidden;
  max-height: 0;
  transition: max-height 0.3s;
}

.ft-persons-panel.open { max-height: 250px; }

.ft-persons-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 10px 14px;
  border-bottom: 2px solid var(--border-color);
  cursor: pointer;
}

.ft-persons-header h4 { margin: 0; font-size: 0.85rem; color: var(--text-primary); display: flex; align-items: center; gap: 6px; }
.ft-persons-header .count { background: var(--primary); color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.7rem; }
.ft-persons-header .arrow { transition: transform 0.3s; color: var(--text-muted); }
.ft-persons-panel.open .ft-persons-header .arrow { transform: rotate(180deg); }

.ft-persons-body { display: flex; gap: 8px; padding: 10px; overflow-x: auto; }

.ft-person-chip {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 6px 10px;
  background: var(--bg-card);
  border: 2px solid var(--border-color);
  border-radius: 20px;
  cursor: pointer;
  white-space: nowrap;
  transition: all 0.2s;
}

.ft-person-chip:hover { border-color: var(--primary); }
.ft-person-chip.orphan { border-style: dashed; border-color: var(--text-muted); }
.ft-person-chip.male { border-color: var(--male-color); }
.ft-person-chip.female { border-color: var(--female-color); }
.ft-person-chip .av { font-size: 1rem; }
.ft-person-chip .nm { font-size: 0.75rem; font-weight: 600; color: var(--text-primary); }

/* Canvas */
.ft-canvas {
  flex: 1;
  position: relative;
  background: var(--bg-secondary);
  border-radius: 8px;
  overflow: hidden;
  min-height: 400px;
  border: 2px solid var(--border-color);
}

.ft-svg { width: 100%; height: 100%; min-height: 400px; cursor: grab; }
.ft-svg:active { cursor: grabbing; }
.ft-svg text { font-family: inherit; }

.ft-empty {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  text-align: center;
  color: var(--text-muted);
  pointer-events: none;
}

.ft-empty .ic { font-size: 3rem; margin-bottom: 10px; opacity: 0.5; }
.ft-empty h3 { margin: 0; color: var(--text-secondary); }

/* Zoom */
.ft-zoom {
  position: absolute;
  bottom: 12px;
  right: 12px;
  display: flex;
  flex-direction: column;
  gap: 4px;
  background: var(--bg-card);
  padding: 5px;
  border-radius: 6px;
  border: 2px solid var(--border-color);
}

.ft-zoom-btn {
  width: 30px;
  height: 30px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: var(--bg-secondary);
  border: none;
  border-radius: 4px;
  color: var(--text-primary);
  font-size: 1rem;
  cursor: pointer;
}

.ft-zoom-btn:hover { background: var(--primary); }
.ft-zoom-lvl { text-align: center; font-size: 0.7rem; color: var(--text-muted); }

/* Stats */
.ft-stats {
  display: flex;
  gap: 15px;
  padding: 8px 14px;
  background: var(--bg-card);
  border-radius: 6px;
  flex-wrap: wrap;
}

.ft-stat { display: flex; align-items: center; gap: 5px; font-size: 0.8rem; }
.ft-stat .lbl { color: var(--text-muted); }
.ft-stat .val { font-weight: 700; color: var(--text-primary); }

/* Modal */
.ft-modal-bg {
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.75);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
  opacity: 0;
  visibility: hidden;
  transition: all 0.3s;
}

.ft-modal-bg.show { opacity: 1; visibility: visible; }

.ft-modal {
  background: var(--bg-secondary);
  border-radius: 12px;
  width: 92%;
  max-width: 400px;
  max-height: 85vh;
  overflow-y: auto;
  transform: scale(0.9);
  transition: transform 0.3s;
}

.ft-modal-bg.show .ft-modal { transform: scale(1); }

.ft-modal-head {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 12px 16px;
  border-bottom: 2px solid var(--border-color);
  position: sticky;
  top: 0;
  background: var(--bg-secondary);
}

.ft-modal-head h2 { font-size: 1rem; color: var(--text-primary); margin: 0; }

.ft-modal-close {
  background: none;
  border: none;
  font-size: 1.3rem;
  color: var(--text-muted);
  cursor: pointer;
  padding: 2px 6px;
  border-radius: 4px;
}

.ft-modal-close:hover { background: var(--bg-card); color: var(--text-primary); }

.ft-modal-body { padding: 14px 16px; }

.ft-form-group { margin-bottom: 14px; }
.ft-form-group label { display: block; font-size: 0.8rem; font-weight: 600; color: var(--text-secondary); margin-bottom: 5px; }

.ft-form-group input,
.ft-form-group select,
.ft-form-group textarea {
  width: 100%;
  padding: 9px 11px;
  background: var(--bg-card);
  border: 2px solid var(--border-color);
  border-radius: 6px;
  color: var(--text-primary);
  font-size: 0.9rem;
  font-family: inherit;
}

.ft-form-group input:focus,
.ft-form-group select:focus,
.ft-form-group textarea:focus { outline: none; border-color: var(--primary); }

.ft-form-row { display: flex; gap: 10px; }
.ft-form-row .ft-form-group { flex: 1; }

/* Gender Toggle */
.ft-gender { display: flex; gap: 8px; }

.ft-gender-opt {
  flex: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 5px;
  padding: 10px;
  background: var(--bg-card);
  border: 2px solid var(--border-color);
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.2s;
}

.ft-gender-opt input { display: none; }
.ft-gender-opt.male:has(input:checked) { border-color: var(--male-color); background: rgba(59,130,246,0.15); }
.ft-gender-opt.female:has(input:checked) { border-color: var(--female-color); background: rgba(236,72,153,0.15); }
.ft-gender-opt span { font-weight: 600; font-size: 0.85rem; }

/* Photo */
.ft-photo-row { display: flex; align-items: center; gap: 12px; }

.ft-photo-preview {
  width: 55px;
  height: 55px;
  border-radius: 50%;
  background: var(--bg-card);
  border: 2px solid var(--border-color);
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
}

.ft-photo-preview img { width: 100%; height: 100%; object-fit: cover; }
.ft-photo-preview .ph { font-size: 1.5rem; color: var(--text-muted); }

.ft-photo-btns { display: flex; flex-direction: column; gap: 5px; }

.ft-photo-btn {
  padding: 5px 10px;
  background: var(--bg-card);
  border: 2px solid var(--border-color);
  border-radius: 5px;
  color: var(--text-primary);
  font-size: 0.75rem;
  cursor: pointer;
  font-family: inherit;
}

.ft-photo-btn:hover { border-color: var(--primary); }
.ft-photo-btn.rm { border-color: var(--danger); color: var(--danger); }

/* Person Select */
.ft-person-select {
  border: 2px solid var(--border-color);
  border-radius: 6px;
  overflow: hidden;
}

.ft-person-select-search {
  width: 100%;
  padding: 8px 10px;
  background: var(--bg-card);
  border: none;
  border-bottom: 1px solid var(--border-color);
  color: var(--text-primary);
  font-size: 0.85rem;
  font-family: inherit;
}

.ft-person-select-search:focus { outline: none; }

.ft-person-select-list { max-height: 150px; overflow-y: auto; }

.ft-person-opt {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 7px 9px;
  cursor: pointer;
  border: 2px solid transparent;
  margin: 4px;
  border-radius: 5px;
}

.ft-person-opt:hover { background: var(--bg-card); }
.ft-person-opt.selected { border-color: var(--primary); background: rgba(5,150,105,0.15); }
.ft-person-opt.none { color: var(--text-muted); border: 2px dashed var(--border-color); justify-content: center; }

.ft-person-opt .av { font-size: 1rem; }
.ft-person-opt .nm { font-size: 0.85rem; color: var(--text-primary); }

/* Status Options */
.ft-status-opts { display: flex; gap: 6px; flex-wrap: wrap; }

.ft-status-opt {
  flex: 1;
  min-width: 80px;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 4px;
  padding: 10px 6px;
  background: var(--bg-card);
  border: 2px solid var(--border-color);
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.2s;
}

.ft-status-opt input { display: none; }
.ft-status-opt:has(input:checked) { border-color: var(--primary); background: rgba(5,150,105,0.15); }
.ft-status-opt .ic { font-size: 1.2rem; }
.ft-status-opt .tx { font-size: 0.7rem; color: var(--text-secondary); text-align: center; }

/* Modal Footer */
.ft-modal-foot {
  display: flex;
  gap: 8px;
  padding: 12px 16px;
  border-top: 2px solid var(--border-color);
  position: sticky;
  bottom: 0;
  background: var(--bg-secondary);
}

.ft-modal-foot button {
  flex: 1;
  padding: 10px;
  border-radius: 6px;
  font-size: 0.9rem;
  font-weight: 700;
  cursor: pointer;
  font-family: inherit;
}

.ft-btn-cancel { background: var(--bg-card); border: 2px solid var(--border-color); color: var(--text-primary); }
.ft-btn-save { background: var(--primary); border: none; color: white; }
.ft-btn-save:hover { background: var(--primary-dark); }
.ft-btn-del { background: var(--danger); border: none; color: white; flex: 0.4; }

/* Tabs */
.ft-tabs { display: flex; border-bottom: 2px solid var(--border-color); margin-bottom: 14px; }

.ft-tab {
  flex: 1;
  padding: 9px;
  background: none;
  border: none;
  color: var(--text-muted);
  font-weight: 600;
  cursor: pointer;
  font-family: inherit;
  font-size: 0.85rem;
  border-bottom: 2px solid transparent;
  margin-bottom: -2px;
}

.ft-tab.active { color: var(--primary); border-bottom-color: var(--primary); }

/* Context Menu */
.ft-ctx {
  position: fixed;
  background: var(--bg-card);
  border: 2px solid var(--border-color);
  border-radius: 8px;
  min-width: 150px;
  z-index: 2000;
  box-shadow: 0 8px 25px rgba(0,0,0,0.4);
  display: none;
}

.ft-ctx.show { display: block; }

.ft-ctx-item {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 9px 14px;
  color: var(--text-primary);
  cursor: pointer;
  font-size: 0.85rem;
}

.ft-ctx-item:first-child { border-radius: 6px 6px 0 0; }
.ft-ctx-item:last-child { border-radius: 0 0 6px 6px; }
.ft-ctx-item:hover { background: var(--bg-secondary); }
.ft-ctx-item.danger { color: var(--danger); }

.ft-ctx-divider { height: 1px; background: var(--border-color); margin: 3px 0; }

/* Add Menu */
.ft-add-menu {
  position: fixed;
  background: var(--bg-card);
  border: 2px solid var(--primary);
  border-radius: 8px;
  min-width: 160px;
  z-index: 2000;
  box-shadow: 0 8px 25px rgba(0,0,0,0.5);
  display: none;
  transform: translate(-50%, 5px);
}

.ft-add-menu.show { display: block; }

.ft-add-item {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 10px 14px;
  color: var(--text-primary);
  cursor: pointer;
  font-size: 0.85rem;
  font-weight: 500;
}

.ft-add-item:first-child { border-radius: 6px 6px 0 0; }
.ft-add-item:last-child { border-radius: 0 0 6px 6px; }
.ft-add-item:hover { background: var(--primary); }

/* Drag Ghost */
.ft-drag-ghost {
  position: fixed;
  pointer-events: none;
  z-index: 3000;
  opacity: 0.85;
  transform: translate(-50%, -50%);
}

/* Toast */
.ft-toast {
  position: fixed;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%) translateY(100px);
  background: var(--bg-card);
  border: 2px solid var(--primary);
  padding: 12px 20px;
  border-radius: 8px;
  color: var(--text-primary);
  font-weight: 600;
  z-index: 3000;
  opacity: 0;
  transition: all 0.3s;
}

.ft-toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }

/* Dropdown */
.ft-dropdown { position: relative; }

.ft-dropdown-menu {
  position: absolute;
  top: 100%;
  right: 0;
  margin-top: 5px;
  background: var(--bg-card);
  border: 2px solid var(--border-color);
  border-radius: 6px;
  min-width: 120px;
  z-index: 100;
  opacity: 0;
  visibility: hidden;
  transform: translateY(-5px);
  transition: all 0.2s;
}

.ft-dropdown.open .ft-dropdown-menu { opacity: 1; visibility: visible; transform: translateY(0); }

.ft-dropdown-item { display: flex; align-items: center; gap: 6px; padding: 8px 12px; color: var(--text-primary); font-size: 0.8rem; cursor: pointer; }
.ft-dropdown-item:hover { background: var(--bg-secondary); }

.ft-dropdown-divider { height: 1px; background: var(--border-color); margin: 3px 0; }

.hidden { display: none; }

/* Relation Info */
.ft-rel-info {
  background: var(--bg-card);
  border-radius: 8px;
  padding: 12px;
  margin-bottom: 14px;
}

.ft-rel-info .title { font-size: 0.75rem; color: var(--text-muted); margin-bottom: 8px; }

.ft-rel-info .person-row {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 8px;
  background: var(--bg-secondary);
  border-radius: 6px;
  margin-bottom: 6px;
}

.ft-rel-info .person-row .av { font-size: 1.2rem; }
.ft-rel-info .person-row .info { flex: 1; }
.ft-rel-info .person-row .nm { font-weight: 600; color: var(--text-primary); font-size: 0.85rem; }
.ft-rel-info .person-row .role { font-size: 0.7rem; color: var(--text-muted); }

@media (max-width: 600px) {
  .ft-btn span:not(.ic) { display: none; }
  .ft-toolbar-group { border-left: none; padding-left: 0; }
}
</style>

<div class="tool-card">
  <div class="tool-header">
    <div class="tool-icon">ğŸŒ³</div>
    <div>
      <h1 class="tool-title">Ø´Ø¬Ø±Ø© Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©</h1>
      <p class="tool-description">Ø£Ù†Ø´Ø¦ Ø´Ø¬Ø±Ø© Ø¹Ø§Ø¦Ù„ØªÙƒ Ø¨Ø³Ù‡ÙˆÙ„Ø© ÙˆØµØ¯Ù‘Ø±Ù‡Ø§ ÙƒØµÙˆØ±Ø©</p>
    </div>
  </div>

  <div class="ft-app">
    <!-- Toolbar -->
    <div class="ft-toolbar">
      <div class="ft-toolbar-group">
        <button class="ft-btn primary" onclick="openPersonModal()"><span class="ic">â•</span><span id="txt-add">Ø¥Ø¶Ø§ÙØ© Ø´Ø®Øµ</span></button>
        <button class="ft-btn" onclick="togglePersonsPanel()"><span class="ic">ğŸ‘¥</span><span id="txt-persons">Ø§Ù„Ø£Ø´Ø®Ø§Øµ</span> <span id="persons-count-badge">(0)</span></button>
      </div>
      <div class="ft-toolbar-group">
        <button class="ft-btn" onclick="saveLocal()"><span class="ic">ğŸ’¾</span><span>Ø­ÙØ¸ Ù…Ø­Ù„ÙŠ</span></button>
        <button class="ft-btn" onclick="loadLocal()"><span class="ic">ğŸ“‚</span><span>ØªØ­Ù…ÙŠÙ„ Ù…Ø­ÙÙˆØ¸</span></button>
      </div>
      <div class="ft-toolbar-group">
        <div class="ft-dropdown" id="export-dd">
          <button class="ft-btn" onclick="toggleDD('export-dd')"><span class="ic">ğŸ“¤</span><span>ØªØµØ¯ÙŠØ±</span></button>
          <div class="ft-dropdown-menu">
            <div class="ft-dropdown-item" onclick="exportPNG()">ğŸ–¼ï¸ PNG</div>
            <div class="ft-dropdown-item" onclick="exportSVG()">ğŸ“ SVG</div>
            <div class="ft-dropdown-divider"></div>
            <div class="ft-dropdown-item" onclick="exportJSON()">ğŸ“„ JSON</div>
          </div>
        </div>
        <button class="ft-btn" onclick="document.getElementById('import-file').click()"><span class="ic">ğŸ“¥</span><span>Ø§Ø³ØªÙŠØ±Ø§Ø¯</span></button>
      </div>
      <div class="ft-toolbar-group">
        <button class="ft-btn" onclick="clearAll()"><span class="ic">ğŸ—‘ï¸</span><span>Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„</span></button>
      </div>
    </div>

    <!-- Persons Panel -->
    <div class="ft-persons-panel" id="persons-panel">
      <div class="ft-persons-header" onclick="togglePersonsPanel()">
        <h4>ğŸ‘¥ <span id="txt-all-persons">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø´Ø®Ø§Øµ</span> <span class="count" id="persons-count">0</span></h4>
        <span class="arrow">â–¼</span>
      </div>
      <div class="ft-persons-body" id="persons-list"></div>
    </div>

    <!-- Canvas -->
    <div class="ft-canvas" id="canvas">
      <svg class="ft-svg" id="svg">
        <defs>
          <filter id="shadow" x="-20%" y="-20%" width="140%" height="140%">
            <feDropShadow dx="0" dy="2" stdDeviation="3" flood-opacity="0.25"/>
          </filter>
        </defs>
        <g id="tree-g">
          <g id="lines-g"></g>
          <g id="cards-g"></g>
        </g>
      </svg>
      <div class="ft-empty" id="empty-msg">
        <div class="ic">ğŸŒ³</div>
        <h3 id="txt-empty">Ø§Ø¨Ø¯Ø£ Ø¨Ø¥Ø¶Ø§ÙØ© Ø´Ø®Øµ</h3>
      </div>
      <div class="ft-zoom">
        <button class="ft-zoom-btn" onclick="zoomIn()">â•</button>
        <div class="ft-zoom-lvl" id="zoom-lvl">100%</div>
        <button class="ft-zoom-btn" onclick="zoomOut()">â–</button>
        <button class="ft-zoom-btn" onclick="fitView()">âŠ¡</button>
      </div>
    </div>

    <!-- Stats -->
    <div class="ft-stats">
      <div class="ft-stat"><span class="lbl">ğŸ‘¥</span><span class="val" id="stat-total">0</span></div>
      <div class="ft-stat"><span class="lbl">ğŸ‘¨</span><span class="val" id="stat-males">0</span></div>
      <div class="ft-stat"><span class="lbl">ğŸ‘©</span><span class="val" id="stat-females">0</span></div>
      <div class="ft-stat"><span class="lbl">ğŸ’‘</span><span class="val" id="stat-marriages">0</span></div>
      <div class="ft-stat"><span class="lbl">ğŸ“Š</span><span class="val" id="stat-gens">0</span></div>
    </div>
  </div>
</div>

<!-- Person Modal -->
<div class="ft-modal-bg" id="person-modal">
  <div class="ft-modal">
    <div class="ft-modal-head">
      <h2 id="pm-title">ğŸ‘¤ Ø¥Ø¶Ø§ÙØ© Ø´Ø®Øµ</h2>
      <button class="ft-modal-close" onclick="closeModal('person-modal')">&times;</button>
    </div>
    <div class="ft-modal-body">
      <div class="ft-form-group">
        <label id="lbl-name">Ø§Ù„Ø§Ø³Ù… *</label>
        <input type="text" id="p-name">
      </div>
      <div class="ft-form-group">
        <label id="lbl-gender">Ø§Ù„Ø¬Ù†Ø³</label>
        <div class="ft-gender">
          <label class="ft-gender-opt male"><input type="radio" name="p-gender" value="male" checked><span>ğŸ‘¨ <span id="lbl-male">Ø°ÙƒØ±</span></span></label>
          <label class="ft-gender-opt female"><input type="radio" name="p-gender" value="female"><span>ğŸ‘© <span id="lbl-female">Ø£Ù†Ø«Ù‰</span></span></label>
        </div>
      </div>
      <div class="ft-form-group">
        <label id="lbl-photo">Ø§Ù„ØµÙˆØ±Ø©</label>
        <div class="ft-photo-row">
          <div class="ft-photo-preview" id="photo-prev"><span class="ph">ğŸ‘¤</span></div>
          <div class="ft-photo-btns">
            <button type="button" class="ft-photo-btn" onclick="document.getElementById('photo-input').click()">ğŸ“· <span id="lbl-upload">Ø±ÙØ¹</span></button>
            <button type="button" class="ft-photo-btn rm" onclick="clearPhoto()" id="btn-rm-photo" style="display:none">ğŸ—‘ï¸</button>
          </div>
        </div>
        <input type="file" id="photo-input" class="hidden" accept="image/*" onchange="onPhotoSelect(event)">
      </div>
      <div class="ft-form-row">
        <div class="ft-form-group"><label id="lbl-birth">ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯</label><input type="date" id="p-birth"></div>
        <div class="ft-form-group"><label id="lbl-death">ØªØ§Ø±ÙŠØ® Ø§Ù„ÙˆÙØ§Ø©</label><input type="date" id="p-death"></div>
      </div>
      <div class="ft-form-group">
        <label id="lbl-notes">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
        <textarea id="p-notes" rows="2"></textarea>
      </div>
    </div>
    <div class="ft-modal-foot">
      <button class="ft-btn-del" id="pm-del" onclick="deletePerson()" style="display:none">ğŸ—‘ï¸</button>
      <button class="ft-btn-cancel" onclick="closeModal('person-modal')" id="btn-cancel">Ø¥Ù„ØºØ§Ø¡</button>
      <button class="ft-btn-save" onclick="savePerson()" id="btn-save">Ø­ÙØ¸</button>
    </div>
  </div>
</div>

<!-- Spouse Modal -->
<div class="ft-modal-bg" id="spouse-modal">
  <div class="ft-modal">
    <div class="ft-modal-head">
      <h2 id="sm-title">ğŸ’‘ Ø¥Ø¶Ø§ÙØ© Ø²ÙˆØ§Ø¬</h2>
      <button class="ft-modal-close" onclick="closeModal('spouse-modal')">&times;</button>
    </div>
    <div class="ft-modal-body">
      <div class="ft-form-group">
        <label id="lbl-husband">Ø§Ù„Ø²ÙˆØ¬</label>
        <div class="ft-person-select" id="husband-select"></div>
      </div>
      <div class="ft-form-group">
        <label id="lbl-wife">Ø§Ù„Ø²ÙˆØ¬Ø©</label>
        <div class="ft-person-select" id="wife-select"></div>
      </div>
      <div class="ft-form-group">
        <label id="lbl-status">Ø§Ù„Ø­Ø§Ù„Ø©</label>
        <div class="ft-status-opts">
          <label class="ft-status-opt"><input type="radio" name="sp-status" value="married" checked><span class="ic">ğŸ’‘</span><span class="tx" id="lbl-married">Ù…ØªØ²ÙˆØ¬Ø§Ù†</span></label>
          <label class="ft-status-opt"><input type="radio" name="sp-status" value="divorced"><span class="ic">ğŸ’”</span><span class="tx" id="lbl-divorced">Ù…Ø·Ù„Ù‚Ø§Ù†</span></label>
          <label class="ft-status-opt"><input type="radio" name="sp-status" value="widowed"><span class="ic">âœï¸</span><span class="tx" id="lbl-widowed">Ø£Ø±Ù…Ù„/Ø©</span></label>
        </div>
      </div>
      <div class="ft-form-row">
        <div class="ft-form-group"><label id="lbl-year-start">Ø³Ù†Ø© Ø§Ù„Ø²ÙˆØ§Ø¬</label><input type="number" id="sp-start" min="1900" max="2100"></div>
        <div class="ft-form-group"><label id="lbl-year-end">Ø³Ù†Ø© Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡</label><input type="number" id="sp-end" min="1900" max="2100"></div>
      </div>
    </div>
    <div class="ft-modal-foot">
      <button class="ft-btn-del" id="sm-del" onclick="deleteSpouseRel()" style="display:none">ğŸ—‘ï¸</button>
      <button class="ft-btn-cancel" onclick="closeModal('spouse-modal')">Ø¥Ù„ØºØ§Ø¡</button>
      <button class="ft-btn-save" onclick="saveSpouseRel()">Ø­ÙØ¸</button>
    </div>
  </div>
</div>

<!-- Child Modal -->
<div class="ft-modal-bg" id="child-modal">
  <div class="ft-modal">
    <div class="ft-modal-head">
      <h2 id="cm-title">ğŸ‘¶ Ø¥Ø¶Ø§ÙØ© Ø§Ø¨Ù†/Ø§Ø¨Ù†Ø©</h2>
      <button class="ft-modal-close" onclick="closeModal('child-modal')">&times;</button>
    </div>
    <div class="ft-modal-body">
      <div class="ft-tabs">
        <button class="ft-tab active" data-tab="new" onclick="switchChildTab('new')" id="tab-new">Ø´Ø®Øµ Ø¬Ø¯ÙŠØ¯</button>
        <button class="ft-tab" data-tab="existing" onclick="switchChildTab('existing')" id="tab-existing">Ø´Ø®Øµ Ù…ÙˆØ¬ÙˆØ¯</button>
      </div>
      
      <div id="child-form-new">
        <div class="ft-form-group">
          <label>Ø§Ù„Ø§Ø³Ù… *</label>
          <input type="text" id="c-name">
        </div>
        <div class="ft-form-group">
          <label>Ø§Ù„Ø¬Ù†Ø³</label>
          <div class="ft-gender">
            <label class="ft-gender-opt male"><input type="radio" name="c-gender" value="male" checked><span>ğŸ‘¨ Ø°ÙƒØ±</span></label>
            <label class="ft-gender-opt female"><input type="radio" name="c-gender" value="female"><span>ğŸ‘© Ø£Ù†Ø«Ù‰</span></label>
          </div>
        </div>
      </div>
      
      <div id="child-form-existing" style="display:none">
        <div class="ft-form-group">
          <label id="lbl-select-child">Ø§Ø®ØªØ± Ø§Ù„Ø´Ø®Øµ</label>
          <div class="ft-person-select" id="child-select"></div>
        </div>
      </div>
      
      <div class="ft-form-group" style="margin-top:14px;padding-top:14px;border-top:1px solid var(--border-color)">
        <label id="lbl-child-type">Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù„Ø§Ù‚Ø©</label>
        <div class="ft-status-opts" id="child-type-opts"></div>
      </div>
    </div>
    <div class="ft-modal-foot">
      <button class="ft-btn-cancel" onclick="closeModal('child-modal')">Ø¥Ù„ØºØ§Ø¡</button>
      <button class="ft-btn-save" onclick="saveChild()">Ø­ÙØ¸</button>
    </div>
  </div>
</div>

<!-- â­ EDIT RELATION Modal - Ø§Ù„Ø£Ù‡Ù…! -->
<div class="ft-modal-bg" id="relation-modal">
  <div class="ft-modal">
    <div class="ft-modal-head">
      <h2 id="rm-title">ğŸ”— ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ù„Ø§Ù‚Ø©</h2>
      <button class="ft-modal-close" onclick="closeModal('relation-modal')">&times;</button>
    </div>
    <div class="ft-modal-body">
      <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø´Ø®Øµ -->
      <div class="ft-rel-info" id="rel-person-info"></div>
      
      <div class="ft-form-group">
        <label id="lbl-rel-father">Ø§Ù„Ø£Ø¨</label>
        <div class="ft-person-select" id="rel-father-select"></div>
      </div>
      <div class="ft-form-group">
        <label id="lbl-rel-mother">Ø§Ù„Ø£Ù…</label>
        <div class="ft-person-select" id="rel-mother-select"></div>
      </div>
    </div>
    <div class="ft-modal-foot">
      <button class="ft-btn-del" onclick="unlinkPerson()" id="rm-unlink">ğŸ”“ ÙÙƒ Ø§Ù„Ø§Ø±ØªØ¨Ø§Ø·</button>
      <button class="ft-btn-cancel" onclick="closeModal('relation-modal')">Ø¥Ù„ØºØ§Ø¡</button>
      <button class="ft-btn-save" onclick="saveRelation()">Ø­ÙØ¸</button>
    </div>
  </div>
</div>

<!-- Context Menu -->
<div class="ft-ctx" id="ctx-menu">
  <div class="ft-ctx-item" onclick="ctxAction('edit')">âœï¸ <span id="ctx-edit">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</span></div>
  <div class="ft-ctx-item" onclick="ctxAction('relation')">ğŸ”— <span id="ctx-relation">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ù„Ø§Ù‚Ø©</span></div>
  <div class="ft-ctx-divider"></div>
  <div class="ft-ctx-item" onclick="ctxAction('spouse')">ğŸ’‘ <span id="ctx-spouse">Ø¥Ø¶Ø§ÙØ© Ø²ÙˆØ¬/Ø©</span></div>
  <div class="ft-ctx-item" onclick="ctxAction('child')">ğŸ‘¶ <span id="ctx-child">Ø¥Ø¶Ø§ÙØ© Ø§Ø¨Ù†/Ø©</span></div>
  <div class="ft-ctx-divider"></div>
  <div class="ft-ctx-item" onclick="ctxAction('locate')">ğŸ“ <span id="ctx-locate">ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹</span></div>
  <div class="ft-ctx-divider"></div>
  <div class="ft-ctx-item danger" onclick="ctxAction('delete')">ğŸ—‘ï¸ <span id="ctx-delete">Ø­Ø°Ù</span></div>
</div>

<!-- Add Menu -->
<div class="ft-add-menu" id="add-menu">
  <div class="ft-add-item" onclick="addMenuAction('parent')">ğŸ‘¨â€ğŸ‘© <span id="am-parent">Ø¥Ø¶Ø§ÙØ© ÙˆØ§Ù„Ø¯ÙŠÙ†</span></div>
  <div class="ft-add-item" onclick="addMenuAction('child')">ğŸ‘¶ <span id="am-child">Ø¥Ø¶Ø§ÙØ© Ø§Ø¨Ù†/Ø©</span></div>
  <div class="ft-add-item" onclick="addMenuAction('sibling')">ğŸ‘« <span id="am-sibling">Ø¥Ø¶Ø§ÙØ© Ø£Ø®/Ø£Ø®Øª</span></div>
  <div class="ft-add-item" onclick="addMenuAction('spouse')">ğŸ’‘ <span id="am-spouse">Ø¥Ø¶Ø§ÙØ© Ø²ÙˆØ¬/Ø©</span></div>
</div>

<div class="ft-toast" id="toast"></div>
<input type="file" id="import-file" class="hidden" accept=".json" onchange="importJSON(event)">

<script>
const isAr = document.documentElement.lang === 'ar';
const t = (ar, en) => isAr ? ar : en;

// ==================== DATA ====================
let db = { persons: {}, relations: {} };

let state = {
  editingPersonId: null,
  editingRelId: null,
  editingChildRelId: null,
  contextPersonId: null,
  addMenuPersonId: null,
  childContext: null,
  currentPhoto: null,
  childTab: 'new',
  zoom: 1,
  panX: 0,
  panY: 0,
  dragging: null
};

const CARD_W = 120, CARD_H = 85;
const GAP_X = 40, GAP_Y = 65;
const SPOUSE_GAP = 30;

// ==================== INIT ====================
function init() {
  setupCanvas();
  setupDragDrop();
  setupI18n();
  render();
  
  document.addEventListener('click', e => {
    hideCtx();
    hideAddMenu();
    document.querySelectorAll('.ft-dropdown.open').forEach(d => d.classList.remove('open'));
  });
  
  document.addEventListener('keydown', e => {
    if (e.key === 'Escape') closeAllModals();
  });
}

function setupI18n() {
  if (!isAr) {
    document.getElementById('txt-add').textContent = 'Add Person';
    document.getElementById('txt-persons').textContent = 'Persons';
    document.getElementById('txt-all-persons').textContent = 'All Persons';
    document.getElementById('txt-empty').textContent = 'Start by adding a person';
    document.getElementById('lbl-name').textContent = 'Name *';
    document.getElementById('lbl-gender').textContent = 'Gender';
    document.getElementById('lbl-male').textContent = 'Male';
    document.getElementById('lbl-female').textContent = 'Female';
    document.getElementById('lbl-photo').textContent = 'Photo';
    document.getElementById('lbl-upload').textContent = 'Upload';
    document.getElementById('lbl-birth').textContent = 'Birth Date';
    document.getElementById('lbl-death').textContent = 'Death Date';
    document.getElementById('lbl-notes').textContent = 'Notes';
    document.getElementById('btn-cancel').textContent = 'Cancel';
    document.getElementById('btn-save').textContent = 'Save';
    document.getElementById('lbl-husband').textContent = 'Husband';
    document.getElementById('lbl-wife').textContent = 'Wife';
    document.getElementById('lbl-status').textContent = 'Status';
    document.getElementById('lbl-married').textContent = 'Married';
    document.getElementById('lbl-divorced').textContent = 'Divorced';
    document.getElementById('lbl-widowed').textContent = 'Widowed';
    document.getElementById('lbl-year-start').textContent = 'Marriage Year';
    document.getElementById('lbl-year-end').textContent = 'End Year';
    document.getElementById('tab-new').textContent = 'New Person';
    document.getElementById('tab-existing').textContent = 'Existing';
    document.getElementById('lbl-select-child').textContent = 'Select Person';
    document.getElementById('lbl-child-type').textContent = 'Relation Type';
    document.getElementById('ctx-edit').textContent = 'Edit Data';
    document.getElementById('ctx-relation').textContent = 'Edit Relation';
    document.getElementById('ctx-spouse').textContent = 'Add Spouse';
    document.getElementById('ctx-child').textContent = 'Add Child';
    document.getElementById('ctx-locate').textContent = 'Locate';
    document.getElementById('ctx-delete').textContent = 'Delete';
    document.getElementById('am-parent').textContent = 'Add Parents';
    document.getElementById('am-child').textContent = 'Add Child';
    document.getElementById('am-sibling').textContent = 'Add Sibling';
    document.getElementById('am-spouse').textContent = 'Add Spouse';
    document.getElementById('rm-title').textContent = 'ğŸ”— Edit Relation';
    document.getElementById('lbl-rel-father').textContent = 'Father';
    document.getElementById('lbl-rel-mother').textContent = 'Mother';
    document.getElementById('rm-unlink').textContent = 'ğŸ”“ Unlink';
  }
}

// ==================== HELPERS ====================
const genId = () => Date.now().toString(36) + Math.random().toString(36).substr(2, 5);

function getSpouseRels(personId) {
  return Object.values(db.relations).filter(r => r.type === 'spouse' && (r.person1Id === personId || r.person2Id === personId));
}

function getSpouse(personId, relId) {
  const rel = db.relations[relId];
  if (!rel || rel.type !== 'spouse') return null;
  return db.persons[rel.person1Id === personId ? rel.person2Id : rel.person1Id];
}

function getChildren(personId) {
  return Object.values(db.relations)
    .filter(r => r.type === 'child' && (r.fatherId === personId || r.motherId === personId))
    .map(r => ({ child: db.persons[r.childId], rel: r }))
    .filter(x => x.child);
}

function getChildrenOfBoth(fatherId, motherId) {
  return Object.values(db.relations)
    .filter(r => r.type === 'child' && r.fatherId === fatherId && r.motherId === motherId)
    .map(r => db.persons[r.childId])
    .filter(Boolean);
}

function getParents(personId) {
  const rel = Object.values(db.relations).find(r => r.type === 'child' && r.childId === personId);
  if (!rel) return { father: null, mother: null, rel: null };
  return { father: db.persons[rel.fatherId], mother: db.persons[rel.motherId], rel };
}

function getLineage(personId, depth = 1) {
  const p = db.persons[personId];
  if (!p) return '';
  let result = p.name;
  const parents = getParents(personId);
  if (parents.father && depth > 0) {
    result += ' ' + (p.gender === 'female' ? t('Ø¨Ù†Øª', 'd/o') : t('Ø¨Ù†', 's/o')) + ' ' + parents.father.name;
  } else if (parents.mother && depth > 0) {
    result += ' ' + (p.gender === 'female' ? t('Ø¨Ù†Øª', 'd/o') : t('Ø§Ø¨Ù†', 's/o')) + ' ' + parents.mother.name;
  }
  return result;
}

function isWifeMarried(wifeId, excludeRelId = null) {
  return Object.values(db.relations).some(r => r.type === 'spouse' && r.person2Id === wifeId && r.status === 'married' && r.id !== excludeRelId);
}

function hasRelation(p) {
  const parents = getParents(p.id);
  return parents.father || parents.mother || getSpouseRels(p.id).length > 0 || getChildren(p.id).length > 0;
}

// ==================== RENDER ====================
function render() {
  renderPersonsList();
  layoutTree();
  renderTree();
  updateStats();
}

function renderPersonsList() {
  const list = document.getElementById('persons-list');
  const persons = Object.values(db.persons);
  
  if (persons.length === 0) {
    list.innerHTML = `<div style="color:var(--text-muted);padding:10px">${t('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£Ø´Ø®Ø§Øµ', 'No persons')}</div>`;
  } else {
    list.innerHTML = persons.map(p => {
      const orphan = !hasRelation(p);
      const gClass = p.gender === 'male' ? 'male' : 'female';
      return `<div class="ft-person-chip ${gClass} ${orphan ? 'orphan' : ''}" 
                   onclick="locatePerson('${p.id}')" 
                   oncontextmenu="showCtx(event,'${p.id}')"
                   draggable="true"
                   data-person-id="${p.id}">
        <span class="av">${p.gender === 'female' ? 'ğŸ‘©' : 'ğŸ‘¨'}</span>
        <span class="nm">${p.name}</span>
      </div>`;
    }).join('');
  }
  
  document.getElementById('persons-count').textContent = persons.length;
  document.getElementById('persons-count-badge').textContent = `(${persons.length})`;
}

function togglePersonsPanel() {
  document.getElementById('persons-panel').classList.toggle('open');
}

// ==================== PERSON MODAL ====================
function openPersonModal(editId = null) {
  state.editingPersonId = editId;
  state.currentPhoto = null;
  
  const isEdit = !!editId;
  document.getElementById('pm-title').innerHTML = isEdit ? 'âœï¸ ' + t('ØªØ¹Ø¯ÙŠÙ„', 'Edit') : 'ğŸ‘¤ ' + t('Ø¥Ø¶Ø§ÙØ© Ø´Ø®Øµ', 'Add Person');
  document.getElementById('pm-del').style.display = isEdit ? 'block' : 'none';
  
  if (isEdit) {
    const p = db.persons[editId];
    document.getElementById('p-name').value = p.name;
    document.querySelector(`input[name="p-gender"][value="${p.gender}"]`).checked = true;
    document.getElementById('p-birth').value = p.birthDate || '';
    document.getElementById('p-death').value = p.deathDate || '';
    document.getElementById('p-notes').value = p.notes || '';
    state.currentPhoto = p.photo;
  } else {
    document.getElementById('p-name').value = '';
    document.querySelector('input[name="p-gender"][value="male"]').checked = true;
    document.getElementById('p-birth').value = '';
    document.getElementById('p-death').value = '';
    document.getElementById('p-notes').value = '';
  }
  
  updatePhotoPreview();
  openModal('person-modal');
}

function savePerson() {
  const name = document.getElementById('p-name').value.trim();
  if (!name) return toast(t('Ø£Ø¯Ø®Ù„ Ø§Ù„Ø§Ø³Ù…', 'Enter name'));
  
  const data = {
    name,
    gender: document.querySelector('input[name="p-gender"]:checked').value,
    photo: state.currentPhoto,
    birthDate: document.getElementById('p-birth').value || null,
    deathDate: document.getElementById('p-death').value || null,
    notes: document.getElementById('p-notes').value.trim()
  };
  
  if (state.editingPersonId) {
    Object.assign(db.persons[state.editingPersonId], data);
  } else {
    const id = genId();
    db.persons[id] = { id, ...data };
  }
  
  closeModal('person-modal');
  render();
  toast(t('ØªÙ…', 'Done'));
}

function deletePerson() {
  if (!state.editingPersonId || !confirm(t('Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø´Ø®ØµØŸ', 'Delete this person?'))) return;
  
  const id = state.editingPersonId;
  Object.keys(db.relations).forEach(rid => {
    const r = db.relations[rid];
    if (r.type === 'spouse' && (r.person1Id === id || r.person2Id === id)) delete db.relations[rid];
    if (r.type === 'child' && (r.childId === id || r.fatherId === id || r.motherId === id)) delete db.relations[rid];
  });
  
  delete db.persons[id];
  closeModal('person-modal');
  render();
  toast(t('ØªÙ…', 'Done'));
}

// ==================== PHOTO ====================
function onPhotoSelect(e) {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = ev => { state.currentPhoto = ev.target.result; updatePhotoPreview(); };
  reader.readAsDataURL(file);
}

function clearPhoto() {
  state.currentPhoto = null;
  document.getElementById('photo-input').value = '';
  updatePhotoPreview();
}

function updatePhotoPreview() {
  const prev = document.getElementById('photo-prev');
  const btn = document.getElementById('btn-rm-photo');
  if (state.currentPhoto) {
    prev.innerHTML = `<img src="${state.currentPhoto}">`;
    btn.style.display = 'block';
  } else {
    prev.innerHTML = '<span class="ph">ğŸ‘¤</span>';
    btn.style.display = 'none';
  }
}

// ==================== SPOUSE MODAL ====================
function openSpouseModal(editRelId = null, preselect = null) {
  state.editingRelId = editRelId;
  
  const males = Object.values(db.persons).filter(p => p.gender === 'male');
  const females = Object.values(db.persons).filter(p => p.gender === 'female');
  
  let selH = preselect?.husbandId || null;
  let selW = preselect?.wifeId || null;
  
  if (editRelId) {
    const r = db.relations[editRelId];
    document.getElementById('sm-title').innerHTML = 'ğŸ’‘ ' + t('ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø²ÙˆØ§Ø¬', 'Edit Marriage');
    document.getElementById('sm-del').style.display = 'block';
    selH = r.person1Id; selW = r.person2Id;
    document.querySelector(`input[name="sp-status"][value="${r.status}"]`).checked = true;
    document.getElementById('sp-start').value = r.startYear || '';
    document.getElementById('sp-end').value = r.endYear || '';
  } else {
    document.getElementById('sm-title').innerHTML = 'ğŸ’‘ ' + t('Ø¥Ø¶Ø§ÙØ© Ø²ÙˆØ§Ø¬', 'Add Marriage');
    document.getElementById('sm-del').style.display = 'none';
    document.querySelector('input[name="sp-status"][value="married"]').checked = true;
    document.getElementById('sp-start').value = '';
    document.getElementById('sp-end').value = '';
  }
  
  renderPersonSelect('husband-select', males, selH);
  renderPersonSelect('wife-select', females, selW);
  openModal('spouse-modal');
}

function saveSpouseRel() {
  const hId = getSelectedPerson('husband-select');
  const wId = getSelectedPerson('wife-select');
  if (!hId && !wId) return toast(t('Ø§Ø®ØªØ± Ø£Ø­Ø¯Ù‡Ù…Ø§', 'Select one'));
  
  const status = document.querySelector('input[name="sp-status"]:checked').value;
  if (wId && status === 'married' && isWifeMarried(wId, state.editingRelId)) {
    return toast(t('Ù‡Ø°Ù‡ Ø§Ù„Ø²ÙˆØ¬Ø© Ù…ØªØ²ÙˆØ¬Ø© Ø­Ø§Ù„ÙŠØ§Ù‹', 'This wife is already married'));
  }
  
  const data = {
    type: 'spouse',
    person1Id: hId,
    person2Id: wId,
    status,
    startYear: parseInt(document.getElementById('sp-start').value) || null,
    endYear: parseInt(document.getElementById('sp-end').value) || null
  };
  
  if (state.editingRelId) {
    Object.assign(db.relations[state.editingRelId], data);
  } else {
    db.relations[genId()] = { id: genId(), ...data };
  }
  
  closeModal('spouse-modal');
  render();
  toast(t('ØªÙ…', 'Done'));
}

function deleteSpouseRel() {
  if (!state.editingRelId || !confirm(t('Ø­Ø°ÙØŸ', 'Delete?'))) return;
  delete db.relations[state.editingRelId];
  closeModal('spouse-modal');
  render();
  toast(t('ØªÙ…', 'Done'));
}

// ==================== CHILD MODAL ====================
function openChildModal(context) {
  state.childContext = context;
  state.childTab = 'new';
  
  document.querySelector('.ft-tab[data-tab="new"]').classList.add('active');
  document.querySelector('.ft-tab[data-tab="existing"]').classList.remove('active');
  document.getElementById('child-form-new').style.display = 'block';
  document.getElementById('child-form-existing').style.display = 'none';
  document.getElementById('c-name').value = '';
  document.querySelector('input[name="c-gender"][value="male"]').checked = true;
  
  const opts = document.getElementById('child-type-opts');
  let optsHtml = '';
  const father = context.fatherId ? db.persons[context.fatherId] : null;
  const mother = context.motherId ? db.persons[context.motherId] : null;
  
  if (father && mother) {
    optsHtml += `<label class="ft-status-opt"><input type="radio" name="c-type" value="both" checked><span class="ic">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§</span><span class="tx">${t('Ù…Ù† Ø§Ù„Ø£Ø¨ ÙˆØ§Ù„Ø£Ù…', 'Both Parents')}</span></label>`;
    optsHtml += `<label class="ft-status-opt"><input type="radio" name="c-type" value="father"><span class="ic">ğŸ‘¨</span><span class="tx">${t('Ù…Ù† Ø§Ù„Ø£Ø¨ ÙÙ‚Ø·', 'Father Only')}</span></label>`;
    optsHtml += `<label class="ft-status-opt"><input type="radio" name="c-type" value="mother"><span class="ic">ğŸ‘©</span><span class="tx">${t('Ù…Ù† Ø§Ù„Ø£Ù… ÙÙ‚Ø·', 'Mother Only')}</span></label>`;
  } else if (father) {
    optsHtml += `<label class="ft-status-opt"><input type="radio" name="c-type" value="father" checked><span class="ic">ğŸ‘¨</span><span class="tx">${t('Ù…Ù† Ø§Ù„Ø£Ø¨', 'From Father')}</span></label>`;
  } else if (mother) {
    optsHtml += `<label class="ft-status-opt"><input type="radio" name="c-type" value="mother" checked><span class="ic">ğŸ‘©</span><span class="tx">${t('Ù…Ù† Ø§Ù„Ø£Ù…', 'From Mother')}</span></label>`;
  }
  opts.innerHTML = optsHtml;
  
  const available = Object.values(db.persons).filter(p => !getParents(p.id).rel);
  renderPersonSelect('child-select', available, null);
  openModal('child-modal');
}

function switchChildTab(tab) {
  state.childTab = tab;
  document.querySelector('.ft-tab[data-tab="new"]').classList.toggle('active', tab === 'new');
  document.querySelector('.ft-tab[data-tab="existing"]').classList.toggle('active', tab === 'existing');
  document.getElementById('child-form-new').style.display = tab === 'new' ? 'block' : 'none';
  document.getElementById('child-form-existing').style.display = tab === 'existing' ? 'block' : 'none';
}

function saveChild() {
  let childId;
  
  if (state.childTab === 'new') {
    const name = document.getElementById('c-name').value.trim();
    if (!name) return toast(t('Ø£Ø¯Ø®Ù„ Ø§Ù„Ø§Ø³Ù…', 'Enter name'));
    childId = genId();
    db.persons[childId] = {
      id: childId, name,
      gender: document.querySelector('input[name="c-gender"]:checked').value,
      photo: null, birthDate: null, deathDate: null, notes: ''
    };
  } else {
    childId = getSelectedPerson('child-select');
    if (!childId) return toast(t('Ø§Ø®ØªØ± Ø´Ø®ØµØ§Ù‹', 'Select person'));
  }
  
  const relType = document.querySelector('input[name="c-type"]:checked')?.value || 'both';
  const relData = { id: genId(), type: 'child', childId, fatherId: null, motherId: null };
  
  if (relType === 'both' || relType === 'father') relData.fatherId = state.childContext.fatherId || null;
  if (relType === 'both' || relType === 'mother') relData.motherId = state.childContext.motherId || null;
  
  db.relations[relData.id] = relData;
  closeModal('child-modal');
  render();
  toast(t('ØªÙ…', 'Done'));
}

// ==================== â­ EDIT RELATION MODAL ====================
function openRelationModal(personId) {
  const p = db.persons[personId];
  if (!p) return;
  
  state.editingChildRelId = personId;
  const parents = getParents(personId);
  
  // Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø´Ø®Øµ
  document.getElementById('rel-person-info').innerHTML = `
    <div class="title">${t('ØªØ¹Ø¯ÙŠÙ„ Ø¹Ù„Ø§Ù‚Ø©:', 'Edit relation for:')}</div>
    <div class="person-row">
      <span class="av">${p.gender === 'female' ? 'ğŸ‘©' : 'ğŸ‘¨'}</span>
      <div class="info">
        <div class="nm">${p.name}</div>
        <div class="role">${getLineage(personId)}</div>
      </div>
    </div>
  `;
  
  // Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¢Ø¨Ø§Ø¡ Ø§Ù„Ù…Ø­ØªÙ…Ù„ÙŠÙ†
  const males = Object.values(db.persons).filter(m => m.gender === 'male' && m.id !== personId);
  const females = Object.values(db.persons).filter(f => f.gender === 'female' && f.id !== personId);
  
  renderPersonSelect('rel-father-select', males, parents.father?.id);
  renderPersonSelect('rel-mother-select', females, parents.mother?.id);
  
  openModal('relation-modal');
}

function saveRelation() {
  const personId = state.editingChildRelId;
  if (!personId) return;
  
  const fatherId = getSelectedPerson('rel-father-select');
  const motherId = getSelectedPerson('rel-mother-select');
  
  // Ø­Ø°Ù Ø§Ù„Ø¹Ù„Ø§Ù‚Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ø¥Ù† ÙˆØ¬Ø¯Øª
  const oldRel = Object.values(db.relations).find(r => r.type === 'child' && r.childId === personId);
  if (oldRel) delete db.relations[oldRel.id];
  
  // Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù„Ø§Ù‚Ø© Ø¬Ø¯ÙŠØ¯Ø© Ø¥Ù† ÙˆØ¬Ø¯ Ø£Ø­Ø¯ Ø§Ù„ÙˆØ§Ù„Ø¯ÙŠÙ†
  if (fatherId || motherId) {
    const newRel = { id: genId(), type: 'child', childId: personId, fatherId, motherId };
    db.relations[newRel.id] = newRel;
  }
  
  closeModal('relation-modal');
  render();
  toast(t('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù„Ø§Ù‚Ø©', 'Relation updated'));
}

function unlinkPerson() {
  const personId = state.editingChildRelId;
  if (!personId) return;
  
  if (!confirm(t('ÙÙƒ Ø§Ø±ØªØ¨Ø§Ø· Ù‡Ø°Ø§ Ø§Ù„Ø´Ø®Øµ Ù…Ù† ÙˆØ§Ù„Ø¯ÙŠÙ‡ØŸ', 'Unlink this person from parents?'))) return;
  
  const rel = Object.values(db.relations).find(r => r.type === 'child' && r.childId === personId);
  if (rel) delete db.relations[rel.id];
  
  closeModal('relation-modal');
  render();
  toast(t('ØªÙ… ÙÙƒ Ø§Ù„Ø§Ø±ØªØ¨Ø§Ø·', 'Unlinked'));
}

// ==================== PERSON SELECT ====================
function renderPersonSelect(containerId, persons, selectedId) {
  const c = document.getElementById(containerId);
  let html = `<input type="text" class="ft-person-select-search" placeholder="${t('Ø§Ø¨Ø­Ø«...', 'Search...')}" oninput="filterSelect('${containerId}', this.value)">`;
  html += `<div class="ft-person-select-list">`;
  html += `<div class="ft-person-opt none ${!selectedId ? 'selected' : ''}" onclick="pickPerson('${containerId}', null)">${t('Ø¨Ø¯ÙˆÙ†', 'None')}</div>`;
  persons.forEach(p => {
    html += `<div class="ft-person-opt ${selectedId === p.id ? 'selected' : ''}" data-id="${p.id}" data-name="${p.name.toLowerCase()}" onclick="pickPerson('${containerId}', '${p.id}')">
      <span class="av">${p.gender === 'female' ? 'ğŸ‘©' : 'ğŸ‘¨'}</span>
      <span class="nm">${p.name}</span>
    </div>`;
  });
  html += '</div>';
  c.innerHTML = html;
}

function filterSelect(cid, q) {
  document.querySelectorAll(`#${cid} .ft-person-opt:not(.none)`).forEach(o => {
    o.style.display = (o.dataset.name || '').includes(q.toLowerCase()) ? '' : 'none';
  });
}

function pickPerson(cid, id) {
  document.querySelectorAll(`#${cid} .ft-person-opt`).forEach(o => {
    o.classList.toggle('selected', id ? o.dataset.id === id : o.classList.contains('none'));
  });
}

function getSelectedPerson(cid) {
  return document.querySelector(`#${cid} .ft-person-opt.selected:not(.none)`)?.dataset.id || null;
}

// ==================== CONTEXT MENU ====================
function showCtx(e, personId) {
  e.preventDefault();
  e.stopPropagation();
  state.contextPersonId = personId;
  const menu = document.getElementById('ctx-menu');
  menu.style.left = e.clientX + 'px';
  menu.style.top = e.clientY + 'px';
  menu.classList.add('show');
}

function hideCtx() { document.getElementById('ctx-menu').classList.remove('show'); }

function ctxAction(action) {
  hideCtx();
  const id = state.contextPersonId;
  if (!id) return;
  const p = db.persons[id];
  
  switch (action) {
    case 'edit': openPersonModal(id); break;
    case 'relation': openRelationModal(id); break;
    case 'spouse': openSpouseModal(null, p.gender === 'male' ? { husbandId: id } : { wifeId: id }); break;
    case 'child':
      const spRels = getSpouseRels(id);
      if (spRels.length > 0) {
        const sp = getSpouse(id, spRels[0].id);
        openChildModal(p.gender === 'male' ? { fatherId: id, motherId: sp?.id } : { fatherId: sp?.id, motherId: id });
      } else {
        openChildModal(p.gender === 'male' ? { fatherId: id } : { motherId: id });
      }
      break;
    case 'locate': locatePerson(id); break;
    case 'delete': state.editingPersonId = id; deletePerson(); break;
  }
}

// ==================== ADD MENU ====================
function showAddMenu(e, personId, screenX, screenY) {
  e.stopPropagation();
  state.addMenuPersonId = personId;
  const menu = document.getElementById('add-menu');
  menu.style.left = screenX + 'px';
  menu.style.top = screenY + 'px';
  menu.classList.add('show');
}

function hideAddMenu() { document.getElementById('add-menu').classList.remove('show'); }

function addMenuAction(action) {
  hideAddMenu();
  const id = state.addMenuPersonId;
  if (!id) return;
  const p = db.persons[id];
  const parents = getParents(id);
  
  switch (action) {
    case 'parent': openSpouseModal(); break;
    case 'child':
      const spRels = getSpouseRels(id);
      if (spRels.length > 0) {
        const sp = getSpouse(id, spRels[0].id);
        openChildModal(p.gender === 'male' ? { fatherId: id, motherId: sp?.id } : { fatherId: sp?.id, motherId: id });
      } else {
        openChildModal(p.gender === 'male' ? { fatherId: id } : { motherId: id });
      }
      break;
    case 'sibling':
      if (!parents.father && !parents.mother) return toast(t('Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆØ§Ù„Ø¯ÙŠÙ†', 'No parents'));
      openChildModal({ fatherId: parents.father?.id, motherId: parents.mother?.id });
      break;
    case 'spouse':
      openSpouseModal(null, p.gender === 'male' ? { husbandId: id } : { wifeId: id });
      break;
  }
}

// ==================== DRAG & DROP ====================
function setupDragDrop() {
  document.addEventListener('dragstart', e => {
    const chip = e.target.closest('[data-person-id]');
    if (chip) {
      state.dragging = chip.dataset.personId;
      e.dataTransfer.effectAllowed = 'move';
    }
  });
  
  document.addEventListener('dragover', e => {
    e.preventDefault();
    e.dataTransfer.dropEffect = 'move';
  });
  
  document.addEventListener('drop', e => {
    e.preventDefault();
    if (!state.dragging) return;
    
    const target = e.target.closest('[data-person-id]');
    if (target && target.dataset.personId !== state.dragging) {
      handleDrop(state.dragging, target.dataset.personId);
    }
    state.dragging = null;
  });
  
  document.addEventListener('dragend', () => { state.dragging = null; });
}

function handleDrop(draggedId, targetId) {
  const dragged = db.persons[draggedId];
  const target = db.persons[targetId];
  if (!dragged || !target) return;
  
  // ÙØªØ­ Ù†Ø§ÙØ°Ø© Ù„Ø§Ø®ØªÙŠØ§Ø± Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù„Ø§Ù‚Ø©
  const choice = prompt(t(
    `Ø§Ø®ØªØ± Ø§Ù„Ø¹Ù„Ø§Ù‚Ø©:\n1 = ${dragged.name} Ø§Ø¨Ù†/Ø§Ø¨Ù†Ø© ${target.name}\n2 = ${target.name} Ø§Ø¨Ù†/Ø§Ø¨Ù†Ø© ${dragged.name}\n3 = Ø²ÙˆØ¬/Ø²ÙˆØ¬Ø©`,
    `Choose relation:\n1 = ${dragged.name} child of ${target.name}\n2 = ${target.name} child of ${dragged.name}\n3 = Spouse`
  ));
  
  if (choice === '1') {
    // dragged is child of target
    const rel = { id: genId(), type: 'child', childId: draggedId };
    if (target.gender === 'male') rel.fatherId = targetId;
    else rel.motherId = targetId;
    db.relations[rel.id] = rel;
    render();
    toast(t('ØªÙ…', 'Done'));
  } else if (choice === '2') {
    // target is child of dragged
    const rel = { id: genId(), type: 'child', childId: targetId };
    if (dragged.gender === 'male') rel.fatherId = draggedId;
    else rel.motherId = draggedId;
    db.relations[rel.id] = rel;
    render();
    toast(t('ØªÙ…', 'Done'));
  } else if (choice === '3') {
    // spouse
    if (dragged.gender === target.gender) return toast(t('ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ†Ø§ Ù…Ø®ØªÙ„ÙÙŠÙ† ÙÙŠ Ø§Ù„Ø¬Ù†Ø³', 'Must be different genders'));
    const hId = dragged.gender === 'male' ? draggedId : targetId;
    const wId = dragged.gender === 'female' ? draggedId : targetId;
    openSpouseModal(null, { husbandId: hId, wifeId: wId });
  }
}

// ==================== LAYOUT & RENDER TREE ====================
function layoutTree() {
  const positions = {};
  const processed = new Set();
  let currentX = 50;
  
  const roots = Object.values(db.persons).filter(p => {
    const parents = getParents(p.id);
    return !parents.father && !parents.mother;
  });
  
  function layoutFamily(personId, level, startX) {
    if (processed.has(personId)) return startX;
    const person = db.persons[personId];
    if (!person) return startX;
    
    processed.add(personId);
    const y = level * (CARD_H + GAP_Y);
    let x = startX;
    
    const spouseRels = getSpouseRels(personId);
    const familyUnits = [];
    
    spouseRels.forEach(rel => {
      const spouse = getSpouse(personId, rel.id);
      if (spouse && !processed.has(spouse.id)) {
        processed.add(spouse.id);
        const fId = person.gender === 'male' ? personId : spouse.id;
        const mId = person.gender === 'female' ? personId : spouse.id;
        familyUnits.push({ spouse, children: getChildrenOfBoth(fId, mId), fatherId: fId, motherId: mId });
      }
    });
    
    positions[personId] = { x, y, level };
    
    let spouseX = x + CARD_W + SPOUSE_GAP;
    familyUnits.forEach(unit => {
      positions[unit.spouse.id] = { x: spouseX, y, level };
      let childX = x;
      unit.children.forEach(child => {
        childX = layoutFamily(child.id, level + 1, childX);
      });
      spouseX += CARD_W + SPOUSE_GAP;
    });
    
    const soloChildren = getChildren(personId).filter(({ rel }) => {
      return person.gender === 'male' ? !rel.motherId : !rel.fatherId;
    });
    
    let soloX = spouseX;
    soloChildren.forEach(({ child }) => {
      soloX = layoutFamily(child.id, level + 1, soloX);
    });
    
    return Math.max(spouseX, soloX, x + CARD_W + GAP_X);
  }
  
  roots.forEach(root => {
    currentX = layoutFamily(root.id, 0, currentX) + GAP_X;
  });
  
  Object.entries(positions).forEach(([id, pos]) => {
    if (db.persons[id]) {
      db.persons[id]._x = pos.x;
      db.persons[id]._y = pos.y;
      db.persons[id]._level = pos.level;
    }
  });
}

function renderTree() {
  const linesG = document.getElementById('lines-g');
  const cardsG = document.getElementById('cards-g');
  linesG.innerHTML = '';
  cardsG.innerHTML = '';
  
  const persons = Object.values(db.persons);
  document.getElementById('empty-msg').style.display = persons.length ? 'none' : 'block';
  if (!persons.length) return;
  
  // Draw spouse lines
  Object.values(db.relations).filter(r => r.type === 'spouse').forEach(rel => {
    const p1 = db.persons[rel.person1Id];
    const p2 = db.persons[rel.person2Id];
    if (p1?._x !== undefined && p2?._x !== undefined) drawSpouseLine(p1, p2, rel, linesG);
  });
  
  // Draw child lines
  Object.values(db.relations).filter(r => r.type === 'child').forEach(rel => {
    const child = db.persons[rel.childId];
    if (!child || child._x === undefined) return;
    const father = db.persons[rel.fatherId];
    const mother = db.persons[rel.motherId];
    
    if (father?._x !== undefined && mother?._x !== undefined) {
      drawChildLine(father, mother, child, linesG);
    } else if (father?._x !== undefined) {
      drawSingleParentLine(father, child, linesG);
    } else if (mother?._x !== undefined) {
      drawSingleParentLine(mother, child, linesG);
    }
  });
  
  // Draw cards
  persons.forEach(p => { if (p._x !== undefined) drawCard(p, cardsG); });
  updateTransform();
}

function drawSpouseLine(p1, p2, rel, layer) {
  const x1 = Math.min(p1._x, p2._x) + CARD_W;
  const x2 = Math.max(p1._x, p2._x);
  const y = p1._y + CARD_H / 2;
  
  const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
  line.setAttribute('x1', x1); line.setAttribute('y1', y);
  line.setAttribute('x2', x2); line.setAttribute('y2', y);
  line.setAttribute('stroke', rel.status === 'divorced' ? '#6b7280' : rel.status === 'widowed' ? '#4b5563' : '#f59e0b');
  line.setAttribute('stroke-width', '3');
  if (rel.status !== 'married') line.setAttribute('stroke-dasharray', rel.status === 'divorced' ? '5,5' : '2,4');
  layer.appendChild(line);
  
  const midX = (x1 + x2) / 2;
  const icon = document.createElementNS('http://www.w3.org/2000/svg', 'text');
  icon.setAttribute('x', midX); icon.setAttribute('y', y - 8);
  icon.setAttribute('text-anchor', 'middle'); icon.setAttribute('font-size', '14');
  icon.textContent = rel.status === 'divorced' ? 'ğŸ’”' : rel.status === 'widowed' ? 'âœï¸' : 'ğŸ’‘';
  layer.appendChild(icon);
  
  // Add child button
  const addG = document.createElementNS('http://www.w3.org/2000/svg', 'g');
  addG.style.cursor = 'pointer';
  const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
  circle.setAttribute('cx', midX); circle.setAttribute('cy', y + 18);
  circle.setAttribute('r', 10);
  circle.setAttribute('fill', '#1e293b'); circle.setAttribute('stroke', '#059669'); circle.setAttribute('stroke-width', '2');
  addG.appendChild(circle);
  const txt = document.createElementNS('http://www.w3.org/2000/svg', 'text');
  txt.setAttribute('x', midX); txt.setAttribute('y', y + 18);
  txt.setAttribute('text-anchor', 'middle'); txt.setAttribute('dominant-baseline', 'central');
  txt.setAttribute('fill', '#059669'); txt.setAttribute('font-size', '14'); txt.setAttribute('font-weight', 'bold');
  txt.textContent = '+';
  addG.appendChild(txt);
  addG.onclick = e => { e.stopPropagation(); openChildModal({ fatherId: rel.person1Id, motherId: rel.person2Id }); };
  addG.onmouseenter = () => { circle.setAttribute('fill', '#059669'); txt.setAttribute('fill', '#fff'); };
  addG.onmouseleave = () => { circle.setAttribute('fill', '#1e293b'); txt.setAttribute('fill', '#059669'); };
  layer.appendChild(addG);
}

function drawChildLine(father, mother, child, layer) {
  const midX = (Math.min(father._x, mother._x) + Math.max(father._x, mother._x) + CARD_W) / 2;
  const y1 = father._y + CARD_H;
  const cx = child._x + CARD_W / 2;
  const cy = child._y;
  const midY = y1 + (cy - y1) / 2;
  
  const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
  path.setAttribute('d', `M ${midX} ${y1} L ${midX} ${midY} L ${cx} ${midY} L ${cx} ${cy}`);
  path.setAttribute('stroke', '#475569'); path.setAttribute('stroke-width', '2'); path.setAttribute('fill', 'none');
  layer.appendChild(path);
}

function drawSingleParentLine(parent, child, layer) {
  const px = parent._x + CARD_W / 2;
  const py = parent._y + CARD_H;
  const cx = child._x + CARD_W / 2;
  const cy = child._y;
  const midY = py + (cy - py) / 2;
  
  const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
  path.setAttribute('d', `M ${px} ${py} L ${px} ${midY} L ${cx} ${midY} L ${cx} ${cy}`);
  path.setAttribute('stroke', '#475569'); path.setAttribute('stroke-width', '2'); path.setAttribute('fill', 'none');
  layer.appendChild(path);
}

function drawCard(p, layer) {
  const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
  g.setAttribute('transform', `translate(${p._x}, ${p._y})`);
  g.setAttribute('data-person-id', p.id);
  g.style.cursor = 'pointer';
  
  const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
  rect.setAttribute('width', CARD_W); rect.setAttribute('height', CARD_H); rect.setAttribute('rx', '10');
  rect.setAttribute('fill', '#334155');
  rect.setAttribute('stroke', p.gender === 'female' ? '#ec4899' : '#3b82f6');
  rect.setAttribute('stroke-width', p.deathDate ? '2' : '3');
  if (p.deathDate) rect.setAttribute('stroke-dasharray', '5,4');
  rect.setAttribute('filter', 'url(#shadow)');
  g.appendChild(rect);
  
  if (p.photo) {
    const img = document.createElementNS('http://www.w3.org/2000/svg', 'image');
    img.setAttribute('x', CARD_W/2 - 15); img.setAttribute('y', 8);
    img.setAttribute('width', 30); img.setAttribute('height', 30);
    img.setAttribute('href', p.photo);
    g.appendChild(img);
  } else {
    const icon = document.createElementNS('http://www.w3.org/2000/svg', 'text');
    icon.setAttribute('x', CARD_W/2); icon.setAttribute('y', 28);
    icon.setAttribute('text-anchor', 'middle'); icon.setAttribute('font-size', '22');
    icon.textContent = p.gender === 'female' ? 'ğŸ‘©' : 'ğŸ‘¨';
    g.appendChild(icon);
  }
  
  const name = document.createElementNS('http://www.w3.org/2000/svg', 'text');
  name.setAttribute('x', CARD_W/2); name.setAttribute('y', 52);
  name.setAttribute('text-anchor', 'middle');
  name.setAttribute('fill', '#f8fafc'); name.setAttribute('font-size', '11'); name.setAttribute('font-weight', '600');
  name.textContent = p.name.length > 12 ? p.name.substring(0, 12) + '..' : p.name;
  g.appendChild(name);
  
  if (p.birthDate) {
    const age = calcAge(p.birthDate, p.deathDate);
    const ageText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
    ageText.setAttribute('x', CARD_W/2); ageText.setAttribute('y', 65);
    ageText.setAttribute('text-anchor', 'middle');
    ageText.setAttribute('fill', '#94a3b8'); ageText.setAttribute('font-size', '9');
    ageText.textContent = age + (isAr ? ' Ø³Ù†Ø©' : ' y') + (p.deathDate ? ' âœ' : '');
    g.appendChild(ageText);
  }
  
  // Add button
  const addBtn = document.createElementNS('http://www.w3.org/2000/svg', 'g');
  addBtn.setAttribute('class', 'card-add-btn');
  addBtn.style.cursor = 'pointer';
  const addRect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
  addRect.setAttribute('x', CARD_W/2 - 14); addRect.setAttribute('y', CARD_H - 18);
  addRect.setAttribute('width', 28); addRect.setAttribute('height', 14); addRect.setAttribute('rx', 5);
  addRect.setAttribute('fill', '#1e293b'); addRect.setAttribute('stroke', '#059669'); addRect.setAttribute('stroke-width', '1.5');
  addBtn.appendChild(addRect);
  const addTxt = document.createElementNS('http://www.w3.org/2000/svg', 'text');
  addTxt.setAttribute('x', CARD_W/2); addTxt.setAttribute('y', CARD_H - 8);
  addTxt.setAttribute('text-anchor', 'middle'); addTxt.setAttribute('fill', '#059669');
  addTxt.setAttribute('font-size', '12'); addTxt.setAttribute('font-weight', 'bold');
  addTxt.textContent = '+';
  addBtn.appendChild(addTxt);
  addBtn.onclick = e => {
    e.stopPropagation();
    const svg = document.getElementById('svg').getBoundingClientRect();
    showAddMenu(e, p.id, svg.left + (p._x + CARD_W/2) * state.zoom + state.panX, svg.top + (p._y + CARD_H) * state.zoom + state.panY);
  };
  addBtn.onmouseenter = () => { addRect.setAttribute('fill', '#059669'); addTxt.setAttribute('fill', '#fff'); };
  addBtn.onmouseleave = () => { addRect.setAttribute('fill', '#1e293b'); addTxt.setAttribute('fill', '#059669'); };
  g.appendChild(addBtn);
  
  g.onclick = e => { if (!e.target.closest('.card-add-btn')) { e.stopPropagation(); openPersonModal(p.id); } };
  g.oncontextmenu = e => { e.preventDefault(); showCtx(e, p.id); };
  g.ondblclick = e => {
    e.stopPropagation();
    const rels = getSpouseRels(p.id);
    if (rels.length > 0) openSpouseModal(rels[0].id);
    else openSpouseModal(null, p.gender === 'male' ? { husbandId: p.id } : { wifeId: p.id });
  };
  
  layer.appendChild(g);
}

function calcAge(birth, death) {
  const b = new Date(birth), e = death ? new Date(death) : new Date();
  let age = e.getFullYear() - b.getFullYear();
  if (e.getMonth() < b.getMonth() || (e.getMonth() === b.getMonth() && e.getDate() < b.getDate())) age--;
  return age;
}

// ==================== CANVAS ====================
let isDragging = false, dragStartX = 0, dragStartY = 0;

function setupCanvas() {
  const svg = document.getElementById('svg');
  const canvas = document.getElementById('canvas');
  
  svg.onmousedown = e => {
    if (e.target.closest('g[data-person-id]')) return;
    isDragging = true;
    dragStartX = e.clientX - state.panX;
    dragStartY = e.clientY - state.panY;
  };
  svg.onmousemove = e => {
    if (!isDragging) return;
    state.panX = e.clientX - dragStartX;
    state.panY = e.clientY - dragStartY;
    updateTransform();
  };
  svg.onmouseup = () => isDragging = false;
  svg.onmouseleave = () => isDragging = false;
  
  canvas.onwheel = e => {
    e.preventDefault();
    state.zoom = Math.max(0.3, Math.min(2, state.zoom + (e.deltaY > 0 ? -0.1 : 0.1)));
    updateTransform();
    document.getElementById('zoom-lvl').textContent = Math.round(state.zoom * 100) + '%';
  };
}

function updateTransform() {
  document.getElementById('tree-g').setAttribute('transform', `translate(${state.panX}, ${state.panY}) scale(${state.zoom})`);
}

function zoomIn() { state.zoom = Math.min(2, state.zoom + 0.1); updateTransform(); document.getElementById('zoom-lvl').textContent = Math.round(state.zoom * 100) + '%'; }
function zoomOut() { state.zoom = Math.max(0.3, state.zoom - 0.1); updateTransform(); document.getElementById('zoom-lvl').textContent = Math.round(state.zoom * 100) + '%'; }
function fitView() { state.zoom = 1; state.panX = 0; state.panY = 0; updateTransform(); document.getElementById('zoom-lvl').textContent = '100%'; }

function locatePerson(id) {
  const p = db.persons[id];
  if (!p || p._x === undefined) return;
  const svg = document.getElementById('svg');
  state.panX = svg.clientWidth / 2 - p._x - CARD_W / 2;
  state.panY = svg.clientHeight / 2 - p._y - CARD_H / 2;
  state.zoom = 1;
  updateTransform();
  document.getElementById('zoom-lvl').textContent = '100%';
}

// ==================== STATS ====================
function updateStats() {
  const persons = Object.values(db.persons);
  const spRels = Object.values(db.relations).filter(r => r.type === 'spouse');
  const levels = new Set(persons.map(p => p._level).filter(l => l !== undefined));
  document.getElementById('stat-total').textContent = persons.length;
  document.getElementById('stat-males').textContent = persons.filter(p => p.gender === 'male').length;
  document.getElementById('stat-females').textContent = persons.filter(p => p.gender === 'female').length;
  document.getElementById('stat-marriages').textContent = spRels.length;
  document.getElementById('stat-gens').textContent = levels.size;
}

// ==================== SAVE/LOAD ====================
function saveLocal() { localStorage.setItem('familyTreeV57', JSON.stringify(db)); toast(t('ØªÙ… Ø§Ù„Ø­ÙØ¸', 'Saved')); }
function loadLocal() {
  const s = localStorage.getItem('familyTreeV57');
  if (s) { db = JSON.parse(s); render(); toast(t('ØªÙ… Ø§Ù„ØªØ­Ù…ÙŠÙ„', 'Loaded')); }
  else toast(t('Ù„Ø§ Ø¨ÙŠØ§Ù†Ø§Øª', 'No data'));
}

function exportJSON() { download(JSON.stringify(db, null, 2), 'family-tree.json', 'application/json'); }
function importJSON(e) {
  const f = e.target.files[0]; if (!f) return;
  const r = new FileReader();
  r.onload = ev => { try { db = JSON.parse(ev.target.result); render(); toast(t('ØªÙ…', 'Done')); } catch { toast(t('Ø®Ø·Ø£', 'Error')); } };
  r.readAsText(f); e.target.value = '';
}

function exportPNG() {
  const svg = document.getElementById('svg');
  const data = new XMLSerializer().serializeToString(svg);
  const canvas = document.createElement('canvas');
  const ctx = canvas.getContext('2d');
  const img = new Image();
  canvas.width = svg.clientWidth * 2; canvas.height = svg.clientHeight * 2;
  img.onload = () => {
    ctx.fillStyle = '#0f172a'; ctx.fillRect(0, 0, canvas.width, canvas.height);
    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
    const a = document.createElement('a'); a.download = 'family-tree.png'; a.href = canvas.toDataURL('image/png'); a.click();
  };
  img.src = 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(data)));
}

function exportSVG() { download(new XMLSerializer().serializeToString(document.getElementById('svg')), 'family-tree.svg', 'image/svg+xml'); }

function download(content, name, type) {
  const blob = new Blob([content], { type });
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = name; a.click(); URL.revokeObjectURL(a.href);
}

function clearAll() {
  if (!confirm(t('Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„ØŸ', 'Clear all?'))) return;
  db = { persons: {}, relations: {} };
  render(); toast(t('ØªÙ…', 'Done'));
}

// ==================== UTILS ====================
function openModal(id) { document.getElementById(id).classList.add('show'); }
function closeModal(id) { document.getElementById(id).classList.remove('show'); }
function closeAllModals() { document.querySelectorAll('.ft-modal-bg.show').forEach(m => m.classList.remove('show')); }
function toast(msg) { const el = document.getElementById('toast'); el.textContent = msg; el.classList.add('show'); setTimeout(() => el.classList.remove('show'), 2500); }
function toggleDD(id) { event.stopPropagation(); document.getElementById(id).classList.toggle('open'); }

init();
</script>

<script>
  window.toolsData = [{"id":"percentage","icon":"ğŸ”¢","name":"Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø¦ÙˆÙŠØ©","keywords":"Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø¦ÙˆÙŠØ©ØŒ Ø­Ø³Ø§Ø¨ Ø§Ù„Ù†Ø³Ø¨Ø©ØŒ Ù†Ø³Ø¨Ø© Ø§Ù„Ø®ØµÙ…ØŒ Ø­Ø³Ø§Ø¨ Ø§Ù„Ø®ØµÙ…ØŒ percentage calculator","searchTerms":"Ù†Ø³Ø¨Ø© Ø§Ù„Ù†Ø³Ø¨Ø© Ù…Ø¦ÙˆÙŠØ© Ø§Ù„Ù…Ø¦ÙˆÙŠØ© Ù†Ø³Ø¨ Ù…Ø¦ÙˆÙŠÙ‡ Ø¨Ø§Ù„Ù…ÙŠØ© Ø¨Ø§Ù„Ù…ÙŠÙ‡ Ø¨Ø§Ù„Ù…Ø¦Ø© Ø¨Ø§Ù„Ù…Ø¦Ù‡ Ø§Ù„Ù…Ø¦ÙˆÙŠÙ‡ Ø®ØµÙ… Ø§Ù„Ø®ØµÙ… ØªØ®ÙÙŠØ¶ Ø§Ù„ØªØ®ÙÙŠØ¶ Ø­Ø³Ù… Ø§Ù„Ø­Ø³Ù… Ø³Ø¹Ø± Ø§Ù„Ø³Ø¹Ø± Ø§ÙˆÙ Ø¹Ø±Ø¶ Ø§Ù„Ø¹Ø±Ø¶ ØªÙ†Ø²ÙŠÙ„Ø§Øª Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø²ÙŠØ§Ø¯Ø© Ù†Ù‚ØµØ§Ù† Ø§Ù„Ù†Ù‚ØµØ§Ù† ÙØ±Ù‚ Ø§Ù„ÙØ±Ù‚ Ø±Ø¨Ø¹ Ø§Ù„Ø±Ø¨Ø¹ Ù†Øµ Ø§Ù„Ù†Øµ Ø«Ù„Ø« Ø§Ù„Ø«Ù„Ø« percent percentage Ø­Ø³Ø§Ø¨ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø±ÙŠØ§Ø¶ÙŠØ§Øª Ø±Ø¨Ø­ Ø§Ù„Ø±Ø¨Ø­ Ø®Ø³Ø§Ø±Ø© Ø§Ù„Ø®Ø³Ø§Ø±Ø© Ø¶Ø±ÙŠØ¨Ø© Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© Ø¶Ø±Ø§ÙŠØ¨ Ù‡Ø§Ù…Ø´ Ø§Ù„Ù‡Ø§Ù…Ø´ ÙƒØ³Ø± Ø§Ù„ÙƒØ³Ø± ÙƒØ³ÙˆØ± Ù‚Ø¨Ù„ Ø¨Ø¹Ø¯ Ø§ØµÙ„ÙŠ Ø§Ù„Ø§ØµÙ„ÙŠ Ø§ØµÙ„ Ø§Ù„Ø§ØµÙ„ ØªÙƒÙ„ÙØ© Ø§Ù„ØªÙƒÙ„ÙØ© Ø¨ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ¹ Ø´Ø±Ø§Ø¡ Ø§Ù„Ø´Ø±Ø§Ø¡ Ø¬Ø²Ø¡ Ø§Ù„Ø¬Ø²Ø¡ ÙƒÙ„ Ø§Ù„ÙƒÙ„ Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹","category":"calculators","categoryName":"Ø­Ø§Ø³Ø¨Ø§Øª","url":"../../ar/tools/percentage.html"},{"id":"interest-calculator","icon":"ğŸ’°","name":"Ø­Ø§Ø³Ø¨Ø© Ø§Ù„ÙÙˆØ§Ø¦Ø¯","keywords":"Ø­Ø§Ø³Ø¨Ø© Ø§Ù„ÙÙˆØ§Ø¦Ø¯ØŒ ÙØ§Ø¦Ø¯Ø© Ø¨Ø³ÙŠØ·Ø©ØŒ ÙØ§Ø¦Ø¯Ø© Ù…Ø±ÙƒØ¨Ø©ØŒ Ø­Ø³Ø§Ø¨ Ø§Ù„Ù‚Ø±Ø¶ØŒ interest calculator","searchTerms":"ÙØ§Ø¦Ø¯Ø© Ø§Ù„ÙØ§Ø¦Ø¯Ø© ÙÙˆØ§Ø¦Ø¯ Ø§Ù„ÙÙˆØ§Ø¦Ø¯ ÙØ§ÙŠØ¯Ø© Ø§Ù„ÙØ§ÙŠØ¯Ø© ÙÙˆØ§ÙŠØ¯ Ø¨Ø³ÙŠØ·Ø© Ø§Ù„Ø¨Ø³ÙŠØ·Ø© Ù…Ø±ÙƒØ¨Ø© Ø§Ù„Ù…Ø±ÙƒØ¨Ø© Ù…Ø±ÙƒØ¨Ù‡ Ù‚Ø±Ø¶ Ø§Ù„Ù‚Ø±Ø¶ Ù‚Ø±ÙˆØ¶ Ø§Ù„Ù‚Ø±ÙˆØ¶ Ø§Ø³ØªØ«Ù…Ø§Ø± Ø§Ù„Ø§Ø³ØªØ«Ù…Ø§Ø± Ø¹Ø§Ø¦Ø¯ Ø§Ù„Ø¹Ø§Ø¦Ø¯ Ø¹ÙˆØ§Ø¦Ø¯ Ø§Ù„Ø¹ÙˆØ§Ø¦Ø¯ Ø±Ø¨Ø­ Ø§Ù„Ø±Ø¨Ø­ Ø¨Ù†Ùƒ Ø§Ù„Ø¨Ù†Ùƒ Ø¨Ù†ÙˆÙƒ Ø§Ù„Ø¨Ù†ÙˆÙƒ Ù…Ø§Ù„ Ø§Ù„Ù…Ø§Ù„ Ù…Ø§Ù„ÙŠØ© Ø§Ù„Ù…Ø§Ù„ÙŠØ© ÙÙ„ÙˆØ³ Ø§Ù„ÙÙ„ÙˆØ³ Ø±Ø§Ø³ Ø±Ø£Ø³ Ø±Ø£Ø³Ù…Ø§Ù„ Ø³Ù†ÙˆÙŠ Ø§Ù„Ø³Ù†ÙˆÙŠ Ø´Ù‡Ø±ÙŠ Ø§Ù„Ø´Ù‡Ø±ÙŠ ÙŠÙˆÙ…ÙŠ Ø§Ù„ÙŠÙˆÙ…ÙŠ Ø±Ø¨Ø¹ÙŠ Ù†ØµÙ ØªØ±Ø§ÙƒÙ… Ø§Ù„ØªØ±Ø§ÙƒÙ… ØªØ±Ø§ÙƒÙ…ÙŠ Ø±ØµÙŠØ¯ Ø§Ù„Ø±ØµÙŠØ¯ Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¨Ù„Øº Ø§ØµÙ„ÙŠ Ø§Ù„Ø§ØµÙ„ÙŠ Ù…Ø¹Ø¯Ù„ Ø§Ù„Ù…Ø¹Ø¯Ù„ Ù†Ø³Ø¨Ø© Ø§Ù„Ù†Ø³Ø¨Ø© Ø­Ø³Ø§Ø¨ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ø­Ø³Ø¨ interest loan compound simple bank money investment","category":"calculators","categoryName":"Ø­Ø§Ø³Ø¨Ø§Øª","url":"../../ar/tools/interest-calculator.html"},{"id":"loan-calculator","icon":"ğŸ¦","name":"Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ù‚Ø±ÙˆØ¶","keywords":"Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ù‚Ø±ÙˆØ¶ØŒ Ù‚Ø³Ø· Ø´Ù‡Ø±ÙŠØŒ Ø¬Ø¯ÙˆÙ„ Ø³Ø¯Ø§Ø¯ØŒ ÙØ§Ø¦Ø¯Ø© Ø§Ù„Ù‚Ø±Ø¶ØŒ loan calculator","searchTerms":"Ù‚Ø±Ø¶ Ø§Ù„Ù‚Ø±Ø¶ Ù‚Ø±ÙˆØ¶ Ø§Ù„Ù‚Ø±ÙˆØ¶ ØªÙ…ÙˆÙŠÙ„ Ø§Ù„ØªÙ…ÙˆÙŠÙ„ Ø¨Ù†Ùƒ Ø§Ù„Ø¨Ù†Ùƒ Ø¨Ù†ÙˆÙƒ Ù‚Ø³Ø· Ø§Ù„Ù‚Ø³Ø· Ø§Ù‚Ø³Ø§Ø· Ø§Ù„Ø§Ù‚Ø³Ø§Ø· Ø´Ù‡Ø±ÙŠ Ø³Ø¯Ø§Ø¯ Ø¬Ø¯ÙˆÙ„ ÙØ§Ø¦Ø¯Ø© ÙÙˆØ§Ø¦Ø¯ ØªÙ‚Ø³ÙŠØ· Ø³ÙŠØ§Ø±Ø© Ù…Ù†Ø²Ù„ Ø¹Ù‚Ø§Ø± Ø´Ø®ØµÙŠ loan payment installment bank mortgage","category":"calculators","categoryName":"Ø­Ø§Ø³Ø¨Ø§Øª","url":"../../ar/tools/loan-calculator.html"},{"id":"body-calculator","icon":"âš–ï¸","name":"Ø­Ø§Ø³Ø¨Ø© ÙƒØªÙ„Ø© Ø§Ù„Ø¬Ø³Ù…","keywords":"Ø­Ø§Ø³Ø¨Ø© BMIØŒ Ù…Ø¤Ø´Ø± ÙƒØªÙ„Ø© Ø§Ù„Ø¬Ø³Ù…ØŒ Ø§Ù„ÙˆØ²Ù† Ø§Ù„Ù…Ø«Ø§Ù„ÙŠØŒ Ø§Ù„Ø³Ø¹Ø±Ø§Øª Ø§Ù„Ø­Ø±Ø§Ø±ÙŠØ©ØŒ Ù†Ø³Ø¨Ø© Ø§Ù„Ø¯Ù‡ÙˆÙ†","searchTerms":"ÙˆØ²Ù† Ø§Ù„ÙˆØ²Ù† ÙƒØªÙ„Ø© Ø§Ù„ÙƒØªÙ„Ø© Ø¬Ø³Ù… Ø§Ù„Ø¬Ø³Ù… bmi Ø¨ÙŠ Ø§Ù… Ø§ÙŠ Ù…Ø¤Ø´Ø± Ø³Ù…Ù†Ø© Ø§Ù„Ø³Ù…Ù†Ø© Ù†Ø­Ø§ÙØ© Ø¯Ù‡ÙˆÙ† Ø§Ù„Ø¯Ù‡ÙˆÙ† Ø³Ø¹Ø±Ø§Øª Ø§Ù„Ø³Ø¹Ø±Ø§Øª Ø­Ø±Ø§Ø±ÙŠØ© Ø§ÙŠØ¶ Ø§Ù„Ø§ÙŠØ¶ Ù…Ø«Ø§Ù„ÙŠ Ø§Ù„Ù…Ø«Ø§Ù„ÙŠ Ø·ÙˆÙ„ Ø§Ù„Ø·ÙˆÙ„ Ø®ØµØ± Ø§Ù„Ø®ØµØ± ÙˆØ±Ùƒ body mass index weight fat calories ideal","category":"calculators","categoryName":"Ø­Ø§Ø³Ø¨Ø§Øª","url":"../../ar/tools/body-calculator.html"},{"id":"age-calculator","icon":"ğŸ‚","name":"Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ø¹Ù…Ø±","keywords":"Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ø¹Ù…Ø±ØŒ Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¹Ù…Ø±ØŒ ÙƒÙ… Ø¹Ù…Ø±ÙŠØŒ Ø§Ù„Ø¨Ø±Ø¬ Ø§Ù„ÙÙ„ÙƒÙŠØŒ Ø¹ÙŠØ¯ Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯","searchTerms":"Ø¹Ù…Ø± Ø§Ù„Ø¹Ù…Ø± Ø¹Ù…Ø±ÙŠ Ø³Ù† Ø§Ù„Ø³Ù† ÙƒÙ… Ù…ÙŠÙ„Ø§Ø¯ Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯ ØªØ§Ø±ÙŠØ® Ø¨Ø±Ø¬ Ø§Ù„Ø¨Ø±Ø¬ Ø§Ø¨Ø±Ø§Ø¬ ÙÙ„ÙƒÙŠ Ø²ÙˆØ¯ÙŠØ§Ùƒ Ø³Ù†Ø© Ø´Ù‡Ø± ÙŠÙˆÙ… age birthday birth date zodiac calculate how old","category":"calculators","categoryName":"Ø­Ø§Ø³Ø¨Ø§Øª","url":"../../ar/tools/age-calculator.html"},{"id":"family-tree","icon":"ğŸŒ³","name":"Ø´Ø¬Ø±Ø© Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©","keywords":"Ø´Ø¬Ø±Ø© Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©ØŒ Ø´Ø¬Ø±Ø© Ø¹Ø§Ø¦Ù„Ø©ØŒ Ù†Ø³Ø¨ØŒ Ø³Ù„Ø§Ù„Ø©ØŒ Ø£Ù†Ø³Ø§Ø¨ØŒ Ø¹Ù„Ø§Ù‚Ø§Øª Ø¹Ø§Ø¦Ù„ÙŠØ©ØŒ family tree","searchTerms":"Ø´Ø¬Ø±Ø© Ø¹Ø§Ø¦Ù„Ø© Ø¹Ø§Ø¦Ù„Ù‡ Ø§Ù„Ø¹Ø§Ø¦Ù„Ù‡ Ø§Ù„Ø¹Ø§Ø¦Ù„Ø© Ù†Ø³Ø¨ Ø£Ù†Ø³Ø§Ø¨ Ø§Ù„Ø£Ù†Ø³Ø§Ø¨ Ø³Ù„Ø§Ù„Ø© Ø¬Ø¯ Ø¬Ø¯Ø© Ø£Ø¨ Ø£Ù… Ø§Ø¨Ù† Ø§Ø¨Ù†Ø© Ø£Ø® Ø£Ø®Øª Ø¹Ù… Ø¹Ù…Ø© Ø®Ø§Ù„ Ø®Ø§Ù„Ø© Ù‚Ø±Ø§Ø¨Ø© Ù‚Ø±ÙŠØ¨ Ø£Ù‚Ø§Ø±Ø¨ Ø§Ù„Ø£Ù‚Ø§Ø±Ø¨ Ù†Ø³Ù„ Ø°Ø±ÙŠØ© family tree genealogy","category":"everyday","categoryName":"Ø£Ø¯ÙˆØ§Øª ÙŠÙˆÙ…ÙŠØ©","url":"../../ar/tools/family-tree.html"}];
</script>
      </main>
      
      <footer class="main-footer">
        <p>ØµÙÙ†Ø¹ Ø¨Ù€ â¤ï¸ | Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø© Â© 2026 Ø¹ÙØ¯Ù‘Ø©</p>
      </footer>
    </div>
  </div>
  
  <!-- Settings Panel -->
  <div class="settings-overlay"></div>
  <div class="settings-panel">
    <div class="settings-header">
      <h2 class="settings-title">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</h2>
      <button class="settings-close" aria-label="Close">âœ•</button>
    </div>
    <div class="settings-content">
      <div class="settings-section">
        <div class="settings-section-title">Ø§Ù„Ù„ØºØ©</div>
        <div class="settings-option">
          <button class="settings-btn active" data-lang-btn="ar">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</button>
          <button class="settings-btn " data-lang-btn="en">English</button>
        </div>
      </div>
      <div class="settings-section">
        <div class="settings-section-title">Ø§Ù„Ù…Ø¸Ù‡Ø±</div>
        <div class="settings-option">
          <button class="settings-btn" data-theme-btn="light">â˜€ï¸ ÙØ§ØªØ­</button>
          <button class="settings-btn" data-theme-btn="dark">ğŸŒ™ Ø¯Ø§ÙƒÙ†</button>
          <button class="settings-btn active" data-theme-btn="auto">ğŸ’» ØªÙ„Ù‚Ø§Ø¦ÙŠ</button>
        </div>
      </div>
      <div class="settings-section">
        <button class="settings-btn" data-clear-data style="width:100%;justify-content:center;color:var(--error);">
          ğŸ—‘ï¸ Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©
        </button>
      </div>
    </div>
  </div>
  
  <div class="toast"></div>
  <script src="../../assets/js/app.js"></script>
</body>
</html>