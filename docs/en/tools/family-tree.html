<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Family Tree - Create Your Family Tree Free | Udda</title>
  <meta name="description" content="Free tool to create your family tree easily. Add people and relationships, upload photos, and export as image or PDF.">
  <meta name="keywords" content="family tree, genealogy, ancestry, lineage, family relationships, family tree maker">
  <meta name="author" content="Udda">
  <meta name="robots" content="index, follow">
  
  <meta property="og:type" content="website">
  <meta property="og:title" content="Family Tree - Create Your Family Tree Free | Udda">
  <meta property="og:description" content="Free tool to create your family tree easily. Add people and relationships, upload photos, and export as image or PDF.">
  <meta property="og:url" content="https://udda.tools/en/tools/family-tree.html">
  <meta property="og:site_name" content="Udda">
  <meta property="og:locale" content="en_US">
  
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Family Tree - Create Your Family Tree Free | Udda">
  <meta name="twitter:description" content="Free tool to create your family tree easily. Add people and relationships, upload photos, and export as image or PDF.">
  
  <link rel="alternate" hreflang="ar" href="https://udda.tools/ar/tools/family-tree.html">
  <link rel="alternate" hreflang="en" href="https://udda.tools/en/tools/family-tree.html">
  <link rel="alternate" hreflang="x-default" href="https://udda.tools/ar/tools/family-tree.html">
  <link rel="canonical" href="https://udda.tools/en/tools/family-tree.html">
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../../assets/css/main.css">
  
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "WebApplication",
    "name": "Family Tree",
    "description": "Free tool to create your family tree easily. Add people and relationships, upload photos, and export as image or PDF.",
    "url": "https://udda.tools/en/tools/family-tree.html",
    "applicationCategory": "UtilityApplication",
    "operatingSystem": "Any",
    "offers": { "@type": "Offer", "price": "0", "priceCurrency": "USD" },
    "inLanguage": ["ar", "en"],
    "isAccessibleForFree": true
  }
  </script>
</head>
<body data-tool-id="family-tree">
  <div class="app-container">
    <div class="sidebar-overlay"></div>
    
    <aside class="sidebar">
      <div class="sidebar-header">
        <a href="../../en/" class="logo">
          <div class="logo-icon">ğŸ”§</div>
          <span class="logo-text sidebar-text">Udda</span>
        </a>
      </div>
      
      <div class="sidebar-search">
        <div class="search-input-wrapper">
          <input type="text" class="search-input" placeholder="Search for a tool..." aria-label="Search for a tool...">
          <svg class="search-icon" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <circle cx="11" cy="11" r="8"></circle>
            <path d="m21 21-4.35-4.35"></path>
          </svg>
        </div>
      </div>
      
      <nav class="sidebar-nav">
        
        <a href="../../en/" class="nav-item ">
          <span class="nav-item-icon">ğŸ </span>
          <span class="sidebar-text">Home</span>
        </a>
        <div class="nav-section ">
          <div class="nav-section-title">
            <span>
              <span class="nav-section-icon">ğŸ§®</span>
              <span class="sidebar-text">Calculators</span>
            </span>
            <svg class="nav-section-arrow sidebar-text" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path d="m6 9 6 6 6-6"></path>
            </svg>
          </div>
          <div class="nav-section-items">
            <a href="../../en/tools/percentage.html" class="nav-item ">
              <span class="nav-item-icon">ğŸ”¢</span>
              <span class="sidebar-text">Percentage Calculator</span>
            </a>
            <a href="../../en/tools/interest-calculator.html" class="nav-item ">
              <span class="nav-item-icon">ğŸ’°</span>
              <span class="sidebar-text">Interest Calculator</span>
            </a>
            <a href="../../en/tools/loan-calculator.html" class="nav-item ">
              <span class="nav-item-icon">ğŸ¦</span>
              <span class="sidebar-text">Loan Calculator</span>
            </a>
            <a href="../../en/tools/body-calculator.html" class="nav-item ">
              <span class="nav-item-icon">âš–ï¸</span>
              <span class="sidebar-text">Body Calculator</span>
            </a>
            <a href="../../en/tools/age-calculator.html" class="nav-item ">
              <span class="nav-item-icon">ğŸ‚</span>
              <span class="sidebar-text">Age Calculator</span>
            </a>
          </div>
        </div>
        <div class="nav-section ">
          <div class="nav-section-title">
            <span>
              <span class="nav-section-icon">ğŸ”„</span>
              <span class="sidebar-text">Converters</span>
            </span>
            <svg class="nav-section-arrow sidebar-text" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path d="m6 9 6 6 6-6"></path>
            </svg>
          </div>
          <div class="nav-section-items">
          </div>
        </div>
        <div class="nav-section ">
          <div class="nav-section-title">
            <span>
              <span class="nav-section-icon">ğŸ“</span>
              <span class="sidebar-text">Text Tools</span>
            </span>
            <svg class="nav-section-arrow sidebar-text" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path d="m6 9 6 6 6-6"></path>
            </svg>
          </div>
          <div class="nav-section-items">
          </div>
        </div>
        <div class="nav-section ">
          <div class="nav-section-title">
            <span>
              <span class="nav-section-icon">ğŸ“…</span>
              <span class="sidebar-text">Date & Time</span>
            </span>
            <svg class="nav-section-arrow sidebar-text" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path d="m6 9 6 6 6-6"></path>
            </svg>
          </div>
          <div class="nav-section-items">
          </div>
        </div>
        <div class="nav-section ">
          <div class="nav-section-title">
            <span>
              <span class="nav-section-icon">âš¡</span>
              <span class="sidebar-text">Generators</span>
            </span>
            <svg class="nav-section-arrow sidebar-text" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path d="m6 9 6 6 6-6"></path>
            </svg>
          </div>
          <div class="nav-section-items">
          </div>
        </div>
        <div class="nav-section ">
          <div class="nav-section-title">
            <span>
              <span class="nav-section-icon">ğŸ–¼ï¸</span>
              <span class="sidebar-text">Image Tools</span>
            </span>
            <svg class="nav-section-arrow sidebar-text" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path d="m6 9 6 6 6-6"></path>
            </svg>
          </div>
          <div class="nav-section-items">
          </div>
        </div>
        <div class="nav-section ">
          <div class="nav-section-title">
            <span>
              <span class="nav-section-icon">ğŸ’»</span>
              <span class="sidebar-text">Developer Tools</span>
            </span>
            <svg class="nav-section-arrow sidebar-text" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path d="m6 9 6 6 6-6"></path>
            </svg>
          </div>
          <div class="nav-section-items">
          </div>
        </div>
        <div class="nav-section open">
          <div class="nav-section-title">
            <span>
              <span class="nav-section-icon">ğŸ </span>
              <span class="sidebar-text">Everyday Tools</span>
            </span>
            <svg class="nav-section-arrow sidebar-text" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path d="m6 9 6 6 6-6"></path>
            </svg>
          </div>
          <div class="nav-section-items">
            <a href="../../en/tools/family-tree.html" class="nav-item active">
              <span class="nav-item-icon">ğŸŒ³</span>
              <span class="sidebar-text">Family Tree</span>
            </a>
          </div>
        </div>
      </nav>
      
      <div class="sidebar-footer">
        <button class="sidebar-toggle" aria-label="Toggle sidebar">
          <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path d="M11 19l-7-7 7-7m8 14l-7-7 7-7"></path>
          </svg>
          <span class="sidebar-text">Sidebar</span>
        </button>
      </div>
    </aside>
    
    <div class="main-content">
      <header class="main-header">
        <button class="header-btn mobile-menu-btn" aria-label="Menu">
          <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path d="M4 6h16M4 12h16M4 18h16"></path>
          </svg>
        </button>
        
        <nav class="header-breadcrumb">
          <a href="../../en/" class="breadcrumb-link">Home</a>
          <span class="breadcrumb-separator">â€º</span>
          <a href="../../en/category/everyday.html" class="breadcrumb-link">Everyday Tools</a>
          <span class="breadcrumb-separator">â€º</span>
          <span class="breadcrumb-current">Family Tree</span>
        </nav>
        
        <div class="header-actions">
          <button class="header-btn" data-favorite-btn aria-label="Add to Favorites">â˜†</button>
          <button class="header-btn" onclick="App.shareUrl('Family Tree')" aria-label="Share">
            <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"></path>
              <polyline points="16 6 12 2 8 6"></polyline>
              <line x1="12" y1="2" x2="12" y2="15"></line>
            </svg>
          </button>
          <button class="header-btn" data-open-settings aria-label="Settings">
            <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <circle cx="12" cy="12" r="3"></circle>
              <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
            </svg>
          </button>
        </div>
      </header>
      
      <main class="page-content">
        <style>
:root {
  --primary: #059669;
  --primary-dark: #047857;
  --male-color: #3b82f6;
  --female-color: #ec4899;
  --marriage-color: #f59e0b;
  --bg-secondary: #1e293b;
  --bg-card: #334155;
  --text-primary: #f8fafc;
  --text-secondary: #94a3b8;
  --text-muted: #64748b;
  --border-color: #475569;
  --danger: #ef4444;
}

* { box-sizing: border-box; }

.ft-container {
  display: flex;
  gap: 10px;
  min-height: 70vh;
}

/* ========== PERSONS SIDEBAR ========== */
.ft-sidebar {
  width: 220px;
  background: var(--bg-secondary);
  border-radius: 10px;
  display: flex;
  flex-direction: column;
  flex-shrink: 0;
  overflow: hidden;
}

.ft-sidebar-head {
  padding: 12px;
  border-bottom: 2px solid var(--border-color);
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.ft-sidebar-head h4 {
  margin: 0;
  font-size: 0.9rem;
  color: var(--text-primary);
  display: flex;
  align-items: center;
  gap: 6px;
}

.ft-sidebar-head .count {
  background: var(--primary);
  color: white;
  padding: 2px 8px;
  border-radius: 10px;
  font-size: 0.7rem;
}

.ft-sidebar-search {
  padding: 8px;
  border-bottom: 1px solid var(--border-color);
}

.ft-sidebar-search input {
  width: 100%;
  padding: 8px 10px;
  background: var(--bg-card);
  border: 2px solid var(--border-color);
  border-radius: 6px;
  color: var(--text-primary);
  font-size: 0.8rem;
  font-family: inherit;
}

.ft-sidebar-search input:focus { outline: none; border-color: var(--primary); }

.ft-sidebar-list {
  flex: 1;
  overflow-y: auto;
  padding: 6px;
}

.ft-list-item {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 8px;
  background: var(--bg-card);
  border-radius: 6px;
  margin-bottom: 4px;
  cursor: pointer;
  border: 2px solid transparent;
  transition: all 0.15s;
}

.ft-list-item:hover { border-color: var(--primary); }
.ft-list-item.orphan { border: 2px dashed var(--text-muted); }
.ft-list-item.male { border-left: 3px solid var(--male-color); }
.ft-list-item.female { border-left: 3px solid var(--female-color); }

.ft-list-item .av {
  width: 30px;
  height: 30px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.1rem;
  flex-shrink: 0;
}

.ft-list-item .info { flex: 1; min-width: 0; }
.ft-list-item .nm { font-size: 0.8rem; font-weight: 600; color: var(--text-primary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.ft-list-item .sub { font-size: 0.65rem; color: var(--text-muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

.ft-list-item .menu-btn {
  padding: 3px 6px;
  background: none;
  border: none;
  color: var(--text-muted);
  cursor: pointer;
  font-size: 0.9rem;
  border-radius: 4px;
}

.ft-list-item .menu-btn:hover { background: var(--bg-secondary); color: var(--text-primary); }

.ft-section-label {
  font-size: 0.7rem;
  color: var(--text-muted);
  padding: 8px 6px 4px;
  border-top: 1px solid var(--border-color);
  margin-top: 6px;
}

.ft-add-btn {
  margin: 8px;
  padding: 10px;
  background: var(--primary);
  border: none;
  border-radius: 6px;
  color: white;
  font-weight: 600;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
  font-family: inherit;
  font-size: 0.85rem;
}

.ft-add-btn:hover { background: var(--primary-dark); }

/* ========== MAIN AREA ========== */
.ft-main {
  flex: 1;
  display: flex;
  flex-direction: column;
  min-width: 0;
}

/* Toolbar */
.ft-toolbar {
  display: flex;
  flex-wrap: wrap;
  gap: 5px;
  padding: 8px 10px;
  background: var(--bg-secondary);
  border-radius: 8px;
  margin-bottom: 8px;
}

.ft-toolbar-group {
  display: flex;
  gap: 4px;
  padding-left: 10px;
  border-left: 2px solid var(--border-color);
}

.ft-toolbar-group:first-child { border-left: none; padding-left: 0; }

.ft-btn {
  display: flex;
  align-items: center;
  gap: 4px;
  padding: 6px 10px;
  background: var(--bg-card);
  border: 2px solid var(--border-color);
  border-radius: 5px;
  color: var(--text-primary);
  font-size: 0.75rem;
  font-weight: 600;
  cursor: pointer;
  font-family: inherit;
  transition: all 0.15s;
}

.ft-btn:hover { border-color: var(--primary); }
.ft-btn .ic { font-size: 0.95rem; }

/* Canvas */
.ft-canvas {
  flex: 1;
  position: relative;
  background: var(--bg-secondary);
  border-radius: 8px;
  overflow: hidden;
  min-height: 380px;
  border: 2px solid var(--border-color);
}

.ft-svg { width: 100%; height: 100%; min-height: 380px; cursor: grab; }
.ft-svg:active { cursor: grabbing; }
.ft-svg text { font-family: inherit; pointer-events: none; }

.ft-empty {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  text-align: center;
  color: var(--text-muted);
  pointer-events: none;
}

.ft-empty .ic { font-size: 3rem; margin-bottom: 8px; opacity: 0.5; }
.ft-empty h3 { margin: 0; color: var(--text-secondary); font-size: 1rem; }

/* Zoom */
.ft-zoom {
  position: absolute;
  bottom: 10px;
  right: 10px;
  display: flex;
  flex-direction: column;
  gap: 3px;
  background: var(--bg-card);
  padding: 4px;
  border-radius: 6px;
  border: 2px solid var(--border-color);
}

.ft-zoom-btn {
  width: 28px;
  height: 28px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: var(--bg-secondary);
  border: none;
  border-radius: 4px;
  color: var(--text-primary);
  font-size: 0.9rem;
  cursor: pointer;
}

.ft-zoom-btn:hover { background: var(--primary); }
.ft-zoom-lvl { text-align: center; font-size: 0.65rem; color: var(--text-muted); }

/* Stats */
.ft-stats {
  display: flex;
  gap: 12px;
  padding: 7px 12px;
  background: var(--bg-card);
  border-radius: 6px;
  margin-top: 8px;
  flex-wrap: wrap;
}

.ft-stat { display: flex; align-items: center; gap: 4px; font-size: 0.75rem; }
.ft-stat .lbl { color: var(--text-muted); }
.ft-stat .val { font-weight: 700; color: var(--text-primary); }

/* ========== MODALS ========== */
.ft-modal-bg {
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.75);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
  opacity: 0;
  visibility: hidden;
  transition: all 0.25s;
}

.ft-modal-bg.show { opacity: 1; visibility: visible; }

.ft-modal {
  background: var(--bg-secondary);
  border-radius: 12px;
  width: 92%;
  max-width: 450px;
  max-height: 85vh;
  overflow-y: auto;
  transform: scale(0.9);
  transition: transform 0.25s;
}

.ft-modal-bg.show .ft-modal { transform: scale(1); }

.ft-modal-head {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 12px 16px;
  border-bottom: 2px solid var(--border-color);
  position: sticky;
  top: 0;
  background: var(--bg-secondary);
  z-index: 10;
}

.ft-modal-head h2 { font-size: 0.95rem; color: var(--text-primary); margin: 0; }

.ft-modal-close {
  background: none;
  border: none;
  font-size: 1.3rem;
  color: var(--text-muted);
  cursor: pointer;
  padding: 2px 6px;
  border-radius: 4px;
}

.ft-modal-close:hover { background: var(--bg-card); color: var(--text-primary); }

.ft-modal-body { padding: 14px 16px; }

.ft-form-group { margin-bottom: 12px; }
.ft-form-group label { display: block; font-size: 0.75rem; font-weight: 600; color: var(--text-secondary); margin-bottom: 4px; }

.ft-form-group input,
.ft-form-group select,
.ft-form-group textarea {
  width: 100%;
  padding: 8px 10px;
  background: var(--bg-card);
  border: 2px solid var(--border-color);
  border-radius: 6px;
  color: var(--text-primary);
  font-size: 0.85rem;
  font-family: inherit;
}

.ft-form-group input:focus,
.ft-form-group select:focus { outline: none; border-color: var(--primary); }

.ft-form-row { display: flex; gap: 10px; }
.ft-form-row .ft-form-group { flex: 1; }

/* Gender */
.ft-gender { display: flex; gap: 8px; }

.ft-gender-opt {
  flex: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 5px;
  padding: 10px;
  background: var(--bg-card);
  border: 2px solid var(--border-color);
  border-radius: 6px;
  cursor: pointer;
}

.ft-gender-opt input { display: none; }
.ft-gender-opt.male:has(input:checked) { border-color: var(--male-color); background: rgba(59,130,246,0.15); }
.ft-gender-opt.female:has(input:checked) { border-color: var(--female-color); background: rgba(236,72,153,0.15); }
.ft-gender-opt span { font-weight: 600; font-size: 0.85rem; }

/* Photo */
.ft-photo-row { display: flex; align-items: center; gap: 12px; }

.ft-photo-preview {
  width: 50px;
  height: 50px;
  border-radius: 50%;
  background: var(--bg-card);
  border: 2px solid var(--border-color);
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
}

.ft-photo-preview img { width: 100%; height: 100%; object-fit: cover; }
.ft-photo-preview .ph { font-size: 1.4rem; color: var(--text-muted); }

.ft-photo-btn {
  padding: 5px 10px;
  background: var(--bg-card);
  border: 2px solid var(--border-color);
  border-radius: 5px;
  color: var(--text-primary);
  font-size: 0.7rem;
  cursor: pointer;
  font-family: inherit;
}

.ft-photo-btn:hover { border-color: var(--primary); }
.ft-photo-btn.rm { border-color: var(--danger); color: var(--danger); }

/* Person Select */
.ft-person-select {
  border: 2px solid var(--border-color);
  border-radius: 6px;
  overflow: hidden;
}

.ft-person-select-search {
  width: 100%;
  padding: 7px 10px;
  background: var(--bg-card);
  border: none;
  border-bottom: 1px solid var(--border-color);
  color: var(--text-primary);
  font-size: 0.8rem;
  font-family: inherit;
}

.ft-person-select-list { max-height: 140px; overflow-y: auto; }

.ft-person-opt {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 6px 8px;
  cursor: pointer;
  border: 2px solid transparent;
  margin: 3px;
  border-radius: 5px;
}

.ft-person-opt:hover { background: var(--bg-card); }
.ft-person-opt.selected { border-color: var(--primary); background: rgba(5,150,105,0.15); }
.ft-person-opt.none { color: var(--text-muted); border: 2px dashed var(--border-color); justify-content: center; }

.ft-person-opt .av { font-size: 1rem; }
.ft-person-opt .nm { font-size: 0.8rem; color: var(--text-primary); }

/* Status */
.ft-status-opts { display: flex; gap: 6px; flex-wrap: wrap; }

.ft-status-opt {
  flex: 1;
  min-width: 75px;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 3px;
  padding: 8px 5px;
  background: var(--bg-card);
  border: 2px solid var(--border-color);
  border-radius: 6px;
  cursor: pointer;
}

.ft-status-opt input { display: none; }
.ft-status-opt:has(input:checked) { border-color: var(--primary); background: rgba(5,150,105,0.15); }
.ft-status-opt .ic { font-size: 1.1rem; }
.ft-status-opt .tx { font-size: 0.65rem; color: var(--text-secondary); text-align: center; }

/* Modal Footer */
.ft-modal-foot {
  display: flex;
  gap: 6px;
  padding: 10px 16px;
  border-top: 2px solid var(--border-color);
  position: sticky;
  bottom: 0;
  background: var(--bg-secondary);
}

.ft-modal-foot button {
  flex: 1;
  padding: 9px;
  border-radius: 6px;
  font-size: 0.85rem;
  font-weight: 700;
  cursor: pointer;
  font-family: inherit;
}

.ft-btn-cancel { background: var(--bg-card); border: 2px solid var(--border-color); color: var(--text-primary); }
.ft-btn-save { background: var(--primary); border: none; color: white; }
.ft-btn-save:hover { background: var(--primary-dark); }
.ft-btn-del { background: var(--danger); border: none; color: white; flex: 0.4; }

/* Tabs */
.ft-tabs { display: flex; border-bottom: 2px solid var(--border-color); margin-bottom: 12px; }

.ft-tab {
  flex: 1;
  padding: 8px;
  background: none;
  border: none;
  color: var(--text-muted);
  font-weight: 600;
  cursor: pointer;
  font-family: inherit;
  font-size: 0.8rem;
  border-bottom: 2px solid transparent;
  margin-bottom: -2px;
}

.ft-tab.active { color: var(--primary); border-bottom-color: var(--primary); }

/* ========== RELATIONS MODAL ========== */
.ft-rel-section {
  background: var(--bg-card);
  border-radius: 8px;
  margin-bottom: 12px;
  overflow: hidden;
}

.ft-rel-section-head {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 10px 12px;
  background: rgba(0,0,0,0.2);
  font-weight: 600;
  font-size: 0.8rem;
  color: var(--text-primary);
}

.ft-rel-section-head .add-btn {
  padding: 3px 8px;
  background: var(--primary);
  border: none;
  border-radius: 4px;
  color: white;
  font-size: 0.7rem;
  cursor: pointer;
}

.ft-rel-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 10px 12px;
  border-bottom: 1px solid var(--border-color);
}

.ft-rel-item:last-child { border-bottom: none; }

.ft-rel-item .av { font-size: 1.2rem; }

.ft-rel-item .info { flex: 1; }
.ft-rel-item .nm { font-weight: 600; font-size: 0.85rem; color: var(--text-primary); }
.ft-rel-item .role { font-size: 0.7rem; color: var(--text-muted); }

.ft-rel-item .actions { display: flex; gap: 4px; }

.ft-rel-item .act-btn {
  padding: 4px 8px;
  background: var(--bg-secondary);
  border: 1px solid var(--border-color);
  border-radius: 4px;
  color: var(--text-primary);
  font-size: 0.7rem;
  cursor: pointer;
}

.ft-rel-item .act-btn:hover { border-color: var(--primary); }
.ft-rel-item .act-btn.danger { color: var(--danger); border-color: var(--danger); }
.ft-rel-item .act-btn.danger:hover { background: var(--danger); color: white; }

.ft-rel-empty {
  padding: 15px;
  text-align: center;
  color: var(--text-muted);
  font-size: 0.8rem;
}

/* Context Menu */
.ft-ctx {
  position: fixed;
  background: var(--bg-card);
  border: 2px solid var(--border-color);
  border-radius: 8px;
  min-width: 150px;
  z-index: 2000;
  box-shadow: 0 8px 25px rgba(0,0,0,0.4);
  display: none;
}

.ft-ctx.show { display: block; }

.ft-ctx-item {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 9px 14px;
  color: var(--text-primary);
  cursor: pointer;
  font-size: 0.8rem;
}

.ft-ctx-item:first-child { border-radius: 6px 6px 0 0; }
.ft-ctx-item:last-child { border-radius: 0 0 6px 6px; }
.ft-ctx-item:hover { background: var(--bg-secondary); }
.ft-ctx-item.danger { color: var(--danger); }

.ft-ctx-divider { height: 1px; background: var(--border-color); margin: 2px 0; }

/* Add Menu */
.ft-add-menu {
  position: fixed;
  background: var(--bg-card);
  border: 2px solid var(--primary);
  border-radius: 8px;
  min-width: 160px;
  z-index: 2000;
  box-shadow: 0 8px 25px rgba(0,0,0,0.5);
  display: none;
  transform: translate(-50%, 5px);
}

.ft-add-menu.show { display: block; }

.ft-add-item {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 10px 14px;
  color: var(--text-primary);
  cursor: pointer;
  font-size: 0.8rem;
}

.ft-add-item:first-child { border-radius: 6px 6px 0 0; }
.ft-add-item:last-child { border-radius: 0 0 6px 6px; }
.ft-add-item:hover { background: var(--primary); }

/* Toast */
.ft-toast {
  position: fixed;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%) translateY(100px);
  background: var(--bg-card);
  border: 2px solid var(--primary);
  padding: 12px 20px;
  border-radius: 8px;
  color: var(--text-primary);
  font-weight: 600;
  z-index: 3000;
  opacity: 0;
  transition: all 0.3s;
}

.ft-toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }

/* Dropdown */
.ft-dropdown { position: relative; }

.ft-dropdown-menu {
  position: absolute;
  top: 100%;
  right: 0;
  margin-top: 4px;
  background: var(--bg-card);
  border: 2px solid var(--border-color);
  border-radius: 6px;
  min-width: 110px;
  z-index: 100;
  opacity: 0;
  visibility: hidden;
}

.ft-dropdown.open .ft-dropdown-menu { opacity: 1; visibility: visible; }

.ft-dropdown-item { display: flex; align-items: center; gap: 5px; padding: 7px 10px; color: var(--text-primary); font-size: 0.75rem; cursor: pointer; }
.ft-dropdown-item:hover { background: var(--bg-secondary); }

.ft-dropdown-divider { height: 1px; background: var(--border-color); }

.hidden { display: none; }

/* Dragging card */
.ft-card-dragging { opacity: 0.6; }

@media (max-width: 700px) {
  .ft-container { flex-direction: column; }
  .ft-sidebar { width: 100%; max-height: 180px; }
  .ft-btn span:not(.ic) { display: none; }
}
</style>

<div class="tool-card">
  <div class="tool-header">
    <div class="tool-icon">ğŸŒ³</div>
    <div>
      <h1 class="tool-title">Family Tree</h1>
      <p class="tool-description">Create your family tree easily and export it</p>
    </div>
  </div>

  <div class="ft-container">
    <!-- Sidebar: Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø´Ø®Ø§Øµ -->
    <aside class="ft-sidebar">
      <div class="ft-sidebar-head">
        <h4>ğŸ“‹ <span id="txt-persons">Ø§Ù„Ø£Ø´Ø®Ø§Øµ</span> <span class="count" id="persons-count">0</span></h4>
      </div>
      <div class="ft-sidebar-search">
        <input type="text" id="search-input" placeholder="Ø§Ø¨Ø­Ø«..." oninput="filterList()">
      </div>
      <div class="ft-sidebar-list" id="persons-list"></div>
      <button class="ft-add-btn" onclick="openPersonModal()">â• <span id="txt-add">Ø¥Ø¶Ø§ÙØ© Ø´Ø®Øµ</span></button>
    </aside>

    <!-- Main Area -->
    <main class="ft-main">
      <div class="ft-toolbar">
        <div class="ft-toolbar-group">
          <button class="ft-btn" onclick="saveLocal()"><span class="ic">ğŸ’¾</span><span>Ø­ÙØ¸</span></button>
          <button class="ft-btn" onclick="loadLocal()"><span class="ic">ğŸ“‚</span><span>ØªØ­Ù…ÙŠÙ„</span></button>
        </div>
        <div class="ft-toolbar-group">
          <div class="ft-dropdown" id="export-dd">
            <button class="ft-btn" onclick="toggleDD('export-dd')"><span class="ic">ğŸ“¤</span><span>ØªØµØ¯ÙŠØ±</span></button>
            <div class="ft-dropdown-menu">
              <div class="ft-dropdown-item" onclick="exportPNG()">ğŸ–¼ï¸ PNG</div>
              <div class="ft-dropdown-item" onclick="exportSVG()">ğŸ“ SVG</div>
              <div class="ft-dropdown-divider"></div>
              <div class="ft-dropdown-item" onclick="exportJSON()">ğŸ“„ JSON</div>
            </div>
          </div>
          <button class="ft-btn" onclick="document.getElementById('import-file').click()"><span class="ic">ğŸ“¥</span><span>Ø§Ø³ØªÙŠØ±Ø§Ø¯</span></button>
        </div>
        <div class="ft-toolbar-group">
          <button class="ft-btn" onclick="resetLayout()"><span class="ic">ğŸ“</span><span>Reset</span></button>
          <button class="ft-btn" onclick="clearAll()"><span class="ic">ğŸ—‘ï¸</span><span>Clear</span></button>
        </div>
      </div>

      <div class="ft-canvas" id="canvas">
        <svg class="ft-svg" id="svg">
          <defs>
            <filter id="shadow" x="-20%" y="-20%" width="140%" height="140%">
              <feDropShadow dx="0" dy="2" stdDeviation="3" flood-opacity="0.25"/>
            </filter>
          </defs>
          <g id="tree-g">
            <g id="lines-g"></g>
            <g id="cards-g"></g>
          </g>
        </svg>
        <div class="ft-empty" id="empty-msg">
          <div class="ic">ğŸŒ³</div>
          <h3>Ø§Ø¨Ø¯Ø£ Ø¨Ø¥Ø¶Ø§ÙØ© Ø´Ø®Øµ</h3>
        </div>
        <div class="ft-zoom">
          <button class="ft-zoom-btn" onclick="zoomIn()">â•</button>
          <div class="ft-zoom-lvl" id="zoom-lvl">100%</div>
          <button class="ft-zoom-btn" onclick="zoomOut()">â–</button>
          <button class="ft-zoom-btn" onclick="fitView()">âŠ¡</button>
        </div>
      </div>

      <div class="ft-stats">
        <div class="ft-stat"><span class="lbl">ğŸ‘¥</span><span class="val" id="stat-total">0</span></div>
        <div class="ft-stat"><span class="lbl">ğŸ‘¨</span><span class="val" id="stat-males">0</span></div>
        <div class="ft-stat"><span class="lbl">ğŸ‘©</span><span class="val" id="stat-females">0</span></div>
        <div class="ft-stat"><span class="lbl">ğŸ’‘</span><span class="val" id="stat-marriages">0</span></div>
        <div class="ft-stat"><span class="lbl">ğŸ“Š</span><span class="val" id="stat-gens">0</span></div>
      </div>
    </main>
  </div>
</div>

<!-- Person Modal -->
<div class="ft-modal-bg" id="person-modal">
  <div class="ft-modal">
    <div class="ft-modal-head">
      <h2 id="pm-title">ğŸ‘¤ Ø¥Ø¶Ø§ÙØ© Ø´Ø®Øµ</h2>
      <button class="ft-modal-close" onclick="closeModal('person-modal')">&times;</button>
    </div>
    <div class="ft-modal-body">
      <div class="ft-form-group">
        <label>Ø§Ù„Ø§Ø³Ù… *</label>
        <input type="text" id="p-name">
      </div>
      <div class="ft-form-group">
        <label>Ø§Ù„Ø¬Ù†Ø³</label>
        <div class="ft-gender">
          <label class="ft-gender-opt male"><input type="radio" name="p-gender" value="male" checked><span>ğŸ‘¨ Ø°ÙƒØ±</span></label>
          <label class="ft-gender-opt female"><input type="radio" name="p-gender" value="female"><span>ğŸ‘© Ø£Ù†Ø«Ù‰</span></label>
        </div>
      </div>
      <div class="ft-form-group">
        <label>Ø§Ù„ØµÙˆØ±Ø©</label>
        <div class="ft-photo-row">
          <div class="ft-photo-preview" id="photo-prev"><span class="ph">ğŸ‘¤</span></div>
          <div>
            <button type="button" class="ft-photo-btn" onclick="document.getElementById('photo-input').click()">ğŸ“· Ø±ÙØ¹</button>
            <button type="button" class="ft-photo-btn rm" onclick="clearPhoto()" id="btn-rm-photo" style="display:none">ğŸ—‘ï¸</button>
          </div>
        </div>
        <input type="file" id="photo-input" class="hidden" accept="image/*" onchange="onPhotoSelect(event)">
      </div>
      <div class="ft-form-row">
        <div class="ft-form-group"><label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯</label><input type="date" id="p-birth"></div>
        <div class="ft-form-group"><label>ØªØ§Ø±ÙŠØ® Ø§Ù„ÙˆÙØ§Ø©</label><input type="date" id="p-death"></div>
      </div>
      <div class="ft-form-group">
        <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
        <textarea id="p-notes" rows="2"></textarea>
      </div>
    </div>
    <div class="ft-modal-foot">
      <button class="ft-btn-del" id="pm-del" onclick="deletePerson()" style="display:none">ğŸ—‘ï¸</button>
      <button class="ft-btn-cancel" onclick="closeModal('person-modal')">Ø¥Ù„ØºØ§Ø¡</button>
      <button class="ft-btn-save" onclick="savePerson()">Ø­ÙØ¸</button>
    </div>
  </div>
</div>

<!-- Spouse Modal -->
<div class="ft-modal-bg" id="spouse-modal">
  <div class="ft-modal">
    <div class="ft-modal-head">
      <h2 id="sm-title">ğŸ’‘ Ø¥Ø¶Ø§ÙØ© Ø²ÙˆØ§Ø¬</h2>
      <button class="ft-modal-close" onclick="closeModal('spouse-modal')">&times;</button>
    </div>
    <div class="ft-modal-body">
      <div class="ft-form-group">
        <label>Ø§Ù„Ø²ÙˆØ¬</label>
        <div class="ft-person-select" id="husband-select"></div>
      </div>
      <div class="ft-form-group">
        <label>Ø§Ù„Ø²ÙˆØ¬Ø©</label>
        <div class="ft-person-select" id="wife-select"></div>
      </div>
      <div class="ft-form-group">
        <label>Ø§Ù„Ø­Ø§Ù„Ø©</label>
        <div class="ft-status-opts">
          <label class="ft-status-opt"><input type="radio" name="sp-status" value="married" checked><span class="ic">ğŸ’‘</span><span class="tx">Ù…ØªØ²ÙˆØ¬Ø§Ù†</span></label>
          <label class="ft-status-opt"><input type="radio" name="sp-status" value="divorced"><span class="ic">ğŸ’”</span><span class="tx">Ù…Ø·Ù„Ù‚Ø§Ù†</span></label>
          <label class="ft-status-opt"><input type="radio" name="sp-status" value="widowed"><span class="ic">âœï¸</span><span class="tx">Ø£Ø±Ù…Ù„/Ø©</span></label>
        </div>
      </div>
      <div class="ft-form-row">
        <div class="ft-form-group"><label>Ø³Ù†Ø© Ø§Ù„Ø²ÙˆØ§Ø¬</label><input type="number" id="sp-start" min="1900" max="2100"></div>
        <div class="ft-form-group"><label>Ø³Ù†Ø© Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡</label><input type="number" id="sp-end" min="1900" max="2100"></div>
      </div>
    </div>
    <div class="ft-modal-foot">
      <button class="ft-btn-del" id="sm-del" onclick="deleteSpouseRel()" style="display:none">ğŸ—‘ï¸</button>
      <button class="ft-btn-cancel" onclick="closeModal('spouse-modal')">Ø¥Ù„ØºØ§Ø¡</button>
      <button class="ft-btn-save" onclick="saveSpouseRel()">Ø­ÙØ¸</button>
    </div>
  </div>
</div>

<!-- Child Modal -->
<div class="ft-modal-bg" id="child-modal">
  <div class="ft-modal">
    <div class="ft-modal-head">
      <h2>ğŸ‘¶ Ø¥Ø¶Ø§ÙØ© Ø§Ø¨Ù†/Ø§Ø¨Ù†Ø©</h2>
      <button class="ft-modal-close" onclick="closeModal('child-modal')">&times;</button>
    </div>
    <div class="ft-modal-body">
      <div class="ft-tabs">
        <button class="ft-tab active" data-tab="new" onclick="switchChildTab('new')">Ø´Ø®Øµ Ø¬Ø¯ÙŠØ¯</button>
        <button class="ft-tab" data-tab="existing" onclick="switchChildTab('existing')">Ø´Ø®Øµ Ù…ÙˆØ¬ÙˆØ¯</button>
      </div>
      <div id="child-form-new">
        <div class="ft-form-group"><label>Ø§Ù„Ø§Ø³Ù… *</label><input type="text" id="c-name"></div>
        <div class="ft-form-group">
          <label>Ø§Ù„Ø¬Ù†Ø³</label>
          <div class="ft-gender">
            <label class="ft-gender-opt male"><input type="radio" name="c-gender" value="male" checked><span>ğŸ‘¨ Ø°ÙƒØ±</span></label>
            <label class="ft-gender-opt female"><input type="radio" name="c-gender" value="female"><span>ğŸ‘© Ø£Ù†Ø«Ù‰</span></label>
          </div>
        </div>
      </div>
      <div id="child-form-existing" style="display:none">
        <div class="ft-form-group"><label>Ø§Ø®ØªØ± Ø§Ù„Ø´Ø®Øµ</label><div class="ft-person-select" id="child-select"></div></div>
      </div>
      <div class="ft-form-group" style="margin-top:12px;padding-top:12px;border-top:1px solid var(--border-color)">
        <label>Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù„Ø§Ù‚Ø©</label>
        <div class="ft-status-opts" id="child-type-opts"></div>
      </div>
    </div>
    <div class="ft-modal-foot">
      <button class="ft-btn-cancel" onclick="closeModal('child-modal')">Ø¥Ù„ØºØ§Ø¡</button>
      <button class="ft-btn-save" onclick="saveChild()">Ø­ÙØ¸</button>
    </div>
  </div>
</div>

<!-- â­ RELATIONS MODAL - Ù†Ø§ÙØ°Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù„Ø§Ù‚Ø§Øª -->
<div class="ft-modal-bg" id="relations-modal">
  <div class="ft-modal" style="max-width:480px">
    <div class="ft-modal-head">
      <h2 id="rm-title">ğŸ”— Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù„Ø§Ù‚Ø§Øª</h2>
      <button class="ft-modal-close" onclick="closeModal('relations-modal')">&times;</button>
    </div>
    <div class="ft-modal-body" id="relations-content">
      <!-- ÙŠÙÙ…Ù„Ø£ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ -->
    </div>
    <div class="ft-modal-foot">
      <button class="ft-btn-cancel" onclick="closeModal('relations-modal')">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
  </div>
</div>

<!-- Edit Child Relation Modal -->
<div class="ft-modal-bg" id="edit-child-rel-modal">
  <div class="ft-modal">
    <div class="ft-modal-head">
      <h2>âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø¹Ù„Ø§Ù‚Ø© Ø§Ù„Ø£Ø¨ÙˆØ©</h2>
      <button class="ft-modal-close" onclick="closeModal('edit-child-rel-modal')">&times;</button>
    </div>
    <div class="ft-modal-body">
      <div class="ft-form-group">
        <label>Ø§Ù„Ø£Ø¨</label>
        <div class="ft-person-select" id="edit-father-select"></div>
      </div>
      <div class="ft-form-group">
        <label>Ø§Ù„Ø£Ù…</label>
        <div class="ft-person-select" id="edit-mother-select"></div>
      </div>
    </div>
    <div class="ft-modal-foot">
      <button class="ft-btn-del" onclick="deleteChildRel()">ğŸ—‘ï¸ Ø­Ø°Ù</button>
      <button class="ft-btn-cancel" onclick="closeModal('edit-child-rel-modal')">Ø¥Ù„ØºØ§Ø¡</button>
      <button class="ft-btn-save" onclick="saveEditChildRel()">Ø­ÙØ¸</button>
    </div>
  </div>
</div>

<!-- Context Menu -->
<div class="ft-ctx" id="ctx-menu">
  <div class="ft-ctx-item" onclick="ctxAction('edit')">âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</div>
  <div class="ft-ctx-item" onclick="ctxAction('relations')">ğŸ”— Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù„Ø§Ù‚Ø§Øª</div>
  <div class="ft-ctx-divider"></div>
  <div class="ft-ctx-item" onclick="ctxAction('spouse')">ğŸ’‘ Ø¥Ø¶Ø§ÙØ© Ø²ÙˆØ¬/Ø©</div>
  <div class="ft-ctx-item" onclick="ctxAction('child')">ğŸ‘¶ Ø¥Ø¶Ø§ÙØ© Ø§Ø¨Ù†/Ø©</div>
  <div class="ft-ctx-divider"></div>
  <div class="ft-ctx-item" onclick="ctxAction('locate')">ğŸ“ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹</div>
  <div class="ft-ctx-divider"></div>
  <div class="ft-ctx-item danger" onclick="ctxAction('delete')">ğŸ—‘ï¸ Ø­Ø°Ù</div>
</div>

<!-- Add Menu -->
<div class="ft-add-menu" id="add-menu">
  <div class="ft-add-item" onclick="addMenuAction('child')">ğŸ‘¶ Ø¥Ø¶Ø§ÙØ© Ø§Ø¨Ù†/Ø©</div>
  <div class="ft-add-item" onclick="addMenuAction('sibling')">ğŸ‘« Ø¥Ø¶Ø§ÙØ© Ø£Ø®/Ø£Ø®Øª</div>
  <div class="ft-add-item" onclick="addMenuAction('spouse')">ğŸ’‘ Ø¥Ø¶Ø§ÙØ© Ø²ÙˆØ¬/Ø©</div>
</div>

<div class="ft-toast" id="toast"></div>
<input type="file" id="import-file" class="hidden" accept=".json" onchange="importJSON(event)">

<script>
const isAr = document.documentElement.lang === 'ar';
const t = (ar, en) => isAr ? ar : en;

let db = { persons: {}, relations: {} };

let state = {
  editingPersonId: null,
  editingRelId: null,
  editingChildRelId: null,
  contextPersonId: null,
  addMenuPersonId: null,
  childContext: null,
  currentPhoto: null,
  childTab: 'new',
  zoom: 1,
  panX: 50,
  panY: 50,
  dragCardId: null,
  dragStartX: 0,
  dragStartY: 0,
  dragOrigX: 0,
  dragOrigY: 0,
  dragGroup: null
};

const CARD_W = 115, CARD_H = 80;
const GAP_X = 35, GAP_Y = 60;
const SPOUSE_GAP = 25;

// ==================== INIT ====================
function init() {
  setupCanvas();
  render();
  
  document.addEventListener('click', e => {
    hideCtx();
    hideAddMenu();
    document.querySelectorAll('.ft-dropdown.open').forEach(d => d.classList.remove('open'));
  });
  
  document.addEventListener('keydown', e => { if (e.key === 'Escape') closeAllModals(); });
}

// ==================== HELPERS ====================
const genId = () => Date.now().toString(36) + Math.random().toString(36).substr(2, 5);

function getSpouseRels(pid) {
  return Object.values(db.relations).filter(r => r.type === 'spouse' && (r.person1Id === pid || r.person2Id === pid));
}

function getSpouse(pid, rid) {
  const r = db.relations[rid];
  if (!r || r.type !== 'spouse') return null;
  return db.persons[r.person1Id === pid ? r.person2Id : r.person1Id];
}

function getChildRels(pid) {
  return Object.values(db.relations).filter(r => r.type === 'child' && (r.fatherId === pid || r.motherId === pid));
}

function getChildrenOfBoth(fid, mid) {
  return Object.values(db.relations)
    .filter(r => r.type === 'child' && r.fatherId === fid && r.motherId === mid)
    .map(r => db.persons[r.childId]).filter(Boolean);
}

function getParentRel(pid) {
  return Object.values(db.relations).find(r => r.type === 'child' && r.childId === pid);
}

function getParents(pid) {
  const rel = getParentRel(pid);
  if (!rel) return { father: null, mother: null, rel: null };
  return { father: db.persons[rel.fatherId], mother: db.persons[rel.motherId], rel };
}

function getLineage(pid) {
  const p = db.persons[pid]; if (!p) return '';
  let r = p.name;
  const pr = getParents(pid);
  if (pr.father) r += ' ' + t('Ø¨Ù†','s/o') + ' ' + pr.father.name;
  else if (pr.mother) r += ' ' + t('Ø§Ø¨Ù†','s/o') + ' ' + pr.mother.name;
  return r;
}

function hasRelation(p) {
  const pr = getParents(p.id);
  return pr.father || pr.mother || getSpouseRels(p.id).length > 0 || getChildRels(p.id).length > 0;
}

// Ø¬Ù…Ø¹ ÙƒÙ„ Ù…Ù† ÙŠØ¬Ø¨ Ø£Ù† ÙŠØªØ­Ø±Ùƒ Ù…Ø¹ Ø§Ù„Ø´Ø®Øµ
function getDragGroup(pid) {
  const mainPerson = db.persons[pid];
  if (!mainPerson) return { spouses: [], descendants: [] };
  
  const spouses = []; // Ø§Ù„Ø£Ø²ÙˆØ§Ø¬ (ÙŠØªØ­Ø±ÙƒÙˆÙ† Ø£ÙÙ‚ÙŠØ§Ù‹ ÙÙ‚Ø·ØŒ Ù†ÙØ³ Y)
  const descendants = []; // Ø§Ù„Ø°Ø±ÙŠØ© (ÙŠØªØ­Ø±ÙƒÙˆÙ† Ø¨Ø§Ù„ÙƒØ§Ù…Ù„)
  const visited = new Set([pid]);
  
  // Ø¬Ù…Ø¹ Ø£Ø²ÙˆØ§Ø¬ Ø§Ù„Ø´Ø®Øµ Ø§Ù„Ø£ØµÙ„ÙŠ
  getSpouseRels(pid).forEach(spRel => {
    const spouseId = spRel.person1Id === pid ? spRel.person2Id : spRel.person1Id;
    if (!visited.has(spouseId)) {
      visited.add(spouseId);
      const spouse = db.persons[spouseId];
      if (spouse && spouse._x !== undefined) {
        spouses.push({ id: spouseId, origX: spouse._x, origY: spouse._y });
      }
    }
  });
  
  // Ø¬Ù…Ø¹ Ø§Ù„Ø°Ø±ÙŠØ© Ø¨Ø´ÙƒÙ„ ØªÙƒØ±Ø§Ø±ÙŠ
  function collectDescendants(personId) {
    const childRels = getChildRels(personId);
    childRels.forEach(rel => {
      const childId = rel.childId;
      if (!visited.has(childId)) {
        visited.add(childId);
        const child = db.persons[childId];
        if (child && child._x !== undefined) {
          descendants.push({ id: childId, origX: child._x, origY: child._y });
          
          // Ø£Ø²ÙˆØ§Ø¬ Ø§Ù„Ø§Ø¨Ù†/Ø§Ù„Ø§Ø¨Ù†Ø©
          getSpouseRels(childId).forEach(spRel => {
            const spouseId = spRel.person1Id === childId ? spRel.person2Id : spRel.person1Id;
            if (!visited.has(spouseId)) {
              visited.add(spouseId);
              const spouse = db.persons[spouseId];
              if (spouse && spouse._x !== undefined) {
                descendants.push({ id: spouseId, origX: spouse._x, origY: spouse._y });
              }
            }
          });
          
          collectDescendants(childId);
        }
      }
    });
  }
  
  // Ø¬Ù…Ø¹ Ø°Ø±ÙŠØ© Ø§Ù„Ø´Ø®Øµ Ø§Ù„Ø£ØµÙ„ÙŠ
  collectDescendants(pid);
  
  // Ø¬Ù…Ø¹ Ø°Ø±ÙŠØ© Ø§Ù„Ø£Ø²ÙˆØ§Ø¬ Ø£ÙŠØ¶Ø§Ù‹ (Ø£Ø¨Ù†Ø§Ø¡ Ù…Ù† Ø²ÙŠØ¬Ø§Øª Ø£Ø®Ø±Ù‰)
  spouses.forEach(sp => collectDescendants(sp.id));
  
  return { spouses, descendants };
}

// ==================== RENDER LIST ====================
function render() {
  renderList();
  layoutTree();
  renderTree();
  updateStats();
}

function renderList() {
  const list = document.getElementById('persons-list');
  const search = document.getElementById('search-input').value.toLowerCase();
  const persons = Object.values(db.persons);
  
  const linked = persons.filter(hasRelation);
  const orphans = persons.filter(p => !hasRelation(p));
  const filter = p => p.name.toLowerCase().includes(search);
  
  let html = '';
  linked.filter(filter).forEach(p => html += listItem(p, false));
  
  const fo = orphans.filter(filter);
  if (fo.length) {
    html += `<div class="ft-section-label">âš ï¸ ${t('ØºÙŠØ± Ù…Ø±ØªØ¨Ø·ÙŠÙ†','Unlinked')} (${fo.length})</div>`;
    fo.forEach(p => html += listItem(p, true));
  }
  
  list.innerHTML = html || `<div style="text-align:center;padding:20px;color:var(--text-muted)">${t('Ù„Ø§ ÙŠÙˆØ¬Ø¯','Empty')}</div>`;
  document.getElementById('persons-count').textContent = persons.length;
}

function listItem(p, orphan) {
  const g = p.gender === 'male' ? 'male' : 'female';
  const icon = p.photo ? `<img src="${p.photo}" style="width:100%;height:100%;border-radius:50%;object-fit:cover">` : (p.gender === 'female' ? 'ğŸ‘©' : 'ğŸ‘¨');
  return `<div class="ft-list-item ${g} ${orphan ? 'orphan' : ''}" onclick="locatePerson('${p.id}')" oncontextmenu="showCtx(event,'${p.id}')">
    <div class="av">${icon}</div>
    <div class="info"><div class="nm">${p.name}</div><div class="sub">${getLineage(p.id)}</div></div>
    <button class="menu-btn" onclick="event.stopPropagation();showCtx(event,'${p.id}')">â‹®</button>
  </div>`;
}

function filterList() { renderList(); }

// ==================== PERSON MODAL ====================
function openPersonModal(editId = null) {
  state.editingPersonId = editId;
  state.currentPhoto = null;
  
  const isEdit = !!editId;
  document.getElementById('pm-title').innerHTML = isEdit ? 'âœï¸ ØªØ¹Ø¯ÙŠÙ„' : 'ğŸ‘¤ Ø¥Ø¶Ø§ÙØ© Ø´Ø®Øµ';
  document.getElementById('pm-del').style.display = isEdit ? 'block' : 'none';
  
  if (isEdit) {
    const p = db.persons[editId];
    document.getElementById('p-name').value = p.name;
    document.querySelector(`input[name="p-gender"][value="${p.gender}"]`).checked = true;
    document.getElementById('p-birth').value = p.birthDate || '';
    document.getElementById('p-death').value = p.deathDate || '';
    document.getElementById('p-notes').value = p.notes || '';
    state.currentPhoto = p.photo;
  } else {
    document.getElementById('p-name').value = '';
    document.querySelector('input[name="p-gender"][value="male"]').checked = true;
    document.getElementById('p-birth').value = '';
    document.getElementById('p-death').value = '';
    document.getElementById('p-notes').value = '';
  }
  updatePhotoPreview();
  openModal('person-modal');
}

function savePerson() {
  const name = document.getElementById('p-name').value.trim();
  if (!name) return toast(t('Ø£Ø¯Ø®Ù„ Ø§Ù„Ø§Ø³Ù…','Enter name'));
  
  const data = {
    name,
    gender: document.querySelector('input[name="p-gender"]:checked').value,
    photo: state.currentPhoto,
    birthDate: document.getElementById('p-birth').value || null,
    deathDate: document.getElementById('p-death').value || null,
    notes: document.getElementById('p-notes').value.trim()
  };
  
  if (state.editingPersonId) {
    Object.assign(db.persons[state.editingPersonId], data);
  } else {
    const id = genId();
    db.persons[id] = { id, ...data };
  }
  
  closeModal('person-modal');
  render();
  toast(t('ØªÙ…','Done'));
}

function deletePerson() {
  if (!state.editingPersonId || !confirm(t('Ø­Ø°ÙØŸ','Delete?'))) return;
  const id = state.editingPersonId;
  
  Object.keys(db.relations).forEach(rid => {
    const r = db.relations[rid];
    if (r.type === 'spouse' && (r.person1Id === id || r.person2Id === id)) delete db.relations[rid];
    if (r.type === 'child' && (r.childId === id || r.fatherId === id || r.motherId === id)) delete db.relations[rid];
  });
  
  delete db.persons[id];
  closeModal('person-modal');
  render();
  toast(t('ØªÙ…','Done'));
}

// Photo
function onPhotoSelect(e) {
  const f = e.target.files[0]; if (!f) return;
  const r = new FileReader();
  r.onload = ev => { state.currentPhoto = ev.target.result; updatePhotoPreview(); };
  r.readAsDataURL(f);
}

function clearPhoto() { state.currentPhoto = null; document.getElementById('photo-input').value = ''; updatePhotoPreview(); }

function updatePhotoPreview() {
  const prev = document.getElementById('photo-prev');
  const btn = document.getElementById('btn-rm-photo');
  if (state.currentPhoto) { prev.innerHTML = `<img src="${state.currentPhoto}">`; btn.style.display = 'inline'; }
  else { prev.innerHTML = '<span class="ph">ğŸ‘¤</span>'; btn.style.display = 'none'; }
}

// ==================== SPOUSE MODAL ====================
function openSpouseModal(editRelId = null, preselect = null) {
  state.editingRelId = editRelId;
  const males = Object.values(db.persons).filter(p => p.gender === 'male');
  const females = Object.values(db.persons).filter(p => p.gender === 'female');
  let selH = preselect?.husbandId, selW = preselect?.wifeId;
  
  if (editRelId) {
    const r = db.relations[editRelId];
    document.getElementById('sm-title').innerHTML = 'ğŸ’‘ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø²ÙˆØ§Ø¬';
    document.getElementById('sm-del').style.display = 'block';
    selH = r.person1Id; selW = r.person2Id;
    document.querySelector(`input[name="sp-status"][value="${r.status}"]`).checked = true;
    document.getElementById('sp-start').value = r.startYear || '';
    document.getElementById('sp-end').value = r.endYear || '';
  } else {
    document.getElementById('sm-title').innerHTML = 'ğŸ’‘ Ø¥Ø¶Ø§ÙØ© Ø²ÙˆØ§Ø¬';
    document.getElementById('sm-del').style.display = 'none';
    document.querySelector('input[name="sp-status"][value="married"]').checked = true;
    document.getElementById('sp-start').value = '';
    document.getElementById('sp-end').value = '';
  }
  
  renderPersonSelect('husband-select', males, selH);
  renderPersonSelect('wife-select', females, selW);
  openModal('spouse-modal');
}

function saveSpouseRel() {
  const hId = getSelectedPerson('husband-select');
  const wId = getSelectedPerson('wife-select');
  if (!hId && !wId) return toast(t('Ø§Ø®ØªØ± Ø£Ø­Ø¯Ù‡Ù…Ø§','Select one'));
  
  const status = document.querySelector('input[name="sp-status"]:checked').value;
  
  const data = {
    type: 'spouse', person1Id: hId, person2Id: wId, status,
    startYear: parseInt(document.getElementById('sp-start').value) || null,
    endYear: parseInt(document.getElementById('sp-end').value) || null
  };
  
  if (state.editingRelId) Object.assign(db.relations[state.editingRelId], data);
  else { const id = genId(); db.relations[id] = { id, ...data }; }
  
  closeModal('spouse-modal');
  render();
  toast(t('ØªÙ…','Done'));
}

function deleteSpouseRel() {
  if (!state.editingRelId || !confirm(t('Ø­Ø°ÙØŸ','Delete?'))) return;
  delete db.relations[state.editingRelId];
  closeModal('spouse-modal');
  render();
  toast(t('ØªÙ…','Done'));
}

// ==================== CHILD MODAL ====================
function openChildModal(ctx) {
  state.childContext = ctx;
  state.childTab = 'new';
  document.querySelector('.ft-tab[data-tab="new"]').classList.add('active');
  document.querySelector('.ft-tab[data-tab="existing"]').classList.remove('active');
  document.getElementById('child-form-new').style.display = 'block';
  document.getElementById('child-form-existing').style.display = 'none';
  document.getElementById('c-name').value = '';
  document.querySelector('input[name="c-gender"][value="male"]').checked = true;
  
  const opts = document.getElementById('child-type-opts');
  const f = ctx.fatherId ? db.persons[ctx.fatherId] : null;
  const m = ctx.motherId ? db.persons[ctx.motherId] : null;
  let html = '';
  if (f && m) {
    html += `<label class="ft-status-opt"><input type="radio" name="c-type" value="both" checked><span class="ic">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§</span><span class="tx">Ù…Ù† Ø§Ù„Ø£Ø¨ ÙˆØ§Ù„Ø£Ù…</span></label>`;
    html += `<label class="ft-status-opt"><input type="radio" name="c-type" value="father"><span class="ic">ğŸ‘¨</span><span class="tx">Ù…Ù† Ø§Ù„Ø£Ø¨ ÙÙ‚Ø·</span></label>`;
    html += `<label class="ft-status-opt"><input type="radio" name="c-type" value="mother"><span class="ic">ğŸ‘©</span><span class="tx">Ù…Ù† Ø§Ù„Ø£Ù… ÙÙ‚Ø·</span></label>`;
  } else if (f) {
    html += `<label class="ft-status-opt"><input type="radio" name="c-type" value="father" checked><span class="ic">ğŸ‘¨</span><span class="tx">Ù…Ù† Ø§Ù„Ø£Ø¨</span></label>`;
  } else if (m) {
    html += `<label class="ft-status-opt"><input type="radio" name="c-type" value="mother" checked><span class="ic">ğŸ‘©</span><span class="tx">Ù…Ù† Ø§Ù„Ø£Ù…</span></label>`;
  }
  opts.innerHTML = html;
  
  const avail = Object.values(db.persons).filter(p => !getParentRel(p.id));
  renderPersonSelect('child-select', avail, null);
  openModal('child-modal');
}

function switchChildTab(tab) {
  state.childTab = tab;
  document.querySelector('.ft-tab[data-tab="new"]').classList.toggle('active', tab === 'new');
  document.querySelector('.ft-tab[data-tab="existing"]').classList.toggle('active', tab === 'existing');
  document.getElementById('child-form-new').style.display = tab === 'new' ? 'block' : 'none';
  document.getElementById('child-form-existing').style.display = tab === 'existing' ? 'block' : 'none';
}

function saveChild() {
  let childId;
  if (state.childTab === 'new') {
    const name = document.getElementById('c-name').value.trim();
    if (!name) return toast(t('Ø£Ø¯Ø®Ù„ Ø§Ù„Ø§Ø³Ù…','Enter name'));
    childId = genId();
    db.persons[childId] = { id: childId, name, gender: document.querySelector('input[name="c-gender"]:checked').value, photo: null, birthDate: null, deathDate: null, notes: '' };
  } else {
    childId = getSelectedPerson('child-select');
    if (!childId) return toast(t('Ø§Ø®ØªØ± Ø´Ø®ØµØ§Ù‹','Select person'));
  }
  
  const rtype = document.querySelector('input[name="c-type"]:checked')?.value || 'both';
  const rel = { id: genId(), type: 'child', childId, fatherId: null, motherId: null };
  if (rtype === 'both' || rtype === 'father') rel.fatherId = state.childContext.fatherId;
  if (rtype === 'both' || rtype === 'mother') rel.motherId = state.childContext.motherId;
  db.relations[rel.id] = rel;
  
  closeModal('child-modal');
  render();
  toast(t('ØªÙ…','Done'));
}

// ==================== â­ RELATIONS MODAL ====================
function openRelationsModal(pid) {
  const p = db.persons[pid];
  if (!p) return;
  
  state.contextPersonId = pid;
  document.getElementById('rm-title').innerHTML = `ğŸ”— Ø¹Ù„Ø§Ù‚Ø§Øª: ${p.name}`;
  
  let html = '';
  
  // Ø§Ù„ÙˆØ§Ù„Ø¯ÙŠÙ†
  const parents = getParents(pid);
  html += `<div class="ft-rel-section">`;
  html += `<div class="ft-rel-section-head">ğŸ‘¨â€ğŸ‘© Ø§Ù„ÙˆØ§Ù„Ø¯ÙŠÙ†</div>`;
  if (parents.father || parents.mother) {
    if (parents.father) {
      html += `<div class="ft-rel-item">
        <span class="av">ğŸ‘¨</span>
        <div class="info"><div class="nm">${parents.father.name}</div><div class="role">Ø§Ù„Ø£Ø¨</div></div>
        <div class="actions">
          <button class="act-btn" onclick="editParentRel('${pid}')">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
          <button class="act-btn danger" onclick="removeParent('${pid}','father')">âŒ</button>
        </div>
      </div>`;
    }
    if (parents.mother) {
      html += `<div class="ft-rel-item">
        <span class="av">ğŸ‘©</span>
        <div class="info"><div class="nm">${parents.mother.name}</div><div class="role">Ø§Ù„Ø£Ù…</div></div>
        <div class="actions">
          <button class="act-btn" onclick="editParentRel('${pid}')">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
          <button class="act-btn danger" onclick="removeParent('${pid}','mother')">âŒ</button>
        </div>
      </div>`;
    }
  } else {
    html += `<div class="ft-rel-empty">Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆØ§Ù„Ø¯ÙŠÙ† <button class="act-btn" onclick="addParentRel('${pid}')" style="margin-right:10px">+ Ø¥Ø¶Ø§ÙØ©</button></div>`;
  }
  html += `</div>`;
  
  // Ø§Ù„Ø²ÙŠØ¬Ø§Øª
  const spouseRels = getSpouseRels(pid);
  html += `<div class="ft-rel-section">`;
  html += `<div class="ft-rel-section-head">ğŸ’‘ Ø§Ù„Ø²ÙŠØ¬Ø§Øª <button class="add-btn" onclick="closeModal('relations-modal');openSpouseModal(null,{${p.gender==='male'?'husbandId':'wifeId'}:'${pid}'})">+ Ø¥Ø¶Ø§ÙØ©</button></div>`;
  if (spouseRels.length) {
    spouseRels.forEach(rel => {
      const sp = getSpouse(pid, rel.id);
      if (!sp) return;
      const statusIcon = rel.status === 'divorced' ? 'ğŸ’”' : rel.status === 'widowed' ? 'âœï¸' : 'ğŸ’‘';
      const statusTxt = rel.status === 'divorced' ? 'Ù…Ø·Ù„Ù‚Ø§Ù†' : rel.status === 'widowed' ? 'Ø£Ø±Ù…Ù„/Ø©' : 'Ù…ØªØ²ÙˆØ¬Ø§Ù†';
      html += `<div class="ft-rel-item">
        <span class="av">${sp.gender === 'female' ? 'ğŸ‘©' : 'ğŸ‘¨'}</span>
        <div class="info"><div class="nm">${sp.name}</div><div class="role">${statusIcon} ${statusTxt}</div></div>
        <div class="actions">
          <button class="act-btn" onclick="closeModal('relations-modal');openSpouseModal('${rel.id}')">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
          <button class="act-btn danger" onclick="removeSpouseRel('${rel.id}')">âŒ</button>
        </div>
      </div>`;
    });
  } else {
    html += `<div class="ft-rel-empty">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø²ÙŠØ¬Ø§Øª</div>`;
  }
  html += `</div>`;
  
  // Ø§Ù„Ø£Ø¨Ù†Ø§Ø¡
  const childRels = getChildRels(pid);
  html += `<div class="ft-rel-section">`;
  html += `<div class="ft-rel-section-head">ğŸ‘¶ Ø§Ù„Ø£Ø¨Ù†Ø§Ø¡ <button class="add-btn" onclick="closeModal('relations-modal');openChildModalFor('${pid}')">+ Ø¥Ø¶Ø§ÙØ©</button></div>`;
  if (childRels.length) {
    childRels.forEach(rel => {
      const child = db.persons[rel.childId];
      if (!child) return;
      const fromTxt = rel.fatherId && rel.motherId ? 'Ù…Ù† Ø§Ù„Ø£Ø¨ ÙˆØ§Ù„Ø£Ù…' : rel.fatherId ? 'Ù…Ù† Ø§Ù„Ø£Ø¨ ÙÙ‚Ø·' : 'Ù…Ù† Ø§Ù„Ø£Ù… ÙÙ‚Ø·';
      html += `<div class="ft-rel-item">
        <span class="av">${child.gender === 'female' ? 'ğŸ‘©' : 'ğŸ‘¨'}</span>
        <div class="info"><div class="nm">${child.name}</div><div class="role">${fromTxt}</div></div>
        <div class="actions">
          <button class="act-btn" onclick="editChildRel('${rel.id}')">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
          <button class="act-btn danger" onclick="removeChildRel('${rel.id}')">âŒ</button>
        </div>
      </div>`;
    });
  } else {
    html += `<div class="ft-rel-empty">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£Ø¨Ù†Ø§Ø¡</div>`;
  }
  html += `</div>`;
  
  document.getElementById('relations-content').innerHTML = html;
  openModal('relations-modal');
}

function openChildModalFor(pid) {
  const p = db.persons[pid];
  const spRels = getSpouseRels(pid);
  if (spRels.length > 0) {
    const sp = getSpouse(pid, spRels[0].id);
    openChildModal(p.gender === 'male' ? { fatherId: pid, motherId: sp?.id } : { fatherId: sp?.id, motherId: pid });
  } else {
    openChildModal(p.gender === 'male' ? { fatherId: pid } : { motherId: pid });
  }
}

function removeSpouseRel(rid) {
  if (!confirm(t('Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø²ÙˆØ§Ø¬ØŸ','Delete?'))) return;
  delete db.relations[rid];
  render();
  openRelationsModal(state.contextPersonId);
  toast(t('ØªÙ…','Done'));
}

function removeChildRel(rid) {
  if (!confirm(t('Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ù„Ø§Ù‚Ø©ØŸ','Delete?'))) return;
  delete db.relations[rid];
  render();
  openRelationsModal(state.contextPersonId);
  toast(t('ØªÙ…','Done'));
}

function removeParent(pid, which) {
  const rel = getParentRel(pid);
  if (!rel) return;
  if (which === 'father') rel.fatherId = null;
  if (which === 'mother') rel.motherId = null;
  if (!rel.fatherId && !rel.motherId) delete db.relations[rel.id];
  render();
  openRelationsModal(pid);
  toast(t('ØªÙ…','Done'));
}

function addParentRel(pid) {
  closeModal('relations-modal');
  state.editingChildRelId = pid;
  const males = Object.values(db.persons).filter(m => m.gender === 'male' && m.id !== pid);
  const females = Object.values(db.persons).filter(f => f.gender === 'female' && f.id !== pid);
  renderPersonSelect('edit-father-select', males, null);
  renderPersonSelect('edit-mother-select', females, null);
  openModal('edit-child-rel-modal');
}

function editParentRel(pid) {
  closeModal('relations-modal');
  state.editingChildRelId = pid;
  const parents = getParents(pid);
  const males = Object.values(db.persons).filter(m => m.gender === 'male' && m.id !== pid);
  const females = Object.values(db.persons).filter(f => f.gender === 'female' && f.id !== pid);
  renderPersonSelect('edit-father-select', males, parents.father?.id);
  renderPersonSelect('edit-mother-select', females, parents.mother?.id);
  openModal('edit-child-rel-modal');
}

function editChildRel(rid) {
  closeModal('relations-modal');
  const rel = db.relations[rid];
  if (!rel) return;
  state.editingChildRelId = rel.childId;
  const males = Object.values(db.persons).filter(m => m.gender === 'male' && m.id !== rel.childId);
  const females = Object.values(db.persons).filter(f => f.gender === 'female' && f.id !== rel.childId);
  renderPersonSelect('edit-father-select', males, rel.fatherId);
  renderPersonSelect('edit-mother-select', females, rel.motherId);
  openModal('edit-child-rel-modal');
}

function saveEditChildRel() {
  const pid = state.editingChildRelId;
  if (!pid) return;
  const fid = getSelectedPerson('edit-father-select');
  const mid = getSelectedPerson('edit-mother-select');
  
  const oldRel = getParentRel(pid);
  if (oldRel) delete db.relations[oldRel.id];
  
  if (fid || mid) {
    const newRel = { id: genId(), type: 'child', childId: pid, fatherId: fid, motherId: mid };
    db.relations[newRel.id] = newRel;
  }
  
  closeModal('edit-child-rel-modal');
  render();
  toast(t('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù„Ø§Ù‚Ø©','Updated'));
}

function deleteChildRel() {
  const pid = state.editingChildRelId;
  if (!pid) return;
  const rel = getParentRel(pid);
  if (rel) delete db.relations[rel.id];
  closeModal('edit-child-rel-modal');
  render();
  toast(t('ØªÙ…','Done'));
}

// ==================== PERSON SELECT ====================
function renderPersonSelect(cid, persons, selId) {
  const c = document.getElementById(cid);
  let h = `<input type="text" class="ft-person-select-search" placeholder="${t('Ø§Ø¨Ø­Ø«...','Search...')}" oninput="filterSelect('${cid}',this.value)">`;
  h += `<div class="ft-person-select-list">`;
  h += `<div class="ft-person-opt none ${!selId?'selected':''}" onclick="pickPerson('${cid}',null)">${t('Ø¨Ø¯ÙˆÙ†','None')}</div>`;
  persons.forEach(p => {
    h += `<div class="ft-person-opt ${selId===p.id?'selected':''}" data-id="${p.id}" data-name="${p.name.toLowerCase()}" onclick="pickPerson('${cid}','${p.id}')">
      <span class="av">${p.gender==='female'?'ğŸ‘©':'ğŸ‘¨'}</span>
      <span class="nm">${p.name}</span>
    </div>`;
  });
  h += '</div>';
  c.innerHTML = h;
}

function filterSelect(cid, q) {
  document.querySelectorAll(`#${cid} .ft-person-opt:not(.none)`).forEach(o => {
    o.style.display = (o.dataset.name||'').includes(q.toLowerCase()) ? '' : 'none';
  });
}

function pickPerson(cid, id) {
  document.querySelectorAll(`#${cid} .ft-person-opt`).forEach(o => {
    o.classList.toggle('selected', id ? o.dataset.id === id : o.classList.contains('none'));
  });
}

function getSelectedPerson(cid) {
  return document.querySelector(`#${cid} .ft-person-opt.selected:not(.none)`)?.dataset.id || null;
}

// ==================== CONTEXT MENU ====================
function showCtx(e, pid) {
  e.preventDefault();
  e.stopPropagation();
  state.contextPersonId = pid;
  const menu = document.getElementById('ctx-menu');
  menu.style.left = e.clientX + 'px';
  menu.style.top = e.clientY + 'px';
  menu.classList.add('show');
}

function hideCtx() { document.getElementById('ctx-menu').classList.remove('show'); }

function ctxAction(action) {
  hideCtx();
  const id = state.contextPersonId;
  if (!id) return;
  const p = db.persons[id];
  
  switch (action) {
    case 'edit': openPersonModal(id); break;
    case 'relations': openRelationsModal(id); break;
    case 'spouse': openSpouseModal(null, p.gender==='male'?{husbandId:id}:{wifeId:id}); break;
    case 'child': openChildModalFor(id); break;
    case 'locate': locatePerson(id); break;
    case 'delete': state.editingPersonId = id; deletePerson(); break;
  }
}

// ==================== ADD MENU ====================
function showAddMenu(e, pid, sx, sy) {
  e.stopPropagation();
  state.addMenuPersonId = pid;
  const menu = document.getElementById('add-menu');
  menu.style.left = sx + 'px';
  menu.style.top = sy + 'px';
  menu.classList.add('show');
}

function hideAddMenu() { document.getElementById('add-menu').classList.remove('show'); }

function addMenuAction(action) {
  hideAddMenu();
  const id = state.addMenuPersonId;
  if (!id) return;
  const p = db.persons[id];
  const parents = getParents(id);
  
  switch (action) {
    case 'child': openChildModalFor(id); break;
    case 'sibling':
      if (!parents.father && !parents.mother) return toast(t('Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆØ§Ù„Ø¯ÙŠÙ†','No parents'));
      openChildModal({ fatherId: parents.father?.id, motherId: parents.mother?.id });
      break;
    case 'spouse': openSpouseModal(null, p.gender==='male'?{husbandId:id}:{wifeId:id}); break;
  }
}

// ==================== LAYOUT & RENDER TREE ====================
function layoutTree() {
  const positions = {};
  const processed = new Set();
  let currentX = 50;
  
  const roots = Object.values(db.persons).filter(p => {
    const pr = getParents(p.id);
    return !pr.father && !pr.mother;
  });
  
  function layoutPerson(pid, level, startX) {
    if (processed.has(pid)) return startX;
    const p = db.persons[pid];
    if (!p) return startX;
    
    // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ø­ÙÙˆØ¸ Ø¥Ù† ÙˆØ¬Ø¯ (Ù„Ù„Ø³Ø­Ø¨ ÙˆØ§Ù„Ø¥ÙÙ„Ø§Øª)
    if (p._manualX !== undefined && p._manualY !== undefined) {
      positions[pid] = { x: p._manualX, y: p._manualY, level };
      processed.add(pid);
      return startX + CARD_W + GAP_X;
    }
    
    processed.add(pid);
    const y = level * (CARD_H + GAP_Y);
    let x = startX;
    
    const spRels = getSpouseRels(pid);
    const units = [];
    
    spRels.forEach(rel => {
      const sp = getSpouse(pid, rel.id);
      if (sp && !processed.has(sp.id)) {
        processed.add(sp.id);
        const fid = p.gender === 'male' ? pid : sp.id;
        const mid = p.gender === 'female' ? pid : sp.id;
        units.push({ spouse: sp, children: getChildrenOfBoth(fid, mid), fatherId: fid, motherId: mid });
      }
    });
    
    positions[pid] = { x, y, level };
    
    let spX = x + CARD_W + SPOUSE_GAP;
    units.forEach(u => {
      positions[u.spouse.id] = { x: spX, y, level };
      let childX = x;
      u.children.forEach(c => { childX = layoutPerson(c.id, level + 1, childX); });
      spX += CARD_W + SPOUSE_GAP;
    });
    
    const soloChilds = getChildRels(pid).filter(r => p.gender === 'male' ? !r.motherId : !r.fatherId);
    let soloX = spX;
    soloChilds.forEach(r => { soloX = layoutPerson(r.childId, level + 1, soloX); });
    
    return Math.max(spX, soloX, x + CARD_W + GAP_X);
  }
  
  roots.forEach(r => { currentX = layoutPerson(r.id, 0, currentX) + GAP_X; });
  
  Object.entries(positions).forEach(([id, pos]) => {
    if (db.persons[id]) {
      db.persons[id]._x = pos.x;
      db.persons[id]._y = pos.y;
      db.persons[id]._level = pos.level;
    }
  });
}

function renderTree() {
  const linesG = document.getElementById('lines-g');
  const cardsG = document.getElementById('cards-g');
  linesG.innerHTML = '';
  cardsG.innerHTML = '';
  
  const persons = Object.values(db.persons);
  document.getElementById('empty-msg').style.display = persons.length ? 'none' : 'block';
  if (!persons.length) return;
  
  // Lines
  Object.values(db.relations).filter(r => r.type === 'spouse').forEach(rel => {
    const p1 = db.persons[rel.person1Id], p2 = db.persons[rel.person2Id];
    if (p1?._x !== undefined && p2?._x !== undefined) drawSpouseLine(p1, p2, rel, linesG);
  });
  
  Object.values(db.relations).filter(r => r.type === 'child').forEach(rel => {
    const child = db.persons[rel.childId];
    if (!child || child._x === undefined) return;
    const f = db.persons[rel.fatherId], m = db.persons[rel.motherId];
    if (f?._x !== undefined && m?._x !== undefined) drawChildLine(f, m, child, linesG);
    else if (f?._x !== undefined) drawSingleLine(f, child, linesG);
    else if (m?._x !== undefined) drawSingleLine(m, child, linesG);
  });
  
  // Cards
  persons.forEach(p => { if (p._x !== undefined) drawCard(p, cardsG); });
  updateTransform();
}

function drawSpouseLine(p1, p2, rel, layer) {
  const x1 = Math.min(p1._x, p2._x) + CARD_W, x2 = Math.max(p1._x, p2._x);
  const y = p1._y + CARD_H / 2;
  
  const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
  line.setAttribute('x1', x1); line.setAttribute('y1', y); line.setAttribute('x2', x2); line.setAttribute('y2', y);
  line.setAttribute('stroke', rel.status==='divorced'?'#6b7280':rel.status==='widowed'?'#4b5563':'#f59e0b');
  line.setAttribute('stroke-width', '3');
  if (rel.status !== 'married') line.setAttribute('stroke-dasharray', rel.status==='divorced'?'5,5':'2,4');
  layer.appendChild(line);
  
  const midX = (x1 + x2) / 2;
  const icon = document.createElementNS('http://www.w3.org/2000/svg', 'text');
  icon.setAttribute('x', midX); icon.setAttribute('y', y - 8); icon.setAttribute('text-anchor', 'middle'); icon.setAttribute('font-size', '13');
  icon.textContent = rel.status==='divorced'?'ğŸ’”':rel.status==='widowed'?'âœï¸':'ğŸ’‘';
  layer.appendChild(icon);
  
  // + button
  const addG = document.createElementNS('http://www.w3.org/2000/svg', 'g');
  addG.style.cursor = 'pointer';
  const circ = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
  circ.setAttribute('cx', midX); circ.setAttribute('cy', y + 16); circ.setAttribute('r', 9);
  circ.setAttribute('fill', '#1e293b'); circ.setAttribute('stroke', '#059669'); circ.setAttribute('stroke-width', '2');
  addG.appendChild(circ);
  const txt = document.createElementNS('http://www.w3.org/2000/svg', 'text');
  txt.setAttribute('x', midX); txt.setAttribute('y', y + 16); txt.setAttribute('text-anchor', 'middle'); txt.setAttribute('dominant-baseline', 'central');
  txt.setAttribute('fill', '#059669'); txt.setAttribute('font-size', '13'); txt.setAttribute('font-weight', 'bold');
  txt.textContent = '+';
  addG.appendChild(txt);
  addG.onclick = e => { e.stopPropagation(); openChildModal({ fatherId: rel.person1Id, motherId: rel.person2Id }); };
  addG.onmouseenter = () => { circ.setAttribute('fill', '#059669'); txt.setAttribute('fill', '#fff'); };
  addG.onmouseleave = () => { circ.setAttribute('fill', '#1e293b'); txt.setAttribute('fill', '#059669'); };
  layer.appendChild(addG);
}

function drawChildLine(f, m, c, layer) {
  const midX = (Math.min(f._x, m._x) + Math.max(f._x, m._x) + CARD_W) / 2;
  const y1 = f._y + CARD_H, cx = c._x + CARD_W/2, cy = c._y, midY = y1 + (cy - y1) / 2;
  const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
  path.setAttribute('d', `M ${midX} ${y1} L ${midX} ${midY} L ${cx} ${midY} L ${cx} ${cy}`);
  path.setAttribute('stroke', '#475569'); path.setAttribute('stroke-width', '2'); path.setAttribute('fill', 'none');
  layer.appendChild(path);
}

function drawSingleLine(p, c, layer) {
  const px = p._x + CARD_W/2, py = p._y + CARD_H, cx = c._x + CARD_W/2, cy = c._y, midY = py + (cy - py) / 2;
  const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
  path.setAttribute('d', `M ${px} ${py} L ${px} ${midY} L ${cx} ${midY} L ${cx} ${cy}`);
  path.setAttribute('stroke', '#475569'); path.setAttribute('stroke-width', '2'); path.setAttribute('fill', 'none');
  layer.appendChild(path);
}

function drawCard(p, layer) {
  const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
  g.setAttribute('transform', `translate(${p._x}, ${p._y})`);
  g.setAttribute('data-person-id', p.id);
  g.style.cursor = 'grab';
  
  const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
  rect.setAttribute('width', CARD_W); rect.setAttribute('height', CARD_H); rect.setAttribute('rx', '9');
  rect.setAttribute('fill', '#334155');
  rect.setAttribute('stroke', p.gender==='female'?'#ec4899':'#3b82f6');
  rect.setAttribute('stroke-width', p.deathDate?'2':'2.5');
  if (p.deathDate) rect.setAttribute('stroke-dasharray', '4,3');
  rect.setAttribute('filter', 'url(#shadow)');
  g.appendChild(rect);
  
  if (p.photo) {
    const img = document.createElementNS('http://www.w3.org/2000/svg', 'image');
    img.setAttribute('x', CARD_W/2 - 14); img.setAttribute('y', 6); img.setAttribute('width', 28); img.setAttribute('height', 28);
    img.setAttribute('href', p.photo);
    g.appendChild(img);
  } else {
    const icon = document.createElementNS('http://www.w3.org/2000/svg', 'text');
    icon.setAttribute('x', CARD_W/2); icon.setAttribute('y', 26); icon.setAttribute('text-anchor', 'middle'); icon.setAttribute('font-size', '20');
    icon.textContent = p.gender==='female'?'ğŸ‘©':'ğŸ‘¨';
    g.appendChild(icon);
  }
  
  const name = document.createElementNS('http://www.w3.org/2000/svg', 'text');
  name.setAttribute('x', CARD_W/2); name.setAttribute('y', 48); name.setAttribute('text-anchor', 'middle');
  name.setAttribute('fill', '#f8fafc'); name.setAttribute('font-size', '10'); name.setAttribute('font-weight', '600');
  name.textContent = p.name.length > 12 ? p.name.substring(0, 12) + '..' : p.name;
  g.appendChild(name);
  
  if (p.birthDate) {
    const b = new Date(p.birthDate), e = p.deathDate ? new Date(p.deathDate) : new Date();
    let age = e.getFullYear() - b.getFullYear();
    const ageT = document.createElementNS('http://www.w3.org/2000/svg', 'text');
    ageT.setAttribute('x', CARD_W/2); ageT.setAttribute('y', 60); ageT.setAttribute('text-anchor', 'middle');
    ageT.setAttribute('fill', '#94a3b8'); ageT.setAttribute('font-size', '8');
    ageT.textContent = age + ' Ø³Ù†Ø©' + (p.deathDate ? ' âœ' : '');
    g.appendChild(ageT);
  }
  
  // + button
  const addBtn = document.createElementNS('http://www.w3.org/2000/svg', 'g');
  addBtn.setAttribute('class', 'add-btn');
  addBtn.style.cursor = 'pointer';
  const aRect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
  aRect.setAttribute('x', CARD_W/2 - 13); aRect.setAttribute('y', CARD_H - 16); aRect.setAttribute('width', 26); aRect.setAttribute('height', 12); aRect.setAttribute('rx', 4);
  aRect.setAttribute('fill', '#1e293b'); aRect.setAttribute('stroke', '#059669'); aRect.setAttribute('stroke-width', '1.5');
  addBtn.appendChild(aRect);
  const aTxt = document.createElementNS('http://www.w3.org/2000/svg', 'text');
  aTxt.setAttribute('x', CARD_W/2); aTxt.setAttribute('y', CARD_H - 7); aTxt.setAttribute('text-anchor', 'middle');
  aTxt.setAttribute('fill', '#059669'); aTxt.setAttribute('font-size', '11'); aTxt.setAttribute('font-weight', 'bold');
  aTxt.textContent = '+';
  addBtn.appendChild(aTxt);
  addBtn.onmousedown = e => e.stopPropagation();
  addBtn.onclick = e => {
    e.stopPropagation();
    const svg = document.getElementById('svg').getBoundingClientRect();
    showAddMenu(e, p.id, svg.left + (p._x + CARD_W/2) * state.zoom + state.panX, svg.top + (p._y + CARD_H) * state.zoom + state.panY);
  };
  addBtn.onmouseenter = () => { aRect.setAttribute('fill', '#059669'); aTxt.setAttribute('fill', '#fff'); };
  addBtn.onmouseleave = () => { aRect.setAttribute('fill', '#1e293b'); aTxt.setAttribute('fill', '#059669'); };
  g.appendChild(addBtn);
  
  // Events
  g.oncontextmenu = e => { e.preventDefault(); showCtx(e, p.id); };
  g.ondblclick = e => { e.stopPropagation(); openRelationsModal(p.id); };
  
  // Drag card
  g.onmousedown = e => {
    if (e.target.closest('.add-btn')) return;
    e.stopPropagation();
    state.dragCardId = p.id;
    state.dragStartX = (e.clientX - state.panX) / state.zoom - p._x;
    state.dragStartY = (e.clientY - state.panY) / state.zoom - p._y;
    
    // Ø­ÙØ¸ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø£ØµÙ„ÙŠ
    state.dragOrigX = p._x;
    state.dragOrigY = p._y;
    
    // Ø¬Ù…Ø¹ Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ø³Ø­Ø¨ (Ø§Ù„Ø£Ø²ÙˆØ§Ø¬ + Ø§Ù„Ø°Ø±ÙŠØ©)
    state.dragGroup = getDragGroup(p.id);
    
    g.style.cursor = 'grabbing';
    g.classList.add('ft-card-dragging');
  };
  
  layer.appendChild(g);
}

// ==================== CANVAS ====================
let isPanning = false, panStartX = 0, panStartY = 0;

function setupCanvas() {
  const svg = document.getElementById('svg');
  const canvas = document.getElementById('canvas');
  
  svg.onmousedown = e => {
    if (e.target.closest('g[data-person-id]')) return;
    isPanning = true;
    panStartX = e.clientX - state.panX;
    panStartY = e.clientY - state.panY;
  };
  
  svg.onmousemove = e => {
    // Drag card
    if (state.dragCardId) {
      const p = db.persons[state.dragCardId];
      if (p) {
        const newX = (e.clientX - state.panX) / state.zoom - state.dragStartX;
        const newY = (e.clientY - state.panY) / state.zoom - state.dragStartY;
        
        // Ø­Ø³Ø§Ø¨ Ø§Ù„ÙØ±Ù‚
        const deltaX = newX - state.dragOrigX;
        const deltaY = newY - state.dragOrigY;
        
        // ØªØ­Ø±ÙŠÙƒ Ø§Ù„Ø´Ø®Øµ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
        p._x = newX;
        p._y = newY;
        p._manualX = newX;
        p._manualY = newY;
        const g = document.querySelector(`g[data-person-id="${p.id}"]`);
        if (g) g.setAttribute('transform', `translate(${newX}, ${newY})`);
        
        // ØªØ­Ø±ÙŠÙƒ Ø§Ù„Ø£Ø²ÙˆØ§Ø¬ (Ù†ÙØ³ deltaX Ùˆ deltaY Ù„Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ù†ÙØ³ Ø§Ù„Ù…Ø³ØªÙˆÙ‰)
        if (state.dragGroup && state.dragGroup.spouses) {
          state.dragGroup.spouses.forEach(sp => {
            const spouse = db.persons[sp.id];
            if (spouse) {
              spouse._x = sp.origX + deltaX;
              spouse._y = sp.origY + deltaY; // Ù†ÙØ³ Ø§Ù„ØªØ­Ø±Ùƒ Ø§Ù„Ø¹Ù…ÙˆØ¯ÙŠ
              spouse._manualX = spouse._x;
              spouse._manualY = spouse._y;
              const sg = document.querySelector(`g[data-person-id="${sp.id}"]`);
              if (sg) sg.setAttribute('transform', `translate(${spouse._x}, ${spouse._y})`);
            }
          });
        }
        
        // ØªØ­Ø±ÙŠÙƒ Ø§Ù„Ø°Ø±ÙŠØ©
        if (state.dragGroup && state.dragGroup.descendants) {
          state.dragGroup.descendants.forEach(d => {
            const desc = db.persons[d.id];
            if (desc) {
              desc._x = d.origX + deltaX;
              desc._y = d.origY + deltaY;
              desc._manualX = desc._x;
              desc._manualY = desc._y;
              const dg = document.querySelector(`g[data-person-id="${d.id}"]`);
              if (dg) dg.setAttribute('transform', `translate(${desc._x}, ${desc._y})`);
            }
          });
        }
      }
      return;
    }
    
    // Pan canvas
    if (isPanning) {
      state.panX = e.clientX - panStartX;
      state.panY = e.clientY - panStartY;
      updateTransform();
    }
  };
  
  svg.onmouseup = () => {
    if (state.dragCardId) {
      const g = document.querySelector(`g[data-person-id="${state.dragCardId}"]`);
      if (g) { g.style.cursor = 'grab'; g.classList.remove('ft-card-dragging'); }
      state.dragCardId = null;
      renderTree(); // re-render lines
    }
    isPanning = false;
  };
  
  svg.onmouseleave = () => { isPanning = false; state.dragCardId = null; };
  
  canvas.onwheel = e => {
    e.preventDefault();
    state.zoom = Math.max(0.3, Math.min(2, state.zoom + (e.deltaY > 0 ? -0.1 : 0.1)));
    updateTransform();
    document.getElementById('zoom-lvl').textContent = Math.round(state.zoom * 100) + '%';
  };
}

function updateTransform() {
  document.getElementById('tree-g').setAttribute('transform', `translate(${state.panX}, ${state.panY}) scale(${state.zoom})`);
}

function zoomIn() { state.zoom = Math.min(2, state.zoom + 0.1); updateTransform(); document.getElementById('zoom-lvl').textContent = Math.round(state.zoom * 100) + '%'; }
function zoomOut() { state.zoom = Math.max(0.3, state.zoom - 0.1); updateTransform(); document.getElementById('zoom-lvl').textContent = Math.round(state.zoom * 100) + '%'; }
function fitView() { state.zoom = 1; state.panX = 50; state.panY = 50; updateTransform(); document.getElementById('zoom-lvl').textContent = '100%'; }

function locatePerson(id) {
  const p = db.persons[id];
  if (!p || p._x === undefined) return;
  const svg = document.getElementById('svg');
  state.panX = svg.clientWidth / 2 - p._x * state.zoom - CARD_W / 2;
  state.panY = svg.clientHeight / 2 - p._y * state.zoom - CARD_H / 2;
  updateTransform();
}

// ==================== STATS ====================
function updateStats() {
  const persons = Object.values(db.persons);
  const spRels = Object.values(db.relations).filter(r => r.type === 'spouse');
  const levels = new Set(persons.map(p => p._level).filter(l => l !== undefined));
  document.getElementById('stat-total').textContent = persons.length;
  document.getElementById('stat-males').textContent = persons.filter(p => p.gender === 'male').length;
  document.getElementById('stat-females').textContent = persons.filter(p => p.gender === 'female').length;
  document.getElementById('stat-marriages').textContent = spRels.length;
  document.getElementById('stat-gens').textContent = levels.size;
}

// ==================== SAVE/LOAD ====================
function saveLocal() { localStorage.setItem('familyTreeV58', JSON.stringify(db)); toast(t('ØªÙ… Ø§Ù„Ø­ÙØ¸','Saved')); }
function loadLocal() {
  const s = localStorage.getItem('familyTreeV58');
  if (s) { db = JSON.parse(s); render(); toast(t('ØªÙ… Ø§Ù„ØªØ­Ù…ÙŠÙ„','Loaded')); }
  else toast(t('Ù„Ø§ Ø¨ÙŠØ§Ù†Ø§Øª','No data'));
}

function exportJSON() { download(JSON.stringify(db, null, 2), 'family-tree.json', 'application/json'); }
function importJSON(e) {
  const f = e.target.files[0]; if (!f) return;
  const r = new FileReader();
  r.onload = ev => { try { db = JSON.parse(ev.target.result); render(); toast(t('ØªÙ…','Done')); } catch { toast(t('Ø®Ø·Ø£','Error')); } };
  r.readAsText(f); e.target.value = '';
}

function exportPNG() {
  const svg = document.getElementById('svg');
  const data = new XMLSerializer().serializeToString(svg);
  const canvas = document.createElement('canvas');
  const ctx = canvas.getContext('2d');
  const img = new Image();
  canvas.width = svg.clientWidth * 2; canvas.height = svg.clientHeight * 2;
  img.onload = () => {
    ctx.fillStyle = '#0f172a'; ctx.fillRect(0, 0, canvas.width, canvas.height);
    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
    const a = document.createElement('a'); a.download = 'family-tree.png'; a.href = canvas.toDataURL('image/png'); a.click();
  };
  img.src = 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(data)));
}

function exportSVG() { download(new XMLSerializer().serializeToString(document.getElementById('svg')), 'family-tree.svg', 'image/svg+xml'); }

function download(c, n, t) { const b = new Blob([c], { type: t }); const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = n; a.click(); }

function clearAll() {
  if (!confirm(t('Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„ØŸ','Clear all?'))) return;
  db = { persons: {}, relations: {} };
  render(); toast(t('ØªÙ…','Done'));
}

// Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ (Ù…Ø³Ø­ Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹ Ø§Ù„ÙŠØ¯ÙˆÙŠØ©)
function resetLayout() {
  Object.values(db.persons).forEach(p => {
    delete p._manualX;
    delete p._manualY;
  });
  render();
  toast(t('ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ±ØªÙŠØ¨','Layout reset'));
}

// ==================== UTILS ====================
function openModal(id) { document.getElementById(id).classList.add('show'); }
function closeModal(id) { document.getElementById(id).classList.remove('show'); }
function closeAllModals() { document.querySelectorAll('.ft-modal-bg.show').forEach(m => m.classList.remove('show')); }
function toast(msg) { const el = document.getElementById('toast'); el.textContent = msg; el.classList.add('show'); setTimeout(() => el.classList.remove('show'), 2500); }
function toggleDD(id) { event.stopPropagation(); document.getElementById(id).classList.toggle('open'); }

init();
</script>

<script>
  window.toolsData = [{"id":"percentage","icon":"ğŸ”¢","name":"Percentage Calculator","keywords":"percentage calculator, calculate percentage, discount calculator, percent change","searchTerms":"percent percentage % discount sale off price change increase decrease difference quarter half third ratio math calculator profit loss tax margin fraction calculate how much what is of total part whole original cost selling buying before after","category":"calculators","categoryName":"Calculators","url":"../../en/tools/percentage.html"},{"id":"interest-calculator","icon":"ğŸ’°","name":"Interest Calculator","keywords":"interest calculator, simple interest, compound interest, loan calculator","searchTerms":"interest simple compound loan investment return profit bank money calculate annual monthly daily quarterly yearly principal rate time period accumulate savings deposit growth calculator finance financial how much earn","category":"calculators","categoryName":"Calculators","url":"../../en/tools/interest-calculator.html"},{"id":"loan-calculator","icon":"ğŸ¦","name":"Loan Calculator","keywords":"loan calculator, monthly payment, amortization schedule, mortgage calculator","searchTerms":"loan loans payment payments installment installments bank mortgage mortgages monthly schedule amortization calculate calculator interest principal finance financing car home personal","category":"calculators","categoryName":"Calculators","url":"../../en/tools/loan-calculator.html"},{"id":"body-calculator","icon":"âš–ï¸","name":"Body Calculator","keywords":"BMI calculator, body mass index, ideal weight, calorie calculator, body fat","searchTerms":"bmi body mass index weight fat calories calorie bmr tdee ideal healthy obesity overweight underweight waist hip ratio calculate calculator health fitness","category":"calculators","categoryName":"Calculators","url":"../../en/tools/body-calculator.html"},{"id":"age-calculator","icon":"ğŸ‚","name":"Age Calculator","keywords":"age calculator, calculate age, how old am I, zodiac sign, birthday calculator","searchTerms":"age birthday birth date zodiac calculate how old years months days weeks hours born sign horoscope difference between dates","category":"calculators","categoryName":"Calculators","url":"../../en/tools/age-calculator.html"},{"id":"family-tree","icon":"ğŸŒ³","name":"Family Tree","keywords":"family tree, genealogy, ancestry, lineage, family relationships, family tree maker","searchTerms":"family tree genealogy ancestry lineage relatives father mother son daughter brother sister grandfather grandmother uncle aunt cousin relations","category":"everyday","categoryName":"Everyday Tools","url":"../../en/tools/family-tree.html"}];
</script>
      </main>
      
      <footer class="main-footer">
        <p>Made with â¤ï¸ | All Rights Reserved Â© 2026 Udda</p>
      </footer>
    </div>
  </div>
  
  <!-- Settings Panel -->
  <div class="settings-overlay"></div>
  <div class="settings-panel">
    <div class="settings-header">
      <h2 class="settings-title">Settings</h2>
      <button class="settings-close" aria-label="Close">âœ•</button>
    </div>
    <div class="settings-content">
      <div class="settings-section">
        <div class="settings-section-title">Language</div>
        <div class="settings-option">
          <button class="settings-btn " data-lang-btn="ar">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</button>
          <button class="settings-btn active" data-lang-btn="en">English</button>
        </div>
      </div>
      <div class="settings-section">
        <div class="settings-section-title">Theme</div>
        <div class="settings-option">
          <button class="settings-btn" data-theme-btn="light">â˜€ï¸ Light</button>
          <button class="settings-btn" data-theme-btn="dark">ğŸŒ™ Dark</button>
          <button class="settings-btn active" data-theme-btn="auto">ğŸ’» Auto</button>
        </div>
      </div>
      <div class="settings-section">
        <button class="settings-btn" data-clear-data style="width:100%;justify-content:center;color:var(--error);">
          ğŸ—‘ï¸ Clear Saved Data
        </button>
      </div>
    </div>
  </div>
  
  <div class="toast"></div>
  <script src="../../assets/js/app.js"></script>
</body>
</html>