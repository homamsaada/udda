<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Family Tree - Create Your Family Tree Free | Udda</title>
  <meta name="description" content="Free tool to create your family tree easily. Add people and relationships, upload photos, and export as image or PDF.">
  <meta name="keywords" content="family tree, genealogy, ancestry, lineage, family relationships, family tree maker">
  <meta name="author" content="Udda">
  <meta name="robots" content="index, follow">
  
  <meta property="og:type" content="website">
  <meta property="og:title" content="Family Tree - Create Your Family Tree Free | Udda">
  <meta property="og:description" content="Free tool to create your family tree easily. Add people and relationships, upload photos, and export as image or PDF.">
  <meta property="og:url" content="https://udda.tools/en/tools/family-tree.html">
  <meta property="og:site_name" content="Udda">
  <meta property="og:locale" content="en_US">
  
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Family Tree - Create Your Family Tree Free | Udda">
  <meta name="twitter:description" content="Free tool to create your family tree easily. Add people and relationships, upload photos, and export as image or PDF.">
  
  <link rel="alternate" hreflang="ar" href="https://udda.tools/ar/tools/family-tree.html">
  <link rel="alternate" hreflang="en" href="https://udda.tools/en/tools/family-tree.html">
  <link rel="alternate" hreflang="x-default" href="https://udda.tools/ar/tools/family-tree.html">
  <link rel="canonical" href="https://udda.tools/en/tools/family-tree.html">
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../../assets/css/main.css">
  
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "WebApplication",
    "name": "Family Tree",
    "description": "Free tool to create your family tree easily. Add people and relationships, upload photos, and export as image or PDF.",
    "url": "https://udda.tools/en/tools/family-tree.html",
    "applicationCategory": "UtilityApplication",
    "operatingSystem": "Any",
    "offers": { "@type": "Offer", "price": "0", "priceCurrency": "USD" },
    "inLanguage": ["ar", "en"],
    "isAccessibleForFree": true
  }
  </script>
</head>
<body data-tool-id="family-tree">
  <div class="app-container">
    <div class="sidebar-overlay"></div>
    
    <aside class="sidebar">
      <div class="sidebar-header">
        <a href="../../en/" class="logo">
          <div class="logo-icon">ğŸ”§</div>
          <span class="logo-text sidebar-text">Udda</span>
        </a>
      </div>
      
      <div class="sidebar-search">
        <div class="search-input-wrapper">
          <input type="text" class="search-input" placeholder="Search for a tool..." aria-label="Search for a tool...">
          <svg class="search-icon" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <circle cx="11" cy="11" r="8"></circle>
            <path d="m21 21-4.35-4.35"></path>
          </svg>
        </div>
      </div>
      
      <nav class="sidebar-nav">
        
        <a href="../../en/" class="nav-item ">
          <span class="nav-item-icon">ğŸ </span>
          <span class="sidebar-text">Home</span>
        </a>
        <div class="nav-section ">
          <div class="nav-section-title">
            <span>
              <span class="nav-section-icon">ğŸ§®</span>
              <span class="sidebar-text">Calculators</span>
            </span>
            <svg class="nav-section-arrow sidebar-text" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path d="m6 9 6 6 6-6"></path>
            </svg>
          </div>
          <div class="nav-section-items">
            <a href="../../en/tools/percentage.html" class="nav-item ">
              <span class="nav-item-icon">ğŸ”¢</span>
              <span class="sidebar-text">Percentage Calculator</span>
            </a>
            <a href="../../en/tools/interest-calculator.html" class="nav-item ">
              <span class="nav-item-icon">ğŸ’°</span>
              <span class="sidebar-text">Interest Calculator</span>
            </a>
            <a href="../../en/tools/loan-calculator.html" class="nav-item ">
              <span class="nav-item-icon">ğŸ¦</span>
              <span class="sidebar-text">Loan Calculator</span>
            </a>
            <a href="../../en/tools/body-calculator.html" class="nav-item ">
              <span class="nav-item-icon">âš–ï¸</span>
              <span class="sidebar-text">Body Calculator</span>
            </a>
            <a href="../../en/tools/age-calculator.html" class="nav-item ">
              <span class="nav-item-icon">ğŸ‚</span>
              <span class="sidebar-text">Age Calculator</span>
            </a>
          </div>
        </div>
        <div class="nav-section ">
          <div class="nav-section-title">
            <span>
              <span class="nav-section-icon">ğŸ”„</span>
              <span class="sidebar-text">Converters</span>
            </span>
            <svg class="nav-section-arrow sidebar-text" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path d="m6 9 6 6 6-6"></path>
            </svg>
          </div>
          <div class="nav-section-items">
          </div>
        </div>
        <div class="nav-section ">
          <div class="nav-section-title">
            <span>
              <span class="nav-section-icon">ğŸ“</span>
              <span class="sidebar-text">Text Tools</span>
            </span>
            <svg class="nav-section-arrow sidebar-text" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path d="m6 9 6 6 6-6"></path>
            </svg>
          </div>
          <div class="nav-section-items">
          </div>
        </div>
        <div class="nav-section ">
          <div class="nav-section-title">
            <span>
              <span class="nav-section-icon">ğŸ“…</span>
              <span class="sidebar-text">Date & Time</span>
            </span>
            <svg class="nav-section-arrow sidebar-text" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path d="m6 9 6 6 6-6"></path>
            </svg>
          </div>
          <div class="nav-section-items">
          </div>
        </div>
        <div class="nav-section ">
          <div class="nav-section-title">
            <span>
              <span class="nav-section-icon">âš¡</span>
              <span class="sidebar-text">Generators</span>
            </span>
            <svg class="nav-section-arrow sidebar-text" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path d="m6 9 6 6 6-6"></path>
            </svg>
          </div>
          <div class="nav-section-items">
          </div>
        </div>
        <div class="nav-section ">
          <div class="nav-section-title">
            <span>
              <span class="nav-section-icon">ğŸ–¼ï¸</span>
              <span class="sidebar-text">Image Tools</span>
            </span>
            <svg class="nav-section-arrow sidebar-text" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path d="m6 9 6 6 6-6"></path>
            </svg>
          </div>
          <div class="nav-section-items">
          </div>
        </div>
        <div class="nav-section ">
          <div class="nav-section-title">
            <span>
              <span class="nav-section-icon">ğŸ’»</span>
              <span class="sidebar-text">Developer Tools</span>
            </span>
            <svg class="nav-section-arrow sidebar-text" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path d="m6 9 6 6 6-6"></path>
            </svg>
          </div>
          <div class="nav-section-items">
          </div>
        </div>
        <div class="nav-section open">
          <div class="nav-section-title">
            <span>
              <span class="nav-section-icon">ğŸ </span>
              <span class="sidebar-text">Everyday Tools</span>
            </span>
            <svg class="nav-section-arrow sidebar-text" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path d="m6 9 6 6 6-6"></path>
            </svg>
          </div>
          <div class="nav-section-items">
            <a href="../../en/tools/family-tree.html" class="nav-item active">
              <span class="nav-item-icon">ğŸŒ³</span>
              <span class="sidebar-text">Family Tree</span>
            </a>
          </div>
        </div>
      </nav>
      
      <div class="sidebar-footer">
        <button class="sidebar-toggle" aria-label="Toggle sidebar">
          <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path d="M11 19l-7-7 7-7m8 14l-7-7 7-7"></path>
          </svg>
          <span class="sidebar-text">Sidebar</span>
        </button>
      </div>
    </aside>
    
    <div class="main-content">
      <header class="main-header">
        <button class="header-btn mobile-menu-btn" aria-label="Menu">
          <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path d="M4 6h16M4 12h16M4 18h16"></path>
          </svg>
        </button>
        
        <nav class="header-breadcrumb">
          <a href="../../en/" class="breadcrumb-link">Home</a>
          <span class="breadcrumb-separator">â€º</span>
          <a href="../../en/category/everyday.html" class="breadcrumb-link">Everyday Tools</a>
          <span class="breadcrumb-separator">â€º</span>
          <span class="breadcrumb-current">Family Tree</span>
        </nav>
        
        <div class="header-actions">
          <button class="header-btn" data-favorite-btn aria-label="Add to Favorites">â˜†</button>
          <button class="header-btn" onclick="App.shareUrl('Family Tree')" aria-label="Share">
            <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"></path>
              <polyline points="16 6 12 2 8 6"></polyline>
              <line x1="12" y1="2" x2="12" y2="15"></line>
            </svg>
          </button>
          <button class="header-btn" data-open-settings aria-label="Settings">
            <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <circle cx="12" cy="12" r="3"></circle>
              <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
            </svg>
          </button>
        </div>
      </header>
      
      <main class="page-content">
        <style>
:root {
  --primary: #059669;
  --primary-dark: #047857;
  --male-color: #3b82f6;
  --female-color: #ec4899;
  --marriage-color: #f59e0b;
  --divorced-color: #6b7280;
  --widowed-color: #4b5563;
  --bg-primary: #0f172a;
  --bg-secondary: #1e293b;
  --bg-card: #334155;
  --text-primary: #f8fafc;
  --text-secondary: #94a3b8;
  --text-muted: #64748b;
  --border-color: #475569;
  --danger: #ef4444;
}

* { box-sizing: border-box; }

.family-tree-app {
  display: flex;
  gap: 12px;
  min-height: 75vh;
  font-family: inherit;
}

/* Sidebar */
.sidebar {
  width: 240px;
  background: var(--bg-secondary);
  border-radius: 10px;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  flex-shrink: 0;
}

.sidebar-header {
  padding: 12px 14px;
  border-bottom: 2px solid var(--border-color);
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.sidebar-header h3 {
  font-size: 0.9rem;
  color: var(--text-primary);
  margin: 0;
  display: flex;
  align-items: center;
  gap: 6px;
}

.sidebar-header .count {
  background: var(--primary);
  color: white;
  padding: 2px 7px;
  border-radius: 10px;
  font-size: 0.7rem;
}

.sidebar-search {
  padding: 8px 10px;
  border-bottom: 1px solid var(--border-color);
}

.sidebar-search input {
  width: 100%;
  padding: 7px 10px;
  background: var(--bg-card);
  border: 2px solid var(--border-color);
  border-radius: 6px;
  color: var(--text-primary);
  font-size: 0.8rem;
  font-family: inherit;
}

.sidebar-search input:focus {
  outline: none;
  border-color: var(--primary);
}

.sidebar-list {
  flex: 1;
  overflow-y: auto;
  padding: 6px;
}

.list-item {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 7px 8px;
  background: var(--bg-card);
  border-radius: 6px;
  margin-bottom: 4px;
  cursor: pointer;
  border: 2px solid transparent;
  transition: all 0.2s;
}

.list-item:hover { border-color: var(--primary); }
.list-item.orphan { border: 2px dashed var(--divorced-color); }

.list-item .icon {
  width: 28px;
  height: 28px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1rem;
  flex-shrink: 0;
}

.list-item .icon.male { background: rgba(59, 130, 246, 0.2); }
.list-item .icon.female { background: rgba(236, 72, 153, 0.2); }
.list-item .icon img { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; }

.list-item .info { flex: 1; min-width: 0; }
.list-item .name { font-size: 0.75rem; font-weight: 600; color: var(--text-primary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.list-item .sub { font-size: 0.65rem; color: var(--text-muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

.list-item .menu-btn {
  padding: 2px 5px;
  background: none;
  border: none;
  color: var(--text-muted);
  cursor: pointer;
  font-size: 0.85rem;
  border-radius: 3px;
}

.list-item .menu-btn:hover { background: var(--bg-secondary); color: var(--text-primary); }

.section-label {
  font-size: 0.65rem;
  color: var(--text-muted);
  padding: 6px 8px 4px;
  display: flex;
  align-items: center;
  gap: 5px;
  border-top: 1px solid var(--border-color);
  margin-top: 4px;
}

.add-btn {
  margin: 8px;
  padding: 9px;
  background: var(--primary);
  border: none;
  border-radius: 6px;
  color: white;
  font-weight: 600;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
  font-family: inherit;
  font-size: 0.85rem;
}

.add-btn:hover { background: var(--primary-dark); }

/* Main */
.main-area { flex: 1; display: flex; flex-direction: column; min-width: 0; }

/* Toolbar */
.toolbar {
  display: flex;
  flex-wrap: wrap;
  gap: 5px;
  padding: 8px 12px;
  background: var(--bg-secondary);
  border-radius: 8px;
  margin-bottom: 8px;
  align-items: center;
}

.toolbar-group {
  display: flex;
  gap: 3px;
  padding: 0 8px;
  border-left: 2px solid var(--border-color);
}

.toolbar-group:first-child { border-left: none; }

.tool-btn {
  display: flex;
  align-items: center;
  gap: 4px;
  padding: 6px 10px;
  background: var(--bg-card);
  border: 2px solid var(--border-color);
  border-radius: 5px;
  color: var(--text-primary);
  font-size: 0.75rem;
  font-weight: 600;
  cursor: pointer;
  font-family: inherit;
  transition: all 0.2s;
}

.tool-btn:hover { border-color: var(--primary); }
.tool-btn .icon { font-size: 0.9rem; }

/* Canvas */
.canvas-wrap {
  flex: 1;
  position: relative;
  background: var(--bg-secondary);
  border-radius: 8px;
  overflow: hidden;
  min-height: 380px;
  border: 2px solid var(--border-color);
}

.tree-svg { width: 100%; height: 100%; min-height: 380px; cursor: grab; font-family: inherit; }
.tree-svg:active { cursor: grabbing; }
.tree-svg text { font-family: inherit; }

.empty-msg {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  text-align: center;
  color: var(--text-muted);
  pointer-events: none;
}

.empty-msg .icon { font-size: 2.5rem; margin-bottom: 8px; opacity: 0.5; }
.empty-msg h3 { font-size: 1.1rem; margin: 0 0 4px; color: var(--text-secondary); }

/* Zoom */
.zoom-panel {
  position: absolute;
  bottom: 12px;
  left: 12px;
  display: flex;
  flex-direction: column;
  gap: 4px;
  background: var(--bg-card);
  padding: 4px;
  border-radius: 6px;
  border: 2px solid var(--border-color);
}

.zoom-btn {
  width: 28px;
  height: 28px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: var(--bg-secondary);
  border: none;
  border-radius: 4px;
  color: var(--text-primary);
  font-size: 0.9rem;
  cursor: pointer;
}

.zoom-btn:hover { background: var(--primary); }
.zoom-level { text-align: center; font-size: 0.65rem; color: var(--text-muted); }

/* Stats */
.stats-bar {
  display: flex;
  gap: 12px;
  padding: 7px 12px;
  background: var(--bg-card);
  border-radius: 6px;
  margin-top: 8px;
  flex-wrap: wrap;
}

.stat { display: flex; align-items: center; gap: 4px; font-size: 0.75rem; }
.stat .label { color: var(--text-muted); }
.stat .val { font-weight: 700; color: var(--text-primary); }

/* Modal */
.modal-bg {
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.7);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
  opacity: 0;
  visibility: hidden;
  transition: all 0.3s;
}

.modal-bg.show { opacity: 1; visibility: visible; }

.modal {
  background: var(--bg-secondary);
  border-radius: 12px;
  width: 90%;
  max-width: 440px;
  max-height: 85vh;
  overflow-y: auto;
  transform: scale(0.9);
  transition: transform 0.3s;
}

.modal-bg.show .modal { transform: scale(1); }

.modal-head {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 12px 16px;
  border-bottom: 2px solid var(--border-color);
  position: sticky;
  top: 0;
  background: var(--bg-secondary);
  z-index: 10;
}

.modal-head h2 { font-size: 0.95rem; color: var(--text-primary); display: flex; align-items: center; gap: 6px; margin: 0; }

.modal-close {
  background: none;
  border: none;
  font-size: 1.2rem;
  color: var(--text-muted);
  cursor: pointer;
  padding: 3px 6px;
  border-radius: 4px;
}

.modal-close:hover { background: var(--bg-card); color: var(--text-primary); }

.modal-body { padding: 14px 16px; }

.form-group { margin-bottom: 12px; }
.form-group label { display: block; font-size: 0.75rem; font-weight: 600; color: var(--text-secondary); margin-bottom: 4px; }

.form-group input,
.form-group select,
.form-group textarea {
  width: 100%;
  padding: 8px 10px;
  background: var(--bg-card);
  border: 2px solid var(--border-color);
  border-radius: 6px;
  color: var(--text-primary);
  font-size: 0.85rem;
  font-family: inherit;
}

.form-group input:focus,
.form-group select:focus,
.form-group textarea:focus { outline: none; border-color: var(--primary); }

.form-group textarea { min-height: 50px; resize: vertical; }

.form-row { display: flex; gap: 10px; }
.form-row .form-group { flex: 1; }

/* Gender */
.gender-toggle { display: flex; gap: 6px; }

.gender-opt {
  flex: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 4px;
  padding: 9px;
  background: var(--bg-card);
  border: 2px solid var(--border-color);
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.2s;
}

.gender-opt input { display: none; }
.gender-opt.male:has(input:checked) { border-color: var(--male-color); background: rgba(59, 130, 246, 0.2); }
.gender-opt.female:has(input:checked) { border-color: var(--female-color); background: rgba(236, 72, 153, 0.2); }
.gender-opt span { font-weight: 600; font-size: 0.8rem; }

/* Photo */
.photo-row { display: flex; align-items: center; gap: 10px; }

.photo-preview {
  width: 50px;
  height: 50px;
  border-radius: 50%;
  background: var(--bg-card);
  border: 2px solid var(--border-color);
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
  flex-shrink: 0;
}

.photo-preview img { width: 100%; height: 100%; object-fit: cover; }
.photo-preview .ph { font-size: 1.3rem; color: var(--text-muted); }

.photo-btns { display: flex; flex-direction: column; gap: 4px; }

.photo-btn {
  padding: 4px 8px;
  background: var(--bg-card);
  border: 2px solid var(--border-color);
  border-radius: 4px;
  color: var(--text-primary);
  font-size: 0.7rem;
  cursor: pointer;
  font-family: inherit;
}

.photo-btn:hover { border-color: var(--primary); }
.photo-btn.rm { border-color: var(--danger); color: var(--danger); }

/* Person Selector */
.person-select {
  border: 2px solid var(--border-color);
  border-radius: 6px;
  overflow: hidden;
}

.person-select-search {
  width: 100%;
  padding: 7px 10px;
  background: var(--bg-card);
  border: none;
  border-bottom: 1px solid var(--border-color);
  color: var(--text-primary);
  font-size: 0.8rem;
  font-family: inherit;
}

.person-select-search:focus { outline: none; }

.person-select-list { max-height: 140px; overflow-y: auto; }

.person-select-opt {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 6px 8px;
  cursor: pointer;
  border: 2px solid transparent;
  margin: 3px;
  border-radius: 5px;
}

.person-select-opt:hover { background: var(--bg-card); }
.person-select-opt.selected { border-color: var(--primary); background: rgba(5, 150, 105, 0.15); }
.person-select-opt.none { color: var(--text-muted); border: 2px dashed var(--border-color); justify-content: center; font-size: 0.8rem; }

.person-select-opt .av { width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.85rem; }
.person-select-opt .nm { font-size: 0.8rem; color: var(--text-primary); }

/* Marriage Status */
.marriage-status { display: flex; gap: 6px; }

.status-opt {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 3px;
  padding: 8px 5px;
  background: var(--bg-card);
  border: 2px solid var(--border-color);
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.2s;
}

.status-opt input { display: none; }
.status-opt:has(input:checked) { border-color: var(--primary); background: rgba(5, 150, 105, 0.15); }
.status-opt .ic { font-size: 1.1rem; }
.status-opt .tx { font-size: 0.7rem; color: var(--text-secondary); }

/* Modal Footer */
.modal-foot {
  display: flex;
  gap: 6px;
  padding: 10px 16px;
  border-top: 2px solid var(--border-color);
  position: sticky;
  bottom: 0;
  background: var(--bg-secondary);
}

.modal-foot button {
  flex: 1;
  padding: 9px;
  border-radius: 6px;
  font-size: 0.85rem;
  font-weight: 700;
  cursor: pointer;
  font-family: inherit;
}

.btn-cancel { background: var(--bg-card); border: 2px solid var(--border-color); color: var(--text-primary); }
.btn-save { background: var(--primary); border: none; color: white; }
.btn-save:hover { background: var(--primary-dark); }
.btn-del { background: var(--danger); border: none; color: white; flex: 0.4; }

/* Context Menu */
.ctx-menu {
  position: fixed;
  background: var(--bg-card);
  border: 2px solid var(--border-color);
  border-radius: 8px;
  min-width: 140px;
  z-index: 2000;
  box-shadow: 0 6px 20px rgba(0,0,0,0.3);
  display: none;
}

.ctx-menu.show { display: block; }

.ctx-item {
  display: flex;
  align-items: center;
  gap: 7px;
  padding: 8px 12px;
  color: var(--text-primary);
  cursor: pointer;
  font-size: 0.8rem;
}

.ctx-item:first-child { border-radius: 6px 6px 0 0; }
.ctx-item:last-child { border-radius: 0 0 6px 6px; }
.ctx-item:hover { background: var(--bg-secondary); }
.ctx-item.danger { color: var(--danger); }

.ctx-divider { height: 1px; background: var(--border-color); margin: 2px 0; }

/* Add Menu */
.add-menu {
  position: fixed;
  background: var(--bg-card);
  border: 2px solid var(--primary);
  border-radius: 8px;
  min-width: 130px;
  z-index: 2000;
  box-shadow: 0 6px 20px rgba(0,0,0,0.4);
  display: none;
  transform: translate(-50%, 4px);
}

.add-menu.show { display: block; }

.add-menu-item {
  display: flex;
  align-items: center;
  gap: 7px;
  padding: 9px 12px;
  color: var(--text-primary);
  cursor: pointer;
  font-size: 0.8rem;
  font-weight: 500;
}

.add-menu-item:first-child { border-radius: 6px 6px 0 0; }
.add-menu-item:last-child { border-radius: 0 0 6px 6px; }
.add-menu-item:hover { background: var(--primary); }

/* Toast */
.toast {
  position: fixed;
  bottom: 18px;
  left: 50%;
  transform: translateX(-50%) translateY(80px);
  background: var(--bg-card);
  border: 2px solid var(--primary);
  padding: 10px 16px;
  border-radius: 6px;
  color: var(--text-primary);
  font-weight: 600;
  z-index: 3000;
  opacity: 0;
  transition: all 0.3s;
}

.toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }

/* Dropdown */
.dropdown { position: relative; }

.dropdown-menu {
  position: absolute;
  top: 100%;
  left: 0;
  margin-top: 4px;
  background: var(--bg-card);
  border: 2px solid var(--border-color);
  border-radius: 6px;
  min-width: 130px;
  z-index: 100;
  opacity: 0;
  visibility: hidden;
  transform: translateY(-5px);
  transition: all 0.2s;
}

.dropdown.open .dropdown-menu { opacity: 1; visibility: visible; transform: translateY(0); }

.dropdown-item { display: flex; align-items: center; gap: 6px; padding: 7px 10px; color: var(--text-primary); font-size: 0.75rem; cursor: pointer; }
.dropdown-item:hover { background: var(--bg-secondary); }
.dropdown-item:first-child { border-radius: 4px 4px 0 0; }
.dropdown-item:last-child { border-radius: 0 0 4px 4px; }

.dropdown-divider { height: 1px; background: var(--border-color); margin: 2px 0; }

.hidden { display: none; }

/* Tabs */
.tabs { display: flex; border-bottom: 2px solid var(--border-color); margin-bottom: 12px; }

.tab {
  flex: 1;
  padding: 8px;
  background: none;
  border: none;
  color: var(--text-muted);
  font-weight: 600;
  cursor: pointer;
  font-family: inherit;
  font-size: 0.8rem;
  border-bottom: 2px solid transparent;
  margin-bottom: -2px;
}

.tab.active { color: var(--primary); border-bottom-color: var(--primary); }

@media (max-width: 800px) {
  .family-tree-app { flex-direction: column; }
  .sidebar { width: 100%; max-height: 200px; }
  .toolbar-group { border-left: none; }
  .tool-btn span:not(.icon) { display: none; }
}
</style>

<div class="tool-card">
  <div class="tool-header">
    <div class="tool-icon">ğŸŒ³</div>
    <div>
      <h1 class="tool-title">Family Tree</h1>
      <p class="tool-description">Create your family tree easily and export it</p>
    </div>
  </div>

  <div class="family-tree-app">
    <aside class="sidebar">
      <div class="sidebar-header">
        <h3>ğŸ“‹ <span id="sidebar-title">Ø§Ù„Ø£Ø´Ø®Ø§Øµ</span> <span class="count" id="persons-count">0</span></h3>
      </div>
      <div class="sidebar-search">
        <input type="text" id="search-input" placeholder="Ø§Ø¨Ø­Ø«...">
      </div>
      <div class="sidebar-list" id="persons-list"></div>
      <button class="add-btn" onclick="openPersonModal()">â• <span id="add-person-txt">Ø¥Ø¶Ø§ÙØ© Ø´Ø®Øµ</span></button>
    </aside>

    <main class="main-area">
      <div class="toolbar">
        <div class="toolbar-group">
          <button class="tool-btn" onclick="saveData()"><span class="icon">ğŸ’¾</span><span>Save Locally</span></button>
          <button class="tool-btn" onclick="loadData()"><span class="icon">ğŸ“‚</span><span>Load Saved</span></button>
        </div>
        <div class="toolbar-group">
          <div class="dropdown" id="export-dd">
            <button class="tool-btn" onclick="toggleDD('export-dd')"><span class="icon">ğŸ“¤</span><span>Export</span></button>
            <div class="dropdown-menu">
              <div class="dropdown-item" onclick="exportPNG()">ğŸ–¼ï¸ PNG</div>
              <div class="dropdown-item" onclick="exportSVG()">ğŸ“ SVG</div>
              <div class="dropdown-divider"></div>
              <div class="dropdown-item" onclick="exportJSON()">ğŸ“„ JSON</div>
            </div>
          </div>
          <button class="tool-btn" onclick="document.getElementById('import-file').click()"><span class="icon">ğŸ“¥</span><span>Import</span></button>
        </div>
        <div class="toolbar-group">
          <button class="tool-btn" onclick="clearAll()"><span class="icon">ğŸ—‘ï¸</span><span>Clear All</span></button>
        </div>
      </div>

      <div class="canvas-wrap" id="canvas-wrap">
        <svg class="tree-svg" id="tree-svg">
          <defs>
            <filter id="shadow" x="-20%" y="-20%" width="140%" height="140%">
              <feDropShadow dx="0" dy="2" stdDeviation="3" flood-opacity="0.2"/>
            </filter>
          </defs>
          <g id="tree-g">
            <g id="lines-g"></g>
            <g id="nodes-g"></g>
          </g>
        </svg>
        <div class="empty-msg" id="empty-msg">
          <div class="icon">ğŸŒ³</div>
          <h3 id="empty-title">Ø§Ø¨Ø¯Ø£ Ø¨Ø¥Ø¶Ø§ÙØ© Ø´Ø®Øµ</h3>
          <p id="empty-sub">Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± Ø§Ù„Ø¥Ø¶Ø§ÙØ©</p>
        </div>
        <div class="zoom-panel">
          <button class="zoom-btn" onclick="zoomIn()">â•</button>
          <div class="zoom-level" id="zoom-level">100%</div>
          <button class="zoom-btn" onclick="zoomOut()">â–</button>
          <button class="zoom-btn" onclick="resetView()">âŠ¡</button>
        </div>
      </div>

      <div class="stats-bar">
        <div class="stat"><span class="label">ğŸ‘¥</span><span class="val" id="stat-persons">0</span></div>
        <div class="stat"><span class="label">ğŸ‘¨</span><span class="val" id="stat-males">0</span></div>
        <div class="stat"><span class="label">ğŸ‘©</span><span class="val" id="stat-females">0</span></div>
        <div class="stat"><span class="label">ğŸ’‘</span><span class="val" id="stat-marriages">0</span></div>
        <div class="stat"><span class="label">ğŸ“Š</span><span class="val" id="stat-gens">0</span></div>
      </div>
    </main>
  </div>
</div>

<!-- Person Modal -->
<div class="modal-bg" id="person-modal">
  <div class="modal">
    <div class="modal-head">
      <h2><span id="pm-icon">ğŸ‘¤</span> <span id="pm-title">Ø¥Ø¶Ø§ÙØ© Ø´Ø®Øµ</span></h2>
      <button class="modal-close" onclick="closeModal('person-modal')">&times;</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label id="lbl-name">Ø§Ù„Ø§Ø³Ù… *</label>
        <input type="text" id="p-name">
      </div>
      <div class="form-group">
        <label id="lbl-gender">Ø§Ù„Ø¬Ù†Ø³</label>
        <div class="gender-toggle">
          <label class="gender-opt male"><input type="radio" name="p-gender" value="male" checked><span>ğŸ‘¨ <span id="lbl-male">Ø°ÙƒØ±</span></span></label>
          <label class="gender-opt female"><input type="radio" name="p-gender" value="female"><span>ğŸ‘© <span id="lbl-female">Ø£Ù†Ø«Ù‰</span></span></label>
        </div>
      </div>
      <div class="form-group">
        <label id="lbl-photo">Ø§Ù„ØµÙˆØ±Ø©</label>
        <div class="photo-row">
          <div class="photo-preview" id="photo-prev"><span class="ph">ğŸ‘¤</span></div>
          <div class="photo-btns">
            <button type="button" class="photo-btn" onclick="document.getElementById('photo-file').click()">ğŸ“· <span id="lbl-upload">Ø±ÙØ¹</span></button>
            <button type="button" class="photo-btn rm" onclick="removePhoto()" id="rm-photo-btn" style="display:none">ğŸ—‘ï¸</button>
          </div>
        </div>
        <input type="file" id="photo-file" class="hidden" accept="image/*" onchange="handlePhoto(event)">
      </div>
      <div class="form-row">
        <div class="form-group"><label id="lbl-birth">ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯</label><input type="date" id="p-birth"></div>
        <div class="form-group"><label id="lbl-death">ØªØ§Ø±ÙŠØ® Ø§Ù„ÙˆÙØ§Ø©</label><input type="date" id="p-death"></div>
      </div>
      <div class="form-group">
        <label id="lbl-notes">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
        <textarea id="p-notes"></textarea>
      </div>
    </div>
    <div class="modal-foot">
      <button class="btn-del" id="pm-del-btn" onclick="deletePerson()" style="display:none">ğŸ—‘ï¸</button>
      <button class="btn-cancel" onclick="closeModal('person-modal')" id="btn-cancel">Ø¥Ù„ØºØ§Ø¡</button>
      <button class="btn-save" onclick="savePerson()" id="btn-save">Ø­ÙØ¸</button>
    </div>
  </div>
</div>

<!-- Marriage Modal -->
<div class="modal-bg" id="marriage-modal">
  <div class="modal">
    <div class="modal-head">
      <h2>ğŸ’‘ <span id="mm-title">Ø¥Ø¶Ø§ÙØ© Ø²ÙˆØ§Ø¬</span></h2>
      <button class="modal-close" onclick="closeModal('marriage-modal')">&times;</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label id="lbl-husband">Ø§Ù„Ø²ÙˆØ¬</label>
        <div class="person-select" id="husband-select"></div>
      </div>
      <div class="form-group">
        <label id="lbl-wife">Ø§Ù„Ø²ÙˆØ¬Ø©</label>
        <div class="person-select" id="wife-select"></div>
      </div>
      <div class="form-group">
        <label id="lbl-status">Ø§Ù„Ø­Ø§Ù„Ø©</label>
        <div class="marriage-status">
          <label class="status-opt"><input type="radio" name="m-status" value="married" checked><span class="ic">ğŸ’‘</span><span class="tx" id="lbl-married">Ù…ØªØ²ÙˆØ¬Ø§Ù†</span></label>
          <label class="status-opt"><input type="radio" name="m-status" value="divorced"><span class="ic">ğŸ’”</span><span class="tx" id="lbl-divorced">Ù…Ø·Ù„Ù‚Ø§Ù†</span></label>
          <label class="status-opt"><input type="radio" name="m-status" value="widowed"><span class="ic">âœï¸</span><span class="tx" id="lbl-widowed">Ø£Ø±Ù…Ù„/Ø©</span></label>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group"><label id="lbl-start">Ø³Ù†Ø© Ø§Ù„Ø²ÙˆØ§Ø¬</label><input type="number" id="m-start" min="1900" max="2100"></div>
        <div class="form-group"><label id="lbl-end">Ø³Ù†Ø© Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡</label><input type="number" id="m-end" min="1900" max="2100"></div>
      </div>
    </div>
    <div class="modal-foot">
      <button class="btn-del" id="mm-del-btn" onclick="deleteMarriage()" style="display:none">ğŸ—‘ï¸</button>
      <button class="btn-cancel" onclick="closeModal('marriage-modal')">Ø¥Ù„ØºØ§Ø¡</button>
      <button class="btn-save" onclick="saveMarriage()">Ø­ÙØ¸</button>
    </div>
  </div>
</div>

<!-- Child Modal -->
<div class="modal-bg" id="child-modal">
  <div class="modal">
    <div class="modal-head">
      <h2>ğŸ‘¶ <span id="cm-title">Ø¥Ø¶Ø§ÙØ© Ø§Ø¨Ù†/Ø§Ø¨Ù†Ø©</span></h2>
      <button class="modal-close" onclick="closeModal('child-modal')">&times;</button>
    </div>
    <div class="modal-body">
      <div class="tabs">
        <button class="tab active" onclick="switchChildTab('new')" id="tab-new">Ø´Ø®Øµ Ø¬Ø¯ÙŠØ¯</button>
        <button class="tab" onclick="switchChildTab('existing')" id="tab-existing">Ø´Ø®Øµ Ù…ÙˆØ¬ÙˆØ¯</button>
      </div>
      
      <div id="child-new-form">
        <div class="form-group">
          <label>Ø§Ù„Ø§Ø³Ù… *</label>
          <input type="text" id="c-name">
        </div>
        <div class="form-group">
          <label>Ø§Ù„Ø¬Ù†Ø³</label>
          <div class="gender-toggle">
            <label class="gender-opt male"><input type="radio" name="c-gender" value="male" checked><span>ğŸ‘¨ Ø°ÙƒØ±</span></label>
            <label class="gender-opt female"><input type="radio" name="c-gender" value="female"><span>ğŸ‘© Ø£Ù†Ø«Ù‰</span></label>
          </div>
        </div>
      </div>
      
      <div id="child-existing-form" style="display:none">
        <div class="form-group">
          <label id="lbl-select-child">Ø§Ø®ØªØ± Ø§Ù„Ø´Ø®Øµ</label>
          <div class="person-select" id="child-select"></div>
        </div>
      </div>
      
      <div class="form-group" style="margin-top:12px; padding-top:12px; border-top:1px solid var(--border-color)">
        <label id="lbl-parentage">Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù„Ø§Ù‚Ø©</label>
        <div class="marriage-status">
          <label class="status-opt" id="opt-from-marriage" style="display:none"><input type="radio" name="c-parentage" value="marriage" checked><span class="ic">ğŸ’‘</span><span class="tx">Ù…Ù† Ø§Ù„Ø²ÙˆØ§Ø¬</span></label>
          <label class="status-opt"><input type="radio" name="c-parentage" value="father"><span class="ic">ğŸ‘¨</span><span class="tx" id="lbl-from-father">Ù…Ù† Ø§Ù„Ø£Ø¨ ÙÙ‚Ø·</span></label>
          <label class="status-opt"><input type="radio" name="c-parentage" value="mother"><span class="ic">ğŸ‘©</span><span class="tx" id="lbl-from-mother">Ù…Ù† Ø§Ù„Ø£Ù… ÙÙ‚Ø·</span></label>
        </div>
      </div>
    </div>
    <div class="modal-foot">
      <button class="btn-cancel" onclick="closeModal('child-modal')">Ø¥Ù„ØºØ§Ø¡</button>
      <button class="btn-save" onclick="saveChild()">Ø­ÙØ¸</button>
    </div>
  </div>
</div>

<!-- Context Menu -->
<div class="ctx-menu" id="ctx-menu">
  <div class="ctx-item" onclick="ctxAct('edit')">âœï¸ <span id="ctx-edit">ØªØ¹Ø¯ÙŠÙ„</span></div>
  <div class="ctx-item" onclick="ctxAct('marriage')">ğŸ’‘ <span id="ctx-marriage">Ø¥Ø¶Ø§ÙØ© Ø²ÙˆØ§Ø¬</span></div>
  <div class="ctx-item" onclick="ctxAct('child')">ğŸ‘¶ <span id="ctx-child">Ø¥Ø¶Ø§ÙØ© Ø§Ø¨Ù†/Ø©</span></div>
  <div class="ctx-item" onclick="ctxAct('locate')">ğŸ“ <span id="ctx-locate">Ø¥Ø¸Ù‡Ø§Ø±</span></div>
  <div class="ctx-divider"></div>
  <div class="ctx-item danger" onclick="ctxAct('delete')">ğŸ—‘ï¸ <span id="ctx-delete">Ø­Ø°Ù</span></div>
</div>

<!-- Add Menu -->
<div class="add-menu" id="add-menu">
  <div class="add-menu-item" onclick="addMenuAct('parent')">ğŸ‘¨â€ğŸ‘© <span id="am-parent">ÙˆØ§Ù„Ø¯ÙŠÙ†</span></div>
  <div class="add-menu-item" onclick="addMenuAct('child')">ğŸ‘¶ <span id="am-child">Ø§Ø¨Ù†/Ø©</span></div>
  <div class="add-menu-item" onclick="addMenuAct('sibling')">ğŸ‘« <span id="am-sibling">Ø£Ø®/Ø£Ø®Øª</span></div>
  <div class="add-menu-item" onclick="addMenuAct('spouse')">ğŸ’‘ <span id="am-spouse">Ø²ÙˆØ¬/Ø©</span></div>
</div>

<div class="toast" id="toast"></div>
<input type="file" id="import-file" class="hidden" accept=".json" onchange="importJSON(event)">

<script>
const isAr = document.documentElement.lang === 'ar';
const t = (ar, en) => isAr ? ar : en;

// ==================== DATA ====================
let db = {
  persons: {},
  marriages: {},
  children: {}
};

let state = {
  editPersonId: null,
  editMarriageId: null,
  currentPersonId: null,
  currentMarriageId: null,
  currentPhoto: null,
  childTab: 'new',
  ctxTarget: null,
  zoom: 1,
  panX: 0,
  panY: 0
};

const CARD_W = 110, CARD_H = 75;
const GAP_X = 30, GAP_Y = 55;
const MARRIAGE_GAP = 20;

// ==================== INIT ====================
function init() {
  setupCanvas();
  setupI18n();
  render();
  
  document.addEventListener('click', e => {
    document.getElementById('ctx-menu').classList.remove('show');
    document.getElementById('add-menu').classList.remove('show');
    document.querySelectorAll('.dropdown.open').forEach(d => d.classList.remove('open'));
  });
  
  document.addEventListener('keydown', e => {
    if (e.key === 'Escape') {
      closeModal('person-modal');
      closeModal('marriage-modal');
      closeModal('child-modal');
    }
  });
  
  document.getElementById('search-input').addEventListener('input', renderList);
}

function setupI18n() {
  if (!isAr) {
    document.getElementById('sidebar-title').textContent = 'Persons';
    document.getElementById('search-input').placeholder = 'Search...';
    document.getElementById('add-person-txt').textContent = 'Add Person';
    document.getElementById('empty-title').textContent = 'Start by adding a person';
    document.getElementById('empty-sub').textContent = 'Click the add button';
    document.getElementById('pm-title').textContent = 'Add Person';
    document.getElementById('lbl-name').textContent = 'Name *';
    document.getElementById('lbl-gender').textContent = 'Gender';
    document.getElementById('lbl-male').textContent = 'Male';
    document.getElementById('lbl-female').textContent = 'Female';
    document.getElementById('lbl-photo').textContent = 'Photo';
    document.getElementById('lbl-upload').textContent = 'Upload';
    document.getElementById('lbl-birth').textContent = 'Birth Date';
    document.getElementById('lbl-death').textContent = 'Death Date';
    document.getElementById('lbl-notes').textContent = 'Notes';
    document.getElementById('btn-cancel').textContent = 'Cancel';
    document.getElementById('btn-save').textContent = 'Save';
    document.getElementById('mm-title').textContent = 'Add Marriage';
    document.getElementById('lbl-husband').textContent = 'Husband';
    document.getElementById('lbl-wife').textContent = 'Wife';
    document.getElementById('lbl-status').textContent = 'Status';
    document.getElementById('lbl-married').textContent = 'Married';
    document.getElementById('lbl-divorced').textContent = 'Divorced';
    document.getElementById('lbl-widowed').textContent = 'Widowed';
    document.getElementById('lbl-start').textContent = 'Marriage Year';
    document.getElementById('lbl-end').textContent = 'End Year';
    document.getElementById('cm-title').textContent = 'Add Child';
    document.getElementById('tab-new').textContent = 'New Person';
    document.getElementById('tab-existing').textContent = 'Existing Person';
    document.getElementById('lbl-select-child').textContent = 'Select Person';
    document.getElementById('lbl-parentage').textContent = 'Relation Type';
    document.getElementById('lbl-from-father').textContent = 'Father only';
    document.getElementById('lbl-from-mother').textContent = 'Mother only';
    document.getElementById('ctx-edit').textContent = 'Edit';
    document.getElementById('ctx-marriage').textContent = 'Add Marriage';
    document.getElementById('ctx-child').textContent = 'Add Child';
    document.getElementById('ctx-locate').textContent = 'Show';
    document.getElementById('ctx-delete').textContent = 'Delete';
    document.getElementById('am-parent').textContent = 'Parents';
    document.getElementById('am-child').textContent = 'Child';
    document.getElementById('am-sibling').textContent = 'Sibling';
    document.getElementById('am-spouse').textContent = 'Spouse';
  }
}

// ==================== HELPERS ====================
function genId() { return Date.now().toString(36) + Math.random().toString(36).substr(2, 5); }

function getMarriagesOf(personId) {
  return Object.values(db.marriages).filter(m => m.husbandId === personId || m.wifeId === personId);
}

function getChildrenOfMarriage(marriageId) {
  return Object.values(db.children).filter(c => c.marriageId === marriageId).map(c => db.persons[c.childId]).filter(Boolean);
}

function getParentsOf(personId) {
  const rec = Object.values(db.children).find(c => c.childId === personId);
  if (!rec) return { father: null, mother: null, marriage: null };
  if (rec.marriageId) {
    const m = db.marriages[rec.marriageId];
    return { father: db.persons[m?.husbandId], mother: db.persons[m?.wifeId], marriage: m };
  }
  return { father: db.persons[rec.fatherId], mother: db.persons[rec.motherId], marriage: null };
}

function getLineage(personId, depth = 2) {
  const p = db.persons[personId];
  if (!p) return '';
  let result = p.name;
  const parents = getParentsOf(personId);
  if (parents.father && depth > 0) {
    result += ' ' + (p.gender === 'female' ? t('Ø¨Ù†Øª', 'd/o') : t('Ø¨Ù†', 's/o')) + ' ' + parents.father.name;
  } else if (parents.mother && depth > 0) {
    result += ' ' + (p.gender === 'female' ? t('Ø¨Ù†Øª', 'd/o') : t('Ø§Ø¨Ù†', 's/o')) + ' ' + parents.mother.name;
  }
  return result;
}

function canWifeMarry(wifeId, excludeId = null) {
  return !Object.values(db.marriages).some(m => m.wifeId === wifeId && m.status === 'married' && m.id !== excludeId);
}

// ==================== RENDER LIST ====================
function renderList() {
  const list = document.getElementById('persons-list');
  const search = document.getElementById('search-input').value.toLowerCase();
  const persons = Object.values(db.persons);
  
  const hasParent = p => Object.values(db.children).some(c => c.childId === p.id);
  const hasRelation = p => hasParent(p) || getMarriagesOf(p.id).length > 0;
  
  const linked = persons.filter(hasRelation);
  const orphans = persons.filter(p => !hasRelation(p));
  
  const filter = p => p.name.toLowerCase().includes(search);
  
  let html = '';
  linked.filter(filter).forEach(p => { html += listItem(p); });
  
  const fo = orphans.filter(filter);
  if (fo.length > 0) {
    html += `<div class="section-label">âš ï¸ ${t('ØºÙŠØ± Ù…Ø±ØªØ¨Ø·ÙŠÙ†', 'Unlinked')} (${fo.length})</div>`;
    fo.forEach(p => { html += listItem(p, true); });
  }
  
  list.innerHTML = html || `<div style="text-align:center;padding:15px;color:var(--text-muted)">${t('Ù„Ø§ ÙŠÙˆØ¬Ø¯', 'Empty')}</div>`;
  document.getElementById('persons-count').textContent = persons.length;
}

function listItem(p, orphan = false) {
  const icon = p.photo ? `<img src="${p.photo}">` : (p.gender === 'female' ? 'ğŸ‘©' : 'ğŸ‘¨');
  return `<div class="list-item ${orphan ? 'orphan' : ''}" onclick="locatePerson('${p.id}')" oncontextmenu="showCtx(event,'${p.id}')">
    <div class="icon ${p.gender}">${icon}</div>
    <div class="info"><div class="name">${p.name}</div><div class="sub">${getLineage(p.id)}</div></div>
    <button class="menu-btn" onclick="event.stopPropagation();showCtx(event,'${p.id}')">â‹®</button>
  </div>`;
}

// ==================== PERSON MODAL ====================
function openPersonModal(editId = null) {
  state.editPersonId = editId;
  state.currentPhoto = null;
  
  if (editId) {
    const p = db.persons[editId];
    document.getElementById('pm-title').textContent = t('ØªØ¹Ø¯ÙŠÙ„', 'Edit');
    document.getElementById('pm-icon').textContent = 'âœï¸';
    document.getElementById('pm-del-btn').style.display = 'block';
    document.getElementById('p-name').value = p.name;
    document.querySelector(`input[name="p-gender"][value="${p.gender}"]`).checked = true;
    document.getElementById('p-birth').value = p.birthDate || '';
    document.getElementById('p-death').value = p.deathDate || '';
    document.getElementById('p-notes').value = p.notes || '';
    state.currentPhoto = p.photo;
  } else {
    document.getElementById('pm-title').textContent = t('Ø¥Ø¶Ø§ÙØ© Ø´Ø®Øµ', 'Add Person');
    document.getElementById('pm-icon').textContent = 'ğŸ‘¤';
    document.getElementById('pm-del-btn').style.display = 'none';
    document.getElementById('p-name').value = '';
    document.querySelector('input[name="p-gender"][value="male"]').checked = true;
    document.getElementById('p-birth').value = '';
    document.getElementById('p-death').value = '';
    document.getElementById('p-notes').value = '';
  }
  
  updatePhotoPreview();
  openModal('person-modal');
}

function savePerson() {
  const name = document.getElementById('p-name').value.trim();
  if (!name) { toast(t('Ø£Ø¯Ø®Ù„ Ø§Ù„Ø§Ø³Ù…', 'Enter name')); return; }
  
  const data = {
    name,
    gender: document.querySelector('input[name="p-gender"]:checked').value,
    photo: state.currentPhoto,
    birthDate: document.getElementById('p-birth').value || null,
    deathDate: document.getElementById('p-death').value || null,
    notes: document.getElementById('p-notes').value.trim()
  };
  
  if (state.editPersonId) {
    Object.assign(db.persons[state.editPersonId], data);
  } else {
    const id = genId();
    db.persons[id] = { id, ...data };
  }
  
  closeModal('person-modal');
  render();
  toast(t('ØªÙ…', 'Done'));
}

function deletePerson() {
  if (!state.editPersonId || !confirm(t('Ø­Ø°ÙØŸ', 'Delete?'))) return;
  const id = state.editPersonId;
  
  Object.keys(db.children).forEach(cid => {
    const c = db.children[cid];
    if (c.childId === id || c.fatherId === id || c.motherId === id) delete db.children[cid];
  });
  
  Object.keys(db.marriages).forEach(mid => {
    const m = db.marriages[mid];
    if (m.husbandId === id || m.wifeId === id) {
      Object.keys(db.children).forEach(cid => {
        if (db.children[cid].marriageId === mid) delete db.children[cid];
      });
      delete db.marriages[mid];
    }
  });
  
  delete db.persons[id];
  closeModal('person-modal');
  render();
  toast(t('ØªÙ…', 'Done'));
}

// ==================== MARRIAGE MODAL ====================
function openMarriageModal(editId = null, preselect = null) {
  state.editMarriageId = editId;
  
  const males = Object.values(db.persons).filter(p => p.gender === 'male');
  const females = Object.values(db.persons).filter(p => p.gender === 'female');
  
  let selH = preselect?.husbandId || null;
  let selW = preselect?.wifeId || null;
  
  if (editId) {
    const m = db.marriages[editId];
    document.getElementById('mm-title').textContent = t('ØªØ¹Ø¯ÙŠÙ„', 'Edit');
    document.getElementById('mm-del-btn').style.display = 'block';
    selH = m.husbandId; selW = m.wifeId;
    document.querySelector(`input[name="m-status"][value="${m.status}"]`).checked = true;
    document.getElementById('m-start').value = m.startYear || '';
    document.getElementById('m-end').value = m.endYear || '';
  } else {
    document.getElementById('mm-title').textContent = t('Ø¥Ø¶Ø§ÙØ© Ø²ÙˆØ§Ø¬', 'Add Marriage');
    document.getElementById('mm-del-btn').style.display = 'none';
    document.querySelector('input[name="m-status"][value="married"]').checked = true;
    document.getElementById('m-start').value = '';
    document.getElementById('m-end').value = '';
  }
  
  renderPersonSelect('husband-select', males, selH);
  renderPersonSelect('wife-select', females, selW);
  
  openModal('marriage-modal');
}

function saveMarriage() {
  const hId = document.querySelector('#husband-select .person-select-opt.selected:not(.none)')?.dataset.id;
  const wId = document.querySelector('#wife-select .person-select-opt.selected:not(.none)')?.dataset.id;
  
  if (!hId && !wId) { toast(t('Ø§Ø®ØªØ± Ø£Ø­Ø¯Ù‡Ù…Ø§', 'Select one')); return; }
  
  const status = document.querySelector('input[name="m-status"]:checked').value;
  if (wId && status === 'married' && !canWifeMarry(wId, state.editMarriageId)) {
    toast(t('Ù…ØªØ²ÙˆØ¬Ø© Ø­Ø§Ù„ÙŠØ§Ù‹', 'Already married'));
    return;
  }
  
  const data = {
    husbandId: hId || null,
    wifeId: wId || null,
    status,
    startYear: document.getElementById('m-start').value ? parseInt(document.getElementById('m-start').value) : null,
    endYear: document.getElementById('m-end').value ? parseInt(document.getElementById('m-end').value) : null
  };
  
  if (state.editMarriageId) {
    Object.assign(db.marriages[state.editMarriageId], data);
  } else {
    const id = genId();
    db.marriages[id] = { id, ...data };
  }
  
  closeModal('marriage-modal');
  render();
  toast(t('ØªÙ…', 'Done'));
}

function deleteMarriage() {
  if (!state.editMarriageId || !confirm(t('Ø­Ø°ÙØŸ', 'Delete?'))) return;
  Object.keys(db.children).forEach(cid => {
    if (db.children[cid].marriageId === state.editMarriageId) delete db.children[cid];
  });
  delete db.marriages[state.editMarriageId];
  closeModal('marriage-modal');
  render();
  toast(t('ØªÙ…', 'Done'));
}

// ==================== CHILD MODAL ====================
function openChildModal(ctx) {
  state.currentPersonId = ctx.personId || null;
  state.currentMarriageId = ctx.marriageId || null;
  state.childTab = 'new';
  
  document.getElementById('tab-new').classList.add('active');
  document.getElementById('tab-existing').classList.remove('active');
  document.getElementById('child-new-form').style.display = 'block';
  document.getElementById('child-existing-form').style.display = 'none';
  document.getElementById('c-name').value = '';
  document.querySelector('input[name="c-gender"][value="male"]').checked = true;
  
  const optM = document.getElementById('opt-from-marriage');
  if (state.currentMarriageId) {
    optM.style.display = 'flex';
    document.querySelector('input[name="c-parentage"][value="marriage"]').checked = true;
  } else {
    optM.style.display = 'none';
    document.querySelector('input[name="c-parentage"][value="father"]').checked = true;
  }
  
  const existing = Object.values(db.persons).filter(p => !Object.values(db.children).some(c => c.childId === p.id));
  renderPersonSelect('child-select', existing, null);
  
  openModal('child-modal');
}

function switchChildTab(tab) {
  state.childTab = tab;
  document.getElementById('tab-new').classList.toggle('active', tab === 'new');
  document.getElementById('tab-existing').classList.toggle('active', tab === 'existing');
  document.getElementById('child-new-form').style.display = tab === 'new' ? 'block' : 'none';
  document.getElementById('child-existing-form').style.display = tab === 'existing' ? 'block' : 'none';
}

function saveChild() {
  let childId;
  
  if (state.childTab === 'new') {
    const name = document.getElementById('c-name').value.trim();
    if (!name) { toast(t('Ø£Ø¯Ø®Ù„ Ø§Ù„Ø§Ø³Ù…', 'Enter name')); return; }
    childId = genId();
    db.persons[childId] = {
      id: childId, name,
      gender: document.querySelector('input[name="c-gender"]:checked').value,
      photo: null, birthDate: null, deathDate: null, notes: ''
    };
  } else {
    childId = document.querySelector('#child-select .person-select-opt.selected:not(.none)')?.dataset.id;
    if (!childId) { toast(t('Ø§Ø®ØªØ±', 'Select')); return; }
  }
  
  const parentage = document.querySelector('input[name="c-parentage"]:checked').value;
  const rec = { id: genId(), childId };
  
  if (parentage === 'marriage' && state.currentMarriageId) {
    rec.marriageId = state.currentMarriageId;
  } else {
    const p = db.persons[state.currentPersonId];
    if (parentage === 'father' || (parentage !== 'mother' && p?.gender === 'male')) {
      rec.fatherId = state.currentPersonId;
    } else {
      rec.motherId = state.currentPersonId;
    }
  }
  
  db.children[rec.id] = rec;
  closeModal('child-modal');
  render();
  toast(t('ØªÙ…', 'Done'));
}

// ==================== PERSON SELECT ====================
function renderPersonSelect(containerId, persons, selectedId) {
  const c = document.getElementById(containerId);
  let html = `<input type="text" class="person-select-search" placeholder="${t('Ø§Ø¨Ø­Ø«...', 'Search...')}" oninput="filterSelect('${containerId}', this.value)">`;
  html += `<div class="person-select-list">`;
  html += `<div class="person-select-opt none ${!selectedId ? 'selected' : ''}" onclick="pickPerson('${containerId}', null)">${t('Ø¨Ø¯ÙˆÙ†', 'None')}</div>`;
  persons.forEach(p => {
    const icon = p.photo ? `<img src="${p.photo}" style="width:100%;height:100%;border-radius:50%;object-fit:cover">` : (p.gender === 'female' ? 'ğŸ‘©' : 'ğŸ‘¨');
    html += `<div class="person-select-opt ${selectedId === p.id ? 'selected' : ''}" data-id="${p.id}" data-name="${p.name.toLowerCase()}" onclick="pickPerson('${containerId}', '${p.id}')">
      <div class="av" style="background:${p.gender === 'female' ? 'rgba(236,72,153,0.2)' : 'rgba(59,130,246,0.2)'}">${icon}</div>
      <span class="nm">${p.name}</span>
    </div>`;
  });
  html += `</div>`;
  c.innerHTML = html;
}

function filterSelect(cid, q) {
  document.querySelectorAll(`#${cid} .person-select-opt:not(.none)`).forEach(o => {
    o.style.display = (o.dataset.name || '').includes(q.toLowerCase()) ? '' : 'none';
  });
}

function pickPerson(cid, id) {
  document.querySelectorAll(`#${cid} .person-select-opt`).forEach(o => {
    o.classList.toggle('selected', id ? o.dataset.id === id : o.classList.contains('none'));
  });
}

// ==================== PHOTO ====================
function handlePhoto(e) {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = ev => { state.currentPhoto = ev.target.result; updatePhotoPreview(); };
  reader.readAsDataURL(file);
}

function removePhoto() {
  state.currentPhoto = null;
  document.getElementById('photo-file').value = '';
  updatePhotoPreview();
}

function updatePhotoPreview() {
  const prev = document.getElementById('photo-prev');
  const btn = document.getElementById('rm-photo-btn');
  if (state.currentPhoto) {
    prev.innerHTML = `<img src="${state.currentPhoto}">`;
    btn.style.display = 'block';
  } else {
    prev.innerHTML = '<span class="ph">ğŸ‘¤</span>';
    btn.style.display = 'none';
  }
}

// ==================== CONTEXT / ADD MENU ====================
function showCtx(e, id) {
  e.preventDefault(); e.stopPropagation();
  state.ctxTarget = id;
  const m = document.getElementById('ctx-menu');
  m.style.left = e.clientX + 'px';
  m.style.top = e.clientY + 'px';
  m.classList.add('show');
}

function ctxAct(act) {
  document.getElementById('ctx-menu').classList.remove('show');
  if (!state.ctxTarget) return;
  const p = db.persons[state.ctxTarget];
  switch (act) {
    case 'edit': openPersonModal(state.ctxTarget); break;
    case 'marriage': openMarriageModal(null, p.gender === 'male' ? { husbandId: state.ctxTarget } : { wifeId: state.ctxTarget }); break;
    case 'child':
      const ms = getMarriagesOf(state.ctxTarget);
      openChildModal({ personId: state.ctxTarget, marriageId: ms[0]?.id });
      break;
    case 'locate': locatePerson(state.ctxTarget); break;
    case 'delete': state.editPersonId = state.ctxTarget; deletePerson(); break;
  }
}

function showAddMenu(e, id, x, y) {
  e.stopPropagation();
  state.currentPersonId = id;
  const m = document.getElementById('add-menu');
  const svg = document.getElementById('tree-svg').getBoundingClientRect();
  m.style.left = (svg.left + x * state.zoom + state.panX) + 'px';
  m.style.top = (svg.top + y * state.zoom + state.panY) + 'px';
  m.classList.add('show');
}

function addMenuAct(act) {
  document.getElementById('add-menu').classList.remove('show');
  const id = state.currentPersonId;
  if (!id) return;
  const p = db.persons[id];
  
  switch (act) {
    case 'parent': openMarriageModal(); break;
    case 'child':
      const ms = getMarriagesOf(id);
      openChildModal({ personId: id, marriageId: ms[0]?.id });
      break;
    case 'sibling':
      const parents = getParentsOf(id);
      if (parents.marriage) openChildModal({ marriageId: parents.marriage.id });
      else if (parents.father) openChildModal({ personId: parents.father.id });
      else if (parents.mother) openChildModal({ personId: parents.mother.id });
      else toast(t('Ù„Ø§ ÙˆØ§Ù„Ø¯ÙŠÙ†', 'No parents'));
      break;
    case 'spouse':
      openMarriageModal(null, p.gender === 'male' ? { husbandId: id } : { wifeId: id });
      break;
  }
}

// ==================== LAYOUT ====================
function render() {
  renderList();
  layoutTree();
  renderTree();
  updateStats();
}

function layoutTree() {
  const nodes = {};
  const done = new Set();
  
  // Ø¬Ù…Ø¹ Ø§Ù„Ø¹Ø§Ø¦Ù„Ø§Øª (Ø²ÙˆØ§Ø¬Ø§Øª Ø§Ù„Ø¬Ø°ÙˆØ±)
  const rootMarriages = Object.values(db.marriages).filter(m => {
    const hp = getParentsOf(m.husbandId);
    const wp = getParentsOf(m.wifeId);
    return !hp.father && !hp.mother && !wp.father && !wp.mother;
  });
  
  const rootPersons = Object.values(db.persons).filter(p => {
    const parents = getParentsOf(p.id);
    return !parents.father && !parents.mother && getMarriagesOf(p.id).length === 0;
  });
  
  let curX = 50;
  
  function layoutFamily(marriageId, level, startX) {
    const m = db.marriages[marriageId];
    if (!m) return startX;
    
    const husband = db.persons[m.husbandId];
    const wife = db.persons[m.wifeId];
    const children = getChildrenOfMarriage(marriageId);
    
    let x = startX;
    const y = level * (CARD_H + GAP_Y);
    
    // Ø­Ø³Ø§Ø¨ Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø¨Ù†Ø§Ø¡
    let childrenWidth = 0;
    const childLayouts = [];
    
    children.forEach(child => {
      const childMs = getMarriagesOf(child.id);
      if (childMs.length > 0) {
        const w = layoutFamily(childMs[0].id, level + 1, x + childrenWidth);
        childLayouts.push({ id: child.id, width: w - (x + childrenWidth) });
        childrenWidth = w - x;
      } else {
        childLayouts.push({ id: child.id, width: CARD_W });
        childrenWidth += CARD_W + GAP_X;
      }
    });
    
    if (childrenWidth > 0) childrenWidth -= GAP_X;
    
    // Ø¹Ø±Ø¶ Ø§Ù„ÙˆØ§Ù„Ø¯ÙŠÙ†
    const parentWidth = (husband ? CARD_W : 0) + (wife ? CARD_W : 0) + (husband && wife ? MARRIAGE_GAP : 0);
    const familyWidth = Math.max(parentWidth, childrenWidth);
    
    // Ù…ÙˆØ¶Ø¹ Ø§Ù„ÙˆØ§Ù„Ø¯ÙŠÙ† (ÙÙŠ Ø§Ù„Ù…Ù†ØªØµÙ ÙÙˆÙ‚ Ø§Ù„Ø£Ø¨Ù†Ø§Ø¡)
    const parentStartX = x + (familyWidth - parentWidth) / 2;
    
    if (husband && !done.has(m.husbandId)) {
      done.add(m.husbandId);
      nodes[m.husbandId] = { x: parentStartX, y, level };
    }
    if (wife && !done.has(m.wifeId)) {
      done.add(m.wifeId);
      nodes[m.wifeId] = { x: parentStartX + (husband ? CARD_W + MARRIAGE_GAP : 0), y, level };
    }
    
    // Ù…ÙˆØ¶Ø¹ Ø§Ù„Ø£Ø¨Ù†Ø§Ø¡
    let childX = x + (familyWidth - childrenWidth) / 2;
    childLayouts.forEach(cl => {
      if (!done.has(cl.id)) {
        done.add(cl.id);
        nodes[cl.id] = { x: childX, y: (level + 1) * (CARD_H + GAP_Y), level: level + 1 };
      }
      childX += cl.width + GAP_X;
    });
    
    return x + familyWidth + GAP_X * 2;
  }
  
  // Ø±Ø³Ù… Ø§Ù„Ø²ÙˆØ§Ø¬Ø§Øª Ø§Ù„Ø¬Ø°Ø±ÙŠØ©
  rootMarriages.forEach(m => {
    curX = layoutFamily(m.id, 0, curX);
  });
  
  // Ø§Ù„Ø£Ø´Ø®Ø§Øµ Ø§Ù„Ù…ÙØ±Ø¯ÙŠÙ†
  rootPersons.forEach(p => {
    if (!done.has(p.id)) {
      done.add(p.id);
      nodes[p.id] = { x: curX, y: 0, level: 0 };
      curX += CARD_W + GAP_X;
    }
  });
  
  // Ø­ÙØ¸ Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹
  Object.entries(nodes).forEach(([id, pos]) => {
    if (db.persons[id]) {
      db.persons[id]._x = pos.x;
      db.persons[id]._y = pos.y;
      db.persons[id]._level = pos.level;
    }
  });
}

function renderTree() {
  const linesG = document.getElementById('lines-g');
  const nodesG = document.getElementById('nodes-g');
  linesG.innerHTML = '';
  nodesG.innerHTML = '';
  
  const persons = Object.values(db.persons);
  document.getElementById('empty-msg').style.display = persons.length === 0 ? 'block' : 'none';
  if (persons.length === 0) return;
  
  // Ø®Ø·ÙˆØ· Ø§Ù„Ø²ÙˆØ§Ø¬
  Object.values(db.marriages).forEach(m => {
    const h = db.persons[m.husbandId];
    const w = db.persons[m.wifeId];
    if (h?._x !== undefined && w?._x !== undefined) {
      drawMarriageLine(h, w, m, linesG);
    }
  });
  
  // Ø®Ø·ÙˆØ· Ø§Ù„Ø£Ø¨Ù†Ø§Ø¡
  Object.values(db.children).forEach(c => {
    const child = db.persons[c.childId];
    if (!child || child._x === undefined) return;
    
    if (c.marriageId) {
      const m = db.marriages[c.marriageId];
      const h = db.persons[m?.husbandId];
      const w = db.persons[m?.wifeId];
      if (h?._x !== undefined && w?._x !== undefined) {
        drawChildFromMarriage(h, w, child, linesG);
      }
    } else {
      const parent = db.persons[c.fatherId || c.motherId];
      if (parent?._x !== undefined) drawChildFromSingle(parent, child, linesG);
    }
  });
  
  // Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª
  persons.forEach(p => { if (p._x !== undefined) drawCard(p, nodesG); });
  
  updateTransform();
}

function drawMarriageLine(h, w, m, layer) {
  const x1 = Math.min(h._x, w._x) + CARD_W;
  const x2 = Math.max(h._x, w._x);
  const y = h._y + CARD_H / 2;
  
  const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
  line.setAttribute('x1', x1); line.setAttribute('y1', y);
  line.setAttribute('x2', x2); line.setAttribute('y2', y);
  
  if (m.status === 'divorced') { line.setAttribute('stroke', '#6b7280'); line.setAttribute('stroke-dasharray', '5,5'); }
  else if (m.status === 'widowed') { line.setAttribute('stroke', '#4b5563'); line.setAttribute('stroke-dasharray', '2,4'); }
  else { line.setAttribute('stroke', '#f59e0b'); }
  line.setAttribute('stroke-width', '3');
  layer.appendChild(line);
  
  const midX = (x1 + x2) / 2;
  const icon = document.createElementNS('http://www.w3.org/2000/svg', 'text');
  icon.setAttribute('x', midX); icon.setAttribute('y', y - 8);
  icon.setAttribute('text-anchor', 'middle'); icon.setAttribute('font-size', '12');
  icon.textContent = m.status === 'divorced' ? 'ğŸ’”' : m.status === 'widowed' ? 'âœï¸' : 'ğŸ’‘';
  layer.appendChild(icon);
  
  // Ø²Ø± + Ø¹Ù„Ù‰ Ø®Ø· Ø§Ù„Ø²ÙˆØ§Ø¬
  const addG = document.createElementNS('http://www.w3.org/2000/svg', 'g');
  addG.style.cursor = 'pointer';
  const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
  circle.setAttribute('cx', midX); circle.setAttribute('cy', y + 15);
  circle.setAttribute('r', 8);
  circle.setAttribute('fill', '#1e293b'); circle.setAttribute('stroke', '#059669'); circle.setAttribute('stroke-width', '2');
  addG.appendChild(circle);
  const txt = document.createElementNS('http://www.w3.org/2000/svg', 'text');
  txt.setAttribute('x', midX); txt.setAttribute('y', y + 15);
  txt.setAttribute('text-anchor', 'middle'); txt.setAttribute('dominant-baseline', 'central');
  txt.setAttribute('fill', '#059669'); txt.setAttribute('font-size', '12'); txt.setAttribute('font-weight', 'bold');
  txt.textContent = '+';
  addG.appendChild(txt);
  addG.onclick = e => { e.stopPropagation(); openChildModal({ marriageId: m.id }); };
  addG.onmouseenter = () => { circle.setAttribute('fill', '#059669'); txt.setAttribute('fill', '#fff'); };
  addG.onmouseleave = () => { circle.setAttribute('fill', '#1e293b'); txt.setAttribute('fill', '#059669'); };
  layer.appendChild(addG);
}

function drawChildFromMarriage(h, w, child, layer) {
  const midX = (Math.min(h._x, w._x) + Math.max(h._x, w._x) + CARD_W) / 2;
  const y1 = h._y + CARD_H;
  const cx = child._x + CARD_W / 2;
  const cy = child._y;
  const midY = y1 + (cy - y1) / 2;
  
  const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
  path.setAttribute('d', `M ${midX} ${y1} L ${midX} ${midY} L ${cx} ${midY} L ${cx} ${cy}`);
  path.setAttribute('stroke', '#475569'); path.setAttribute('stroke-width', '2'); path.setAttribute('fill', 'none');
  layer.appendChild(path);
}

function drawChildFromSingle(parent, child, layer) {
  const px = parent._x + CARD_W / 2;
  const py = parent._y + CARD_H;
  const cx = child._x + CARD_W / 2;
  const cy = child._y;
  const midY = py + (cy - py) / 2;
  
  const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
  path.setAttribute('d', `M ${px} ${py} L ${px} ${midY} L ${cx} ${midY} L ${cx} ${cy}`);
  path.setAttribute('stroke', '#475569'); path.setAttribute('stroke-width', '2'); path.setAttribute('fill', 'none');
  layer.appendChild(path);
}

function drawCard(p, layer) {
  const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
  g.setAttribute('transform', `translate(${p._x}, ${p._y})`);
  g.setAttribute('data-id', p.id);
  g.style.cursor = 'pointer';
  
  const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
  rect.setAttribute('width', CARD_W); rect.setAttribute('height', CARD_H); rect.setAttribute('rx', '8');
  rect.setAttribute('fill', '#334155');
  rect.setAttribute('stroke', p.gender === 'female' ? '#ec4899' : '#3b82f6');
  rect.setAttribute('stroke-width', p.deathDate ? '2' : '2.5');
  if (p.deathDate) rect.setAttribute('stroke-dasharray', '4,3');
  rect.setAttribute('filter', 'url(#shadow)');
  g.appendChild(rect);
  
  if (p.photo) {
    const img = document.createElementNS('http://www.w3.org/2000/svg', 'image');
    img.setAttribute('x', CARD_W/2 - 12); img.setAttribute('y', 5);
    img.setAttribute('width', 24); img.setAttribute('height', 24);
    img.setAttribute('href', p.photo);
    g.appendChild(img);
  } else {
    const icon = document.createElementNS('http://www.w3.org/2000/svg', 'text');
    icon.setAttribute('x', CARD_W/2); icon.setAttribute('y', 22);
    icon.setAttribute('text-anchor', 'middle'); icon.setAttribute('font-size', '18');
    icon.textContent = p.gender === 'female' ? 'ğŸ‘©' : 'ğŸ‘¨';
    g.appendChild(icon);
  }
  
  const name = document.createElementNS('http://www.w3.org/2000/svg', 'text');
  name.setAttribute('x', CARD_W/2); name.setAttribute('y', 42);
  name.setAttribute('text-anchor', 'middle');
  name.setAttribute('fill', '#f8fafc'); name.setAttribute('font-size', '10'); name.setAttribute('font-weight', '600');
  name.textContent = p.name.length > 12 ? p.name.substring(0, 12) + '..' : p.name;
  g.appendChild(name);
  
  if (p.birthDate) {
    const age = calcAge(p.birthDate, p.deathDate);
    const txt = document.createElementNS('http://www.w3.org/2000/svg', 'text');
    txt.setAttribute('x', CARD_W/2); txt.setAttribute('y', 54);
    txt.setAttribute('text-anchor', 'middle');
    txt.setAttribute('fill', '#94a3b8'); txt.setAttribute('font-size', '8');
    txt.textContent = age + (isAr ? ' Ø³Ù†Ø©' : ' y') + (p.deathDate ? ' âœ' : '');
    g.appendChild(txt);
  }
  
  // Ø²Ø± +
  const addG = document.createElementNS('http://www.w3.org/2000/svg', 'g');
  addG.setAttribute('class', 'add-g');
  addG.style.cursor = 'pointer';
  const addRect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
  addRect.setAttribute('x', CARD_W/2 - 12); addRect.setAttribute('y', CARD_H - 16);
  addRect.setAttribute('width', 24); addRect.setAttribute('height', 12); addRect.setAttribute('rx', 4);
  addRect.setAttribute('fill', '#1e293b'); addRect.setAttribute('stroke', '#059669'); addRect.setAttribute('stroke-width', '1.5');
  addG.appendChild(addRect);
  const addTxt = document.createElementNS('http://www.w3.org/2000/svg', 'text');
  addTxt.setAttribute('x', CARD_W/2); addTxt.setAttribute('y', CARD_H - 7);
  addTxt.setAttribute('text-anchor', 'middle'); addTxt.setAttribute('fill', '#059669');
  addTxt.setAttribute('font-size', '10'); addTxt.setAttribute('font-weight', 'bold');
  addTxt.textContent = '+';
  addG.appendChild(addTxt);
  addG.onclick = e => showAddMenu(e, p.id, p._x + CARD_W/2, p._y + CARD_H);
  addG.onmouseenter = () => { addRect.setAttribute('fill', '#059669'); addTxt.setAttribute('fill', '#fff'); };
  addG.onmouseleave = () => { addRect.setAttribute('fill', '#1e293b'); addTxt.setAttribute('fill', '#059669'); };
  g.appendChild(addG);
  
  g.onclick = e => { if (!e.target.closest('.add-g')) { e.stopPropagation(); openPersonModal(p.id); } };
  g.oncontextmenu = e => { e.preventDefault(); showCtx(e, p.id); };
  g.ondblclick = e => {
    e.stopPropagation();
    const ms = getMarriagesOf(p.id);
    if (ms.length > 0) openMarriageModal(ms[0].id);
    else openMarriageModal(null, p.gender === 'male' ? { husbandId: p.id } : { wifeId: p.id });
  };
  
  layer.appendChild(g);
}

function calcAge(birth, death) {
  const b = new Date(birth), e = death ? new Date(death) : new Date();
  let age = e.getFullYear() - b.getFullYear();
  if (e.getMonth() < b.getMonth() || (e.getMonth() === b.getMonth() && e.getDate() < b.getDate())) age--;
  return age;
}

// ==================== CANVAS ====================
let isDrag = false, dragX = 0, dragY = 0;

function setupCanvas() {
  const svg = document.getElementById('tree-svg');
  const wrap = document.getElementById('canvas-wrap');
  
  svg.onmousedown = e => {
    if (e.target.closest('g[data-id]') || e.target.closest('.add-g')) return;
    isDrag = true; dragX = e.clientX - state.panX; dragY = e.clientY - state.panY;
  };
  svg.onmousemove = e => {
    if (!isDrag) return;
    state.panX = e.clientX - dragX; state.panY = e.clientY - dragY;
    updateTransform();
  };
  svg.onmouseup = () => isDrag = false;
  svg.onmouseleave = () => isDrag = false;
  
  wrap.onwheel = e => {
    e.preventDefault();
    state.zoom = Math.max(0.3, Math.min(2, state.zoom + (e.deltaY > 0 ? -0.1 : 0.1)));
    updateTransform();
    document.getElementById('zoom-level').textContent = Math.round(state.zoom * 100) + '%';
  };
}

function updateTransform() {
  document.getElementById('tree-g').setAttribute('transform', `translate(${state.panX}, ${state.panY}) scale(${state.zoom})`);
}

function zoomIn() { state.zoom = Math.min(2, state.zoom + 0.1); updateTransform(); document.getElementById('zoom-level').textContent = Math.round(state.zoom * 100) + '%'; }
function zoomOut() { state.zoom = Math.max(0.3, state.zoom - 0.1); updateTransform(); document.getElementById('zoom-level').textContent = Math.round(state.zoom * 100) + '%'; }
function resetView() { state.zoom = 1; state.panX = 0; state.panY = 0; updateTransform(); document.getElementById('zoom-level').textContent = '100%'; }

function locatePerson(id) {
  const p = db.persons[id];
  if (!p || p._x === undefined) return;
  const svg = document.getElementById('tree-svg');
  state.panX = svg.clientWidth / 2 - p._x - CARD_W / 2;
  state.panY = svg.clientHeight / 2 - p._y - CARD_H / 2;
  state.zoom = 1;
  updateTransform();
  document.getElementById('zoom-level').textContent = '100%';
}

// ==================== STATS ====================
function updateStats() {
  const persons = Object.values(db.persons);
  const levels = new Set(persons.map(p => p._level).filter(l => l !== undefined));
  document.getElementById('stat-persons').textContent = persons.length;
  document.getElementById('stat-males').textContent = persons.filter(p => p.gender === 'male').length;
  document.getElementById('stat-females').textContent = persons.filter(p => p.gender === 'female').length;
  document.getElementById('stat-marriages').textContent = Object.keys(db.marriages).length;
  document.getElementById('stat-gens').textContent = levels.size;
}

// ==================== SAVE/LOAD ====================
function saveData() { localStorage.setItem('familyTreeV55', JSON.stringify(db)); toast(t('ØªÙ…', 'Done')); }
function loadData() {
  const s = localStorage.getItem('familyTreeV55');
  if (s) { db = JSON.parse(s); render(); toast(t('ØªÙ…', 'Done')); }
  else toast(t('Ù„Ø§ Ø¨ÙŠØ§Ù†Ø§Øª', 'No data'));
}

function exportJSON() { dl(JSON.stringify(db, null, 2), 'family-tree.json', 'application/json'); }
function importJSON(e) {
  const f = e.target.files[0]; if (!f) return;
  const r = new FileReader();
  r.onload = ev => { try { db = JSON.parse(ev.target.result); render(); toast(t('ØªÙ…', 'Done')); } catch { toast(t('Ø®Ø·Ø£', 'Error')); } };
  r.readAsText(f); e.target.value = '';
}

function exportPNG() {
  const svg = document.getElementById('tree-svg');
  const data = new XMLSerializer().serializeToString(svg);
  const canvas = document.createElement('canvas');
  const ctx = canvas.getContext('2d');
  const img = new Image();
  canvas.width = svg.clientWidth * 2; canvas.height = svg.clientHeight * 2;
  img.onload = () => {
    ctx.fillStyle = '#0f172a'; ctx.fillRect(0, 0, canvas.width, canvas.height);
    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
    const a = document.createElement('a'); a.download = 'family-tree.png'; a.href = canvas.toDataURL('image/png'); a.click();
  };
  img.src = 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(data)));
}

function exportSVG() { dl(new XMLSerializer().serializeToString(document.getElementById('tree-svg')), 'family-tree.svg', 'image/svg+xml'); }

function dl(content, name, type) {
  const blob = new Blob([content], { type });
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = name; a.click(); URL.revokeObjectURL(a.href);
}

function clearAll() {
  if (!confirm(t('Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„ØŸ', 'Clear all?'))) return;
  db = { persons: {}, marriages: {}, children: {} };
  render(); toast(t('ØªÙ…', 'Done'));
}

// ==================== UTILS ====================
function openModal(id) { document.getElementById(id).classList.add('show'); }
function closeModal(id) { document.getElementById(id).classList.remove('show'); }
function toast(msg) { const t = document.getElementById('toast'); t.textContent = msg; t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 2000); }
function toggleDD(id) { event.stopPropagation(); document.getElementById(id).classList.toggle('open'); }

init();
</script>

<script>
  window.toolsData = [{"id":"percentage","icon":"ğŸ”¢","name":"Percentage Calculator","keywords":"percentage calculator, calculate percentage, discount calculator, percent change","searchTerms":"percent percentage % discount sale off price change increase decrease difference quarter half third ratio math calculator profit loss tax margin fraction calculate how much what is of total part whole original cost selling buying before after","category":"calculators","categoryName":"Calculators","url":"../../en/tools/percentage.html"},{"id":"interest-calculator","icon":"ğŸ’°","name":"Interest Calculator","keywords":"interest calculator, simple interest, compound interest, loan calculator","searchTerms":"interest simple compound loan investment return profit bank money calculate annual monthly daily quarterly yearly principal rate time period accumulate savings deposit growth calculator finance financial how much earn","category":"calculators","categoryName":"Calculators","url":"../../en/tools/interest-calculator.html"},{"id":"loan-calculator","icon":"ğŸ¦","name":"Loan Calculator","keywords":"loan calculator, monthly payment, amortization schedule, mortgage calculator","searchTerms":"loan loans payment payments installment installments bank mortgage mortgages monthly schedule amortization calculate calculator interest principal finance financing car home personal","category":"calculators","categoryName":"Calculators","url":"../../en/tools/loan-calculator.html"},{"id":"body-calculator","icon":"âš–ï¸","name":"Body Calculator","keywords":"BMI calculator, body mass index, ideal weight, calorie calculator, body fat","searchTerms":"bmi body mass index weight fat calories calorie bmr tdee ideal healthy obesity overweight underweight waist hip ratio calculate calculator health fitness","category":"calculators","categoryName":"Calculators","url":"../../en/tools/body-calculator.html"},{"id":"age-calculator","icon":"ğŸ‚","name":"Age Calculator","keywords":"age calculator, calculate age, how old am I, zodiac sign, birthday calculator","searchTerms":"age birthday birth date zodiac calculate how old years months days weeks hours born sign horoscope difference between dates","category":"calculators","categoryName":"Calculators","url":"../../en/tools/age-calculator.html"},{"id":"family-tree","icon":"ğŸŒ³","name":"Family Tree","keywords":"family tree, genealogy, ancestry, lineage, family relationships, family tree maker","searchTerms":"family tree genealogy ancestry lineage relatives father mother son daughter brother sister grandfather grandmother uncle aunt cousin relations","category":"everyday","categoryName":"Everyday Tools","url":"../../en/tools/family-tree.html"}];
</script>
      </main>
      
      <footer class="main-footer">
        <p>Made with â¤ï¸ | All Rights Reserved Â© 2026 Udda</p>
      </footer>
    </div>
  </div>
  
  <!-- Settings Panel -->
  <div class="settings-overlay"></div>
  <div class="settings-panel">
    <div class="settings-header">
      <h2 class="settings-title">Settings</h2>
      <button class="settings-close" aria-label="Close">âœ•</button>
    </div>
    <div class="settings-content">
      <div class="settings-section">
        <div class="settings-section-title">Language</div>
        <div class="settings-option">
          <button class="settings-btn " data-lang-btn="ar">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</button>
          <button class="settings-btn active" data-lang-btn="en">English</button>
        </div>
      </div>
      <div class="settings-section">
        <div class="settings-section-title">Theme</div>
        <div class="settings-option">
          <button class="settings-btn" data-theme-btn="light">â˜€ï¸ Light</button>
          <button class="settings-btn" data-theme-btn="dark">ğŸŒ™ Dark</button>
          <button class="settings-btn active" data-theme-btn="auto">ğŸ’» Auto</button>
        </div>
      </div>
      <div class="settings-section">
        <button class="settings-btn" data-clear-data style="width:100%;justify-content:center;color:var(--error);">
          ğŸ—‘ï¸ Clear Saved Data
        </button>
      </div>
    </div>
  </div>
  
  <div class="toast"></div>
  <script src="../../assets/js/app.js"></script>
</body>
</html>