<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Family Tree - Create Your Family Tree Free | Udda</title>
  <meta name="description" content="Free tool to create your family tree easily. Add people and relationships, upload photos, and export as image or PDF.">
  <meta name="keywords" content="family tree, genealogy, ancestry, lineage, family relationships, family tree maker">
  <meta name="author" content="Udda">
  <meta name="robots" content="index, follow">
  
  <meta property="og:type" content="website">
  <meta property="og:title" content="Family Tree - Create Your Family Tree Free | Udda">
  <meta property="og:description" content="Free tool to create your family tree easily. Add people and relationships, upload photos, and export as image or PDF.">
  <meta property="og:url" content="https://udda.tools/en/tools/family-tree.html">
  <meta property="og:site_name" content="Udda">
  <meta property="og:locale" content="en_US">
  
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Family Tree - Create Your Family Tree Free | Udda">
  <meta name="twitter:description" content="Free tool to create your family tree easily. Add people and relationships, upload photos, and export as image or PDF.">
  
  <link rel="alternate" hreflang="ar" href="https://udda.tools/ar/tools/family-tree.html">
  <link rel="alternate" hreflang="en" href="https://udda.tools/en/tools/family-tree.html">
  <link rel="alternate" hreflang="x-default" href="https://udda.tools/ar/tools/family-tree.html">
  <link rel="canonical" href="https://udda.tools/en/tools/family-tree.html">
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../../assets/css/main.css">
  
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "WebApplication",
    "name": "Family Tree",
    "description": "Free tool to create your family tree easily. Add people and relationships, upload photos, and export as image or PDF.",
    "url": "https://udda.tools/en/tools/family-tree.html",
    "applicationCategory": "UtilityApplication",
    "operatingSystem": "Any",
    "offers": { "@type": "Offer", "price": "0", "priceCurrency": "USD" },
    "inLanguage": ["ar", "en"],
    "isAccessibleForFree": true
  }
  </script>
</head>
<body data-tool-id="family-tree">
  <div class="app-container">
    <div class="sidebar-overlay"></div>
    
    <aside class="sidebar">
      <div class="sidebar-header">
        <a href="../../en/" class="logo">
          <div class="logo-icon">üîß</div>
          <span class="logo-text sidebar-text">Udda</span>
        </a>
      </div>
      
      <div class="sidebar-search">
        <div class="search-input-wrapper">
          <input type="text" class="search-input" placeholder="Search for a tool..." aria-label="Search for a tool...">
          <svg class="search-icon" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <circle cx="11" cy="11" r="8"></circle>
            <path d="m21 21-4.35-4.35"></path>
          </svg>
        </div>
      </div>
      
      <nav class="sidebar-nav">
        
        <a href="../../en/" class="nav-item ">
          <span class="nav-item-icon">üè†</span>
          <span class="sidebar-text">Home</span>
        </a>
        <div class="nav-section ">
          <div class="nav-section-title">
            <span>
              <span class="nav-section-icon">üßÆ</span>
              <span class="sidebar-text">Calculators</span>
            </span>
            <svg class="nav-section-arrow sidebar-text" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path d="m6 9 6 6 6-6"></path>
            </svg>
          </div>
          <div class="nav-section-items">
            <a href="../../en/tools/percentage.html" class="nav-item ">
              <span class="nav-item-icon">üî¢</span>
              <span class="sidebar-text">Percentage Calculator</span>
            </a>
            <a href="../../en/tools/interest-calculator.html" class="nav-item ">
              <span class="nav-item-icon">üí∞</span>
              <span class="sidebar-text">Interest Calculator</span>
            </a>
            <a href="../../en/tools/loan-calculator.html" class="nav-item ">
              <span class="nav-item-icon">üè¶</span>
              <span class="sidebar-text">Loan Calculator</span>
            </a>
            <a href="../../en/tools/body-calculator.html" class="nav-item ">
              <span class="nav-item-icon">‚öñÔ∏è</span>
              <span class="sidebar-text">Body Calculator</span>
            </a>
            <a href="../../en/tools/age-calculator.html" class="nav-item ">
              <span class="nav-item-icon">üéÇ</span>
              <span class="sidebar-text">Age Calculator</span>
            </a>
          </div>
        </div>
        <div class="nav-section ">
          <div class="nav-section-title">
            <span>
              <span class="nav-section-icon">üîÑ</span>
              <span class="sidebar-text">Converters</span>
            </span>
            <svg class="nav-section-arrow sidebar-text" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path d="m6 9 6 6 6-6"></path>
            </svg>
          </div>
          <div class="nav-section-items">
          </div>
        </div>
        <div class="nav-section ">
          <div class="nav-section-title">
            <span>
              <span class="nav-section-icon">üìù</span>
              <span class="sidebar-text">Text Tools</span>
            </span>
            <svg class="nav-section-arrow sidebar-text" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path d="m6 9 6 6 6-6"></path>
            </svg>
          </div>
          <div class="nav-section-items">
          </div>
        </div>
        <div class="nav-section ">
          <div class="nav-section-title">
            <span>
              <span class="nav-section-icon">üìÖ</span>
              <span class="sidebar-text">Date & Time</span>
            </span>
            <svg class="nav-section-arrow sidebar-text" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path d="m6 9 6 6 6-6"></path>
            </svg>
          </div>
          <div class="nav-section-items">
          </div>
        </div>
        <div class="nav-section ">
          <div class="nav-section-title">
            <span>
              <span class="nav-section-icon">‚ö°</span>
              <span class="sidebar-text">Generators</span>
            </span>
            <svg class="nav-section-arrow sidebar-text" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path d="m6 9 6 6 6-6"></path>
            </svg>
          </div>
          <div class="nav-section-items">
          </div>
        </div>
        <div class="nav-section ">
          <div class="nav-section-title">
            <span>
              <span class="nav-section-icon">üñºÔ∏è</span>
              <span class="sidebar-text">Image Tools</span>
            </span>
            <svg class="nav-section-arrow sidebar-text" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path d="m6 9 6 6 6-6"></path>
            </svg>
          </div>
          <div class="nav-section-items">
          </div>
        </div>
        <div class="nav-section ">
          <div class="nav-section-title">
            <span>
              <span class="nav-section-icon">üíª</span>
              <span class="sidebar-text">Developer Tools</span>
            </span>
            <svg class="nav-section-arrow sidebar-text" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path d="m6 9 6 6 6-6"></path>
            </svg>
          </div>
          <div class="nav-section-items">
          </div>
        </div>
        <div class="nav-section open">
          <div class="nav-section-title">
            <span>
              <span class="nav-section-icon">üè†</span>
              <span class="sidebar-text">Everyday Tools</span>
            </span>
            <svg class="nav-section-arrow sidebar-text" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path d="m6 9 6 6 6-6"></path>
            </svg>
          </div>
          <div class="nav-section-items">
            <a href="../../en/tools/family-tree.html" class="nav-item active">
              <span class="nav-item-icon">üå≥</span>
              <span class="sidebar-text">Family Tree</span>
            </a>
          </div>
        </div>
      </nav>
      
      <div class="sidebar-footer">
        <button class="sidebar-toggle" aria-label="Toggle sidebar">
          <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path d="M11 19l-7-7 7-7m8 14l-7-7 7-7"></path>
          </svg>
          <span class="sidebar-text">Sidebar</span>
        </button>
      </div>
    </aside>
    
    <div class="main-content">
      <header class="main-header">
        <button class="header-btn mobile-menu-btn" aria-label="Menu">
          <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path d="M4 6h16M4 12h16M4 18h16"></path>
          </svg>
        </button>
        
        <nav class="header-breadcrumb">
          <a href="../../en/" class="breadcrumb-link">Home</a>
          <span class="breadcrumb-separator">‚Ä∫</span>
          <a href="../../en/category/everyday.html" class="breadcrumb-link">Everyday Tools</a>
          <span class="breadcrumb-separator">‚Ä∫</span>
          <span class="breadcrumb-current">Family Tree</span>
        </nav>
        
        <div class="header-actions">
          <button class="header-btn" data-favorite-btn aria-label="Add to Favorites">‚òÜ</button>
          <button class="header-btn" onclick="App.shareUrl('Family Tree')" aria-label="Share">
            <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"></path>
              <polyline points="16 6 12 2 8 6"></polyline>
              <line x1="12" y1="2" x2="12" y2="15"></line>
            </svg>
          </button>
          <button class="header-btn" data-open-settings aria-label="Settings">
            <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <circle cx="12" cy="12" r="3"></circle>
              <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
            </svg>
          </button>
        </div>
      </header>
      
      <main class="page-content">
        <style>
:root {
  --primary: #059669;
  --primary-dark: #047857;
  --primary-light: #d1fae5;
  --male-color: #3b82f6;
  --male-light: #dbeafe;
  --female-color: #ec4899;
  --female-light: #fce7f3;
  --deceased-color: #6b7280;
  --bg-primary: #0f172a;
  --bg-secondary: #1e293b;
  --bg-card: #334155;
  --text-primary: #f8fafc;
  --text-secondary: #94a3b8;
  --text-muted: #64748b;
  --border-color: #475569;
  --shadow: 0 10px 40px rgba(0,0,0,0.3);
}

.family-tree-app {
  min-height: 80vh;
  display: flex;
  flex-direction: column;
}

/* Toolbar */
.tree-toolbar {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  padding: 16px;
  background: var(--bg-secondary);
  border-radius: 12px;
  margin-bottom: 16px;
  align-items: center;
}

.toolbar-group {
  display: flex;
  gap: 4px;
  padding: 0 12px;
  border-left: 2px solid var(--border-color);
}

.toolbar-group:first-child {
  border-left: none;
  padding-right: 12px;
}

.tool-btn {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
  padding: 10px 16px;
  background: var(--bg-card);
  border: 2px solid var(--border-color);
  border-radius: 8px;
  color: var(--text-primary);
  font-size: 0.9rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
}

.tool-btn:hover {
  border-color: var(--primary);
  background: rgba(5, 150, 105, 0.1);
}

.tool-btn.primary {
  background: var(--primary);
  border-color: var(--primary);
}

.tool-btn.primary:hover {
  background: var(--primary-dark);
}

.tool-btn .icon {
  font-size: 1.1rem;
}

/* Canvas Container */
.canvas-container {
  flex: 1;
  position: relative;
  background: var(--bg-secondary);
  border-radius: 16px;
  overflow: hidden;
  min-height: 500px;
  border: 2px solid var(--border-color);
}

.tree-canvas {
  width: 100%;
  height: 100%;
  min-height: 500px;
  cursor: grab;
}

.tree-canvas:active {
  cursor: grabbing;
}

.tree-canvas.dragging-person {
  cursor: grabbing;
}

/* Empty State */
.empty-state {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  text-align: center;
  color: var(--text-muted);
}

.empty-state .icon {
  font-size: 4rem;
  margin-bottom: 16px;
  opacity: 0.5;
}

.empty-state h3 {
  font-size: 1.5rem;
  margin-bottom: 8px;
  color: var(--text-secondary);
}

.empty-state p {
  margin-bottom: 20px;
}

.empty-state .start-btn {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  padding: 14px 28px;
  background: var(--primary);
  color: white;
  border: none;
  border-radius: 12px;
  font-size: 1.1rem;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.2s;
}

.empty-state .start-btn:hover {
  background: var(--primary-dark);
  transform: scale(1.05);
}

/* Person Card in SVG */
.person-node {
  cursor: pointer;
  transition: transform 0.2s;
}

.person-node:hover {
  filter: brightness(1.1);
}

.person-card {
  fill: var(--bg-card);
  stroke: var(--border-color);
  stroke-width: 2;
  rx: 12;
}

.person-card.male {
  stroke: var(--male-color);
}

.person-card.female {
  stroke: var(--female-color);
}

.person-card.deceased {
  stroke-dasharray: 5,3;
  opacity: 0.8;
}

.person-card.selected {
  stroke-width: 3;
  filter: drop-shadow(0 0 10px var(--primary));
}

/* Add Buttons */
.add-btn-group {
  cursor: pointer;
}

.add-btn-circle {
  fill: var(--bg-secondary);
  stroke: var(--primary);
  stroke-width: 2;
  transition: all 0.2s;
}

.add-btn-group:hover .add-btn-circle {
  fill: var(--primary);
}

.add-btn-text {
  fill: var(--primary);
  font-size: 16px;
  font-weight: bold;
  text-anchor: middle;
  dominant-baseline: central;
}

.add-btn-group:hover .add-btn-text {
  fill: white;
}

/* Connection Lines */
.connection-line {
  stroke: var(--border-color);
  stroke-width: 2;
  fill: none;
}

.connection-line.spouse {
  stroke: var(--female-color);
  stroke-dasharray: 5,5;
}

/* Modal */
.modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0,0,0,0.7);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
  opacity: 0;
  visibility: hidden;
  transition: all 0.3s;
}

.modal-overlay.show {
  opacity: 1;
  visibility: visible;
}

.modal-content {
  background: var(--bg-secondary);
  border-radius: 20px;
  width: 90%;
  max-width: 500px;
  max-height: 90vh;
  overflow-y: auto;
  transform: scale(0.9);
  transition: transform 0.3s;
}

.modal-overlay.show .modal-content {
  transform: scale(1);
}

.modal-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 20px 24px;
  border-bottom: 2px solid var(--border-color);
}

.modal-header h2 {
  font-size: 1.3rem;
  color: var(--text-primary);
  display: flex;
  align-items: center;
  gap: 10px;
}

.modal-close {
  background: none;
  border: none;
  font-size: 1.5rem;
  color: var(--text-muted);
  cursor: pointer;
  padding: 8px;
  border-radius: 8px;
  transition: all 0.2s;
}

.modal-close:hover {
  background: var(--bg-card);
  color: var(--text-primary);
}

.modal-body {
  padding: 24px;
}

.form-group {
  margin-bottom: 20px;
}

.form-group label {
  display: block;
  font-size: 0.9rem;
  font-weight: 600;
  color: var(--text-secondary);
  margin-bottom: 8px;
}

.form-group input,
.form-group select,
.form-group textarea {
  width: 100%;
  padding: 12px 16px;
  background: var(--bg-card);
  border: 2px solid var(--border-color);
  border-radius: 10px;
  color: var(--text-primary);
  font-size: 1rem;
  font-family: inherit;
  transition: border-color 0.2s;
}

.form-group input:focus,
.form-group select:focus,
.form-group textarea:focus {
  outline: none;
  border-color: var(--primary);
}

.form-group textarea {
  min-height: 80px;
  resize: vertical;
}

/* Gender Toggle */
.gender-toggle {
  display: flex;
  gap: 12px;
}

.gender-option {
  flex: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  padding: 14px;
  background: var(--bg-card);
  border: 2px solid var(--border-color);
  border-radius: 10px;
  cursor: pointer;
  transition: all 0.2s;
}

.gender-option input {
  display: none;
}

.gender-option.male:has(input:checked) {
  border-color: var(--male-color);
  background: var(--male-light);
  color: var(--male-color);
}

.gender-option.female:has(input:checked) {
  border-color: var(--female-color);
  background: var(--female-light);
  color: var(--female-color);
}

.gender-option .icon {
  font-size: 1.3rem;
}

.gender-option span {
  font-weight: 600;
}

/* Photo Upload */
.photo-upload {
  display: flex;
  align-items: center;
  gap: 16px;
}

.photo-preview {
  width: 80px;
  height: 80px;
  border-radius: 50%;
  background: var(--bg-card);
  border: 3px solid var(--border-color);
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
}

.photo-preview img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.photo-preview .placeholder {
  font-size: 2rem;
  color: var(--text-muted);
}

.photo-buttons {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.photo-btn {
  padding: 8px 16px;
  background: var(--bg-card);
  border: 2px solid var(--border-color);
  border-radius: 8px;
  color: var(--text-primary);
  font-size: 0.85rem;
  cursor: pointer;
  transition: all 0.2s;
}

.photo-btn:hover {
  border-color: var(--primary);
}

.photo-btn.remove {
  border-color: #ef4444;
  color: #ef4444;
}

/* Relation Select */
.relation-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 10px;
}

.relation-option {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 6px;
  padding: 12px 8px;
  background: var(--bg-card);
  border: 2px solid var(--border-color);
  border-radius: 10px;
  cursor: pointer;
  transition: all 0.2s;
}

.relation-option:hover {
  border-color: var(--primary);
}

.relation-option.selected {
  border-color: var(--primary);
  background: rgba(5, 150, 105, 0.2);
}

.relation-option .icon {
  font-size: 1.5rem;
}

.relation-option span {
  font-size: 0.8rem;
  font-weight: 600;
  text-align: center;
}

/* Modal Footer */
.modal-footer {
  display: flex;
  gap: 12px;
  padding: 20px 24px;
  border-top: 2px solid var(--border-color);
}

.modal-footer button {
  flex: 1;
  padding: 14px;
  border-radius: 10px;
  font-size: 1rem;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.2s;
}

.btn-cancel {
  background: var(--bg-card);
  border: 2px solid var(--border-color);
  color: var(--text-primary);
}

.btn-cancel:hover {
  border-color: var(--text-muted);
}

.btn-save {
  background: var(--primary);
  border: none;
  color: white;
}

.btn-save:hover {
  background: var(--primary-dark);
}

.btn-delete {
  background: #ef4444;
  border: none;
  color: white;
  flex: 0.5;
}

.btn-delete:hover {
  background: #dc2626;
}

/* Zoom Controls */
.zoom-controls {
  position: absolute;
  bottom: 20px;
  left: 20px;
  display: flex;
  flex-direction: column;
  gap: 8px;
  background: var(--bg-card);
  padding: 8px;
  border-radius: 12px;
  border: 2px solid var(--border-color);
}

.zoom-btn {
  width: 40px;
  height: 40px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: var(--bg-secondary);
  border: none;
  border-radius: 8px;
  color: var(--text-primary);
  font-size: 1.2rem;
  cursor: pointer;
  transition: all 0.2s;
}

.zoom-btn:hover {
  background: var(--primary);
}

.zoom-level {
  text-align: center;
  font-size: 0.8rem;
  color: var(--text-muted);
  padding: 4px 0;
}

/* Stats Bar */
.stats-bar {
  display: flex;
  gap: 20px;
  padding: 12px 20px;
  background: var(--bg-card);
  border-radius: 10px;
  margin-top: 16px;
}

.stat-item {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 0.9rem;
}

.stat-item .icon {
  font-size: 1.1rem;
}

.stat-item .label {
  color: var(--text-muted);
}

.stat-item .value {
  font-weight: 700;
  color: var(--text-primary);
}

/* Toast Notification */
.toast {
  position: fixed;
  bottom: 30px;
  left: 50%;
  transform: translateX(-50%) translateY(100px);
  background: var(--bg-card);
  border: 2px solid var(--primary);
  padding: 16px 24px;
  border-radius: 12px;
  color: var(--text-primary);
  font-weight: 600;
  z-index: 2000;
  opacity: 0;
  transition: all 0.3s;
}

.toast.show {
  transform: translateX(-50%) translateY(0);
  opacity: 1;
}

/* Dropdown Menu */
.dropdown {
  position: relative;
}

.dropdown-menu {
  position: absolute;
  top: 100%;
  right: 0;
  margin-top: 8px;
  background: var(--bg-card);
  border: 2px solid var(--border-color);
  border-radius: 12px;
  min-width: 180px;
  z-index: 100;
  opacity: 0;
  visibility: hidden;
  transform: translateY(-10px);
  transition: all 0.2s;
}

.dropdown.open .dropdown-menu {
  opacity: 1;
  visibility: visible;
  transform: translateY(0);
}

.dropdown-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 12px 16px;
  color: var(--text-primary);
  font-size: 0.9rem;
  cursor: pointer;
  transition: background 0.2s;
}

.dropdown-item:first-child {
  border-radius: 10px 10px 0 0;
}

.dropdown-item:last-child {
  border-radius: 0 0 10px 10px;
}

.dropdown-item:hover {
  background: var(--bg-secondary);
}

.dropdown-divider {
  height: 1px;
  background: var(--border-color);
  margin: 4px 0;
}

/* Hidden file input */
.hidden-input {
  display: none;
}

/* Responsive */
@media (max-width: 768px) {
  .tree-toolbar {
    justify-content: center;
  }
  
  .toolbar-group {
    border-left: none;
    padding: 8px 0;
    width: 100%;
    justify-content: center;
  }
  
  .tool-btn span:not(.icon) {
    display: none;
  }
  
  .relation-grid {
    grid-template-columns: repeat(2, 1fr);
  }
  
  .stats-bar {
    flex-wrap: wrap;
    justify-content: center;
  }
}
</style>

<div class="tool-card">
  <div class="tool-header">
    <div class="tool-icon">üå≥</div>
    <div>
      <h1 class="tool-title">Family Tree</h1>
      <p class="tool-description">Create your family tree easily and export it</p>
    </div>
  </div>

  <div class="family-tree-app">
    <!-- Toolbar -->
    <div class="tree-toolbar">
      <div class="toolbar-group">
        <button class="tool-btn primary" onclick="addFirstPerson()" id="add-first-btn">
          <span class="icon">‚ûï</span>
          <span>Add Person</span>
        </button>
      </div>
      
      <div class="toolbar-group">
        <button class="tool-btn" onclick="saveToLocal()">
          <span class="icon">üíæ</span>
          <span>Save Locally</span>
        </button>
        <button class="tool-btn" onclick="loadFromLocal()">
          <span class="icon">üìÇ</span>
          <span>Load Saved</span>
        </button>
      </div>
      
      <div class="toolbar-group">
        <div class="dropdown" id="export-dropdown">
          <button class="tool-btn" onclick="toggleDropdown('export-dropdown')">
            <span class="icon">üì§</span>
            <span>Export</span>
          </button>
          <div class="dropdown-menu">
            <div class="dropdown-item" onclick="exportAsPNG()">
              <span>üñºÔ∏è</span> Export as PNG
            </div>
            <div class="dropdown-item" onclick="exportAsSVG()">
              <span>üìê</span> Export as SVG
            </div>
            <div class="dropdown-divider"></div>
            <div class="dropdown-item" onclick="exportAsJSON()">
              <span>üìÑ</span> Export Data
            </div>
          </div>
        </div>
        <button class="tool-btn" onclick="importJSON()">
          <span class="icon">üì•</span>
          <span>Import</span>
        </button>
      </div>
      
      <div class="toolbar-group">
        <button class="tool-btn" onclick="clearAll()">
          <span class="icon">üóëÔ∏è</span>
          <span>Clear All</span>
        </button>
      </div>
    </div>

    <!-- Canvas -->
    <div class="canvas-container" id="canvas-container">
      <svg class="tree-canvas" id="tree-canvas">
        <defs>
          <filter id="shadow" x="-20%" y="-20%" width="140%" height="140%">
            <feDropShadow dx="0" dy="4" stdDeviation="8" flood-opacity="0.3"/>
          </filter>
          <clipPath id="photo-clip">
            <circle cx="30" cy="30" r="28"/>
          </clipPath>
        </defs>
        <g id="connections-layer"></g>
        <g id="persons-layer"></g>
      </svg>
      
      <!-- Empty State -->
      <div class="empty-state" id="empty-state">
        <div class="icon">üå≥</div>
        <h3>Start by adding the first person</h3>
        <p>Click + to add relative</p>
        <button class="start-btn" onclick="addFirstPerson()">
          <span>‚ûï</span> Add Person
        </button>
      </div>
      
      <!-- Zoom Controls -->
      <div class="zoom-controls">
        <button class="zoom-btn" onclick="zoomIn()">‚ûï</button>
        <div class="zoom-level" id="zoom-level">100%</div>
        <button class="zoom-btn" onclick="zoomOut()">‚ûñ</button>
        <button class="zoom-btn" onclick="fitToScreen()">‚ä°</button>
      </div>
    </div>

    <!-- Stats Bar -->
    <div class="stats-bar" id="stats-bar" style="display: none;">
      <div class="stat-item">
        <span class="icon">üë•</span>
        <span class="label">Total Persons:</span>
        <span class="value" id="stat-total">0</span>
      </div>
      <div class="stat-item">
        <span class="icon">üë®</span>
        <span class="label">Males:</span>
        <span class="value" id="stat-males">0</span>
      </div>
      <div class="stat-item">
        <span class="icon">üë©</span>
        <span class="label">Females:</span>
        <span class="value" id="stat-females">0</span>
      </div>
      <div class="stat-item">
        <span class="icon">üìä</span>
        <span class="label">Generations:</span>
        <span class="value" id="stat-generations">0</span>
      </div>
    </div>
  </div>
</div>

<!-- Add/Edit Person Modal -->
<div class="modal-overlay" id="person-modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2><span id="modal-icon">üë§</span> <span id="modal-title">Add Person</span></h2>
      <button class="modal-close" onclick="closeModal()">&times;</button>
    </div>
    <div class="modal-body">
      <!-- Relation Selection (shown when adding) -->
      <div class="form-group" id="relation-group" style="display: none;">
        <label>Relation</label>
        <div class="relation-grid" id="relation-grid"></div>
      </div>
      
      <!-- Name -->
      <div class="form-group">
        <label>Name *</label>
        <input type="text" id="person-name" placeholder="Name" required>
      </div>
      
      <!-- Gender -->
      <div class="form-group">
        <label>Gender</label>
        <div class="gender-toggle">
          <label class="gender-option male">
            <input type="radio" name="gender" value="male" checked>
            <span class="icon">üë®</span>
            <span>Male</span>
          </label>
          <label class="gender-option female">
            <input type="radio" name="gender" value="female">
            <span class="icon">üë©</span>
            <span>Female</span>
          </label>
        </div>
      </div>
      
      <!-- Photo -->
      <div class="form-group">
        <label>Photo</label>
        <div class="photo-upload">
          <div class="photo-preview" id="photo-preview">
            <span class="placeholder">üë§</span>
          </div>
          <div class="photo-buttons">
            <button class="photo-btn" onclick="document.getElementById('photo-input').click()">
              üì∑ Upload Photo
            </button>
            <button class="photo-btn remove" onclick="removePhoto()" id="remove-photo-btn" style="display: none;">
              üóëÔ∏è Remove Photo
            </button>
          </div>
        </div>
        <input type="file" id="photo-input" class="hidden-input" accept="image/*" onchange="handlePhotoUpload(event)">
      </div>
      
      <!-- Birth Date -->
      <div class="form-group">
        <label>Birth Date</label>
        <input type="date" id="person-birth">
      </div>
      
      <!-- Death Date -->
      <div class="form-group">
        <label>Death Date</label>
        <input type="date" id="person-death">
      </div>
      
      <!-- Notes -->
      <div class="form-group">
        <label>Notes</label>
        <textarea id="person-notes" placeholder="Notes"></textarea>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-delete" id="delete-btn" onclick="deletePerson()" style="display: none;">
        üóëÔ∏è Delete
      </button>
      <button class="btn-cancel" onclick="closeModal()">Cancel</button>
      <button class="btn-save" onclick="savePerson()">Save</button>
    </div>
  </div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<!-- Hidden inputs -->
<input type="file" id="import-input" class="hidden-input" accept=".json" onchange="handleImport(event)">

<script>
const isArabic = document.documentElement.lang === 'ar';

// ==================== DATA STRUCTURE ====================
let familyData = {
  title: isArabic ? 'ÿ¥ÿ¨ÿ±ÿ© ÿπÿßÿ¶ŸÑÿ©' : 'Family Tree',
  persons: {},
  rootId: null
};

let currentPersonId = null;
let editMode = false;
let addingRelativeTo = null;
let selectedRelation = null;
let currentPhoto = null;

// Canvas state
let zoom = 1;
let panX = 0;
let panY = 0;
let isDragging = false;
let dragStartX = 0;
let dragStartY = 0;

// Card dimensions
const CARD_WIDTH = 160;
const CARD_HEIGHT = 100;
const CARD_GAP_H = 60;
const CARD_GAP_V = 80;

// Relations config
const relations = [
  { id: 'father', icon: 'üë®', label: isArabic ? 'ÿ£ÿ®' : 'Father', gender: 'male', position: 'parent' },
  { id: 'mother', icon: 'üë©', label: isArabic ? 'ÿ£ŸÖ' : 'Mother', gender: 'female', position: 'parent' },
  { id: 'spouse', icon: 'üíë', label: isArabic ? 'ÿ≤Ÿàÿ¨/ÿ©' : 'Spouse', gender: null, position: 'spouse' },
  { id: 'son', icon: 'üë¶', label: isArabic ? 'ÿßÿ®ŸÜ' : 'Son', gender: 'male', position: 'child' },
  { id: 'daughter', icon: 'üëß', label: isArabic ? 'ÿßÿ®ŸÜÿ©' : 'Daughter', gender: 'female', position: 'child' },
  { id: 'brother', icon: 'üë®‚Äçü¶±', label: isArabic ? 'ÿ£ÿÆ' : 'Brother', gender: 'male', position: 'sibling' },
  { id: 'sister', icon: 'üë©‚Äçü¶±', label: isArabic ? 'ÿ£ÿÆÿ™' : 'Sister', gender: 'female', position: 'sibling' }
];

// ==================== INITIALIZATION ====================
function init() {
  setupCanvas();
  buildRelationGrid();
  updateUI();
}

function setupCanvas() {
  const canvas = document.getElementById('tree-canvas');
  const container = document.getElementById('canvas-container');
  
  // Pan with mouse drag
  canvas.addEventListener('mousedown', startPan);
  canvas.addEventListener('mousemove', doPan);
  canvas.addEventListener('mouseup', endPan);
  canvas.addEventListener('mouseleave', endPan);
  
  // Zoom with wheel
  container.addEventListener('wheel', handleZoom);
  
  // Touch support
  canvas.addEventListener('touchstart', handleTouchStart);
  canvas.addEventListener('touchmove', handleTouchMove);
  canvas.addEventListener('touchend', handleTouchEnd);
}

function buildRelationGrid() {
  const grid = document.getElementById('relation-grid');
  grid.innerHTML = relations.map(r => `
    <div class="relation-option" data-relation="${r.id}" onclick="selectRelation('${r.id}')">
      <span class="icon">${r.icon}</span>
      <span>${r.label}</span>
    </div>
  `).join('');
}

// ==================== PERSON MANAGEMENT ====================
function generateId() {
  return 'person-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
}

function addFirstPerson() {
  editMode = false;
  addingRelativeTo = null;
  selectedRelation = null;
  currentPhoto = null;
  
  document.getElementById('relation-group').style.display = 'none';
  document.getElementById('delete-btn').style.display = 'none';
  document.getElementById('modal-title').textContent = isArabic ? 'ÿ•ÿ∂ÿßŸÅÿ© ÿ¥ÿÆÿµ' : 'Add Person';
  document.getElementById('modal-icon').textContent = 'üë§';
  
  resetForm();
  openModal();
}

function addRelativeTo(personId) {
  editMode = false;
  addingRelativeTo = personId;
  selectedRelation = null;
  currentPhoto = null;
  
  document.getElementById('relation-group').style.display = 'block';
  document.getElementById('delete-btn').style.display = 'none';
  document.getElementById('modal-title').textContent = isArabic ? 'ÿ•ÿ∂ÿßŸÅÿ© ŸÇÿ±Ÿäÿ®' : 'Add Relative';
  document.getElementById('modal-icon').textContent = '‚ûï';
  
  // Reset relation selection
  document.querySelectorAll('.relation-option').forEach(el => el.classList.remove('selected'));
  
  resetForm();
  openModal();
}

function editPerson(personId) {
  editMode = true;
  currentPersonId = personId;
  addingRelativeTo = null;
  
  const person = familyData.persons[personId];
  if (!person) return;
  
  document.getElementById('relation-group').style.display = 'none';
  document.getElementById('delete-btn').style.display = 'block';
  document.getElementById('modal-title').textContent = isArabic ? 'ÿ™ÿπÿØŸäŸÑ' : 'Edit';
  document.getElementById('modal-icon').textContent = '‚úèÔ∏è';
  
  // Fill form
  document.getElementById('person-name').value = person.name || '';
  document.querySelector(`input[name="gender"][value="${person.gender}"]`).checked = true;
  document.getElementById('person-birth').value = person.birthDate || '';
  document.getElementById('person-death').value = person.deathDate || '';
  document.getElementById('person-notes').value = person.notes || '';
  
  // Photo
  currentPhoto = person.photo || null;
  updatePhotoPreview();
  
  openModal();
}

function savePerson() {
  const name = document.getElementById('person-name').value.trim();
  if (!name) {
    showToast(isArabic ? 'ÿßŸÑÿ±ÿ¨ÿßÿ° ÿ•ÿØÿÆÿßŸÑ ÿßŸÑÿßÿ≥ŸÖ' : 'Please enter a name');
    return;
  }
  
  const gender = document.querySelector('input[name="gender"]:checked').value;
  const birthDate = document.getElementById('person-birth').value;
  const deathDate = document.getElementById('person-death').value;
  const notes = document.getElementById('person-notes').value.trim();
  
  if (editMode && currentPersonId) {
    // Update existing
    familyData.persons[currentPersonId] = {
      ...familyData.persons[currentPersonId],
      name,
      gender,
      birthDate,
      deathDate,
      notes,
      photo: currentPhoto
    };
  } else {
    // Create new
    const newId = generateId();
    const newPerson = {
      id: newId,
      name,
      gender,
      birthDate,
      deathDate,
      notes,
      photo: currentPhoto,
      x: 0,
      y: 0,
      relations: {
        father: null,
        mother: null,
        spouse: [],
        children: [],
        siblings: []
      }
    };
    
    if (addingRelativeTo && selectedRelation) {
      // Link to existing person
      const relative = familyData.persons[addingRelativeTo];
      const rel = relations.find(r => r.id === selectedRelation);
      
      if (rel.position === 'parent') {
        if (selectedRelation === 'father') {
          newPerson.relations.children.push(addingRelativeTo);
          relative.relations.father = newId;
        } else {
          newPerson.relations.children.push(addingRelativeTo);
          relative.relations.mother = newId;
        }
      } else if (rel.position === 'child') {
        newPerson.relations.father = relative.gender === 'male' ? addingRelativeTo : null;
        newPerson.relations.mother = relative.gender === 'female' ? addingRelativeTo : null;
        relative.relations.children.push(newId);
      } else if (rel.position === 'spouse') {
        newPerson.relations.spouse.push(addingRelativeTo);
        relative.relations.spouse.push(newId);
      } else if (rel.position === 'sibling') {
        newPerson.relations.siblings.push(addingRelativeTo);
        relative.relations.siblings.push(newId);
        // Share parents
        if (relative.relations.father) newPerson.relations.father = relative.relations.father;
        if (relative.relations.mother) newPerson.relations.mother = relative.relations.mother;
      }
    } else {
      familyData.rootId = newId;
    }
    
    familyData.persons[newId] = newPerson;
  }
  
  closeModal();
  layoutTree();
  renderTree();
  updateUI();
  showToast(isArabic ? 'ÿ™ŸÖ ÿßŸÑÿ≠ŸÅÿ∏' : 'Saved');
}

function deletePerson() {
  if (!currentPersonId) return;
  
  const confirmMsg = isArabic ? 'ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ≠ÿ∞ŸÅ Ÿáÿ∞ÿß ÿßŸÑÿ¥ÿÆÿµÿü' : 'Are you sure you want to delete this person?';
  if (!confirm(confirmMsg)) return;
  
  const person = familyData.persons[currentPersonId];
  
  // Remove relations
  Object.values(familyData.persons).forEach(p => {
    if (p.relations.father === currentPersonId) p.relations.father = null;
    if (p.relations.mother === currentPersonId) p.relations.mother = null;
    p.relations.spouse = p.relations.spouse.filter(id => id !== currentPersonId);
    p.relations.children = p.relations.children.filter(id => id !== currentPersonId);
    p.relations.siblings = p.relations.siblings.filter(id => id !== currentPersonId);
  });
  
  delete familyData.persons[currentPersonId];
  
  if (familyData.rootId === currentPersonId) {
    const remaining = Object.keys(familyData.persons);
    familyData.rootId = remaining.length > 0 ? remaining[0] : null;
  }
  
  closeModal();
  layoutTree();
  renderTree();
  updateUI();
  showToast(isArabic ? 'ÿ™ŸÖ ÿßŸÑÿ≠ÿ∞ŸÅ' : 'Deleted');
}

function selectRelation(relationId) {
  selectedRelation = relationId;
  document.querySelectorAll('.relation-option').forEach(el => {
    el.classList.toggle('selected', el.dataset.relation === relationId);
  });
  
  // Auto-select gender based on relation
  const rel = relations.find(r => r.id === relationId);
  if (rel && rel.gender) {
    document.querySelector(`input[name="gender"][value="${rel.gender}"]`).checked = true;
  }
}

// ==================== PHOTO HANDLING ====================
function handlePhotoUpload(event) {
  const file = event.target.files[0];
  if (!file) return;
  
  const reader = new FileReader();
  reader.onload = function(e) {
    currentPhoto = e.target.result;
    updatePhotoPreview();
  };
  reader.readAsDataURL(file);
}

function removePhoto() {
  currentPhoto = null;
  updatePhotoPreview();
  document.getElementById('photo-input').value = '';
}

function updatePhotoPreview() {
  const preview = document.getElementById('photo-preview');
  const removeBtn = document.getElementById('remove-photo-btn');
  
  if (currentPhoto) {
    preview.innerHTML = `<img src="${currentPhoto}" alt="Photo">`;
    removeBtn.style.display = 'block';
  } else {
    preview.innerHTML = '<span class="placeholder">üë§</span>';
    removeBtn.style.display = 'none';
  }
}

// ==================== LAYOUT ====================
function layoutTree() {
  if (!familyData.rootId || Object.keys(familyData.persons).length === 0) return;
  
  const canvas = document.getElementById('tree-canvas');
  const containerWidth = canvas.clientWidth || 800;
  const containerHeight = canvas.clientHeight || 500;
  
  // Simple layout - center root and position others around it
  const persons = Object.values(familyData.persons);
  const levels = {};
  
  // BFS to assign levels
  const visited = new Set();
  const queue = [{ id: familyData.rootId, level: 0 }];
  
  while (queue.length > 0) {
    const { id, level } = queue.shift();
    if (visited.has(id)) continue;
    visited.add(id);
    
    const person = familyData.persons[id];
    if (!person) continue;
    
    if (!levels[level]) levels[level] = [];
    levels[level].push(id);
    
    // Parents go up
    if (person.relations.father && !visited.has(person.relations.father)) {
      queue.push({ id: person.relations.father, level: level - 1 });
    }
    if (person.relations.mother && !visited.has(person.relations.mother)) {
      queue.push({ id: person.relations.mother, level: level - 1 });
    }
    
    // Children go down
    person.relations.children.forEach(childId => {
      if (!visited.has(childId)) {
        queue.push({ id: childId, level: level + 1 });
      }
    });
    
    // Spouse same level
    person.relations.spouse.forEach(spouseId => {
      if (!visited.has(spouseId)) {
        queue.push({ id: spouseId, level: level });
      }
    });
    
    // Siblings same level
    person.relations.siblings.forEach(sibId => {
      if (!visited.has(sibId)) {
        queue.push({ id: sibId, level: level });
      }
    });
  }
  
  // Position by level
  const levelNumbers = Object.keys(levels).map(Number).sort((a, b) => a - b);
  const minLevel = Math.min(...levelNumbers);
  const maxLevel = Math.max(...levelNumbers);
  const totalLevels = maxLevel - minLevel + 1;
  
  const startY = 100;
  
  levelNumbers.forEach(level => {
    const personsInLevel = levels[level];
    const levelY = startY + (level - minLevel) * (CARD_HEIGHT + CARD_GAP_V);
    const totalWidth = personsInLevel.length * CARD_WIDTH + (personsInLevel.length - 1) * CARD_GAP_H;
    const startX = (containerWidth - totalWidth) / 2;
    
    personsInLevel.forEach((personId, index) => {
      const person = familyData.persons[personId];
      person.x = startX + index * (CARD_WIDTH + CARD_GAP_H);
      person.y = levelY;
    });
  });
}

// ==================== RENDERING ====================
function renderTree() {
  const connectionsLayer = document.getElementById('connections-layer');
  const personsLayer = document.getElementById('persons-layer');
  
  connectionsLayer.innerHTML = '';
  personsLayer.innerHTML = '';
  
  const persons = Object.values(familyData.persons);
  if (persons.length === 0) return;
  
  // Draw connections first
  persons.forEach(person => {
    // Connect to father
    if (person.relations.father) {
      const father = familyData.persons[person.relations.father];
      if (father) drawConnection(father, person);
    }
    // Connect to mother
    if (person.relations.mother) {
      const mother = familyData.persons[person.relations.mother];
      if (mother) drawConnection(mother, person);
    }
    // Connect to spouse
    person.relations.spouse.forEach(spouseId => {
      const spouse = familyData.persons[spouseId];
      if (spouse && person.id < spouseId) { // Avoid duplicate lines
        drawConnection(person, spouse, true);
      }
    });
  });
  
  // Draw person cards
  persons.forEach(person => {
    drawPersonCard(person);
  });
  
  // Apply transform
  updateTransform();
}

function drawConnection(from, to, isSpouse = false) {
  const layer = document.getElementById('connections-layer');
  
  const x1 = from.x + CARD_WIDTH / 2;
  const y1 = from.y + CARD_HEIGHT / 2;
  const x2 = to.x + CARD_WIDTH / 2;
  const y2 = to.y + CARD_HEIGHT / 2;
  
  let path;
  if (isSpouse) {
    // Horizontal line for spouse
    path = `M ${x1} ${y1} L ${x2} ${y2}`;
  } else {
    // Curved line for parent-child
    const midY = (y1 + y2) / 2;
    path = `M ${x1} ${y1 + CARD_HEIGHT/2} L ${x1} ${midY} L ${x2} ${midY} L ${x2} ${y2 - CARD_HEIGHT/2}`;
  }
  
  const line = document.createElementNS('http://www.w3.org/2000/svg', 'path');
  line.setAttribute('d', path);
  line.setAttribute('class', `connection-line ${isSpouse ? 'spouse' : ''}`);
  layer.appendChild(line);
}

function drawPersonCard(person) {
  const layer = document.getElementById('persons-layer');
  const isDeceased = !!person.deathDate;
  
  const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
  g.setAttribute('class', 'person-node');
  g.setAttribute('transform', `translate(${person.x}, ${person.y})`);
  g.setAttribute('data-id', person.id);
  
  // Card background
  const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
  rect.setAttribute('width', CARD_WIDTH);
  rect.setAttribute('height', CARD_HEIGHT);
  rect.setAttribute('class', `person-card ${person.gender} ${isDeceased ? 'deceased' : ''}`);
  rect.setAttribute('filter', 'url(#shadow)');
  g.appendChild(rect);
  
  // Photo or icon
  if (person.photo) {
    const img = document.createElementNS('http://www.w3.org/2000/svg', 'image');
    img.setAttribute('x', CARD_WIDTH/2 - 25);
    img.setAttribute('y', 10);
    img.setAttribute('width', 50);
    img.setAttribute('height', 50);
    img.setAttribute('href', person.photo);
    img.setAttribute('clip-path', 'circle(25px at 25px 25px)');
    img.style.borderRadius = '50%';
    g.appendChild(img);
  } else {
    const icon = document.createElementNS('http://www.w3.org/2000/svg', 'text');
    icon.setAttribute('x', CARD_WIDTH/2);
    icon.setAttribute('y', 42);
    icon.setAttribute('text-anchor', 'middle');
    icon.setAttribute('font-size', '30');
    icon.textContent = person.gender === 'female' ? 'üë©' : 'üë®';
    if (isDeceased) icon.style.opacity = '0.6';
    g.appendChild(icon);
  }
  
  // Name
  const name = document.createElementNS('http://www.w3.org/2000/svg', 'text');
  name.setAttribute('x', CARD_WIDTH/2);
  name.setAttribute('y', 75);
  name.setAttribute('text-anchor', 'middle');
  name.setAttribute('fill', '#f8fafc');
  name.setAttribute('font-size', '14');
  name.setAttribute('font-weight', '600');
  name.textContent = person.name.length > 15 ? person.name.substring(0, 15) + '...' : person.name;
  g.appendChild(name);
  
  // Age/dates
  if (person.birthDate) {
    const age = calculateAge(person.birthDate, person.deathDate);
    const ageText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
    ageText.setAttribute('x', CARD_WIDTH/2);
    ageText.setAttribute('y', 92);
    ageText.setAttribute('text-anchor', 'middle');
    ageText.setAttribute('fill', '#94a3b8');
    ageText.setAttribute('font-size', '11');
    ageText.textContent = age + (isArabic ? ' ÿ≥ŸÜÿ©' : ' yrs');
    if (isDeceased) ageText.textContent += ' ‚úù';
    g.appendChild(ageText);
  }
  
  // Click to edit
  g.addEventListener('click', () => editPerson(person.id));
  
  // Add buttons
  drawAddButtons(g, person);
  
  layer.appendChild(g);
}

function drawAddButtons(group, person) {
  const positions = [
    { x: CARD_WIDTH/2, y: -25, rel: 'parent' },    // Top - parents
    { x: CARD_WIDTH + 15, y: CARD_HEIGHT/2 - 12, rel: 'spouse' },  // Right - spouse
    { x: CARD_WIDTH/2, y: CARD_HEIGHT + 15, rel: 'child' },   // Bottom - children
  ];
  
  positions.forEach(pos => {
    const btn = document.createElementNS('http://www.w3.org/2000/svg', 'g');
    btn.setAttribute('class', 'add-btn-group');
    btn.setAttribute('transform', `translate(${pos.x - 12}, ${pos.y})`);
    
    const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
    circle.setAttribute('cx', 12);
    circle.setAttribute('cy', 12);
    circle.setAttribute('r', 12);
    circle.setAttribute('class', 'add-btn-circle');
    btn.appendChild(circle);
    
    const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
    text.setAttribute('x', 12);
    text.setAttribute('y', 12);
    text.setAttribute('class', 'add-btn-text');
    text.textContent = '+';
    btn.appendChild(text);
    
    btn.addEventListener('click', (e) => {
      e.stopPropagation();
      addRelativeTo(person.id);
    });
    
    group.appendChild(btn);
  });
}

function calculateAge(birthDate, deathDate) {
  const birth = new Date(birthDate);
  const end = deathDate ? new Date(deathDate) : new Date();
  let age = end.getFullYear() - birth.getFullYear();
  const m = end.getMonth() - birth.getMonth();
  if (m < 0 || (m === 0 && end.getDate() < birth.getDate())) {
    age--;
  }
  return age;
}

// ==================== PAN & ZOOM ====================
function startPan(e) {
  if (e.target.closest('.person-node') || e.target.closest('.add-btn-group')) return;
  isDragging = true;
  dragStartX = e.clientX - panX;
  dragStartY = e.clientY - panY;
  document.getElementById('tree-canvas').classList.add('dragging-person');
}

function doPan(e) {
  if (!isDragging) return;
  panX = e.clientX - dragStartX;
  panY = e.clientY - dragStartY;
  updateTransform();
}

function endPan() {
  isDragging = false;
  document.getElementById('tree-canvas').classList.remove('dragging-person');
}

function handleZoom(e) {
  e.preventDefault();
  const delta = e.deltaY > 0 ? -0.1 : 0.1;
  zoom = Math.max(0.3, Math.min(2, zoom + delta));
  updateTransform();
  document.getElementById('zoom-level').textContent = Math.round(zoom * 100) + '%';
}

function zoomIn() {
  zoom = Math.min(2, zoom + 0.1);
  updateTransform();
  document.getElementById('zoom-level').textContent = Math.round(zoom * 100) + '%';
}

function zoomOut() {
  zoom = Math.max(0.3, zoom - 0.1);
  updateTransform();
  document.getElementById('zoom-level').textContent = Math.round(zoom * 100) + '%';
}

function fitToScreen() {
  zoom = 1;
  panX = 0;
  panY = 0;
  updateTransform();
  document.getElementById('zoom-level').textContent = '100%';
}

function updateTransform() {
  const connections = document.getElementById('connections-layer');
  const persons = document.getElementById('persons-layer');
  const transform = `translate(${panX}, ${panY}) scale(${zoom})`;
  connections.setAttribute('transform', transform);
  persons.setAttribute('transform', transform);
}

// Touch support
let touchStartX, touchStartY;
function handleTouchStart(e) {
  if (e.touches.length === 1) {
    touchStartX = e.touches[0].clientX - panX;
    touchStartY = e.touches[0].clientY - panY;
  }
}

function handleTouchMove(e) {
  if (e.touches.length === 1) {
    panX = e.touches[0].clientX - touchStartX;
    panY = e.touches[0].clientY - touchStartY;
    updateTransform();
  }
}

function handleTouchEnd() {}

// ==================== SAVE/LOAD ====================
function saveToLocal() {
  localStorage.setItem('familyTree', JSON.stringify(familyData));
  showToast(isArabic ? 'ÿ™ŸÖ ÿßŸÑÿ≠ŸÅÿ∏ ÿ®ŸÜÿ¨ÿßÿ≠' : 'Saved successfully');
}

function loadFromLocal() {
  const saved = localStorage.getItem('familyTree');
  if (saved) {
    try {
      familyData = JSON.parse(saved);
      layoutTree();
      renderTree();
      updateUI();
      showToast(isArabic ? 'ÿ™ŸÖ ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ ÿ®ŸÜÿ¨ÿßÿ≠' : 'Loaded successfully');
    } catch (e) {
      showToast(isArabic ? 'ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ' : 'Load error');
    }
  } else {
    showToast(isArabic ? 'ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ®ŸäÿßŸÜÿßÿ™ ŸÖÿ≠ŸÅŸàÿ∏ÿ©' : 'No saved data');
  }
}

function exportAsJSON() {
  const data = JSON.stringify(familyData, null, 2);
  downloadFile(data, 'family-tree.json', 'application/json');
}

function importJSON() {
  document.getElementById('import-input').click();
}

function handleImport(event) {
  const file = event.target.files[0];
  if (!file) return;
  
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      familyData = JSON.parse(e.target.result);
      layoutTree();
      renderTree();
      updateUI();
      showToast(isArabic ? 'ÿ™ŸÖ ÿßŸÑÿßÿ≥ÿ™Ÿäÿ±ÿßÿØ ÿ®ŸÜÿ¨ÿßÿ≠' : 'Imported successfully');
    } catch (err) {
      showToast(isArabic ? 'ŸÖŸÑŸÅ ÿ∫Ÿäÿ± ÿµÿßŸÑÿ≠' : 'Invalid file');
    }
  };
  reader.readAsText(file);
}

function exportAsPNG() {
  const svg = document.getElementById('tree-canvas');
  const svgData = new XMLSerializer().serializeToString(svg);
  const canvas = document.createElement('canvas');
  const ctx = canvas.getContext('2d');
  const img = new Image();
  
  canvas.width = svg.clientWidth * 2;
  canvas.height = svg.clientHeight * 2;
  
  img.onload = function() {
    ctx.fillStyle = '#0f172a';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
    
    const link = document.createElement('a');
    link.download = 'family-tree.png';
    link.href = canvas.toDataURL('image/png');
    link.click();
  };
  
  img.src = 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svgData)));
}

function exportAsSVG() {
  const svg = document.getElementById('tree-canvas');
  const svgData = new XMLSerializer().serializeToString(svg);
  downloadFile(svgData, 'family-tree.svg', 'image/svg+xml');
}

function downloadFile(content, filename, type) {
  const blob = new Blob([content], { type });
  const url = URL.createObjectURL(blob);
  const link = document.createElement('a');
  link.href = url;
  link.download = filename;
  link.click();
  URL.revokeObjectURL(url);
}

function clearAll() {
  const confirmMsg = isArabic ? 'ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ŸÖÿ≥ÿ≠ ÿßŸÑÿ¥ÿ¨ÿ±ÿ© ÿ®ÿßŸÑŸÉÿßŸÖŸÑÿü' : 'Are you sure you want to clear the entire tree?';
  if (!confirm(confirmMsg)) return;
  
  familyData = {
    title: isArabic ? 'ÿ¥ÿ¨ÿ±ÿ© ÿπÿßÿ¶ŸÑÿ©' : 'Family Tree',
    persons: {},
    rootId: null
  };
  
  renderTree();
  updateUI();
  showToast(isArabic ? 'ÿ™ŸÖ ÿßŸÑŸÖÿ≥ÿ≠' : 'Cleared');
}

// ==================== UI ====================
function updateUI() {
  const persons = Object.values(familyData.persons);
  const isEmpty = persons.length === 0;
  
  document.getElementById('empty-state').style.display = isEmpty ? 'flex' : 'none';
  document.getElementById('stats-bar').style.display = isEmpty ? 'none' : 'flex';
  
  if (!isEmpty) {
    const males = persons.filter(p => p.gender === 'male').length;
    const females = persons.filter(p => p.gender === 'female').length;
    
    document.getElementById('stat-total').textContent = persons.length;
    document.getElementById('stat-males').textContent = males;
    document.getElementById('stat-females').textContent = females;
  }
}

function openModal() {
  document.getElementById('person-modal').classList.add('show');
}

function closeModal() {
  document.getElementById('person-modal').classList.remove('show');
  currentPersonId = null;
  addingRelativeTo = null;
  selectedRelation = null;
}

function resetForm() {
  document.getElementById('person-name').value = '';
  document.querySelector('input[name="gender"][value="male"]').checked = true;
  document.getElementById('person-birth').value = '';
  document.getElementById('person-death').value = '';
  document.getElementById('person-notes').value = '';
  currentPhoto = null;
  updatePhotoPreview();
}

function showToast(message) {
  const toast = document.getElementById('toast');
  toast.textContent = message;
  toast.classList.add('show');
  setTimeout(() => toast.classList.remove('show'), 2000);
}

function toggleDropdown(id) {
  const dropdown = document.getElementById(id);
  dropdown.classList.toggle('open');
  
  // Close when clicking outside
  const closeDropdown = (e) => {
    if (!dropdown.contains(e.target)) {
      dropdown.classList.remove('open');
      document.removeEventListener('click', closeDropdown);
    }
  };
  
  setTimeout(() => document.addEventListener('click', closeDropdown), 0);
}

// Close modal on Escape
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') closeModal();
});

// Initialize
init();
</script>

<script>
  window.toolsData = [{"id":"percentage","icon":"üî¢","name":"Percentage Calculator","keywords":"percentage calculator, calculate percentage, discount calculator, percent change","searchTerms":"percent percentage % discount sale off price change increase decrease difference quarter half third ratio math calculator profit loss tax margin fraction calculate how much what is of total part whole original cost selling buying before after","category":"calculators","categoryName":"Calculators","url":"../../en/tools/percentage.html"},{"id":"interest-calculator","icon":"üí∞","name":"Interest Calculator","keywords":"interest calculator, simple interest, compound interest, loan calculator","searchTerms":"interest simple compound loan investment return profit bank money calculate annual monthly daily quarterly yearly principal rate time period accumulate savings deposit growth calculator finance financial how much earn","category":"calculators","categoryName":"Calculators","url":"../../en/tools/interest-calculator.html"},{"id":"loan-calculator","icon":"üè¶","name":"Loan Calculator","keywords":"loan calculator, monthly payment, amortization schedule, mortgage calculator","searchTerms":"loan loans payment payments installment installments bank mortgage mortgages monthly schedule amortization calculate calculator interest principal finance financing car home personal","category":"calculators","categoryName":"Calculators","url":"../../en/tools/loan-calculator.html"},{"id":"body-calculator","icon":"‚öñÔ∏è","name":"Body Calculator","keywords":"BMI calculator, body mass index, ideal weight, calorie calculator, body fat","searchTerms":"bmi body mass index weight fat calories calorie bmr tdee ideal healthy obesity overweight underweight waist hip ratio calculate calculator health fitness","category":"calculators","categoryName":"Calculators","url":"../../en/tools/body-calculator.html"},{"id":"age-calculator","icon":"üéÇ","name":"Age Calculator","keywords":"age calculator, calculate age, how old am I, zodiac sign, birthday calculator","searchTerms":"age birthday birth date zodiac calculate how old years months days weeks hours born sign horoscope difference between dates","category":"calculators","categoryName":"Calculators","url":"../../en/tools/age-calculator.html"},{"id":"family-tree","icon":"üå≥","name":"Family Tree","keywords":"family tree, genealogy, ancestry, lineage, family relationships, family tree maker","searchTerms":"family tree genealogy ancestry lineage relatives father mother son daughter brother sister grandfather grandmother uncle aunt cousin relations","category":"everyday","categoryName":"Everyday Tools","url":"../../en/tools/family-tree.html"}];
</script>
      </main>
      
      <footer class="main-footer">
        <p>Made with ‚ù§Ô∏è | All Rights Reserved ¬© 2026 Udda</p>
      </footer>
    </div>
  </div>
  
  <!-- Settings Panel -->
  <div class="settings-overlay"></div>
  <div class="settings-panel">
    <div class="settings-header">
      <h2 class="settings-title">Settings</h2>
      <button class="settings-close" aria-label="Close">‚úï</button>
    </div>
    <div class="settings-content">
      <div class="settings-section">
        <div class="settings-section-title">Language</div>
        <div class="settings-option">
          <button class="settings-btn " data-lang-btn="ar">ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</button>
          <button class="settings-btn active" data-lang-btn="en">English</button>
        </div>
      </div>
      <div class="settings-section">
        <div class="settings-section-title">Theme</div>
        <div class="settings-option">
          <button class="settings-btn" data-theme-btn="light">‚òÄÔ∏è Light</button>
          <button class="settings-btn" data-theme-btn="dark">üåô Dark</button>
          <button class="settings-btn active" data-theme-btn="auto">üíª Auto</button>
        </div>
      </div>
      <div class="settings-section">
        <button class="settings-btn" data-clear-data style="width:100%;justify-content:center;color:var(--error);">
          üóëÔ∏è Clear Saved Data
        </button>
      </div>
    </div>
  </div>
  
  <div class="toast"></div>
  <script src="../../assets/js/app.js"></script>
</body>
</html>